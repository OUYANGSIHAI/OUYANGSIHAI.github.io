<!DOCTYPE HTML>
<html lang="zh-CN">
    <!-- shw2018 洪卫  modify 2019.08.15-->



<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Spring Boot, Spring Cloud, 微服务, Java技术, 好好学java, Java面试, 分布式, 最新干货分享">
    <meta name="baidu-site-verification" content="fmlEuI34ir" />
    <meta name="google-site-verification" content="ZWVq5UvPg33BCEA3LRTUkYe5J854o9lF1_WRTer9l8A" />
    <meta name="description" content="本站是 好好学java 的技术分享博客。内容涵盖Java后端技术、Spring Boot、Spring Cloud、微服务架构、分布式、Java面试、测试开发等相关的研究与知识分享。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MyBatis 源码分析 – 配置文件解析过程 | 好好学java | Spring Boot | Spring Cloud | 微服务 | Java技术 | Java面试 | 分布式 | 最新干货分享</title>
    <link rel="icon" type="image/png" href="http://image.ouyangsihai.cn/FjihsEiBMONnJIRtPwgGkjE4HAP7">

    <!-- <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css"> -->
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <!-- 自定义fontawesome样式：欧阳思海 -->
    <link rel="stylesheet" type="text/css" href="/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/css/brands.min.css">
    <link rel="stylesheet" type="text/css" href="/css/fontawesome.min.css">
    <link rel="stylesheet" type="text/css" href="/css/regular.min.css">
    <link rel="stylesheet" type="text/css" href="/css/solid.min.css">


    <style type="text/css">
        code[class*="language-"],
            pre[class*="language-"] {
                white-space: pre !important;
            }

            

        /* 将matery.css中的背景颜色修改放到这里：欧阳思海 */
        .bg-color {
            background-image: linear-gradient(to right, #ec8585 0%, #419488 100%);
            opacity: 0.9;
            // 透明度
        }
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>

    
    
    <script>
        (function () {
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>
    

    <script>
        var _hmt = _hmt || [];
        (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?6fe466069710c03a563713b507fbaca7";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
        })();
    </script>


    <!-- Google Analytics -->
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-XXXXX-Y', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics -->

    <script>(function (i, s, o, g, r, a, m) { i["DaoVoiceObject"] = r; i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments) }, i[r].l = 1 * new Date(); a = s.createElement(o), m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; a.charset = "utf-8"; m.parentNode.insertBefore(a, m) })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0a804bac.js", "daovoice")</script>

    <script>
        if (true) {
            daovoice('init', {
                app_id: "0a804bac",
                user_id: "NO_89757", // 必填: 该用户在您系统上的唯一ID
                email: "daovoice@example.com", // 选填:  该用户在您系统上的主邮箱
                name: "道客船长", // 选填: 用户名
                signed_up: 1449821660 // 选填: 用户的注册时间，用Unix时间戳表示
            });
            daovoice('update');

            daovoice('init', {
                app_id: "0a804bac"
            });
            daovoice('update');
        }
    </script>
<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/rss2.xml" title="好好学java" type="application/rss+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

    <body>

        <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="http://image.ouyangsihai.cn/FjihsEiBMONnJIRtPwgGkjE4HAP7" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span" style="font-size: 1.4rem;">好好学java</span>
                </a>
            </div>
            


<!-- <a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="" class="waves-effect waves-light">
            
            <i class="fa "></i>
            
            <span></span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title=""></i>
        </a>
    </li>
</ul> -->

<!-- 支持二级菜单特性 洪卫 shw2018 modify 2019.09.17  -->
<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-align-justify"></i></a>
<ul class="right nav-menu">
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-folder-minus"></i>
                
                <span style="font-size: 1.1rem;">Java学习</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/Java%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86/" >
                    
                    <span>Java入门</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/Javaweb/" >
                    
                    <span>Java Web</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/spring%E6%95%99%E7%A8%8B/" >
                    
                    <span>Spring教程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/springboot%E6%95%99%E7%A8%8B/" >
                    
                    <span>SpringBoot教程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/springcloud%E6%95%99%E7%A8%8B/" >
                    
                    <span>SpringCloud教程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/Java%E9%9D%A2%E8%AF%95%E9%A2%98/" >
                    
                    <span>Java面试</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E5%89%91%E6%8C%87offer/" >
                    
                    <span>剑指offer</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-code-branch"></i>
                
                <span style="font-size: 1.1rem;">Java进阶</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%B3%BB%E5%88%97/" >
                    
                    <span>设计模式</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" >
                    
                    <span>Java并发编程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3/" >
                    
                    <span>数据库</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/redis/" >
                    
                    <span>Redis</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/linux/" >
                    
                    <span>Linux</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/" >
                    
                    <span>Java实战项目</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-code"></i>
                
                <span style="font-size: 1.1rem;">python学习</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/python%E5%9F%BA%E7%A1%80/" >
                    
                    <span>python基础</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/python%E6%A1%86%E6%9E%B6/" >
                    
                    <span>python框架</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/python%E5%85%B6%E4%BB%96/" >
                    
                    <span>python其他</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-coffee"></i>
                
                <span style="font-size: 1.1rem;">Java扩展</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/dubbo/" >
                    
                    <span>dubbo</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/netty/" >
                    
                    <span>netty</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/rpc/" >
                    
                    <span>rpc</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/eureka/" >
                    
                    <span>eureka</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" >
                    
                    <span>中间件</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" >
                    
                    <span>分布式</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-desktop"></i>
                
                <span style="font-size: 1.1rem;">计算机核心</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" >
                    
                    <span>数据结构</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/leetcode%E5%88%B7%E9%A2%98/" >
                    
                    <span>leetcode刷题</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" >
                    
                    <span>计算机网络</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E7%AE%97%E6%B3%95/" >
                    
                    <span>算法</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/categories/" class="waves-effect waves-light">
              
                <i style="font-size: 1.1rem;" class="fa fa-adjust"></i>
              
              <span style="font-size: 1.1rem;">学习资源</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/contact" class="waves-effect waves-light">
              
                <i style="font-size: 1.1rem;" class="fa fa-envelope"></i>
              
              <span style="font-size: 1.1rem;">留言</span>
            </a>

            
      </li>
    

    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="http://image.ouyangsihai.cn/FjihsEiBMONnJIRtPwgGkjE4HAP7" class="logo-img circle responsive-img">
        
        <div class="logo-name">好好学java</div>
        <div class="logo-desc">
            
            
            本站是 好好学java 的技术分享博客，涵盖Java后端技术、SpringBoot、微服务架构、分布式、Java面试等知 ...
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-folder-minus"></i>
			
			Java学习
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/Java%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86/ " style="margin-left:75px";>
				  
		          <span>Java入门</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Javaweb/ " style="margin-left:75px";>
				  
		          <span>Java Web</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/spring%E6%95%99%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>Spring教程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/springboot%E6%95%99%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>SpringBoot教程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/springcloud%E6%95%99%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>SpringCloud教程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Java%E9%9D%A2%E8%AF%95%E9%A2%98/ " style="margin-left:75px";>
				  
		          <span>Java面试</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E5%89%91%E6%8C%87offer/ " style="margin-left:75px";>
				  
		          <span>剑指offer</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-code-branch"></i>
			
			Java进阶
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%B3%BB%E5%88%97/ " style="margin-left:75px";>
				  
		          <span>设计模式</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>Java并发编程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3/ " style="margin-left:75px";>
				  
		          <span>数据库</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/redis/ " style="margin-left:75px";>
				  
		          <span>Redis</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/linux/ " style="margin-left:75px";>
				  
		          <span>Linux</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/ " style="margin-left:75px";>
				  
		          <span>Java实战项目</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-code"></i>
			
			python学习
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/python%E5%9F%BA%E7%A1%80/ " style="margin-left:75px";>
				  
		          <span>python基础</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/python%E6%A1%86%E6%9E%B6/ " style="margin-left:75px";>
				  
		          <span>python框架</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/python%E5%85%B6%E4%BB%96/ " style="margin-left:75px";>
				  
		          <span>python其他</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-coffee"></i>
			
			Java扩展
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/dubbo/ " style="margin-left:75px";>
				  
		          <span>dubbo</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/netty/ " style="margin-left:75px";>
				  
		          <span>netty</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/rpc/ " style="margin-left:75px";>
				  
		          <span>rpc</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/eureka/ " style="margin-left:75px";>
				  
		          <span>eureka</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/ " style="margin-left:75px";>
				  
		          <span>中间件</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/ " style="margin-left:75px";>
				  
		          <span>分布式</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-desktop"></i>
			
			计算机核心
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ " style="margin-left:75px";>
				  
		          <span>数据结构</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/leetcode%E5%88%B7%E9%A2%98/ " style="margin-left:75px";>
				  
		          <span>leetcode刷题</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ " style="margin-left:75px";>
				  
		          <span>计算机网络</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E7%AE%97%E6%B3%95/ " style="margin-left:75px";>
				  
		          <span>算法</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/" class="waves-effect waves-light">
			
			    <i class="fa fa-fw fa-adjust"></i>
			
			学习资源
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa fa-fw fa-envelope"></i>
			
			留言
		</a>
          
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

        



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/12.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        MyBatis 源码分析 – 配置文件解析过程
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }

    /* 自定义mycard：欧阳思海 */

    #my-card {
        /* position: relative; */
        width: 310px;
        height: 300px;
        /* max-height: 330px; */
        margin-bottom: 15px;
        margin-top: 15px;
        /* text-align: center; */
        border: 0;
        border-radius: 3px;
        color: rgba(0, 0, 0, .87);
        background: #fff 50%;
        background-image: none;
        background-size: auto;
        background-size: cover;
        box-shadow: 0 15px 35px rgba(50, 50, 93, .1), 0 5px 15px rgba(0, 0, 0, .07);
    }

    /* .widget {
        line-height: 1.6em;
        word-wrap: break-word;
        font-size: 0.9em;
        padding-top: 15px;
        padding-left: -45px;
    } */
</style>




<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- shw2018 洪卫  modify 2019.08.15-->

<!-- 代码块修改的代码开始 -->
<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFunction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

<!-- 代码块修改代码结束 -->


<!-- 文章内容详情 -->
<div id="container">
    <div id="artDetail">
        <div class="card">
            <div class="card-content article-info">
                <div class="row tag-cate">
                    <div class="col s7">
                        
                        <div class="article-tag">
                            <!--我修改的地方：欧阳思海-->
                            
                            <a href="/tags/mybatis-mybatis%E6%BA%90%E7%A0%81/" target="_blank">
                                <span class="chip bg-color">mybatis,mybatis源码</span>
                            </a>
                            
                        </div>
                        
                    </div>
                    <div class="col s5 right-align">
                        
                        <div class="post-cate">
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/mybatis%E6%BA%90%E7%A0%81/" class="post-category" target="_blank">
                                mybatis源码
                            </a>
                            
                        </div>
                        
                    </div>
                </div>

                <div class="post-info">
                    <div class="post-date info-break-policy">
                        <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                        2021-04-05
                    </div>

                    <div class="post-author info-break-policy">
                        <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                        
                        欧阳思海
                        
                    </div>

                    
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        17.7k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        76 分
                    </div>
                    
                    

                    
                    <span id="busuanzi_container_site_pv" style='display:none'></span>
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>

                    

                </div>
            </div>
            <hr class="clearfix">
            <div class="card-content article-card-content">
                <!-- 欧阳思海，modify，2020.05.01-->
<!-- 文章详情详情页面的头部广告位置信息 -->
<div id="post-head-panel">
    
    <a href="https://github.com/OUYANGSIHAI/JavaInterview" style="font-size: 18px;" target="_blank">
        <img src="/icons/hot.gif">
        本人花费半年的时间总结的《Java面试指南》已拿腾讯等大厂offer，已开源在github ，欢迎star！
    </a>
    
    
</div>
<br />



<blockquote>
    
            <p>本文GitHub <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">https://github.com/OUYANGSIHAI/JavaInterview</a> 已收录，这是我花了6个月总结的<b>一线大厂Java面试</b>总结，本人已拿大厂offer，欢迎star</p>
    
    <p>原文链接：blog.ouyangsihai.cn &gt;&gt; <a href="/mybatis-yuan-ma-fen-xi-pei-zhi-wen-jian-jie-xi-guo-cheng.html" target="_blank">MyBatis 源码分析 – 配置文件解析过程</a></p>
</blockquote>
                <div id="articleContent">
                    <h2 id="本文速览"><a href="#本文速览" class="headerlink" title="* 本文速览"></a>* 本文速览</h2><p>由于本篇文章篇幅比较大，所以这里拿出一节对本文进行快速概括。本篇文章对 MyBatis 配置文件中常用配置的解析过程进行了较为详细的介绍和分析，包括但不限于<code class="java">
settings</code>，<code class="java">
typeAliases</code>和<code class="java">
typeHandlers</code>等，本文的篇幅也主要在对这三个配置解析过程的分析上。下面，我们来一起看一下本篇文章的目录结构。</p>
<img class=" aligncenter" title="MyBatis 源码分析 - 配置文件解析过程" src="https://www.javazhiyin.com/wp-content/uploads/2018/07/8-1532920599.jpeg" src="https://www.javazhiyin.com/wp-content/themes/mnews/images/post-loading.gif" alt="MyBatis 源码分析 - 配置文件解析过程">

<p>从目录上可以看出，2.3节、2.5节和2.8节的内容比较多。其中2.3节是关于<code class="java">
settings</code>配置解析过程的分析，除了对常规的 XML 解析过程分析，本节额外的分析了元信息类<code class="java">
MetaClass</code>源码的逻辑。2.5节则是详细分析了别名注册的过程，包含自动注册和手动注册别名等两种方式。2.8节则是详细介绍了类型处理器的注册过程，类型注册逻辑是封装在<code class="java">
TypeHandlerRegistry</code>类中的各个<code class="java">
register</code>重载方法中。由于重载方法比较多，且互为调用，调用关系比较复杂。为此，我专门画了一张方法调用关系图。这张图在分析类类型处理器注册那一块的源码时，会很有用。</p>
<img class=" aligncenter" title="MyBatis 源码分析 - 配置文件解析过程" src="https://www.javazhiyin.com/wp-content/uploads/2018/07/8-1532920600.jpeg" src="https://www.javazhiyin.com/wp-content/themes/mnews/images/post-loading.gif" alt="MyBatis 源码分析 - 配置文件解析过程">

<p>本文的2.9节主要用于分析 SQL 映射文件的解析过程。由于 SQL 映射文件解析的过程也很复杂，所以这里把2.9节独立成文，后续会进行更新。至于其他的章节，没什么太复杂的东西，就不一一叙述了。</p>
<p>以上就是 MyBatis 配置文件解析过程的速览，如果大家对以上所说内容比较熟悉了，那就不用往下看了。如果不了解，或是有兴趣的话，不妨阅读一下。本篇文章行文较长，除了对常规的 XML 解析过程进行分析，还额外分析了一些源码。如果能掌握本文所分析内容，我相信可以对 MyBatis 有更深入的了解。好了，其他的就不多说了，进入正题吧。</p>
<h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h2><p>在上一篇文章中，我介绍了 MyBatis 的一些基础知识，用于为本文及后续的源码分析文章进行铺垫。经过前面的铺垫，我觉得是时候后分析一下 MyBatis 源码了。在本篇文章中，我将从 MyBatis 解析配置文件的过程着手进行分析。并会在分析的过程中，向大家介绍一些配置的使用方式和用途。MyBatis 的配置比较丰富，很难在一篇文章中把所有配置的解析过程分析完。所以关于配置文件的解析，这里会分两篇文章进行讲解。本篇文章将会分析诸如<code class="java">
settings</code>，<code class="java">
typeAliases</code>以及<code class="java">
typeHandlers</code>等标签的解析过程。下一篇文章则会重点介绍 SQL 映射文件的解析过程。本系列文章所分析的源码版本为<code class="java">
3.4.6</code>，是 MyBatis 最新的版本。好了，其他的就不多说了，下面进入源码分析阶段。</p>
<h2 id="2-配置文件解析过程分析"><a href="#2-配置文件解析过程分析" class="headerlink" title="2.配置文件解析过程分析"></a>2.配置文件解析过程分析</h2><h3 id="2-1-配置文件解析入口"><a href="#2-1-配置文件解析入口" class="headerlink" title="2.1 配置文件解析入口"></a>2.1 配置文件解析入口</h3><p>在单独使用 MyBatis 时，第一步要做的事情就是根据配置文件构建<code class="java">
SqlSessionFactory</code>对象。相关代码如下：</p>
<td class="line_numbers"><pre>123</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">String resource = "mybatis-config.xml";InputStream inputStream = Resources.getResourceAsStream(resource);SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);</pre></td>

<p>String resource &#x3D; “mybatis-config.xml”;<br>InputStream inputStream &#x3D; Resources.getResourceAsStream(resource);<br>SqlSessionFactory sqlSessionFactory &#x3D; new SqlSessionFactoryBuilder().build(inputStream);</p>
<p>首先，我们使用 MyBatis 提供的工具类 Resources 加载配置文件，得到一个输入流。然后再通过 SqlSessionFactoryBuilder 对象的<code class="java">
build</code>方法构建 SqlSessionFactory 对象。所以这里的 build 方法是我们分析配置文件解析过程的入口方法。那下面我们来看一下这个方法的代码：</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- SqlSessionFactoryBuilderpublic SqlSessionFactory build(InputStream inputStream) {    // 调用重载方法    return build(inputStream, null, null);} public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) {    try {        // 创建配置文件解析器        XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);        // 调用 parse 方法解析配置文件，生成 Configuration 对象        return build(parser.parse());    } catch (Exception e) {        throw ExceptionFactory.wrapException("Error building SqlSession.", e);    } finally {        ErrorContext.instance().reset();        try {        inputStream.close();        } catch (IOException e) {        // Intentionally ignore. Prefer previous error.        }    }} public SqlSessionFactory build(Configuration config) {    // 创建 DefaultSqlSessionFactory    return new DefaultSqlSessionFactory(config);}</pre></td>

<p>&#x2F;&#x2F; -☆- SqlSessionFactoryBuilder<br>public SqlSessionFactory build(InputStream inputStream) {<br>    &#x2F;&#x2F; 调用重载方法<br>    return build(inputStream, null, null);<br>}</p>
<p>public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) {<br>    try {<br>        &#x2F;&#x2F; 创建配置文件解析器<br>        XMLConfigBuilder parser &#x3D; new XMLConfigBuilder(inputStream, environment, properties);<br>        &#x2F;&#x2F; 调用 parse 方法解析配置文件，生成 Configuration 对象<br>        return build(parser.parse());<br>    } catch (Exception e) {<br>        throw ExceptionFactory.wrapException(“Error building SqlSession.”, e);<br>    } finally {<br>        ErrorContext.instance().reset();<br>        try {<br>        inputStream.close();<br>        } catch (IOException e) {<br>        &#x2F;&#x2F; Intentionally ignore. Prefer previous error.<br>        }<br>    }<br>}</p>
<p>public SqlSessionFactory build(Configuration config) {<br>    &#x2F;&#x2F; 创建 DefaultSqlSessionFactory<br>    return new DefaultSqlSessionFactory(config);<br>}</p>
<p>从上面的代码中，我们大致可以猜出 MyBatis 配置文件是通过<code class="java">
XMLConfigBuilder</code>进行解析的。不过目前这里还没有非常明确的解析逻辑，所以我们继续往下看。这次来看一下 XMLConfigBuilder 的<code class="java">
parse</code>方法，如下：</p>
<td class="line_numbers"><pre>12345678910</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- XMLConfigBuilderpublic Configuration parse() {    if (parsed) {        throw new BuilderException("Each XMLConfigBuilder can only be used once.");    }    parsed = true;    // 解析配置    parseConfiguration(parser.evalNode("/configuration"));    return configuration;}</pre></td>

<p>&#x2F;&#x2F; -☆- XMLConfigBuilder<br>public Configuration parse() {<br>    if (parsed) {<br>        throw new BuilderException(“Each XMLConfigBuilder can only be used once.”);<br>    }<br>    parsed &#x3D; true;<br>    &#x2F;&#x2F; 解析配置<br>    parseConfiguration(parser.evalNode(“&#x2F;configuration”));<br>    return configuration;<br>}</p>
<p>到这里大家可以看到一些端倪了，注意一个 xpath 表达式 - <code class="java">
/configuration</code>。这个表达式代表的是 MyBatis 的<code class="java">
configuration/</code>标签，这里选中这个标签，并传递给<code class="java">
parseConfiguration</code>方法。我们继续跟下去。</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738394041424344</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void parseConfiguration(XNode root) {    try {        // 解析 properties 配置        propertiesElement(root.evalNode("properties"));         // 解析 settings 配置，并将其转换为 Properties 对象        Properties settings = settingsAsProperties(root.evalNode("settings"));         // 加载 vfs        loadCustomVfs(settings);         // 解析 typeAliases 配置        typeAliasesElement(root.evalNode("typeAliases"));         // 解析 plugins 配置        pluginElement(root.evalNode("plugins"));         // 解析 objectFactory 配置        objectFactoryElement(root.evalNode("objectFactory"));         // 解析 objectWrapperFactory 配置        objectWrapperFactoryElement(root.evalNode("objectWrapperFactory"));         // 解析 reflectorFactory 配置        reflectorFactoryElement(root.evalNode("reflectorFactory"));         // settings 中的信息设置到 Configuration 对象中        settingsElement(settings);         // 解析 environments 配置        environmentsElement(root.evalNode("environments"));         // 解析 databaseIdProvider，获取并设置 databaseId 到 Configuration 对象        databaseIdProviderElement(root.evalNode("databaseIdProvider"));         // 解析 typeHandlers 配置        typeHandlerElement(root.evalNode("typeHandlers"));         // 解析 mappers 配置        mapperElement(root.evalNode("mappers"));    } catch (Exception e) {        throw new BuilderException("Error parsing SQL Mapper Configuration. Cause: " + e, e);    }}</pre></td>

<p>private void parseConfiguration(XNode root) {<br>    try {<br>        &#x2F;&#x2F; 解析 properties 配置<br>        propertiesElement(root.evalNode(“properties”));</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// 解析 settings 配置，并将其转换为 Properties 对象</span>
    Properties settings <span class="token operator">=</span> <span class="token function">settingsAsProperties</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"settings"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 加载 vfs</span>
    <span class="token function">loadCustomVfs</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 typeAliases 配置</span>
    <span class="token function">typeAliasesElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"typeAliases"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 plugins 配置</span>
    <span class="token function">pluginElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"plugins"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 objectFactory 配置</span>
    <span class="token function">objectFactoryElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"objectFactory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 objectWrapperFactory 配置</span>
    <span class="token function">objectWrapperFactoryElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"objectWrapperFactory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 reflectorFactory 配置</span>
    <span class="token function">reflectorFactoryElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"reflectorFactory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// settings 中的信息设置到 Configuration 对象中</span>
    <span class="token function">settingsElement</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 environments 配置</span>
    <span class="token function">environmentsElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"environments"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 databaseIdProvider，获取并设置 databaseId 到 Configuration 对象</span>
    <span class="token function">databaseIdProviderElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"databaseIdProvider"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 typeHandlers 配置</span>
    <span class="token function">typeHandlerElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"typeHandlers"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 mappers 配置</span>
    <span class="token function">mapperElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"mappers"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Error parsing SQL Mapper Configuration. Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>到此，一个 MyBatis 的解析过程就出来了，每个配置的解析逻辑都封装在了相应的方法中。在下面分析过程中，我不打算按照方法调用的顺序进行分析，我会适当进行一定的调整。同时，MyBatis 中配置较多，对于一些不常用的配置，这里会略过。那下面我们开始进行分析吧。</p>
<h3 id="2-2-解析-properties-配置"><a href="#2-2-解析-properties-配置" class="headerlink" title="2.2 解析 properties 配置"></a>2.2 解析 properties 配置</h3><p>解析<code class="java">
properties</code>节点是由<code class="java">
propertiesElement</code>这个方法完成的，该方法的逻辑比较简单。在分析方法源码前，先来看一下 properties 节点的配置内容。如下：</p>
<td class="line_numbers"><pre>1234</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">properties resource="jdbc.properties"    property name="jdbc.username" value="coolblog"/    property name="hello" value="world"//properties</pre></td>

<p>properties resource&#x3D;”jdbc.properties”<br>    property name&#x3D;”jdbc.username” value&#x3D;”coolblog”&#x2F;<br>    property name&#x3D;”hello” value&#x3D;”world”&#x2F;<br>&#x2F;properties</p>
<p>在上面的配置中，我为 properties 节点配置了一个 resource 属性，以及两个子节点。下面我们参照上面的配置，来分析一下 propertiesElement 的逻辑。相关分析如下。</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- XMLConfigBuilderprivate void propertiesElement(XNode context) throws Exception {    if (context != null) {        // 解析 propertis 的子节点，并将这些节点内容转换为属性对象 Properties        Properties defaults = context.getChildrenAsProperties();        // 获取 propertis 节点中的 resource 和 url 属性值        String resource = context.getStringAttribute("resource");        String url = context.getStringAttribute("url");         // 两者都不用空，则抛出异常        if (resource != null && url != null) {            throw new BuilderException("The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.");        }        if (resource != null) {            // 从文件系统中加载并解析属性文件            defaults.putAll(Resources.getResourceAsProperties(resource));        } else if (url != null) {            // 通过 url 加载并解析属性文件            defaults.putAll(Resources.getUrlAsProperties(url));        }        Properties vars = configuration.getVariables();        if (vars != null) {            defaults.putAll(vars);        }        parser.setVariables(defaults);        // 将属性值设置到 configuration 中        configuration.setVariables(defaults);    }} public Properties getChildrenAsProperties() {    Properties properties = new Properties();    // 获取并遍历子节点    for (XNode child : getChildren()) {        // 获取 property 节点的 name 和 value 属性        String name = child.getStringAttribute("name");        String value = child.getStringAttribute("value");        if (name != null && value != null) {            // 设置属性到属性对象中            properties.setProperty(name, value);        }    }    return properties;} // -☆- XNodepublic ListXNode getChildren() {    ListXNode children = new ArrayListXNode();    // 获取子节点列表    NodeList nodeList = node.getChildNodes();    if (nodeList != null) {        for (int i = 0, n = nodeList.getLength(); i  n; i++) {            Node node = nodeList.item(i);            if (node.getNodeType() == Node.ELEMENT_NODE) {                // 将节点对象封装到 XNode 中，并将 XNode 对象放入 children 列表中                children.add(new XNode(xpathParser, node, variables));            }        }    }    return children;}</pre></td>

<p>&#x2F;&#x2F; -☆- XMLConfigBuilder<br>private void propertiesElement(XNode context) throws Exception {<br>    if (context !&#x3D; null) {<br>        &#x2F;&#x2F; 解析 propertis 的子节点，并将这些节点内容转换为属性对象 Properties<br>        Properties defaults &#x3D; context.getChildrenAsProperties();<br>        &#x2F;&#x2F; 获取 propertis 节点中的 resource 和 url 属性值<br>        String resource &#x3D; context.getStringAttribute(“resource”);<br>        String url &#x3D; context.getStringAttribute(“url”);</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// 两者都不用空，则抛出异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> url <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 从文件系统中加载并解析属性文件</span>
        defaults<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>Resources<span class="token punctuation">.</span><span class="token function">getResourceAsProperties</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 通过 url 加载并解析属性文件</span>
        defaults<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>Resources<span class="token punctuation">.</span><span class="token function">getUrlAsProperties</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Properties vars <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vars <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        defaults<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>vars<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    parser<span class="token punctuation">.</span><span class="token function">setVariables</span><span class="token punctuation">(</span>defaults<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 将属性值设置到 configuration 中</span>
    configuration<span class="token punctuation">.</span><span class="token function">setVariables</span><span class="token punctuation">(</span>defaults<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>public Properties getChildrenAsProperties() {<br>    Properties properties &#x3D; new Properties();<br>    &#x2F;&#x2F; 获取并遍历子节点<br>    for (XNode child : getChildren()) {<br>        &#x2F;&#x2F; 获取 property 节点的 name 和 value 属性<br>        String name &#x3D; child.getStringAttribute(“name”);<br>        String value &#x3D; child.getStringAttribute(“value”);<br>        if (name !&#x3D; null &amp;&amp; value !&#x3D; null) {<br>            &#x2F;&#x2F; 设置属性到属性对象中<br>            properties.setProperty(name, value);<br>        }<br>    }<br>    return properties;<br>}</p>
<p>&#x2F;&#x2F; -☆- XNode<br>public ListXNode getChildren() {<br>    ListXNode children &#x3D; new ArrayListXNode();<br>    &#x2F;&#x2F; 获取子节点列表<br>    NodeList nodeList &#x3D; node.getChildNodes();<br>    if (nodeList !&#x3D; null) {<br>        for (int i &#x3D; 0, n &#x3D; nodeList.getLength(); i  n; i++) {<br>            Node node &#x3D; nodeList.item(i);<br>            if (node.getNodeType() &#x3D;&#x3D; Node.ELEMENT_NODE) {<br>                &#x2F;&#x2F; 将节点对象封装到 XNode 中，并将 XNode 对象放入 children 列表中<br>                children.add(new XNode(xpathParser, node, variables));<br>            }<br>        }<br>    }<br>    return children;<br>}</p>
<p>上面是 properties 节点解析的主要过程，不是很复杂。主要包含三个步骤，一是解析 properties 节点的子节点，并将解析结果设置到 Properties 对象中。二是从文件系统或通过网络读取属性配置，这取决于 properties 节点的 resource 和 url 是否为空。第二步对应的代码比较简单，这里就不分析了。有兴趣的话，大家可以自己去看看。最后一步则是将解析出的属性对象设置到 XPathParser 和 Configuration 对象中。</p>
<p>需要注意的是，propertiesElement 方法是先解析 properties 节点的子节点内容，后再从文件系统或者网络读取属性配置，并将所有的属性及属性值都放入到 defaults 属性对象中。这就会存在同名属性覆盖的问题，也就是从文件系统，或者网络上读取到的属性及属性值会覆盖掉 properties 子节点中同名的属性和及值。比如上面配置中的<code class="java">
jdbc.properties</code>内容如下：</p>
<td class="line_numbers"><pre>1234</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">jdbc.driver=com.mysql.cj.jdbc.Driverjdbc.url=jdbc:mysql://localhost:3306/myblog?...jdbc.username=rootjdbc.password=1234</pre></td>

<p>jdbc.driver&#x3D;com.mysql.cj.jdbc.Driver<br>jdbc.url&#x3D;jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;myblog?…<br>jdbc.username&#x3D;root<br>jdbc.password&#x3D;1234</p>
<p>与 properties 子节点内容合并后，结果如下：</p>
<img class=" aligncenter" title="MyBatis 源码分析 - 配置文件解析过程" src="https://www.javazhiyin.com/wp-content/uploads/2018/07/9-1532920601.jpeg" src="https://www.javazhiyin.com/wp-content/themes/mnews/images/post-loading.gif" alt="MyBatis 源码分析 - 配置文件解析过程">

<p>如上，原<code class="java">
jdbc.username</code>值为<code class="java">
coolblog</code>，现在被覆盖为了<code class="java">
root</code>。同名属性覆盖的问题需要大家注意一下，其他的就没什么了，继续往下分析。</p>
<h3 id="2-3-解析-settings-配置"><a href="#2-3-解析-settings-配置" class="headerlink" title="2.3 解析 settings 配置"></a>2.3 解析 settings 配置</h3><h4 id="2-3-1-settings-节点的解析过程"><a href="#2-3-1-settings-节点的解析过程" class="headerlink" title="2.3.1 settings 节点的解析过程"></a>2.3.1 settings 节点的解析过程</h4><p>settings 相关配置是 MyBatis 中非常重要的配置，这些配置用于调整 MyBatis 运行时的行为。settings 配置繁多，在对这些配置不熟悉的情况下，保持默认配置即可。关于 settings 相关配置，MyBatis 官网上进行了比较详细的描述，大家可以去了解一下。在本节中，暂时还用不到这些配置，所以即使不了解这些配置也没什么关系。下面先来看一个比较简单的配置，如下：</p>
<td class="line_numbers"><pre>12345</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">settings    setting name="cacheEnabled" value="true"/    setting name="lazyLoadingEnabled" value="true"/    setting name="autoMappingBehavior" value="PARTIAL"//settings</pre></td>

<p>settings<br>    setting name&#x3D;”cacheEnabled” value&#x3D;”true”&#x2F;<br>    setting name&#x3D;”lazyLoadingEnabled” value&#x3D;”true”&#x2F;<br>    setting name&#x3D;”autoMappingBehavior” value&#x3D;”PARTIAL”&#x2F;<br>&#x2F;settings</p>
<p>接下来，对照上面的配置，来分析源码。如下：</p>
<td class="line_numbers"><pre>123456789101112131415161718</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- XMLConfigBuilderprivate Properties settingsAsProperties(XNode context) {    if (context == null) {        return new Properties();    }    // 获取 settings 子节点中的内容，getChildrenAsProperties 方法前面已分析过，这里不再赘述    Properties props = context.getChildrenAsProperties();     // 创建 Configuration 类的“元信息”对象    MetaClass metaConfig = MetaClass.forClass(Configuration.class, localReflectorFactory);    for (Object key : props.keySet()) {        // 检测 Configuration 中是否存在相关属性，不存在则抛出异常        if (!metaConfig.hasSetter(String.valueOf(key))) {            throw new BuilderException("The setting " + key + " is not known.  Make sure you spelled it correctly (case sensitive).");        }    }    return props;}</pre></td>

<p>&#x2F;&#x2F; -☆- XMLConfigBuilder<br>private Properties settingsAsProperties(XNode context) {<br>    if (context &#x3D;&#x3D; null) {<br>        return new Properties();<br>    }<br>    &#x2F;&#x2F; 获取 settings 子节点中的内容，getChildrenAsProperties 方法前面已分析过，这里不再赘述<br>    Properties props &#x3D; context.getChildrenAsProperties();</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 创建 Configuration 类的“元信息”对象</span>
MetaClass metaConfig <span class="token operator">=</span> MetaClass<span class="token punctuation">.</span><span class="token function">forClass</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> localReflectorFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>Object key <span class="token operator">:</span> props<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 检测 Configuration 中是否存在相关属性，不存在则抛出异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>metaConfig<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"The setting "</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">" is not known.  Make sure you spelled it correctly (case sensitive)."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> props<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>如上，settingsAsProperties 方法看起来并不复杂，不过这是一个假象。在上面的代码中出现了一个陌生的类<code class="java">
MetaClass</code>，这个类是用来做什么的呢？答案是用来解析目标类的一些元信息，比如类的成员变量，getter&#x2F;setter 方法等。关于这个类的逻辑，待会我会详细解析。接下来，简单总结一下上面代码的逻辑。如下：</p>
<ol>
<li>解析 settings 子节点的内容，并将解析结果转成 Properties 对象</li>
<li>为 Configuration 创建<code class="java">
元信息</code>对象</li>
<li>通过 MetaClass 检测 Configuration 中是否存在某个属性的 setter 方法，不存在则抛异常</li>
<li>若通过 MetaClass 的检测，则返回 Properties 对象，方法逻辑结束</li>
</ol>
<p>下面，我们来重点关注一下第2步和第3步的流程。这两步流程对应的代码较为复杂，需要一点耐心阅读。好了，下面开始分析。</p>
<h4 id="2-3-2-元信息对象创建过程"><a href="#2-3-2-元信息对象创建过程" class="headerlink" title="2.3.2 元信息对象创建过程"></a>2.3.2 元信息对象创建过程</h4><p>元信息类<code class="java">
MetaClass</code>的构造方法为私有类型，所以不能直接创建，必须使用其提供的<code class="java">
forClass</code>方法进行创建。它的创建逻辑如下：</p>
<td class="line_numbers"><pre>1234567891011121314151617</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public class MetaClass {    private final ReflectorFactory reflectorFactory;    private final Reflector reflector;     private MetaClass(Class? type, ReflectorFactory reflectorFactory) {        this.reflectorFactory = reflectorFactory;        // 根据类型创建 Reflector        this.reflector = reflectorFactory.findForClass(type);    }     public static MetaClass forClass(Class? type, ReflectorFactory reflectorFactory) {        // 调用构造方法        return new MetaClass(type, reflectorFactory);    }     // 省略其他方法}</pre></td>

<p>public class MetaClass {<br>    private final ReflectorFactory reflectorFactory;<br>    private final Reflector reflector;</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">private</span> <span class="token function">MetaClass</span><span class="token punctuation">(</span>Class<span class="token operator">?</span> type<span class="token punctuation">,</span> ReflectorFactory reflectorFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reflectorFactory <span class="token operator">=</span> reflectorFactory<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 根据类型创建 Reflector</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reflector <span class="token operator">=</span> reflectorFactory<span class="token punctuation">.</span><span class="token function">findForClass</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> MetaClass <span class="token function">forClass</span><span class="token punctuation">(</span>Class<span class="token operator">?</span> type<span class="token punctuation">,</span> ReflectorFactory reflectorFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 调用构造方法</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MetaClass</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> reflectorFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 省略其他方法</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面的代码看起来很简单，不过这只是冰山一角。上面代码出现了两个新的类<code class="java">
ReflectorFactory</code>和<code class="java">
Reflector</code>，MetaClass 通过引入这些新类帮助它完成功能。下面我们看一下<code class="java">
hasSetter</code>方法的源码就知道是怎么回事了。</p>
<td class="line_numbers"><pre>1234567891011121314151617181920</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- MetaClasspublic boolean hasSetter(String name) {    // 属性分词器，用于解析属性名    PropertyTokenizer prop = new PropertyTokenizer(name);    // hasNext 返回 true，则表明 name 是一个复合属性，后面会进行分析    if (prop.hasNext()) {        // 调用 reflector 的 hasSetter 方法        if (reflector.hasSetter(prop.getName())) {            // 为属性创建创建 MetaClass            MetaClass metaProp = metaClassForProperty(prop.getName());            // 再次调用 hasSetter            return metaProp.hasSetter(prop.getChildren());        } else {            return false;        }    } else {        // 调用 reflector 的 hasSetter 方法        return reflector.hasSetter(prop.getName());    }}</pre></td>

<p>&#x2F;&#x2F; -☆- MetaClass<br>public boolean hasSetter(String name) {<br>    &#x2F;&#x2F; 属性分词器，用于解析属性名<br>    PropertyTokenizer prop &#x3D; new PropertyTokenizer(name);<br>    &#x2F;&#x2F; hasNext 返回 true，则表明 name 是一个复合属性，后面会进行分析<br>    if (prop.hasNext()) {<br>        &#x2F;&#x2F; 调用 reflector 的 hasSetter 方法<br>        if (reflector.hasSetter(prop.getName())) {<br>            &#x2F;&#x2F; 为属性创建创建 MetaClass<br>            MetaClass metaProp &#x3D; metaClassForProperty(prop.getName());<br>            &#x2F;&#x2F; 再次调用 hasSetter<br>            return metaProp.hasSetter(prop.getChildren());<br>        } else {<br>            return false;<br>        }<br>    } else {<br>        &#x2F;&#x2F; 调用 reflector 的 hasSetter 方法<br>        return reflector.hasSetter(prop.getName());<br>    }<br>}</p>
<p>从上面的代码中，我们可以看出 MetaClass 中的 hasSetter 方法最终调用了 Reflector 的 hasSetter 方法。关于 Reflector 的 hasSetter 方法，这里先不分析，Reflector 这个类的逻辑较为复杂，本节会在随后进行详细说明。下面来简单介绍一下上面代码中出现的几个类：</p>
<ol>
<li>ReflectorFactory - 顾名思义，Reflector 的工厂类，兼有缓存 Reflector 对象的功能</li>
<li>Reflector - 反射器，用于解析和存储目标类中的元信息</li>
<li>PropertyTokenizer - 属性名分词器，用于处理较为复杂的属性名</li>
</ol>
<p>上面的描述比较简单，仅从上面的描述中，还不能让大家有更深入的理解。所以下面单独分析一下这几个类的逻辑，首先是<code class="java">
ReflectorFactory</code>。ReflectorFactory 是一个接口，MyBatis 中目前只有一个实现类<code class="java">
DefaultReflectorFactory</code>，它的分析如下：</p>
<h5 id="2-3-2-1-DefaultReflectorFactory-源码分析"><a href="#2-3-2-1-DefaultReflectorFactory-源码分析" class="headerlink" title="2.3.2.1 DefaultReflectorFactory 源码分析"></a>2.3.2.1 DefaultReflectorFactory 源码分析</h5><p>DefaultReflectorFactory 用于创建 Reflector，同时兼有缓存的功能，它的源码如下。</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public class DefaultReflectorFactory implements ReflectorFactory {     private boolean classCacheEnabled = true;    /** 目标类和反射器映射缓存 */    private final ConcurrentMapClass?, Reflector reflectorMap = new ConcurrentHashMapClass?, Reflector();     // 省略部分代码     @Override    public Reflector findForClass(Class? type) {        // classCacheEnabled 默认为 true        if (classCacheEnabled) {            // 从缓存中获取 Reflector 对象            Reflector cached = reflectorMap.get(type);            // 缓存为空，则创建一个新的 Reflector 实例，并放入缓存中            if (cached == null) {                cached = new Reflector(type);                // 将 type, cached 映射缓存到 map 中，方便下次取用                reflectorMap.put(type, cached);            }            return cached;        } else {            // 创建一个新的 Reflector 实例            return new Reflector(type);        }    }}</pre></td>

<p>public class DefaultReflectorFactory implements ReflectorFactory {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">private</span> <span class="token keyword">boolean</span> classCacheEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/** 目标类和反射器映射缓存 */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> ConcurrentMapClass<span class="token operator">?</span><span class="token punctuation">,</span> Reflector reflectorMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMapClass</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token function">Reflector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 省略部分代码</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> Reflector <span class="token function">findForClass</span><span class="token punctuation">(</span>Class<span class="token operator">?</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// classCacheEnabled 默认为 true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>classCacheEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 从缓存中获取 Reflector 对象</span>
        Reflector cached <span class="token operator">=</span> reflectorMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 缓存为空，则创建一个新的 Reflector 实例，并放入缓存中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cached <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Reflector</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将 type, cached 映射缓存到 map 中，方便下次取用</span>
            reflectorMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> cached<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cached<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 创建一个新的 Reflector 实例</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Reflector</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>如上，DefaultReflectorFactory 的<code class="java">
findForClass</code>方法逻辑不是很复杂，包含两个访存操作，和一个对象创建操作。代码注释的比较清楚了，就不多说了。接下来，来分析一下反射器 Reflector。</p>
<h5 id="2-3-2-2-Reflector-源码分析"><a href="#2-3-2-2-Reflector-源码分析" class="headerlink" title="2.3.2.2 Reflector 源码分析"></a>2.3.2.2 Reflector 源码分析</h5><p>本小节，我们来看一下 Reflector 的源码。Reflector 这个类的用途主要是是通过反射获取目标类的 getter 方法及其返回值类型，setter 方法及其参数值类型等元信息。并将获取到的元信息缓存到相应的集合中，供后续使用。Reflector 本身代码比较多，这里不能一一分析。本小节，我将会分析三部分逻辑，分别如下：</p>
<ol>
<li>Reflector 构造方法及成员变量分析</li>
<li>getter 方法解析过程</li>
<li>setter 方法解析过程</li>
</ol>
<p>下面我们按照这个步骤进行分析，先来分析 Reflector 构造方法。</p>
<p><strong>● Reflector 构造方法及成员变量分析</strong></p>
<p>Reflector 构造方法中包含了很多初始化逻辑，目标类的元信息解析过程也是在构造方法中完成的，这些元信息最终会被保存到 Reflector 的成员变量中。下面我们先来看看 Reflector 的构造方法和相关的成员变量定义，代码如下：</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738394041424344</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public class Reflector {     private final Class? type;    private final String[] readablePropertyNames;    private final String[] writeablePropertyNames;    private final MapString, Invoker setMethods = new HashMapString, Invoker();    private final MapString, Invoker getMethods = new HashMapString, Invoker();    private final MapString, Class? setTypes = new HashMapString, Class?();    private final MapString, Class? getTypes = new HashMapString, Class?();    private Constructor? defaultConstructor;     private MapString, String caseInsensitivePropertyMap = new HashMapString, String();     public Reflector(Class? clazz) {        type = clazz;        // 解析目标类的默认构造方法，并赋值给 defaultConstructor 变量        addDefaultConstructor(clazz);         // 解析 getter 方法，并将解析结果放入 getMethods 中        addGetMethods(clazz);         // 解析 setter 方法，并将解析结果放入 setMethods 中        addSetMethods(clazz);         // 解析属性字段，并将解析结果添加到 setMethods 或 getMethods 中        addFields(clazz);         // 从 getMethods 映射中获取可读属性名数组        readablePropertyNames = getMethods.keySet().toArray(new String[getMethods.keySet().size()]);         // 从 setMethods 映射中获取可写属性名数组        writeablePropertyNames = setMethods.keySet().toArray(new String[setMethods.keySet().size()]);         // 将所有属性名的大写形式作为键，属性名作为值，存入到 caseInsensitivePropertyMap 中        for (String propName : readablePropertyNames) {            caseInsensitivePropertyMap.put(propName.toUpperCase(Locale.ENGLISH), propName);        }        for (String propName : writeablePropertyNames) {            caseInsensitivePropertyMap.put(propName.toUpperCase(Locale.ENGLISH), propName);        }    }     // 省略其他方法}</pre></td>

<p>public class Reflector {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">private</span> <span class="token keyword">final</span> Class<span class="token operator">?</span> type<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> readablePropertyNames<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> writeablePropertyNames<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> MapString<span class="token punctuation">,</span> Invoker setMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMapString</span><span class="token punctuation">,</span> <span class="token function">Invoker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> MapString<span class="token punctuation">,</span> Invoker getMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMapString</span><span class="token punctuation">,</span> <span class="token function">Invoker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> MapString<span class="token punctuation">,</span> Class<span class="token operator">?</span> setTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMapString</span><span class="token punctuation">,</span> Class<span class="token operator">?</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> MapString<span class="token punctuation">,</span> Class<span class="token operator">?</span> getTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMapString</span><span class="token punctuation">,</span> Class<span class="token operator">?</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> Constructor<span class="token operator">?</span> defaultConstructor<span class="token punctuation">;</span>

<span class="token keyword">private</span> MapString<span class="token punctuation">,</span> String caseInsensitivePropertyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMapString</span><span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token function">Reflector</span><span class="token punctuation">(</span>Class<span class="token operator">?</span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    type <span class="token operator">=</span> clazz<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 解析目标类的默认构造方法，并赋值给 defaultConstructor 变量</span>
    <span class="token function">addDefaultConstructor</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 getter 方法，并将解析结果放入 getMethods 中</span>
    <span class="token function">addGetMethods</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 setter 方法，并将解析结果放入 setMethods 中</span>
    <span class="token function">addSetMethods</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析属性字段，并将解析结果添加到 setMethods 或 getMethods 中</span>
    <span class="token function">addFields</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 从 getMethods 映射中获取可读属性名数组</span>
    readablePropertyNames <span class="token operator">=</span> getMethods<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>getMethods<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 从 setMethods 映射中获取可写属性名数组</span>
    writeablePropertyNames <span class="token operator">=</span> setMethods<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>setMethods<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 将所有属性名的大写形式作为键，属性名作为值，存入到 caseInsensitivePropertyMap 中</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>String propName <span class="token operator">:</span> readablePropertyNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        caseInsensitivePropertyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>propName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">,</span> propName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>String propName <span class="token operator">:</span> writeablePropertyNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        caseInsensitivePropertyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>propName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">,</span> propName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 省略其他方法</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>如上，Reflector 的构造方法看起来略为复杂，不过好在一些比较复杂的逻辑都封装在了相应的方法中，这样整体的逻辑就比较清晰了。Reflector 构造方法所做的事情均已进行了注释，大家对照着注释先看一下。相关方法的细节待会会进行分析。看完构造方法，下面我来通过表格的形式，列举一下 Reflector 部分成员变量的用途。如下：</p>
<tr class="header"><th style="width: 160px;">变量名</th><th style="width: 140px;">类型</th>|用途</tr>|------

<p>上面列举了一些集合变量，这些变量用于缓存各种原信息。关于这些变量，这里描述的不太好懂，主要是不太好解释。要想了解这些变量更多的细节，还是要深入到源码中。所以我们成热打铁，继续往下分析。</p>
<p><strong>● getter 方法解析过程</strong></p>
<p>getter 方法解析的逻辑被封装在了<code class="java">
addGetMethods</code>方法中，这个方法除了会解析形如<code class="java">
getXXX</code>的方法，同时也会解析<code class="java">
isXXX</code>方法。该方法的源码分析如下：</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void addGetMethods(Class? cls) {    MapString, ListMethod conflictingGetters = new HashMapString, ListMethod();    // 获取当前类，接口，以及父类中的方法。该方法逻辑不是很复杂，这里就不展开了    Method[] methods = getClassMethods(cls);    for (Method method : methods) {        // getter 方法不应该有参数，若存在参数，则忽略当前方法        if (method.getParameterTypes().length  0) {            continue;        }        String name = method.getName();        // 过滤出以 get 或 is 开头的方法        if ((name.startsWith("get") && name.length()  3)            || (name.startsWith("is") && name.length()  2)) {            // 将 getXXX 或 isXXX 等方法名转成相应的属性，比如 getName - name            name = PropertyNamer.methodToProperty(name);            /*             * 将冲突的方法添加到 conflictingGetters 中。考虑这样一种情况：             *              * getTitle 和 isTitle 两个方法经过 methodToProperty 处理，             * 均得到 name = title，这会导致冲突。             *             * 对于冲突的方法，这里先统一起存起来，后续再解决冲突             */            addMethodConflict(conflictingGetters, name, method);        }    }     // 解决 getter 冲突    resolveGetterConflicts(conflictingGetters);}</pre></td>

<p>private void addGetMethods(Class? cls) {<br>    MapString, ListMethod conflictingGetters &#x3D; new HashMapString, ListMethod();<br>    &#x2F;&#x2F; 获取当前类，接口，以及父类中的方法。该方法逻辑不是很复杂，这里就不展开了<br>    Method[] methods &#x3D; getClassMethods(cls);<br>    for (Method method : methods) {<br>        &#x2F;&#x2F; getter 方法不应该有参数，若存在参数，则忽略当前方法<br>        if (method.getParameterTypes().length  0) {<br>            continue;<br>        }<br>        String name &#x3D; method.getName();<br>        &#x2F;&#x2F; 过滤出以 get 或 is 开头的方法<br>        if ((name.startsWith(“get”) &amp;&amp; name.length()  3)<br>            || (name.startsWith(“is”) &amp;&amp; name.length()  2)) {<br>            &#x2F;&#x2F; 将 getXXX 或 isXXX 等方法名转成相应的属性，比如 getName - name<br>            name &#x3D; PropertyNamer.methodToProperty(name);<br>            &#x2F;*<br>             * 将冲突的方法添加到 conflictingGetters 中。考虑这样一种情况：<br>             *<br>             * getTitle 和 isTitle 两个方法经过 methodToProperty 处理，<br>             * 均得到 name &#x3D; title，这会导致冲突。<br>             *<br>             * 对于冲突的方法，这里先统一起存起来，后续再解决冲突<br>             *&#x2F;<br>            addMethodConflict(conflictingGetters, name, method);<br>        }<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 解决 getter 冲突</span>
<span class="token function">resolveGetterConflicts</span><span class="token punctuation">(</span>conflictingGetters<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>如上，addGetMethods 方法的执行流程如下：</p>
<ol>
<li>获取当前类，接口，以及父类中的方法</li>
<li>遍历上一步获取的方法数组，并过滤出以<code class="java">
get</code>和<code class="java">
is</code>开头的方法</li>
<li>将方法名转换成相应的属性名</li>
<li>将属性名和方法对象添加到冲突集合中</li>
<li>解决冲突</li>
</ol>
<p>在上面的执行流程中，前三步比较简单，大家自行分析吧。第4步也不复杂，下面我会把源码贴出来，大家看一下就能懂。在这几步中，第5步逻辑比较复杂，这一步逻辑我们重点关注一下。下面继续看源码吧。</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">/** 添加属性名和方法对象到冲突集合中 */private void addMethodConflict(MapString, ListMethod conflictingMethods, String name, Method method) {    ListMethod list = conflictingMethods.get(name);    if (list == null) {        list = new ArrayListMethod();        conflictingMethods.put(name, list);    }    list.add(method);} /** 解决冲突 */private void resolveGetterConflicts(MapString, ListMethod conflictingGetters) {    for (EntryString, ListMethod entry : conflictingGetters.entrySet()) {        Method winner = null;        String propName = entry.getKey();        for (Method candidate : entry.getValue()) {            if (winner == null) {                winner = candidate;                continue;            }            // 获取返回值类型            Class? winnerType = winner.getReturnType();            Class? candidateType = candidate.getReturnType();             /*              * 两个方法的返回值类型一致，若两个方法返回值类型均为 boolean，则选取 isXXX 方法             * 为 winner。否则无法决定哪个方法更为合适，只能抛出异常             */            if (candidateType.equals(winnerType)) {                if (!boolean.class.equals(candidateType)) {                    throw new ReflectionException(                        "Illegal overloaded getter method with ambiguous type for property "                            + propName + " in class " + winner.getDeclaringClass()                            + ". This breaks the JavaBeans specification and can cause unpredictable results.");                 /*                 * 如果方法返回值类型为 boolean，且方法名以 "is" 开头，                 * 则认为候选方法 candidate 更为合适                 */                } else if (candidate.getName().startsWith("is")) {                    winner = candidate;                }             /*             * winnerType 是 candidateType 的子类，类型上更为具体，             * 则认为当前的 winner 仍是合适的，无需做什么事情             */            } else if (candidateType.isAssignableFrom(winnerType)) {             /*             * candidateType 是 winnerType 的子类，此时认为 candidate 方法更为合适，             * 故将 winner 更新为 candidate             */            } else if (winnerType.isAssignableFrom(candidateType)) {                winner = candidate;            } else {                throw new ReflectionException(                    "Illegal overloaded getter method with ambiguous type for property "                        + propName + " in class " + winner.getDeclaringClass()                        + ". This breaks the JavaBeans specification and can cause unpredictable results.");            }        }         // 将筛选出的方法添加到 getMethods 中，并将方法返回值添加到 getTypes 中        addGetMethod(propName, winner);    }} private void addGetMethod(String name, Method method) {    if (isValidPropertyName(name)) {        getMethods.put(name, new MethodInvoker(method));        // 解析返回值类型        Type returnType = TypeParameterResolver.resolveReturnType(method, type);        // 将返回值类型由 Type 转为 Class，并将转换后的结果缓存到 setTypes 中        getTypes.put(name, typeToClass(returnType));    }}</pre></td>

<p>&#x2F;** 添加属性名和方法对象到冲突集合中 *&#x2F;<br>private void addMethodConflict(MapString, ListMethod conflictingMethods, String name, Method method) {<br>    ListMethod list &#x3D; conflictingMethods.get(name);<br>    if (list &#x3D;&#x3D; null) {<br>        list &#x3D; new ArrayListMethod();<br>        conflictingMethods.put(name, list);<br>    }<br>    list.add(method);<br>}</p>
<p>&#x2F;** 解决冲突 *&#x2F;<br>private void resolveGetterConflicts(MapString, ListMethod conflictingGetters) {<br>    for (EntryString, ListMethod entry : conflictingGetters.entrySet()) {<br>        Method winner &#x3D; null;<br>        String propName &#x3D; entry.getKey();<br>        for (Method candidate : entry.getValue()) {<br>            if (winner &#x3D;&#x3D; null) {<br>                winner &#x3D; candidate;<br>                continue;<br>            }<br>            &#x2F;&#x2F; 获取返回值类型<br>            Class? winnerType &#x3D; winner.getReturnType();<br>            Class? candidateType &#x3D; candidate.getReturnType();</p>
<pre class="line-numbers language-java"><code class="language-java">
        <span class="token comment" spellcheck="true">/* 
         * 两个方法的返回值类型一致，若两个方法返回值类型均为 boolean，则选取 isXXX 方法
         * 为 winner。否则无法决定哪个方法更为合适，只能抛出异常
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>winnerType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>candidateType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionException</span><span class="token punctuation">(</span>
                    <span class="token string">"Illegal overloaded getter method with ambiguous type for property "</span>
                        <span class="token operator">+</span> propName <span class="token operator">+</span> <span class="token string">" in class "</span> <span class="token operator">+</span> winner<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">+</span> <span class="token string">". This breaks the JavaBeans specification and can cause unpredictable results."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/*
             * 如果方法返回值类型为 boolean，且方法名以 "is" 开头，
             * 则认为候选方法 candidate 更为合适
             */</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"is"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                winner <span class="token operator">=</span> candidate<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/*
         * winnerType 是 candidateType 的子类，类型上更为具体，
         * 则认为当前的 winner 仍是合适的，无需做什么事情
         */</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateType<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>winnerType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">/*
         * candidateType 是 winnerType 的子类，此时认为 candidate 方法更为合适，
         * 故将 winner 更新为 candidate
         */</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>winnerType<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>candidateType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            winner <span class="token operator">=</span> candidate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionException</span><span class="token punctuation">(</span>
                <span class="token string">"Illegal overloaded getter method with ambiguous type for property "</span>
                    <span class="token operator">+</span> propName <span class="token operator">+</span> <span class="token string">" in class "</span> <span class="token operator">+</span> winner<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">". This breaks the JavaBeans specification and can cause unpredictable results."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 将筛选出的方法添加到 getMethods 中，并将方法返回值添加到 getTypes 中</span>
    <span class="token function">addGetMethod</span><span class="token punctuation">(</span>propName<span class="token punctuation">,</span> winner<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>private void addGetMethod(String name, Method method) {<br>    if (isValidPropertyName(name)) {<br>        getMethods.put(name, new MethodInvoker(method));<br>        &#x2F;&#x2F; 解析返回值类型<br>        Type returnType &#x3D; TypeParameterResolver.resolveReturnType(method, type);<br>        &#x2F;&#x2F; 将返回值类型由 Type 转为 Class，并将转换后的结果缓存到 setTypes 中<br>        getTypes.put(name, typeToClass(returnType));<br>    }<br>}</p>
<p>以上就是解除冲突的过程，代码有点长，不太容易看懂。这里大家只要记住解决冲突的规则即可理解上面代码的逻辑。相关规则如下：</p>
<ol>
<li>冲突方法的返回值类型具有继承关系，子类返回值对应的方法被认为是更合适的选择</li>
<li>冲突方法的返回值类型相同，如果返回值类型为<code class="java">
boolean</code>，那么以<code class="java">
is</code>开头的方法则是更合适的方法</li>
<li>冲突方法的返回值类型相同，但返回值类型非<code class="java">
boolean</code>，此时出现歧义，抛出异常</li>
<li>冲突方法的返回值类型不相关，无法确定哪个是更好的选择，此时直接抛异常</li>
</ol>
<p>分析完 getter 方法的解析过程，下面继续分析 setter 方法的解析过程。</p>
<p><strong>● setter 方法解析过程</strong></p>
<p>与 getter 方法解析过程相比，setter 方法的解析过程与此有一定的区别。主要体现在冲突出现的原因，以及冲突的解决方法上。那下面，我们深入源码来找出两者之间的区别。</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void addSetMethods(Class? cls) {    MapString, ListMethod conflictingSetters = new HashMapString, ListMethod();    // 获取当前类，接口，以及父类中的方法。该方法逻辑不是很复杂，这里就不展开了    Method[] methods = getClassMethods(cls);    for (Method method : methods) {        String name = method.getName();        // 过滤出 setter 方法，且方法仅有一个参数        if (name.startsWith("set") && name.length()  3) {            if (method.getParameterTypes().length == 1) {                name = PropertyNamer.methodToProperty(name);                /*                 * setter 方法发生冲突原因是：可能存在重载情况，比如：                 *     void setSex(int sex);                 *     void setSex(SexEnum sex);                 */                addMethodConflict(conflictingSetters, name, method);            }        }    }    // 解决 setter 冲突    resolveSetterConflicts(conflictingSetters);}</pre></td>

<p>private void addSetMethods(Class? cls) {<br>    MapString, ListMethod conflictingSetters &#x3D; new HashMapString, ListMethod();<br>    &#x2F;&#x2F; 获取当前类，接口，以及父类中的方法。该方法逻辑不是很复杂，这里就不展开了<br>    Method[] methods &#x3D; getClassMethods(cls);<br>    for (Method method : methods) {<br>        String name &#x3D; method.getName();<br>        &#x2F;&#x2F; 过滤出 setter 方法，且方法仅有一个参数<br>        if (name.startsWith(“set”) &amp;&amp; name.length()  3) {<br>            if (method.getParameterTypes().length &#x3D;&#x3D; 1) {<br>                name &#x3D; PropertyNamer.methodToProperty(name);<br>                &#x2F;*<br>                 * setter 方法发生冲突原因是：可能存在重载情况，比如：<br>                 *     void setSex(int sex);<br>                 *     void setSex(SexEnum sex);<br>                 *&#x2F;<br>                addMethodConflict(conflictingSetters, name, method);<br>            }<br>        }<br>    }<br>    &#x2F;&#x2F; 解决 setter 冲突<br>    resolveSetterConflicts(conflictingSetters);<br>}</p>
<p>从上面的代码和注释中，我们可知道 setter 方法之间出现冲突的原因。即方法存在重载，方法重载导致<code class="java">
methodToProperty</code>方法解析出的属性名完全一致。而 getter 方法之间出现冲突的原因是<code class="java">
getXXX</code>和<code class="java">
isXXX</code>对应的属性名一致。既然冲突发生了，要进行调停，那接下来继续来看看调停冲突的逻辑。</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void resolveSetterConflicts(MapString, ListMethod conflictingSetters) {    for (String propName : conflictingSetters.keySet()) {        ListMethod setters = conflictingSetters.get(propName);        /*         * 获取 getter 方法的返回值类型，由于 getter 方法不存在重载的情况，         * 所以可以用它的返回值类型反推哪个 setter 的更为合适         */        Class? getterType = getTypes.get(propName);        Method match = null;        ReflectionException exception = null;        for (Method setter : setters) {            // 获取参数类型            Class? paramType = setter.getParameterTypes()[0];            if (paramType.equals(getterType)) {                // 参数类型和返回类型一致，则认为是最好的选择，并结束循环                match = setter;                break;            }            if (exception == null) {                try {                    // 选择一个更为合适的方法                    match = pickBetterSetter(match, setter, propName);                } catch (ReflectionException e) {                    match = null;                    exception = e;                }            }        }        // 若 match 为空，表示没找到更为合适的方法，此时抛出异常        if (match == null) {            throw exception;        } else {            // 将筛选出的方法放入 setMethods 中，并将方法参数值添加到 setTypes 中            addSetMethod(propName, match);        }    }} /** 从两个 setter 方法中选择一个更为合适方法 */private Method pickBetterSetter(Method setter1, Method setter2, String property) {    if (setter1 == null) {        return setter2;    }    Class? paramType1 = setter1.getParameterTypes()[0];    Class? paramType2 = setter2.getParameterTypes()[0];     // 如果参数2可赋值给参数1，即参数2是参数1的子类，则认为参数2对应的 setter 方法更为合适    if (paramType1.isAssignableFrom(paramType2)) {        return setter2;     // 这里和上面情况相反    } else if (paramType2.isAssignableFrom(paramType1)) {        return setter1;    }     // 两种参数类型不相关，这里抛出异常    throw new ReflectionException("Ambiguous setters defined for property '" + property + "' in class '"        + setter2.getDeclaringClass() + "' with types '" + paramType1.getName() + "' and '"        + paramType2.getName() + "'.");} private void addSetMethod(String name, Method method) {    if (isValidPropertyName(name)) {        setMethods.put(name, new MethodInvoker(method));        // 解析参数类型列表        Type[] paramTypes = TypeParameterResolver.resolveParamTypes(method, type);        // 将参数类型由 Type 转为 Class，并将转换后的结果缓存到 setTypes        setTypes.put(name, typeToClass(paramTypes[0]));    }}</pre></td>

<p>private void resolveSetterConflicts(MapString, ListMethod conflictingSetters) {<br>    for (String propName : conflictingSetters.keySet()) {<br>        ListMethod setters &#x3D; conflictingSetters.get(propName);<br>        &#x2F;*<br>         * 获取 getter 方法的返回值类型，由于 getter 方法不存在重载的情况，<br>         * 所以可以用它的返回值类型反推哪个 setter 的更为合适<br>         *&#x2F;<br>        Class? getterType &#x3D; getTypes.get(propName);<br>        Method match &#x3D; null;<br>        ReflectionException exception &#x3D; null;<br>        for (Method setter : setters) {<br>            &#x2F;&#x2F; 获取参数类型<br>            Class? paramType &#x3D; setter.getParameterTypes()[0];<br>            if (paramType.equals(getterType)) {<br>                &#x2F;&#x2F; 参数类型和返回类型一致，则认为是最好的选择，并结束循环<br>                match &#x3D; setter;<br>                break;<br>            }<br>            if (exception &#x3D;&#x3D; null) {<br>                try {<br>                    &#x2F;&#x2F; 选择一个更为合适的方法<br>                    match &#x3D; pickBetterSetter(match, setter, propName);<br>                } catch (ReflectionException e) {<br>                    match &#x3D; null;<br>                    exception &#x3D; e;<br>                }<br>            }<br>        }<br>        &#x2F;&#x2F; 若 match 为空，表示没找到更为合适的方法，此时抛出异常<br>        if (match &#x3D;&#x3D; null) {<br>            throw exception;<br>        } else {<br>            &#x2F;&#x2F; 将筛选出的方法放入 setMethods 中，并将方法参数值添加到 setTypes 中<br>            addSetMethod(propName, match);<br>        }<br>    }<br>}</p>
<p>&#x2F;** 从两个 setter 方法中选择一个更为合适方法 *&#x2F;<br>private Method pickBetterSetter(Method setter1, Method setter2, String property) {<br>    if (setter1 &#x3D;&#x3D; null) {<br>        return setter2;<br>    }<br>    Class? paramType1 &#x3D; setter1.getParameterTypes()[0];<br>    Class? paramType2 &#x3D; setter2.getParameterTypes()[0];</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 如果参数2可赋值给参数1，即参数2是参数1的子类，则认为参数2对应的 setter 方法更为合适</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>paramType1<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>paramType2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> setter2<span class="token punctuation">;</span>
    
<span class="token comment" spellcheck="true">// 这里和上面情况相反</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>paramType2<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>paramType1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> setter1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 两种参数类型不相关，这里抛出异常</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionException</span><span class="token punctuation">(</span><span class="token string">"Ambiguous setters defined for property '"</span> <span class="token operator">+</span> property <span class="token operator">+</span> <span class="token string">"' in class '"</span>
    <span class="token operator">+</span> setter2<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"' with types '"</span> <span class="token operator">+</span> paramType1<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"' and '"</span>
    <span class="token operator">+</span> paramType2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>private void addSetMethod(String name, Method method) {<br>    if (isValidPropertyName(name)) {<br>        setMethods.put(name, new MethodInvoker(method));<br>        &#x2F;&#x2F; 解析参数类型列表<br>        Type[] paramTypes &#x3D; TypeParameterResolver.resolveParamTypes(method, type);<br>        &#x2F;&#x2F; 将参数类型由 Type 转为 Class，并将转换后的结果缓存到 setTypes<br>        setTypes.put(name, typeToClass(paramTypes[0]));<br>    }<br>}</p>
<p>关于 setter 方法冲突的解析规则，这里也总结一下吧。如下：</p>
<ol>
<li>冲突方法的参数类型与 getter 的返回类型一致，则认为是最好的选择</li>
<li>冲突方法的参数类型具有继承关系，子类参数对应的方法被认为是更合适的选择</li>
<li>冲突方法的参数类型不相关，无法确定哪个是更好的选择，此时直接抛异常</li>
</ol>
<p>到此关于 setter 方法的解析过程就说完了。我在前面说过 MetaClass 的<code class="java">
hasSetter</code>最终调用了 Refactor 的<code class="java">
hasSetter</code>方法，那么现在是时候分析 Refactor 的<code class="java">
hasSetter</code>方法了。代码如下如下：</p>
<td class="line_numbers"><pre>123</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public boolean hasSetter(String propertyName) {    return setMethods.keySet().contains(propertyName);}</pre></td>

<p>public boolean hasSetter(String propertyName) {<br>    return setMethods.keySet().contains(propertyName);<br>}</p>
<p>代码如上，就两行，很简单，就不多说了。</p>
<h5 id="2-3-2-3-PropertyTokenizer-源码分析"><a href="#2-3-2-3-PropertyTokenizer-源码分析" class="headerlink" title="2.3.2.3 PropertyTokenizer 源码分析"></a>2.3.2.3 PropertyTokenizer 源码分析</h5><p>对于较为复杂的属性，需要进行进一步解析才能使用。那什么样的属性是复杂属性呢？来看个测试代码就知道了。</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public class MetaClassTest {     private class Author {        private Integer id;        private String name;        private Integer age;        /** 一个作者对应多篇文章 */        private Article[] articles;         // 省略 getter/setter    }     private class Article {        private Integer id;        private String title;        private String content;        /** 一篇文章对应一个作者 */        private Author author;         // 省略 getter/setter    }     @Test    public void testHasSetter() {        // 为 Author 创建元信息对象        MetaClass authorMeta = MetaClass.forClass(Author.class, new DefaultReflectorFactory());        System.out.println("------------☆ Author ☆------------");        System.out.println("id - " + authorMeta.hasSetter("id"));        System.out.println("name - " + authorMeta.hasSetter("name"));        System.out.println("age - " + authorMeta.hasSetter("age"));        // 检测 Author 中是否包含 Article[] 的 setter        System.out.println("articles - " + authorMeta.hasSetter("articles"));        System.out.println("articles[] - " + authorMeta.hasSetter("articles[]"));        System.out.println("title - " + authorMeta.hasSetter("title"));         // 为 Article 创建元信息对象        MetaClass articleMeta = MetaClass.forClass(Article.class, new DefaultReflectorFactory());        System.out.println("\n------------☆ Article ☆------------");        System.out.println("id - " + articleMeta.hasSetter("id"));        System.out.println("title - " + articleMeta.hasSetter("title"));        System.out.println("content - " + articleMeta.hasSetter("content"));        // 下面两个均为复杂属性，分别检测 Article 类中的 Author 类是否包含 id 和 name 的 setter 方法        System.out.println("author.id - " + articleMeta.hasSetter("author.id"));        System.out.println("author.name - " + articleMeta.hasSetter("author.name"));    }}</pre></td>

<p>public class MetaClassTest {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Author</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> Integer id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> Integer age<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/** 一个作者对应多篇文章 */</span>
    <span class="token keyword">private</span> Article<span class="token punctuation">[</span><span class="token punctuation">]</span> articles<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 省略 getter/setter</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Article</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> Integer id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String title<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String content<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/** 一篇文章对应一个作者 */</span>
    <span class="token keyword">private</span> Author author<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 省略 getter/setter</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testHasSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 为 Author 创建元信息对象</span>
    MetaClass authorMeta <span class="token operator">=</span> MetaClass<span class="token punctuation">.</span><span class="token function">forClass</span><span class="token punctuation">(</span>Author<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultReflectorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------------☆ Author ☆------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"id - "</span> <span class="token operator">+</span> authorMeta<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"name - "</span> <span class="token operator">+</span> authorMeta<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"age - "</span> <span class="token operator">+</span> authorMeta<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 检测 Author 中是否包含 Article[] 的 setter</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"articles - "</span> <span class="token operator">+</span> authorMeta<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">"articles"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"articles[] - "</span> <span class="token operator">+</span> authorMeta<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">"articles[]"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"title - "</span> <span class="token operator">+</span> authorMeta<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 为 Article 创建元信息对象</span>
    MetaClass articleMeta <span class="token operator">=</span> MetaClass<span class="token punctuation">.</span><span class="token function">forClass</span><span class="token punctuation">(</span>Article<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultReflectorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n------------☆ Article ☆------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"id - "</span> <span class="token operator">+</span> articleMeta<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"title - "</span> <span class="token operator">+</span> articleMeta<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content - "</span> <span class="token operator">+</span> articleMeta<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 下面两个均为复杂属性，分别检测 Article 类中的 Author 类是否包含 id 和 name 的 setter 方法</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"author.id - "</span> <span class="token operator">+</span> articleMeta<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">"author.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"author.name - "</span> <span class="token operator">+</span> articleMeta<span class="token punctuation">.</span><span class="token function">hasSetter</span><span class="token punctuation">(</span><span class="token string">"author.name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>如上，<code class="java">
Article</code>类中包含了一个<code class="java">
Author</code>引用。然后我们调用 articleMeta 的 hasSetter 检测<code class="java">
author.id</code>和<code class="java">
author.name</code>属性是否存在，我们的期望结果为 true。测试结果如下：</p>
<img class=" aligncenter" title="MyBatis 源码分析 - 配置文件解析过程" src="https://www.javazhiyin.com/wp-content/uploads/2018/07/6-1532920601.jpeg" src="https://www.javazhiyin.com/wp-content/themes/mnews/images/post-loading.gif" alt="MyBatis 源码分析 - 配置文件解析过程">

<p>如上，标记⑤处的输出均为 true，我们的预期达到了。标记②处检测 Article 数组的是否存在 setter 方法，结果也均为 true。这说明 PropertyTokenizer 对数组和复合属性均进行了处理。那它是如何处理的呢？答案如下：</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public class PropertyTokenizer implements IteratorPropertyTokenizer {     private String name;    private final String indexedName;    private String index;    private final String children;     public PropertyTokenizer(String fullname) {        // 检测传入的参数中是否包含字符 '.'        int delim = fullname.indexOf('.');        if (delim  -1) {            /*             * 以点位为界，进行分割。比如：             *    fullname = www.coolblog.xyz             *             * 以第一个点为分界符：             *    name = www             *    children = coolblog.xyz             */             name = fullname.substring(0, delim);            children = fullname.substring(delim + 1);        } else {            // fullname 中不存在字符 '.'            name = fullname;            children = null;        }        indexedName = name;        // 检测传入的参数中是否包含字符 '['        delim = name.indexOf('[');        if (delim  -1) {            /*             * 获取中括号里的内容，比如：             *   1. 对于数组或List集合：[] 中的内容为数组下标，             *      比如 fullname = articles[1]，index = 1             *   2. 对于Map：[] 中的内容为键，             *      比如 fullname = xxxMap[keyName]，index = keyName             *             * 关于 index 属性的用法，可以参考 BaseWrapper 的 getCollectionValue 方法             */            index = name.substring(delim + 1, name.length() - 1);             // 获取分解符前面的内容，比如 fullname = articles[1]，name = articles            name = name.substring(0, delim);        }    }     // 省略 getter     @Override    public boolean hasNext() {        return children != null;    }     @Override    public PropertyTokenizer next() {        // 对 children 进行再次切分，用于解析多重复合属性        return new PropertyTokenizer(children);    }     // 省略部分方法}</pre></td>

<p>public class PropertyTokenizer implements IteratorPropertyTokenizer {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">private</span> String name<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String indexedName<span class="token punctuation">;</span>
<span class="token keyword">private</span> String index<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String children<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token function">PropertyTokenizer</span><span class="token punctuation">(</span>String fullname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 检测传入的参数中是否包含字符 '.'</span>
    <span class="token keyword">int</span> delim <span class="token operator">=</span> fullname<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>delim  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * 以点位为界，进行分割。比如：
         *    fullname = www.coolblog.xyz
         *
         * 以第一个点为分界符：
         *    name = www
         *    children = coolblog.xyz
         */</span> 
        name <span class="token operator">=</span> fullname<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> delim<span class="token punctuation">)</span><span class="token punctuation">;</span>
        children <span class="token operator">=</span> fullname<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>delim <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// fullname 中不存在字符 '.'</span>
        name <span class="token operator">=</span> fullname<span class="token punctuation">;</span>
        children <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    indexedName <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 检测传入的参数中是否包含字符 '['</span>
    delim <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'['</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>delim  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * 获取中括号里的内容，比如：
         *   1. 对于数组或List集合：[] 中的内容为数组下标，
         *      比如 fullname = articles[1]，index = 1
         *   2. 对于Map：[] 中的内容为键，
         *      比如 fullname = xxxMap[keyName]，index = keyName
         *
         * 关于 index 属性的用法，可以参考 BaseWrapper 的 getCollectionValue 方法
         */</span>
        index <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>delim <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 获取分解符前面的内容，比如 fullname = articles[1]，name = articles</span>
        name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> delim<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 省略 getter</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> children <span class="token operator">!=</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> PropertyTokenizer <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 对 children 进行再次切分，用于解析多重复合属性</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PropertyTokenizer</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 省略部分方法</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>以上是 PropertyTokenizer 的源码分析，注释的比较多，应该分析清楚了。大家如果看懂了上面的分析，那么可以自行举例进行测试，以加深理解。</p>
<h4 id="2-3-3-小结"><a href="#2-3-3-小结" class="headerlink" title="2.3.3 小结"></a>2.3.3 小结</h4><p>本节的篇幅比较大，大家看起来应该蛮辛苦的。本节为了分析 MetaClass 的 hasSetter 方法，把这个方法涉及到的源码均分析了一遍。其实，如果想简单点分析，我可以直接把 MetaClass 当成一个黑盒，然后用一句话告诉大家 hasSetter 方法有什么用即可。但是这样做我觉的文章太虚，没什么深度。关于 MetaClass 及相关源码大家第一次看可能会有点吃力，看不懂可以先放一放。后面多看几遍，动手写点测试代码调试一下，可以帮助理解。</p>
<p>好了，关于 setting 节点的解析过程就先分析到这里，我们继续往下分析。</p>
<h3 id="2-4-设置-settings-配置到-Configuration-中"><a href="#2-4-设置-settings-配置到-Configuration-中" class="headerlink" title="2.4 设置 settings 配置到 Configuration 中"></a>2.4 设置 settings 配置到 Configuration 中</h3><p>上一节讲了 settings 配置的解析过程，这些配置解析出来要有一个存放的地方，以使其他代码可以找到这些配置。这个存放地方就是 Configuration 对象，本节就来看一下这将 settings 配置设置到 Configuration 对象中的过程。如下：</p>
<td class="line_numbers"><pre>123456789101112131415161718</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void settingsElement(Properties props) throws Exception {    // 设置 autoMappingBehavior 属性，默认值为 PARTIAL    configuration.setAutoMappingBehavior(AutoMappingBehavior.valueOf(props.getProperty("autoMappingBehavior", "PARTIAL")));    configuration.setAutoMappingUnknownColumnBehavior(AutoMappingUnknownColumnBehavior.valueOf(props.getProperty("autoMappingUnknownColumnBehavior", "NONE")));    // 设置 cacheEnabled 属性，默认值为 true    configuration.setCacheEnabled(booleanValueOf(props.getProperty("cacheEnabled"), true));     // 省略部分代码     // 解析默认的枚举处理器    Class? extends TypeHandler typeHandler = (Class? extends TypeHandler)resolveClass(props.getProperty("defaultEnumTypeHandler"));    // 设置默认枚举处理器    configuration.setDefaultEnumTypeHandler(typeHandler);    configuration.setCallSettersOnNulls(booleanValueOf(props.getProperty("callSettersOnNulls"), false));    configuration.setUseActualParamName(booleanValueOf(props.getProperty("useActualParamName"), true));     // 省略部分代码}</pre></td>

<p>private void settingsElement(Properties props) throws Exception {<br>    &#x2F;&#x2F; 设置 autoMappingBehavior 属性，默认值为 PARTIAL<br>    configuration.setAutoMappingBehavior(AutoMappingBehavior.valueOf(props.getProperty(“autoMappingBehavior”, “PARTIAL”)));<br>    configuration.setAutoMappingUnknownColumnBehavior(AutoMappingUnknownColumnBehavior.valueOf(props.getProperty(“autoMappingUnknownColumnBehavior”, “NONE”)));<br>    &#x2F;&#x2F; 设置 cacheEnabled 属性，默认值为 true<br>    configuration.setCacheEnabled(booleanValueOf(props.getProperty(“cacheEnabled”), true));</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 省略部分代码</span>

<span class="token comment" spellcheck="true">// 解析默认的枚举处理器</span>
Class<span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">TypeHandler</span> typeHandler <span class="token operator">=</span> <span class="token punctuation">(</span>Class<span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">TypeHandler</span><span class="token punctuation">)</span><span class="token function">resolveClass</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"defaultEnumTypeHandler"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 设置默认枚举处理器</span>
configuration<span class="token punctuation">.</span><span class="token function">setDefaultEnumTypeHandler</span><span class="token punctuation">(</span>typeHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
configuration<span class="token punctuation">.</span><span class="token function">setCallSettersOnNulls</span><span class="token punctuation">(</span><span class="token function">booleanValueOf</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"callSettersOnNulls"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
configuration<span class="token punctuation">.</span><span class="token function">setUseActualParamName</span><span class="token punctuation">(</span><span class="token function">booleanValueOf</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"useActualParamName"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 省略部分代码</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面代码处理调用 Configuration 的 setter 方法，就没太多逻辑了。这里来看一下上面出现的一个调用<code class="java">
resolveClass</code>，它的源码如下：</p>
<td class="line_numbers"><pre>12345678910111213141516171819</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- BaseBuilderprotected Class? resolveClass(String alias) {    if (alias == null) {        return null;    }    try {        // 通过别名解析        return resolveAlias(alias);    } catch (Exception e) {        throw new BuilderException("Error resolving class. Cause: " + e, e);    }} protected final TypeAliasRegistry typeAliasRegistry; protected Class? resolveAlias(String alias) {    // 通过别名注册器解析别名对于的类型 Class    return typeAliasRegistry.resolveAlias(alias);}</pre></td>

<p>&#x2F;&#x2F; -☆- BaseBuilder<br>protected Class? resolveClass(String alias) {<br>    if (alias &#x3D;&#x3D; null) {<br>        return null;<br>    }<br>    try {<br>        &#x2F;&#x2F; 通过别名解析<br>        return resolveAlias(alias);<br>    } catch (Exception e) {<br>        throw new BuilderException(“Error resolving class. Cause: “ + e, e);<br>    }<br>}</p>
<p>protected final TypeAliasRegistry typeAliasRegistry;</p>
<p>protected Class? resolveAlias(String alias) {<br>    &#x2F;&#x2F; 通过别名注册器解析别名对于的类型 Class<br>    return typeAliasRegistry.resolveAlias(alias);<br>}</p>
<p>这里出现了一个新的类<code class="java">
TypeAliasRegistry</code>，大家对于它可能会觉得陌生，但是对于<code class="java">
typeAlias</code>应该不会陌生。TypeAliasRegistry 的用途就是将别名和类型进行映射，这样就可以用别名表示某个类了，方便使用。既然聊到了别名，那下面我们不妨看看别名的配置的解析过程。</p>
<h3 id="2-5-解析-typeAliases-配置"><a href="#2-5-解析-typeAliases-配置" class="headerlink" title="2.5 解析 typeAliases 配置"></a>2.5 解析 typeAliases 配置</h3><p>在 MyBatis 中，可以为我们自己写的有些类定义一个别名。这样在使用的时候，我们只需要输入别名即可，无需再把全限定的类名写出来。在 MyBatis 中，我们有两种方式进行别名配置。第一种是仅配置包名，让 MyBatis 去扫描包中的类型，并根据类型得到相应的别名。这种方式可配合 Alias 注解使用，即通过注解为某个类配置别名，而不是让 MyBatis 按照默认规则生成别名。这种方式的配置如下：</p>
<td class="line_numbers"><pre>1234</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">typeAliases    package name="xyz.coolblog.model1"/    package name="xyz.coolblog.model2"//typeAliases</pre></td>

<p>typeAliases<br>    package name&#x3D;”xyz.coolblog.model1”&#x2F;<br>    package name&#x3D;”xyz.coolblog.model2”&#x2F;<br>&#x2F;typeAliases</p>
<p>第二种方式是通过手动的方式，明确为某个类型配置别名。这种方式的配置如下：</p>
<td class="line_numbers"><pre>1234</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">typeAliases    typeAlias alias="article" type="xyz.coolblog.model.Article" /    typeAlias type="xyz.coolblog.model.Author" //typeAliases</pre></td>

<p>typeAliases<br>    typeAlias alias&#x3D;”article” type&#x3D;”xyz.coolblog.model.Article” &#x2F;<br>    typeAlias type&#x3D;”xyz.coolblog.model.Author” &#x2F;<br>&#x2F;typeAliases</p>
<p>对比这两种方式，第一种自动扫描的方式配置起来比较简单，缺点也不明显。唯一能想到缺点可能就是 MyBatis 会将某个包下所有符合要求的类的别名都解析出来，并形成映射关系。如果你不想让某些类被扫描，</p>
<p>这个好像做不到，没发现 MyBatis 提供了相关的排除机制。不过我觉得这并不是什么大问题，最多是多解析并缓存了一些别名到类型的映射，在时间和空间上产生了一些额外的消耗而已。当然，如果无法忍受这些消耗，可以使用第二种配置方式，通过手工的方式精确配置某些类型的别名。不过这种方式比较繁琐，特别是配置项比较多时。至于两种方式怎么选择，这个看具体的情况了。配置项非常少时，两种皆可。比较多的话，还是让 MyBatis 自行扫描吧。</p>
<p>以上介绍了两种不同的别名配置方式，下面我们来看一下两种不同的别名配置是怎样解析的。代码如下：</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- XMLConfigBuilderprivate void typeAliasesElement(XNode parent) {    if (parent != null) {        for (XNode child : parent.getChildren()) {            // ⭐️ 从指定的包中解析别名和类型的映射            if ("package".equals(child.getName())) {                String typeAliasPackage = child.getStringAttribute("name");                configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);             // ⭐️ 从 typeAlias 节点中解析别名和类型的映射            } else {                // 获取 alias 和 type 属性值，alias 不是必填项，可为空                String alias = child.getStringAttribute("alias");                String type = child.getStringAttribute("type");                try {                    // 加载 type 对应的类型                    Class? clazz = Resources.classForName(type);                     // 注册别名到类型的映射                    if (alias == null) {                        typeAliasRegistry.registerAlias(clazz);                    } else {                        typeAliasRegistry.registerAlias(alias, clazz);                    }                } catch (ClassNotFoundException e) {                    throw new BuilderException("Error registering typeAlias for '" + alias + "'. Cause: " + e, e);                }            }        }    }}</pre></td>

<p>&#x2F;&#x2F; -☆- XMLConfigBuilder<br>private void typeAliasesElement(XNode parent) {<br>    if (parent !&#x3D; null) {<br>        for (XNode child : parent.getChildren()) {<br>            &#x2F;&#x2F; ⭐️ 从指定的包中解析别名和类型的映射<br>            if (“package”.equals(child.getName())) {<br>                String typeAliasPackage &#x3D; child.getStringAttribute(“name”);<br>                configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);</p>
<pre class="line-numbers language-java"><code class="language-java">
        <span class="token comment" spellcheck="true">// ⭐️ 从 typeAlias 节点中解析别名和类型的映射</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取 alias 和 type 属性值，alias 不是必填项，可为空</span>
            String alias <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"alias"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String type <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 加载 type 对应的类型</span>
                Class<span class="token operator">?</span> clazz <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">classForName</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// 注册别名到类型的映射</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>alias <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    typeAliasRegistry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    typeAliasRegistry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span>alias<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Error registering typeAlias for '"</span> <span class="token operator">+</span> alias <span class="token operator">+</span> <span class="token string">"'. Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>如上，上面的代码通过一个<code class="java">
if-else</code>条件分支来处理两种不同的配置，这里我用⭐️标注了出来。下面我们来分别看一下这两种配置方式的解析过程，首先来看一下手动配置方式的解析过程。</p>
<h4 id="2-5-1-从-typeAlias-节点中解析并注册别名"><a href="#2-5-1-从-typeAlias-节点中解析并注册别名" class="headerlink" title="2.5.1 从 typeAlias 节点中解析并注册别名"></a>2.5.1 从 typeAlias 节点中解析并注册别名</h4><p>在别名的配置中，<code class="java">
type</code>属性是必须要配置的，而<code class="java">
alias</code>属性则不是必须的。这个在配置文件的 DTD 中有规定。如果使用者未配置 alias 属性，则需要 MyBatis 自行为目标类型生成别名。对于别名为空的情况，注册别名的任务交由<code class="java">
void registerAlias(Class?)</code>方法处理。若不为空，则由<code class="java">
void registerAlias(String, Class?)</code>进行别名注册。这两个方法的分析如下：</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private final MapString, Class? TYPE_ALIASES = new HashMapString, Class?(); public void registerAlias(Class? type) {    // 获取全路径类名的简称    String alias = type.getSimpleName();    Alias aliasAnnotation = type.getAnnotation(Alias.class);    if (aliasAnnotation != null) {        // 从注解中取出别名        alias = aliasAnnotation.value();    }    // 调用重载方法注册别名和类型映射    registerAlias(alias, type);} public void registerAlias(String alias, Class? value) {    if (alias == null) {        throw new TypeException("The parameter alias cannot be null");    }    // 将别名转成小写    String key = alias.toLowerCase(Locale.ENGLISH);    /*     * 如果 TYPE_ALIASES 中存在了某个类型映射，这里判断当前类型与映射中的类型是否一致，     * 不一致则抛出异常，不允许一个别名对应两种类型     */    if (TYPE_ALIASES.containsKey(key) && TYPE_ALIASES.get(key) != null && !TYPE_ALIASES.get(key).equals(value)) {        throw new TypeException(            "The alias '" + alias + "' is already mapped to the value '" + TYPE_ALIASES.get(key).getName() + "'.");    }    // 缓存别名到类型映射    TYPE_ALIASES.put(key, value);}</pre></td>

<p>private final MapString, Class? TYPE_ALIASES &#x3D; new HashMapString, Class?();</p>
<p>public void registerAlias(Class? type) {<br>    &#x2F;&#x2F; 获取全路径类名的简称<br>    String alias &#x3D; type.getSimpleName();<br>    Alias aliasAnnotation &#x3D; type.getAnnotation(Alias.class);<br>    if (aliasAnnotation !&#x3D; null) {<br>        &#x2F;&#x2F; 从注解中取出别名<br>        alias &#x3D; aliasAnnotation.value();<br>    }<br>    &#x2F;&#x2F; 调用重载方法注册别名和类型映射<br>    registerAlias(alias, type);<br>}</p>
<p>public void registerAlias(String alias, Class? value) {<br>    if (alias &#x3D;&#x3D; null) {<br>        throw new TypeException(“The parameter alias cannot be null”);<br>    }<br>    &#x2F;&#x2F; 将别名转成小写<br>    String key &#x3D; alias.toLowerCase(Locale.ENGLISH);<br>    &#x2F;*<br>     * 如果 TYPE_ALIASES 中存在了某个类型映射，这里判断当前类型与映射中的类型是否一致，<br>     * 不一致则抛出异常，不允许一个别名对应两种类型<br>     *&#x2F;<br>    if (TYPE_ALIASES.containsKey(key) &amp;&amp; TYPE_ALIASES.get(key) !&#x3D; null &amp;&amp; !TYPE_ALIASES.get(key).equals(value)) {<br>        throw new TypeException(<br>            “The alias ‘“ + alias + “‘ is already mapped to the value ‘“ + TYPE_ALIASES.get(key).getName() + “‘.”);<br>    }<br>    &#x2F;&#x2F; 缓存别名到类型映射<br>    TYPE_ALIASES.put(key, value);<br>}</p>
<p>如上，若用户为明确配置 alias 属性，MyBatis 会使用类名的小写形式作为别名。比如，全限定类名<code class="java">
xyz.coolblog.model.Author</code>的别名为<code class="java">
author</code>。若类中有<code class="java">
@Alias</code>注解，则从注解中取值作为别名。</p>
<p>上面的代码不是很复杂，注释的也比较清楚了，就不多说了。继续往下看。</p>
<h4 id="2-5-2-从指定的包中解析并注册别名"><a href="#2-5-2-从指定的包中解析并注册别名" class="headerlink" title="2.5.2 从指定的包中解析并注册别名"></a>2.5.2 从指定的包中解析并注册别名</h4><p>从指定的包中解析并注册别名过程主要由别名的解析和注册两步组成。下面来看一下相关代码：</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public void registerAliases(String packageName) {    // 调用重载方法注册别名    registerAliases(packageName, Object.class);} public void registerAliases(String packageName, Class? superType) {    ResolverUtilClass? resolverUtil = new ResolverUtilClass?();    /*     * 查找某个包下的父类为 superType 的类。从调用栈来看，这里的      * superType = Object.class，所以 ResolverUtil 将查找所有的类。     * 查找完成后，查找结果将会被缓存到内部集合中。     */     resolverUtil.find(new ResolverUtil.IsA(superType), packageName);    // 获取查找结果    SetClass? extends Class? typeSet = resolverUtil.getClasses();    for (Class? type : typeSet) {        // 忽略匿名类，接口，内部类        if (!type.isAnonymousClass() && !type.isInterface() && !type.isMemberClass()) {            // 为类型注册别名             registerAlias(type);        }    }}</pre></td>

<p>public void registerAliases(String packageName) {<br>    &#x2F;&#x2F; 调用重载方法注册别名<br>    registerAliases(packageName, Object.class);<br>}</p>
<p>public void registerAliases(String packageName, Class? superType) {<br>    ResolverUtilClass? resolverUtil &#x3D; new ResolverUtilClass?();<br>    &#x2F;*<br>     * 查找某个包下的父类为 superType 的类。从调用栈来看，这里的<br>     * superType &#x3D; Object.class，所以 ResolverUtil 将查找所有的类。<br>     * 查找完成后，查找结果将会被缓存到内部集合中。<br>     *&#x2F;<br>    resolverUtil.find(new ResolverUtil.IsA(superType), packageName);<br>    &#x2F;&#x2F; 获取查找结果<br>    SetClass? extends Class? typeSet &#x3D; resolverUtil.getClasses();<br>    for (Class? type : typeSet) {<br>        &#x2F;&#x2F; 忽略匿名类，接口，内部类<br>        if (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !type.isMemberClass()) {<br>            &#x2F;&#x2F; 为类型注册别名<br>            registerAlias(type);<br>        }<br>    }<br>}</p>
<p>上面的代码不多，相关流程也不复杂，可简单总结为下面两个步骤：</p>
<ol>
<li>查找指定包下的所有类</li>
<li>遍历查找到的类型集合，为每个类型注册别名</li>
</ol>
<p>在这两步流程中，第2步流程对应的代码上一节已经分析过了，这里不再赘述。第1步的功能理解起来不难，但是背后对应的代码有点多。限于篇幅原因，这里我不打算详细分析这一部分的代码，只做简单的流程总结。如下：</p>
<li>通过 VFS（虚拟文件系统）获取指定包下的所有文件的路径名，

<p>比如<code class="java">
xyz/coolblog/model/Article.class</code></li></p>
<ol>
<li>筛选以<code class="java">
.class</code>结尾的文件名</li>
<li>将路径名转成全限定的类名，通过类加载器加载类名</li>
<li>对类型进行匹配，若符合匹配规则，则将其放入内部集合中</li>
</ol>
<p>以上就是类型资源查找的过程，并不是很复杂，大家有兴趣自己看看吧。</p>
<h4 id="2-5-3-注册-MyBatis-内部类及常见类型的别名"><a href="#2-5-3-注册-MyBatis-内部类及常见类型的别名" class="headerlink" title="2.5.3 注册 MyBatis 内部类及常见类型的别名"></a>2.5.3 注册 MyBatis 内部类及常见类型的别名</h4><p>最后，我们来看一下一些 MyBatis 内部类及一些常见类型的别名注册过程。如下：</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- Configurationpublic Configuration() {    // 注册事务工厂的别名    typeAliasRegistry.registerAlias("JDBC", JdbcTransactionFactory.class);    // 省略部分代码，下同     // 注册数据源的别名    typeAliasRegistry.registerAlias("POOLED", PooledDataSourceFactory.class);     // 注册缓存策略的别名    typeAliasRegistry.registerAlias("FIFO", FifoCache.class);    typeAliasRegistry.registerAlias("LRU", LruCache.class);     // 注册日志类的别名    typeAliasRegistry.registerAlias("SLF4J", Slf4jImpl.class);    typeAliasRegistry.registerAlias("LOG4J", Log4jImpl.class);     // 注册动态代理工厂的别名    typeAliasRegistry.registerAlias("CGLIB", CglibProxyFactory.class);    typeAliasRegistry.registerAlias("JAVASSIST", JavassistProxyFactory.class);} // -☆- TypeAliasRegistrypublic TypeAliasRegistry() {    // 注册 String 的别名    registerAlias("string", String.class);     // 注册基本类型包装类的别名    registerAlias("byte", Byte.class);    // 省略部分代码，下同     // 注册基本类型包装类数组的别名    registerAlias("byte[]", Byte[].class);     // 注册基本类型的别名    registerAlias("_byte", byte.class);     // 注册基本类型包装类的别名    registerAlias("_byte[]", byte[].class);     // 注册 Date, BigDecimal, Object 等类型的别名    registerAlias("date", Date.class);    registerAlias("decimal", BigDecimal.class);    registerAlias("object", Object.class);     // 注册 Date, BigDecimal, Object 等数组类型的别名    registerAlias("date[]", Date[].class);    registerAlias("decimal[]", BigDecimal[].class);    registerAlias("object[]", Object[].class);     // 注册集合类型的别名    registerAlias("map", Map.class);    registerAlias("hashmap", HashMap.class);    registerAlias("list", List.class);    registerAlias("arraylist", ArrayList.class);    registerAlias("collection", Collection.class);    registerAlias("iterator", Iterator.class);     // 注册 ResultSet 的别名    registerAlias("ResultSet", ResultSet.class);}</pre></td>

<p>&#x2F;&#x2F; -☆- Configuration<br>public Configuration() {<br>    &#x2F;&#x2F; 注册事务工厂的别名<br>    typeAliasRegistry.registerAlias(“JDBC”, JdbcTransactionFactory.class);<br>    &#x2F;&#x2F; 省略部分代码，下同</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 注册数据源的别名</span>
typeAliasRegistry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"POOLED"</span><span class="token punctuation">,</span> PooledDataSourceFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注册缓存策略的别名</span>
typeAliasRegistry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"FIFO"</span><span class="token punctuation">,</span> FifoCache<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
typeAliasRegistry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"LRU"</span><span class="token punctuation">,</span> LruCache<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注册日志类的别名</span>
typeAliasRegistry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"SLF4J"</span><span class="token punctuation">,</span> Slf4jImpl<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
typeAliasRegistry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"LOG4J"</span><span class="token punctuation">,</span> Log4jImpl<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注册动态代理工厂的别名</span>
typeAliasRegistry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"CGLIB"</span><span class="token punctuation">,</span> CglibProxyFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
typeAliasRegistry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"JAVASSIST"</span><span class="token punctuation">,</span> JavassistProxyFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>&#x2F;&#x2F; -☆- TypeAliasRegistry<br>public TypeAliasRegistry() {<br>    &#x2F;&#x2F; 注册 String 的别名<br>    registerAlias(“string”, String.class);</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 注册基本类型包装类的别名</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"byte"</span><span class="token punctuation">,</span> Byte<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 省略部分代码，下同</span>

<span class="token comment" spellcheck="true">// 注册基本类型包装类数组的别名</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"byte[]"</span><span class="token punctuation">,</span> Byte<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注册基本类型的别名</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"_byte"</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注册基本类型包装类的别名</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"_byte[]"</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注册 Date, BigDecimal, Object 等类型的别名</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"date"</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"decimal"</span><span class="token punctuation">,</span> BigDecimal<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"object"</span><span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注册 Date, BigDecimal, Object 等数组类型的别名</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"date[]"</span><span class="token punctuation">,</span> Date<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"decimal[]"</span><span class="token punctuation">,</span> BigDecimal<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"object[]"</span><span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注册集合类型的别名</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"map"</span><span class="token punctuation">,</span> Map<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"hashmap"</span><span class="token punctuation">,</span> HashMap<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"list"</span><span class="token punctuation">,</span> List<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"arraylist"</span><span class="token punctuation">,</span> ArrayList<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"collection"</span><span class="token punctuation">,</span> Collection<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"iterator"</span><span class="token punctuation">,</span> Iterator<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注册 ResultSet 的别名</span>
<span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token string">"ResultSet"</span><span class="token punctuation">,</span> ResultSet<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>我记得以前配置<code class="java">
select/</code>标签的<code class="java">
resultType</code>属性，由于不知道有别名这回事，傻傻的使用全限定类名进行配置。当时还觉得这样配置一定不会出错吧，很放心。现在想想有点搞笑。</p>
<p>好了，以上就是别名解析的全部流程，大家看懂了吗？如果觉得没啥障碍的话，那继续往下看呗。</p>
<h3 id="2-6-解析-plugins-配置"><a href="#2-6-解析-plugins-配置" class="headerlink" title="2.6 解析 plugins 配置"></a>2.6 解析 plugins 配置</h3><p>插件是 MyBatis 提供的一个拓展机制，通过插件机制我们可在 SQL 执行过程中的某些点上做一些自定义操作。实现一个插件需要比简单，首先需要让插件类实现<code class="java">
Interceptor</code>接口。然后在插件类上添加<code class="java">
@Intercepts</code>和<code class="java">
@Signature</code>注解，用于指定想要拦截的目标方法。MyBatis 允许拦截下面接口中的一些方法：</p>
<ul>
<li>Executor: update 方法，query 方法，flushStatements 方法，commit 方法，rollback 方法， getTransaction 方法，close 方法，isClosed 方法</li>
<li>ParameterHandler: getParameterObject 方法，setParameters 方法</li>
<li>ResultSetHandler: handleResultSets 方法，handleOutputParameters 方法</li>
<li>StatementHandler: prepare 方法，parameterize 方法，batch 方法，update 方法，query 方法</li>
</ul>
<p>比较常见的插件有分页插件、分表插件等，有兴趣的朋友可以去了解下。本节我们来分析一下插件的配置的解析过程，先来了解插件的配置。如下：</p>
<td class="line_numbers"><pre>12345</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">plugins    plugin interceptor="xyz.coolblog.mybatis.ExamplePlugin"        property name="key" value="value"/    /plugin/plugins</pre></td>

<p>plugins<br>    plugin interceptor&#x3D;”xyz.coolblog.mybatis.ExamplePlugin”<br>        property name&#x3D;”key” value&#x3D;”value”&#x2F;<br>    &#x2F;plugin<br>&#x2F;plugins</p>
<p>解析过程分析如下：</p>
<td class="line_numbers"><pre>123456789101112131415</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void pluginElement(XNode parent) throws Exception {    if (parent != null) {        for (XNode child : parent.getChildren()) {            String interceptor = child.getStringAttribute("interceptor");            // 获取配置信息            Properties properties = child.getChildrenAsProperties();            // 解析拦截器的类型，并创建拦截器            Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).newInstance();            // 设置属性            interceptorInstance.setProperties(properties);            // 添加拦截器到 Configuration 中            configuration.addInterceptor(interceptorInstance);        }    }}</pre></td>

<p>private void pluginElement(XNode parent) throws Exception {<br>    if (parent !&#x3D; null) {<br>        for (XNode child : parent.getChildren()) {<br>            String interceptor &#x3D; child.getStringAttribute(“interceptor”);<br>            &#x2F;&#x2F; 获取配置信息<br>            Properties properties &#x3D; child.getChildrenAsProperties();<br>            &#x2F;&#x2F; 解析拦截器的类型，并创建拦截器<br>            Interceptor interceptorInstance &#x3D; (Interceptor) resolveClass(interceptor).newInstance();<br>            &#x2F;&#x2F; 设置属性<br>            interceptorInstance.setProperties(properties);<br>            &#x2F;&#x2F; 添加拦截器到 Configuration 中<br>            configuration.addInterceptor(interceptorInstance);<br>        }<br>    }<br>}</p>
<p>如上，插件解析的过程还是比较简单的。首先是获取配置，然后再解析拦截器类型，并实例化拦截器。最后向拦截器中设置属性，并将拦截器添加到 Configuration 中。好了，关于插件配置的分析就先到这，继续往下分析。</p>
<h3 id="2-7-解析-environments-配置"><a href="#2-7-解析-environments-配置" class="headerlink" title="2.7 解析 environments 配置"></a>2.7 解析 environments 配置</h3><p>在 MyBatis 中，事务管理器和数据源是配置在 environments 中的。它们的配置大致如下：</p>
<td class="line_numbers"><pre>1234567891011</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">environments default="development"    environment id="development"        transactionManager type="JDBC"/        dataSource type="POOLED"            property name="driver" value="${jdbc.driver}"/            property name="url" value="${jdbc.url}"/            property name="username" value="${jdbc.username}"/            property name="password" value="${jdbc.password}"/        /dataSource    /environment/environments</pre></td>

<p>environments default&#x3D;”development”<br>    environment id&#x3D;”development”<br>        transactionManager type&#x3D;”JDBC”&#x2F;<br>        dataSource type&#x3D;”POOLED”<br>            property name&#x3D;”driver” value&#x3D;”${jdbc.driver}”&#x2F;<br>            property name&#x3D;”url” value&#x3D;”${jdbc.url}”&#x2F;<br>            property name&#x3D;”username” value&#x3D;”${jdbc.username}”&#x2F;<br>            property name&#x3D;”password” value&#x3D;”${jdbc.password}”&#x2F;<br>        &#x2F;dataSource<br>    &#x2F;environment<br>&#x2F;environments</p>
<p>接下来我们对照上面的配置进行分析，如下：</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private String environment; private void environmentsElement(XNode context) throws Exception {    if (context != null) {        if (environment == null) {            // 获取 default 属性            environment = context.getStringAttribute("default");        }        for (XNode child : context.getChildren()) {            // 获取 id 属性            String id = child.getStringAttribute("id");            /*             * 检测当前 environment 节点的 id 与其父节点 environments 的属性 default              * 内容是否一致，一致则返回 true，否则返回 false             */            if (isSpecifiedEnvironment(id)) {                // 解析 transactionManager 节点，逻辑和插件的解析逻辑很相似，不在赘述                TransactionFactory txFactory = transactionManagerElement(child.evalNode("transactionManager"));                // 解析 dataSource 节点，逻辑和插件的解析逻辑很相似，不在赘述                DataSourceFactory dsFactory = dataSourceElement(child.evalNode("dataSource"));                // 创建 DataSource 对象                DataSource dataSource = dsFactory.getDataSource();                Environment.Builder environmentBuilder = new Environment.Builder(id)                    .transactionFactory(txFactory)                    .dataSource(dataSource);                // 构建 Environment 对象，并设置到 configuration 中                configuration.setEnvironment(environmentBuilder.build());            }        }    }}</pre></td>

<p>private String environment;</p>
<p>private void environmentsElement(XNode context) throws Exception {<br>    if (context !&#x3D; null) {<br>        if (environment &#x3D;&#x3D; null) {<br>            &#x2F;&#x2F; 获取 default 属性<br>            environment &#x3D; context.getStringAttribute(“default”);<br>        }<br>        for (XNode child : context.getChildren()) {<br>            &#x2F;&#x2F; 获取 id 属性<br>            String id &#x3D; child.getStringAttribute(“id”);<br>            &#x2F;*<br>             * 检测当前 environment 节点的 id 与其父节点 environments 的属性 default<br>             * 内容是否一致，一致则返回 true，否则返回 false<br>             *&#x2F;<br>            if (isSpecifiedEnvironment(id)) {<br>                &#x2F;&#x2F; 解析 transactionManager 节点，逻辑和插件的解析逻辑很相似，不在赘述<br>                TransactionFactory txFactory &#x3D; transactionManagerElement(child.evalNode(“transactionManager”));<br>                &#x2F;&#x2F; 解析 dataSource 节点，逻辑和插件的解析逻辑很相似，不在赘述<br>                DataSourceFactory dsFactory &#x3D; dataSourceElement(child.evalNode(“dataSource”));<br>                &#x2F;&#x2F; 创建 DataSource 对象<br>                DataSource dataSource &#x3D; dsFactory.getDataSource();<br>                Environment.Builder environmentBuilder &#x3D; new Environment.Builder(id)<br>                    .transactionFactory(txFactory)<br>                    .dataSource(dataSource);<br>                &#x2F;&#x2F; 构建 Environment 对象，并设置到 configuration 中<br>                configuration.setEnvironment(environmentBuilder.build());<br>            }<br>        }<br>    }<br>}</p>
<p>environments 配置的解析过程没什么特别之处，按部就班解析就行了，不多说了。</p>
<h3 id="2-8-解析-typeHandlers-配置"><a href="#2-8-解析-typeHandlers-配置" class="headerlink" title="2.8 解析 typeHandlers 配置"></a>2.8 解析 typeHandlers 配置</h3><p>在向数据库存储或读取数据时，我们需要将数据库字段类型和 Java 类型进行一个转换。比如数据库中有<code class="java">
CHAR</code>和<code class="java">
VARCHAR</code>等类型，但 Java 中没有这些类型，不过 Java 有<code class="java">
String</code>类型。所以我们在从数据库中读取 CHAR 和 VARCHAR 类型的数据时，就可以把它们转成 String 。在 MyBatis 中，数据库类型和 Java 类型之间的转换任务是委托给类型处理器<code class="java">
TypeHandler</code>去处理的。MyBatis 提供了一些常见类型的类型处理器，除此之外，我们还可以自定义类型处理器以非常见类型转换的需求。这里我就不演示自定义类型处理器的编写方法了，没用过或者不熟悉的同学可以 ，或者我在上一篇中写的示例。</p>
<p>下面，我们来看一下类型处理器的配置方法：</p>
<td class="line_numbers"><pre>1234</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">!-- 自动扫描 --typeHandlers    package name="xyz.coolblog.handlers"//typeHandlers</pre></td>

<p>!– 自动扫描 –<br>typeHandlers<br>    package name&#x3D;”xyz.coolblog.handlers”&#x2F;<br>&#x2F;typeHandlers</p>
<td class="line_numbers"><pre>123456</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">!-- 手动配置 --typeHandlers    typeHandler jdbcType="TINYINT"            javaType="xyz.coolblog.constant.ArticleTypeEnum"            handler="xyz.coolblog.mybatis.ArticleTypeHandler"//typeHandlers</pre></td>

<p>!– 手动配置 –<br>typeHandlers<br>    typeHandler jdbcType&#x3D;”TINYINT”<br>            javaType&#x3D;”xyz.coolblog.constant.ArticleTypeEnum”<br>            handler&#x3D;”xyz.coolblog.mybatis.ArticleTypeHandler”&#x2F;<br>&#x2F;typeHandlers</p>
<p>使用自动扫描的方式注册类型处理器时，应使用<code class="java">
@MappedTypes</code>和<code class="java">
@MappedJdbcTypes</code>注解配置<code class="java">
javaType</code>和<code class="java">
jdbcType</code>。关于注解，这里就不演示了，比较简单，大家自行尝试。下面开始分析代码。</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void typeHandlerElement(XNode parent) throws Exception {    if (parent != null) {        for (XNode child : parent.getChildren()) {            // 从指定的包中注册 TypeHandler            if ("package".equals(child.getName())) {                String typeHandlerPackage = child.getStringAttribute("name");                // 注册方法 ①                typeHandlerRegistry.register(typeHandlerPackage);             // 从 typeHandler 节点中解析别名到类型的映射            } else {                // 获取 javaType，jdbcType 和 handler 等属性值                String javaTypeName = child.getStringAttribute("javaType");                String jdbcTypeName = child.getStringAttribute("jdbcType");                String handlerTypeName = child.getStringAttribute("handler");                 // 解析上面获取到的属性值                Class? javaTypeClass = resolveClass(javaTypeName);                JdbcType jdbcType = resolveJdbcType(jdbcTypeName);                Class? typeHandlerClass = resolveClass(handlerTypeName);                 // 根据 javaTypeClass 和 jdbcType 值的情况进行不同的注册策略                if (javaTypeClass != null) {                    if (jdbcType == null) {                        // 注册方法 ②                        typeHandlerRegistry.register(javaTypeClass, typeHandlerClass);                    } else {                        // 注册方法 ③                        typeHandlerRegistry.register(javaTypeClass, jdbcType, typeHandlerClass);                    }                } else {                    // 注册方法 ④                    typeHandlerRegistry.register(typeHandlerClass);                }            }        }    }}</pre></td>

<p>private void typeHandlerElement(XNode parent) throws Exception {<br>    if (parent !&#x3D; null) {<br>        for (XNode child : parent.getChildren()) {<br>            &#x2F;&#x2F; 从指定的包中注册 TypeHandler<br>            if (“package”.equals(child.getName())) {<br>                String typeHandlerPackage &#x3D; child.getStringAttribute(“name”);<br>                &#x2F;&#x2F; 注册方法 ①<br>                typeHandlerRegistry.register(typeHandlerPackage);</p>
<pre class="line-numbers language-java"><code class="language-java">
        <span class="token comment" spellcheck="true">// 从 typeHandler 节点中解析别名到类型的映射</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取 javaType，jdbcType 和 handler 等属性值</span>
            String javaTypeName <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"javaType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String jdbcTypeName <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"jdbcType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String handlerTypeName <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"handler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 解析上面获取到的属性值</span>
            Class<span class="token operator">?</span> javaTypeClass <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>javaTypeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            JdbcType jdbcType <span class="token operator">=</span> <span class="token function">resolveJdbcType</span><span class="token punctuation">(</span>jdbcTypeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Class<span class="token operator">?</span> typeHandlerClass <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>handlerTypeName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 根据 javaTypeClass 和 jdbcType 值的情况进行不同的注册策略</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>javaTypeClass <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>jdbcType <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 注册方法 ②</span>
                    typeHandlerRegistry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>javaTypeClass<span class="token punctuation">,</span> typeHandlerClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 注册方法 ③</span>
                    typeHandlerRegistry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>javaTypeClass<span class="token punctuation">,</span> jdbcType<span class="token punctuation">,</span> typeHandlerClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 注册方法 ④</span>
                typeHandlerRegistry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>typeHandlerClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面代码中用于解析 XML 部分的代码比较简单，没什么需要特别说明的。除此之外，上面的代码中调用了4个不同的类型处理器注册方法。这些注册方法的逻辑不难理解，但是重载方法很多，上面调用的注册方法只是重载方法的一部分。由于重载太多且重载方法之间互相调用，导致这一块的代码有点凌乱。我一开始在整理这部分代码时，也很抓狂。后来没辙了，把重载方法的调用图画了出来，才理清了代码。一图胜千言，看图吧。</p>
<img class=" aligncenter" title="MyBatis 源码分析 - 配置文件解析过程" src="https://www.javazhiyin.com/wp-content/uploads/2018/07/2-1532920602.jpeg" src="https://www.javazhiyin.com/wp-content/themes/mnews/images/post-loading.gif" alt="MyBatis 源码分析 - 配置文件解析过程">

<p>在上面的调用图中，每个蓝色背景框下都有一个标签。每个标签上面都已一个编号，这些编号与上面代码中的标签是一致的。这里我把<code class="java">
蓝色背景框</code>内的方法称为<code class="java">
开始方法</code>，<code class="java">
红色背景框</code>内的方法称为<code class="java">
终点方法</code>，<code class="java">
白色背景框</code>内的方法称为<code class="java">
中间方法</code>。下面我会分析从每个开始方法向下分析，为了避免冗余分析，我会按照<code class="java">
③ → ② → ④ → ①</code>的顺序进行分析。大家在阅读代码分析时，可以参照上面的图片，辅助理解。好了，下面开始进行分析。</p>
<h4 id="2-8-1-register-Class-JdbcType-Class-方法分析"><a href="#2-8-1-register-Class-JdbcType-Class-方法分析" class="headerlink" title="2.8.1 register(Class, JdbcType, Class) 方法分析"></a>2.8.1 register(Class, JdbcType, Class) 方法分析</h4><p>当代码执行到此方法时，表示<code class="java">
javaTypeClass != null &amp;&amp; jdbcType != null</code>条件成立，即使用者明确配置了<code class="java">
javaType</code>和<code class="java">
jdbcType</code>属性的值。那下面我们来看一下该方法的分析。</p>
<td class="line_numbers"><pre>123456789101112131415161718192021</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public void register(Class? javaTypeClass, JdbcType jdbcType, Class? typeHandlerClass) {    // 调用终点方法    register(javaTypeClass, jdbcType, getInstance(javaTypeClass, typeHandlerClass));} /** 类型处理器注册过程的终点 */private void register(Type javaType, JdbcType jdbcType, TypeHandler? handler) {    if (javaType != null) {        // JdbcType 到 TypeHandler 的映射        MapJdbcType, TypeHandler? map = TYPE_HANDLER_MAP.get(javaType);        if (map == null || map == NULL_TYPE_HANDLER_MAP) {            map = new HashMapJdbcType, TypeHandler?();            // 存储 javaType 到 MapJdbcType, TypeHandler 的映射            TYPE_HANDLER_MAP.put(javaType, map);        }        map.put(jdbcType, handler);    }     // 存储所有的 TypeHandler    ALL_TYPE_HANDLERS_MAP.put(handler.getClass(), handler);}</pre></td>

<p>public void register(Class? javaTypeClass, JdbcType jdbcType, Class? typeHandlerClass) {<br>    &#x2F;&#x2F; 调用终点方法<br>    register(javaTypeClass, jdbcType, getInstance(javaTypeClass, typeHandlerClass));<br>}</p>
<p>&#x2F;** 类型处理器注册过程的终点 *&#x2F;<br>private void register(Type javaType, JdbcType jdbcType, TypeHandler? handler) {<br>    if (javaType !&#x3D; null) {<br>        &#x2F;&#x2F; JdbcType 到 TypeHandler 的映射<br>        MapJdbcType, TypeHandler? map &#x3D; TYPE_HANDLER_MAP.get(javaType);<br>        if (map &#x3D;&#x3D; null || map &#x3D;&#x3D; NULL_TYPE_HANDLER_MAP) {<br>            map &#x3D; new HashMapJdbcType, TypeHandler?();<br>            &#x2F;&#x2F; 存储 javaType 到 MapJdbcType, TypeHandler 的映射<br>            TYPE_HANDLER_MAP.put(javaType, map);<br>        }<br>        map.put(jdbcType, handler);<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 存储所有的 TypeHandler</span>
ALL_TYPE_HANDLERS_MAP<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面的代码只有两层调用，比较简单。同时，所谓的注册过程也就是把类型和处理器进行映射而已，没什么特别之处。关于这个方法就先分析到这里，继续往下分析。下面的方法对应注册方法②。</p>
<h4 id="2-8-2-register-Class-Class-方法分析"><a href="#2-8-2-register-Class-Class-方法分析" class="headerlink" title="2.8.2 register(Class, Class) 方法分析"></a>2.8.2 register(Class, Class) 方法分析</h4><p>当代码执行到此方法时，表示<code class="java">
javaTypeClass != null &amp;&amp; jdbcType == null</code>条件成立，即使用者仅设置了<code class="java">
javaType</code>属性的值。下面我们来看一下该方法的分析。</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public void register(Class? javaTypeClass, Class? typeHandlerClass) {    // 调用中间方法 register(Type, TypeHandler)    register(javaTypeClass, getInstance(javaTypeClass, typeHandlerClass));} private T void register(Type javaType, TypeHandler? extends T typeHandler) {    // 获取 @MappedJdbcTypes 注解    MappedJdbcTypes mappedJdbcTypes = typeHandler.getClass().getAnnotation(MappedJdbcTypes.class);    if (mappedJdbcTypes != null) {        // 遍历 @MappedJdbcTypes 注解中配置的值        for (JdbcType handledJdbcType : mappedJdbcTypes.value()) {            // 调用终点方法，参考上一小节的分析            register(javaType, handledJdbcType, typeHandler);        }        if (mappedJdbcTypes.includeNullJdbcType()) {            // 调用终点方法，jdbcType = null            register(javaType, null, typeHandler);        }    } else {        // 调用终点方法，jdbcType = null        register(javaType, null, typeHandler);    }}</pre></td>

<p>public void register(Class? javaTypeClass, Class? typeHandlerClass) {<br>    &#x2F;&#x2F; 调用中间方法 register(Type, TypeHandler)<br>    register(javaTypeClass, getInstance(javaTypeClass, typeHandlerClass));<br>}</p>
<p>private  void register(Type javaType, TypeHandler? extends  typeHandler) {<br>    &#x2F;&#x2F; 获取 @MappedJdbcTypes 注解<br>    MappedJdbcTypes mappedJdbcTypes &#x3D; typeHandler.getClass().getAnnotation(MappedJdbcTypes.class);<br>    if (mappedJdbcTypes !&#x3D; null) {<br>        &#x2F;&#x2F; 遍历 @MappedJdbcTypes 注解中配置的值<br>        for (JdbcType handledJdbcType : mappedJdbcTypes.value()) {<br>            &#x2F;&#x2F; 调用终点方法，参考上一小节的分析<br>            register(javaType, handledJdbcType, typeHandler);<br>        }<br>        if (mappedJdbcTypes.includeNullJdbcType()) {<br>            &#x2F;&#x2F; 调用终点方法，jdbcType &#x3D; null<br>            register(javaType, null, typeHandler);<br>        }<br>    } else {<br>        &#x2F;&#x2F; 调用终点方法，jdbcType &#x3D; null<br>        register(javaType, null, typeHandler);<br>    }<br>}</p>
<p>上面的代码包含三层调用，其中终点方法的逻辑上一节已经分析过，这里不再赘述。上面的逻辑也比较简单，主要做的事情是尝试从注解中获取<code class="java">
JdbcType</code>的值。这个方法就分析这么多，下面分析注册方法④。</p>
<h4 id="2-8-3-register-Class-方法分析"><a href="#2-8-3-register-Class-方法分析" class="headerlink" title="2.8.3 register(Class) 方法分析"></a>2.8.3 register(Class) 方法分析</h4><p>当代码执行到此方法时，表示<code class="java">
javaTypeClass == null &amp;&amp; jdbcType != null</code>条件成立，即使用者未配置<code class="java">
javaType</code>和<code class="java">
jdbcType</code>属性的值。该方法的分析如下。</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public void register(Class? typeHandlerClass) {    boolean mappedTypeFound = false;    // 获取 @MappedTypes 注解    MappedTypes mappedTypes = typeHandlerClass.getAnnotation(MappedTypes.class);    if (mappedTypes != null) {        // 遍历 @MappedTypes 注解中配置的值        for (Class? javaTypeClass : mappedTypes.value()) {            // 调用注册方法 ②            register(javaTypeClass, typeHandlerClass);            mappedTypeFound = true;        }    }    if (!mappedTypeFound) {        // 调用中间方法 register(TypeHandler)        register(getInstance(null, typeHandlerClass));    }} public T void register(TypeHandlerT typeHandler) {    boolean mappedTypeFound = false;    // 获取 @MappedTypes 注解    MappedTypes mappedTypes = typeHandler.getClass().getAnnotation(MappedTypes.class);    if (mappedTypes != null) {        for (Class? handledType : mappedTypes.value()) {            // 调用中间方法 register(Type, TypeHandler)            register(handledType, typeHandler);            mappedTypeFound = true;        }    }    // 自动发现映射类型    if (!mappedTypeFound && typeHandler instanceof TypeReference) {        try {            TypeReferenceT typeReference = (TypeReferenceT) typeHandler;            // 获取参数模板中的参数类型，并调用中间方法 register(Type, TypeHandler)            register(typeReference.getRawType(), typeHandler);            mappedTypeFound = true;        } catch (Throwable t) {        }    }    if (!mappedTypeFound) {        // 调用中间方法 register(Class, TypeHandler)        register((ClassT) null, typeHandler);    }} public T void register(ClassT javaType, TypeHandler? extends T typeHandler) {    // 调用中间方法 register(Type, TypeHandler)    register((Type) javaType, typeHandler);}</pre></td>

<p>public void register(Class? typeHandlerClass) {<br>    boolean mappedTypeFound &#x3D; false;<br>    &#x2F;&#x2F; 获取 @MappedTypes 注解<br>    MappedTypes mappedTypes &#x3D; typeHandlerClass.getAnnotation(MappedTypes.class);<br>    if (mappedTypes !&#x3D; null) {<br>        &#x2F;&#x2F; 遍历 @MappedTypes 注解中配置的值<br>        for (Class? javaTypeClass : mappedTypes.value()) {<br>            &#x2F;&#x2F; 调用注册方法 ②<br>            register(javaTypeClass, typeHandlerClass);<br>            mappedTypeFound &#x3D; true;<br>        }<br>    }<br>    if (!mappedTypeFound) {<br>        &#x2F;&#x2F; 调用中间方法 register(TypeHandler)<br>        register(getInstance(null, typeHandlerClass));<br>    }<br>}</p>
<p>public  void register(TypeHandler typeHandler) {<br>    boolean mappedTypeFound &#x3D; false;<br>    &#x2F;&#x2F; 获取 @MappedTypes 注解<br>    MappedTypes mappedTypes &#x3D; typeHandler.getClass().getAnnotation(MappedTypes.class);<br>    if (mappedTypes !&#x3D; null) {<br>        for (Class? handledType : mappedTypes.value()) {<br>            &#x2F;&#x2F; 调用中间方法 register(Type, TypeHandler)<br>            register(handledType, typeHandler);<br>            mappedTypeFound &#x3D; true;<br>        }<br>    }<br>    &#x2F;&#x2F; 自动发现映射类型<br>    if (!mappedTypeFound &amp;&amp; typeHandler instanceof TypeReference) {<br>        try {<br>            TypeReference typeReference &#x3D; (TypeReference) typeHandler;<br>            &#x2F;&#x2F; 获取参数模板中的参数类型，并调用中间方法 register(Type, TypeHandler)<br>            register(typeReference.getRawType(), typeHandler);<br>            mappedTypeFound &#x3D; true;<br>        } catch (Throwable t) {<br>        }<br>    }<br>    if (!mappedTypeFound) {<br>        &#x2F;&#x2F; 调用中间方法 register(Class, TypeHandler)<br>        register((Class) null, typeHandler);<br>    }<br>}</p>
<p>public  void register(Class javaType, TypeHandler? extends  typeHandler) {<br>    &#x2F;&#x2F; 调用中间方法 register(Type, TypeHandler)<br>    register((Type) javaType, typeHandler);<br>}</p>
<p>上面的代码比较多，不过不用太担心。不管是通过注解的方式，还是通过反射的方式，它们最终目的是为了解析出<code class="java">
javaType</code>的值。解析完成后，这些方法会调用中间方法<code class="java">
register(Type, TypeHandler)</code>，这个方法负责解析<code class="java">
jdbcType</code>，该方法上一节已经分析过。一个复杂解析 javaType，另一个负责解析 jdbcType，逻辑比较清晰了。那我们趁热打铁，继续分析下一个注册方法，编号为①。</p>
<h4 id="2-8-4-register-String-方法分析"><a href="#2-8-4-register-String-方法分析" class="headerlink" title="2.8.4 register(String) 方法分析"></a>2.8.4 register(String) 方法分析</h4><p>本节代码的主要是用于自动扫描类型处理器，并调用其他方法注册扫描结果。该方法的分析如下：</p>
<td class="line_numbers"><pre>12345678910111213</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public void register(String packageName) {    ResolverUtilClass? resolverUtil = new ResolverUtilClass?();    // 从指定包中查找 TypeHandler    resolverUtil.find(new ResolverUtil.IsA(TypeHandler.class), packageName);    SetClass? extends Class? handlerSet = resolverUtil.getClasses();    for (Class? type : handlerSet) {        // 忽略内部类，接口，抽象类等        if (!type.isAnonymousClass() && !type.isInterface() && !Modifier.isAbstract(type.getModifiers())) {            // 调用注册方法 ④            register(type);        }    }}</pre></td>

<p>public void register(String packageName) {<br>    ResolverUtilClass? resolverUtil &#x3D; new ResolverUtilClass?();<br>    &#x2F;&#x2F; 从指定包中查找 TypeHandler<br>    resolverUtil.find(new ResolverUtil.IsA(TypeHandler.class), packageName);<br>    SetClass? extends Class? handlerSet &#x3D; resolverUtil.getClasses();<br>    for (Class? type : handlerSet) {<br>        &#x2F;&#x2F; 忽略内部类，接口，抽象类等<br>        if (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !Modifier.isAbstract(type.getModifiers())) {<br>            &#x2F;&#x2F; 调用注册方法 ④<br>            register(type);<br>        }<br>    }<br>}</p>
<p>上面代码的逻辑比较简单，其中注册方法④已经在上一节分析过了，这里就不多说了。</p>
<h4 id="2-8-5-小结"><a href="#2-8-5-小结" class="headerlink" title="2.8.5 小结"></a>2.8.5 小结</h4><p>类型处理器的解析过程不复杂，但是注册过程由于重载方法间相互调用，导致调用路线比较复杂。这个时候需要想办法理清方法的调用路线，理清后，整个逻辑就清晰明了了。好了，关于类型处理器的解析过程就先分析到这。</p>
<h3 id="2-9-解析-mappers-配置"><a href="#2-9-解析-mappers-配置" class="headerlink" title="2.9 解析 mappers 配置"></a>2.9 解析 mappers 配置</h3><p>前面分析的都是 MyBatis 的一些配置，本节的内容原本是打算分析 mappers 节点的解析过程。但由于本文的篇幅已经很大了，加之 mappers 节点的过程也比较复杂。所以，关于本节的内容，我会独立成文，后面再进行更新。这里先告知大家一下。</p>
<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h2><p>本文对 MyBatis 配置文件中部分配置的解析过程进行了详细的分析。本文所关注的点不局限于配置文件的解析过程，如果仅分析配置文件，那就简单多了。对于我来说，我更希望在分析配置文件的过程中，尽量把一些背景知识弄明白，这样才能对 MyBatis 有更多的了解。从本文的篇幅以及内容上来说，我觉得本篇文章达到了自己的预期。通过本文的分析，也使我加深了对 MyBatis 的理解。总的来说，收获还是比较多的。不过个人水平有限，若文章有错误不妥之处，也请大家多多指教。</p>
<p>本篇文章篇幅比较大，写起来还是很耗费精力的。如果大家觉得这篇文章还不错的话，不妨给个赞吧，算是对我的鼓励了。好了，本篇文章就到这里了，感谢大家的阅读。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>- </p>

                </div>
                <!-- 欧阳思海，modify，2020.05.01-->
<!-- 文章详情详情页面的头部广告位置信息 -->
<div id="post-head-panel">
    
    <a href="https://github.com/OUYANGSIHAI/JavaInterview" style="font-size: 18px;" target="_blank">
        <img src="/icons/hot.gif">
        本人花费半年的时间总结的《Java面试指南》已拿腾讯等大厂offer，已开源在github ，欢迎star！
    </a>
    
    
</div>
<br />



<blockquote>
    
            <p>本文GitHub <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">https://github.com/OUYANGSIHAI/JavaInterview</a> 已收录，这是我花了6个月总结的<b>一线大厂Java面试</b>总结，本人已拿大厂offer，欢迎star</p>
    
    <p>原文链接：blog.ouyangsihai.cn &gt;&gt; <a href="/mybatis-yuan-ma-fen-xi-pei-zhi-wen-jian-jie-xi-guo-cheng.html" target="_blank">MyBatis 源码分析 – 配置文件解析过程</a></p>
</blockquote>
                <hr />

                
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">多少都是对我的认可</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="http://image.ouyangsihai.cn/FpbhsOuf3Ar9vY34B97Y2qQ7LVGe" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="http://image.ouyangsihai.cn/FgYlMzms68PH73PWpZBwPfbLTAws" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
                

                <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

                

                
                <div class="reprint1">
                    <p>
                        <span class="reprint1-tip">
                            <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                        </span>
                        <a href="https://blog.ouyangsihai.cn" class="b-link-green">好好学java</a>
                        <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                        <a href="/mybatis-yuan-ma-fen-xi-pei-zhi-wen-jian-jie-xi-guo-cheng.html" class="b-link-green">MyBatis 源码分析 – 配置文件解析过程</a>
                    </p>
                </div>

            </div>
        </div>

        

        

        

        

        
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }
    /* valine 评论框增加背景图片 */
    #vcomments textarea {
        box-sizing: border-box;
        background: url("") 100% 100% no-repeat;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    /* 修复评论第一行位置错位 */
    .v .vlist .vcard {
    padding-top: 2.5em !important ;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <link rel="stylesheet" type="text/css" href="/libs//libs/jQuery-emoji/dist/css/jquery.emoji.css">
<script src="/libs//libs/jQuery-emoji/dist/js/jquery.emoji.min.js"></script>
<script src="/libs//libs/jQuery-emoji/dist/js/emoji.list.js"></script> -->
<script>
    new Valine({
        el: '#vcomments',
        appId: 'MxSNOS83TYWU3Opsy2GTW1ih-gzGzoHsz',
        appKey: '4XevOgmAxHEwVDnIKgvEUihB',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '请畅所欲言吧，别害羞~',

    });

//     function parse_emoji() {
//     jQuery(".vcontent").emojiParse({
//       basePath: '/libs/jQuery-emoji/images/emoji',
//       icons: emojiLists   // 注：详见 js/emoji.list.js
//     });
//   }
  
//   setTimeout(function() {
//     // jQuery emoji 解析
//     parse_emoji();
//     // jquery emoji 初始化
//     jQuery(".veditor").emoji({
//       showTab: true,
//       animation: 'slide',
//       basePath: '/libs/jQuery-emoji/images/emoji',
//       icons: emojiLists  // 注：详见 js/emoji.list.js
//     });
//     jQuery(".vmore").on("click", function() {
//       setTimeout(function() {
//         parse_emoji();
//       }, 500);
//     });
//   }, 800)

</script>
        

        

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/springboot-zheng-he-mybatis.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="SpringBoot整合MyBatis">
                        
                        <span class="card-title">SpringBoot整合MyBatis</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            

学完了Spring的JavaConfiguration配置形式，我们就可以进行SpringBoot的配置了。在
Spring-Java配置形式讲解文章中介绍了，SpringBoot的配置形式多数为JavaConfiguration的形式
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock fa-fw icon-date"></i>2021-04-05
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/mybatis%E6%BA%90%E7%A0%81/" class="post-category" target="_blank">
                                    mybatis源码
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/mybatis-mybatis%E6%BA%90%E7%A0%81/" target="_blank">
                        <span class="chip bg-color">mybatis,mybatis源码</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/mybatis-yuan-ma-fen-xi-ying-she-wen-jian-jie-xi-guo-cheng.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="MyBatis 源码分析 – 映射文件解析过程">
                        
                        <span class="card-title">MyBatis 源码分析 – 映射文件解析过程</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            1.简介在上一篇文章中，我详细分析了 MyBatis 配置文件的解析过程。由于上一篇文章的篇幅比较大，加之映射文件解析过程也比较复杂的原因。所以我将映射文件解析过程的分析内容从上一篇文章中抽取出来，独立成文，于是就有了本篇文章。在本篇文章中
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock fa-fw icon-date"></i>2021-04-05
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/mybatis%E6%BA%90%E7%A0%81/" class="post-category" target="_blank">
                                    mybatis源码
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/mybatis-mybatis%E6%BA%90%E7%A0%81/" target="_blank">
                        <span class="chip bg-color">mybatis,mybatis源码</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
    </div>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('500')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 好好学java<br />'
            + '作者: 好好学java<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>



<!--
<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'container',
        blogId: '15305-1590684104111-518',
        name: '程序员的技术圈子',
        qrcode: 'http://image.ouyangsihai.cn/FtAUOeE5--1JTdcuuZFIhMuEUuJO',
        keyword: 'vip',
    });
</script>
-->

    </div>
    <div id="toc-aside" style="width: 310px;" class="expanded col l3 hide-on-med-and-down">
        <!-- 自定义右侧card：欧阳思海 -->
        <!-- <div id="my-card" style="background: ">
            
        </div> -->
        <!-- <div class="toc-widget">
            <div class="toc-title" style="display: none;"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;</div>
            <div id="toc-content"></div>
        </div> -->








        <aside class="col-lg-3" style="width: 300px;">

            <link rel="stylesheet" type="text/css" href="/css/my-aside.css">

            <!-- 关注公众号信息：欧阳思海 -->
            <div class="widget-wrap">
                <div class="widget bg-danger" style="color:whitesmoke; background-color: #419488">
                    <div class="card-front animated col s12 m12 l8 offset-l2 fadeInUp">
                        <div class="row">
                            <div class="col-md-5" style="text-align: center;">
                                <img class="adv" style="width: 95px; height: 95px;"
                                    src="http://image.ouyangsihai.cn/FtAUOeE5--1JTdcuuZFIhMuEUuJO">
                            </div>
                            <div class="col-md-7" style="text-align: center;">
                                <h2 style="font-size: 18px; 
                                    margin: 0; 
                                    padding: 0;
                                    border: 0; 
                                    outline: 0;
                                    font-weight: inherit;
                                    font-style: inherit;
                                    font-family: inherit;
                                    vertical-align: baseline;">关注公众号</h2>
                                 
                                <small style="font-size: 15px;">
                                    →「技术干货」每日推送 <br>
                                    →「回复资料」领取资料 <br>
                                    →「微信加群」每周福利 <br>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- <div style="font-size: 0.8em;">
                        <a href="/assets/erweima.jpg" target="_blank"
                            style="color:orange;font-size: 14px;">点击添加我的微信，加入技术讨论群</a>
                        除公众号以外，我还会在以下平台发布内容：
                    </div>
                    -->

                    <div class="profile-block social-links col-md-7" style="text-align: center;">
                        <table style="align-items: center; 
                                        padding-left: 25px;">
                            <tbody>
                                <tr>
                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank" title="GitHub"
                                            class="tooltip">
                                            <img style="width: 22px;height: 22px;" src="/icons/github.svg"></a>
                                    </td>

                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://www.zhihu.com/people/hai-hai-ren-sheng-50/activities"
                                            target="_blank" title="知乎" class="tooltip">
                                            <img style="width: 22px;" src="/icons/zhihu.svg"></a>
                                    </td>
                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://blog.csdn.net/sihai12345" target="_blank" title="CSDN"
                                            class="tooltip">
                                            <img style="width: 18px;" src="/icons/CSDN.svg"></a>
                                    </td>
                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://www.jianshu.com/u/12b0bd4c857c" target="_blank" title="简书"
                                            class="tooltip">
                                            <img style="width: 22px;" src="/icons/JianShu.svg"></a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            

            <!-- custom rightside_link：热门文章推荐：欧阳思海 -->
            
            <div class="widget-wrap widget-panel">
                <p style="text-align: left;padding-bottom: 10px;line-height: 30px; font-size: 14px;">
                    
                    <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">

                        <img src="/icons/hot.gif">

                        本人花费半年的时间总结的《 Java 面试指南》已拿腾讯等大厂 offer，已开源在 github ，欢迎 star！
                    </a><br>
                    
                    <a href="https://mp.weixin.qq.com/s/I0jimqziHqRNaIy0kXRCnw" target="_blank">

                        <img src="/icons/hot.gif">

                        2020 Java 1000G 最新学习资源，Java基础、Java项目实战、Java分布式等等！
                    </a><br>
                    
                    <a href="http://image.ouyangsihai.cn/FpB-dO6g-XU44mMrVlj7EL1y7Rs7" target="_blank">

                        <img src="/icons/hot.gif">

                        高级 Java 开发微信群，一起搞事情吧！
                    </a><br>
                    
                </p>
            </div>
            

            

            <!-- custom rightside_banner：右侧广告或者其他的栏目设置：欧阳思海 -->
            
            <div class="widget-wrap">
                <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">
                    <img src="http://image.ouyangsihai.cn/FhhoEYMaNr6m0v8KhG8vSPgoREBV" style="width: 100%;">
                </a>
            </div>
            
            

            

            <!-- 右侧专栏分类：欧阳思海 -->
            
            <div class="widget-wrap widget-panel">
                <ul class="media-list">
                    
                    <li class="media">
                        <a href="/categories/MySQL的艺术世界/" target="_blank">
                            <div class="media-left">
                                <img class="media-object" src="http://image.ouyangsihai.cn/Fn3kQurieQ_0QUeqPmx5RW5i6R9n" style="width: 55px;">
                            </div>
                            <div class="media-body">
                                <h4 class="media-heading" style="margin-bottom: 10px; font-size: 100%;
                                                                    margin: 0;
                                                                    padding: 0;
                                                                    border: 0;
                                                                    outline: 0;
                                                                    font-weight: inherit;
                                                                    font-style: inherit;
                                                                    font-family: inherit;
                                                                    vertical-align: baseline;">
                                    MySQL 的系列文章，解决全部面试问题！
                                </h4>
                                <p>
                                    总共10篇文章，面试热门的锁、事务，通通解决了！
                                </p>
                            </div>
                        </a>
                    </li>
                    <hr>
                    
                    <li class="media">
                        <a href="/categories/深入理解Java虚拟机/" target="_blank">
                            <div class="media-left">
                                <img class="media-object" src="http://image.ouyangsihai.cn/FpcS21VWJOHSgGzKcpW3_xVTSEeN" style="width: 55px;">
                            </div>
                            <div class="media-body">
                                <h4 class="media-heading" style="margin-bottom: 10px; font-size: 100%;
                                                                    margin: 0;
                                                                    padding: 0;
                                                                    border: 0;
                                                                    outline: 0;
                                                                    font-weight: inherit;
                                                                    font-style: inherit;
                                                                    font-family: inherit;
                                                                    vertical-align: baseline;">
                                    深入理解 Java 虚拟机，面试必问
                                </h4>
                                <p>
                                    总共10篇文章，包括内存模型、GC算法、GC收集器等。
                                </p>
                            </div>
                        </a>
                    </li>
                    <hr>
                    
                </ul>
            </div>
            

            <!-- 右侧分类 -->
            <div class="widget-wrap widget-panel">
                <h3 class="widget-title">文章分类</h3>
                <div class="widget">
                    <ul class="category-list">
                        
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/趣聊数据结构与算法/">>
                                趣聊数据结构与算法</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/职业生涯浅谈/">>
                                职业生涯浅谈</a><span class="category-list-count">33</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java项目分享/">>
                                Java项目分享</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java面试经验/">>
                                Java面试经验</a><span class="category-list-count">4</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/我要进大厂/">>
                                我要进大厂</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/好好学java/">>
                                好好学java</a><span class="category-list-count">1116</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/剑指offer/">>
                                剑指offer</a><span class="category-list-count">112</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/css/">>
                                css</a><span class="category-list-count">12</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/其他框架/">>
                                其他框架</a><span class="category-list-count">142</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python其他/">>
                                python其他</a><span class="category-list-count">45</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/数据库相关/">>
                                数据库相关</a><span class="category-list-count">293</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java核心知识/">>
                                Java核心知识</a><span class="category-list-count">196</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java面试题/">>
                                Java面试题</a><span class="category-list-count">308</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/mybatis源码/">>
                                mybatis源码</a><span class="category-list-count">56</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/spring教程/">>
                                spring教程</a><span class="category-list-count">173</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springboot教程/">>
                                springboot教程</a><span class="category-list-count">156</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/实战Activiti工作流/">>
                                实战Activiti工作流</a><span class="category-list-count">4</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springcloud教程/">>
                                springcloud教程</a><span class="category-list-count">39</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/linux/">>
                                linux</a><span class="category-list-count">91</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python框架/">>
                                python框架</a><span class="category-list-count">43</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python基础/">>
                                python基础</a><span class="category-list-count">78</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/dubbo/">>
                                dubbo</a><span class="category-list-count">37</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java源码/">>
                                Java源码</a><span class="category-list-count">76</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/叽叽喳喳杂七杂八/">>
                                叽叽喳喳杂七杂八</a><span class="category-list-count">10</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/MySQL的艺术世界/">>
                                MySQL的艺术世界</a><span class="category-list-count">8</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/jquery/">>
                                jquery</a><span class="category-list-count">14</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java并发/">>
                                Java并发</a><span class="category-list-count">43</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java文章合辑/">>
                                Java文章合辑</a><span class="category-list-count">11</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java基础修炼/">>
                                Java基础修炼</a><span class="category-list-count">7</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/不一样的Java8/">>
                                不一样的Java8</a><span class="category-list-count">3</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/小程序开发的世界/">>
                                小程序开发的世界</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java学习资源分享/">>
                                Java学习资源分享</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java小学生漫游/">>
                                Java小学生漫游</a><span class="category-list-count">2</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/rocketmq源码解析/">>
                                rocketmq源码解析</a><span class="category-list-count">33</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springmvc最新教程/">>
                                springmvc最新教程</a><span class="category-list-count">9</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java的Exception/">>
                                Java的Exception</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/vue-js/">>
                                vue.js</a><span class="category-list-count">10</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/实战设计模式/">>
                                实战设计模式</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python数据处理/">>
                                python数据处理</a><span class="category-list-count">7</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java-Web闯关/">>
                                Java Web闯关</a><span class="category-list-count">7</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springboot2-0最新教程/">>
                                springboot2.0最新教程</a><span class="category-list-count">11</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/netty/">>
                                netty</a><span class="category-list-count">16</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/rpc/">>
                                rpc</a><span class="category-list-count">13</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/拥抱大厂系列/">>
                                拥抱大厂系列</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/eureka/">>
                                eureka</a><span class="category-list-count">19</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/分布式/">>
                                分布式</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/中间件/">>
                                中间件</a><span class="category-list-count">23</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java基础/">>
                                Java基础</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/带你学Python/">>
                                带你学Python</a><span class="category-list-count">10</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/使用技术工具/">>
                                使用技术工具</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/mycat源码/">>
                                mycat源码</a><span class="category-list-count">5</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/深入理解Java虚拟机/">>
                                深入理解Java虚拟机</a><span class="category-list-count">8</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/spring源码/">>
                                spring源码</a><span class="category-list-count">2</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java集合源码分析/">>
                                Java集合源码分析</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/github的repo/">>
                                github的repo</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java框架深究/">>
                                Java框架深究</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/分布式架构/">>
                                分布式架构</a><span class="category-list-count">2</span>
                        </li>
                        
                        
                    </ul>
                </div>
            </div>

        </aside>









    </div>
</div>

<!-- TOC 悬浮按钮. 修改成永远不显示：欧阳思海-->




<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        console.log('============');

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

                        
            /* 修复文章卡片 div 的宽度. */
            let fixPostCardWidth = function (srcId, targetId) {
                let srcDiv = $('#' + srcId);
                if (srcDiv.length === 0) {
                    return;
                }

                let w = srcDiv.width();
                if (w >= 450) {
                    w = w + 21;
                } else if (w >= 350 && w < 450) {
                    w = w + 18;
                } else if (w >= 300 && w < 350) {
                    w = w + 16;
                } else {
                    w = w + 14;
                }
                $('#' + targetId).width(w);
            };

            // 切换TOC目录展开收缩的相关操作.
            // 修改右侧边栏功能：欧阳思海
            const expandedClass = 'expanded';
            let $tocAside = $('#toc-aside');
            let $mainContent = $('#main-content');

            $('#floating-toc-btn .btn-floating').click(function () {
                if ($tocAside.hasClass(expandedClass)) {
                    $tocAside.removeClass(expandedClass).slideUp(500);
                    $mainContent.removeClass('l9');
                } else {
                    $tocAside.addClass(expandedClass).slideDown(500);
                    $mainContent.addClass('l9');
                }
                fixPostCardWidth('artDetail', 'prenext-posts');
            });
                        
                    });
</script>
    

</main>


        <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            
	    Copyright&copy; 2019 <a href="https://www.java1000.com/" target="_blank"> 好好学java </a>维护. 网站备案/许可证号：赣ICP备17007984号-3
            <br>
            <span id="sitetime"></span>
            <br>

            

            
                    <!-- 
                        <span id="busuanzi_container_site_pv" style='display:none'></span>
                        总访问量: <span id="busuanzi_value_site_pv" class="white-color"></span>
                    
        
                    
                        <span id="busuanzi_container_site_uv" style='display:none'></span>
                        人次&nbsp; | &nbsp;访客人数: <span id="busuanzi_value_site_uv" class="white-color"></span> 人
                     -->
                        <!-- 修改计数：欧阳思海 -->
                    
                        <span id="busuanzi_container_site_pv" style='display:inline'>
                            <i class="fa fa-heart-o"></i>
                            本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                        </span>
                    
                    
                        <span id="busuanzi_container_site_uv" style='display:none'>
                            人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                        </span>
                    
    
            

            
                &nbsp; | &nbsp;字数统计:&nbsp;
                <span class="white-color">8290.3k</span> 字
            

            
            <br>

        </div>

        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/OUYANGSIHAI/JavaInterview" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-code-branch"></i>
    </a>


 
    <a href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=1446037005@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>




    <a href="https://zhihu.com/people/hai-hai-ren-sheng-50/activities" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>









    <a href="https://blog.ouyangsihai.cn/sitemap.xml" class="tooltipped" target="_blank" data-tooltip="站点地图" data-position="top" data-delay="50">
        <i class="fa fa-sitemap"></i>
    </a>



    <a href="https://blog.ouyangsihai.cn/friends" class="tooltipped" target="_blank" data-tooltip="友情链接" data-position="top" data-delay="50">
        <i class="fa fa-address-book"></i>
    </a>
</div>

    </div>
</footer>

<div class="progress-bar"></div>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();

        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */

        var t1 = Date.UTC(2019, 08, 10, 00, 00, 00); //北京时间2019-8-1 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes *
            minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours +
            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒" ;
    } /*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

<!-- 修改计数：欧阳思海 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);  // 50ms周期检测函数
        var pvcountOffset = 1005469;  // 初始化首次数据
        var uvcountOffset = 250804;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int); // 停止检测
            }
        }
    });
</script>




        <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    console.log("lets go！");
    console.log("/");
    searchFunc("/" + "search.json", 'searchInput', 'searchResult');
});
</script>
        <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


        <script src="/libs/materialize/materialize.min.js"></script>
        <script src="/libs/masonry/masonry.pkgd.min.js"></script>
        <script src="/libs/aos/aos.js"></script>
        <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
        <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
        <script src="/js/matery.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-149362573-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-149362573-1');
</script>



        
            <script src="/libs/others/clicklove.js"></script>
        

        
            <script async src="/libs/others/busuanzi.pure.mini.js"></script>
        

        <!-- 洪卫 shw2018 add 2019.08.28 -->
        <script type="text/javascript">
            var OriginTitile = document.title,
                st;
            document.addEventListener("visibilitychange", function () {
                document.hidden ? (document.title = "看不见我🙈~看不见我🙈~", clearTimeout(st)) : (document.title =
                    "(๑•̀ㅂ•́) ✧被发现了～", st = setTimeout(function () {
                        document.title = OriginTitile
                    }, 3e3))
            })
        </script>

        <!-- 鼠标点击烟花爆炸效果  洪卫 shw2018 add 2019.09.09 -->
        

        <!-- 背景雪花飘落特效洪卫 shw2018 add 2019.09.10 -->
        

        <!-- 鼠标点击文字特效 洪卫 shw2018 add 2019.09.10-->
        

        <!-- 背景雪花飘落特效 洪卫 shw2018 add 2019.09.10 -->
        

        <!-- 在线聊天工具  洪卫 shw2018 add 2019.09.11 -->
        

        <!-- 背景 canvas-nest  洪卫 shw 2018  add 2019.09.15-->
        

        <!-- 背景静止彩带  洪卫 shw 2018  add 2019.09.15-->
        

        <!-- 背景动态彩带 洪卫 shw 2018  add 2019.09.15-->
        

    </body>
</html>
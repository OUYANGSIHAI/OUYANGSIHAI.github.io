<!DOCTYPE HTML>
<html lang="zh-CN">
    <!-- shw2018 洪卫  modify 2019.08.15-->



<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Spring Boot, Spring Cloud, 微服务, Java技术, 好好学java, Java面试, 分布式, 最新干货分享">
    <meta name="baidu-site-verification" content="fmlEuI34ir" />
    <meta name="google-site-verification" content="ZWVq5UvPg33BCEA3LRTUkYe5J854o9lF1_WRTer9l8A" />
    <meta name="description" content="本站是 好好学java 的技术分享博客。内容涵盖Java后端技术、Spring Boot、Spring Cloud、微服务架构、分布式、Java面试、测试开发等相关的研究与知识分享。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>深入源码分析SpringIOC（二） | 好好学java | Spring Boot | Spring Cloud | 微服务 | Java技术 | Java面试 | 分布式 | 最新干货分享</title>
    <link rel="icon" type="image/png" href="http://image.ouyangsihai.cn/FjihsEiBMONnJIRtPwgGkjE4HAP7">

    <!-- <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css"> -->
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <!-- 自定义fontawesome样式：欧阳思海 -->
    <link rel="stylesheet" type="text/css" href="/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/css/brands.min.css">
    <link rel="stylesheet" type="text/css" href="/css/fontawesome.min.css">
    <link rel="stylesheet" type="text/css" href="/css/regular.min.css">
    <link rel="stylesheet" type="text/css" href="/css/solid.min.css">


    <style type="text/css">
        code[class*="language-"],
            pre[class*="language-"] {
                white-space: pre !important;
            }

            

        /* 将matery.css中的背景颜色修改放到这里：欧阳思海 */
        .bg-color {
            background-image: linear-gradient(to right, #ec8585 0%, #419488 100%);
            opacity: 0.9;
            // 透明度
        }
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>

    
    
    <script>
        (function () {
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>
    

    <script>
        var _hmt = _hmt || [];
        (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?6fe466069710c03a563713b507fbaca7";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
        })();
    </script>


    <!-- Google Analytics -->
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-XXXXX-Y', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics -->

    <script>(function (i, s, o, g, r, a, m) { i["DaoVoiceObject"] = r; i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments) }, i[r].l = 1 * new Date(); a = s.createElement(o), m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; a.charset = "utf-8"; m.parentNode.insertBefore(a, m) })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0a804bac.js", "daovoice")</script>

    <script>
        if (true) {
            daovoice('init', {
                app_id: "0a804bac",
                user_id: "NO_89757", // 必填: 该用户在您系统上的唯一ID
                email: "daovoice@example.com", // 选填:  该用户在您系统上的主邮箱
                name: "道客船长", // 选填: 用户名
                signed_up: 1449821660 // 选填: 用户的注册时间，用Unix时间戳表示
            });
            daovoice('update');

            daovoice('init', {
                app_id: "0a804bac"
            });
            daovoice('update');
        }
    </script>
<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/rss2.xml" title="好好学java" type="application/rss+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

    <body>

        <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="http://image.ouyangsihai.cn/FjihsEiBMONnJIRtPwgGkjE4HAP7" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span" style="font-size: 1.4rem;">好好学java</span>
                </a>
            </div>
            


<!-- <a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="" class="waves-effect waves-light">
            
            <i class="fa "></i>
            
            <span></span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title=""></i>
        </a>
    </li>
</ul> -->

<!-- 支持二级菜单特性 洪卫 shw2018 modify 2019.09.17  -->
<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-align-justify"></i></a>
<ul class="right nav-menu">
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-folder-minus"></i>
                
                <span style="font-size: 1.1rem;">Java学习</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/Java%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86/" >
                    
                    <span>Java入门</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/Javaweb/" >
                    
                    <span>Java Web</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/spring%E6%95%99%E7%A8%8B/" >
                    
                    <span>Spring教程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/springboot%E6%95%99%E7%A8%8B/" >
                    
                    <span>SpringBoot教程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/springcloud%E6%95%99%E7%A8%8B/" >
                    
                    <span>SpringCloud教程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/Java%E9%9D%A2%E8%AF%95%E9%A2%98/" >
                    
                    <span>Java面试</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E5%89%91%E6%8C%87offer/" >
                    
                    <span>剑指offer</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-code-branch"></i>
                
                <span style="font-size: 1.1rem;">Java进阶</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%B3%BB%E5%88%97/" >
                    
                    <span>设计模式</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" >
                    
                    <span>Java并发编程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3/" >
                    
                    <span>数据库</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/redis/" >
                    
                    <span>Redis</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/linux/" >
                    
                    <span>Linux</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/" >
                    
                    <span>Java实战项目</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-code"></i>
                
                <span style="font-size: 1.1rem;">python学习</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/python%E5%9F%BA%E7%A1%80/" >
                    
                    <span>python基础</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/python%E6%A1%86%E6%9E%B6/" >
                    
                    <span>python框架</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/python%E5%85%B6%E4%BB%96/" >
                    
                    <span>python其他</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-coffee"></i>
                
                <span style="font-size: 1.1rem;">Java扩展</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/dubbo/" >
                    
                    <span>dubbo</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/netty/" >
                    
                    <span>netty</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/rpc/" >
                    
                    <span>rpc</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/eureka/" >
                    
                    <span>eureka</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" >
                    
                    <span>中间件</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" >
                    
                    <span>分布式</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-desktop"></i>
                
                <span style="font-size: 1.1rem;">计算机核心</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" >
                    
                    <span>数据结构</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/leetcode%E5%88%B7%E9%A2%98/" >
                    
                    <span>leetcode刷题</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" >
                    
                    <span>计算机网络</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E7%AE%97%E6%B3%95/" >
                    
                    <span>算法</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/categories/" class="waves-effect waves-light">
              
                <i style="font-size: 1.1rem;" class="fa fa-adjust"></i>
              
              <span style="font-size: 1.1rem;">学习资源</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/contact" class="waves-effect waves-light">
              
                <i style="font-size: 1.1rem;" class="fa fa-envelope"></i>
              
              <span style="font-size: 1.1rem;">留言</span>
            </a>

            
      </li>
    

    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="http://image.ouyangsihai.cn/FjihsEiBMONnJIRtPwgGkjE4HAP7" class="logo-img circle responsive-img">
        
        <div class="logo-name">好好学java</div>
        <div class="logo-desc">
            
            
            本站是 好好学java 的技术分享博客，涵盖Java后端技术、SpringBoot、微服务架构、分布式、Java面试等知 ...
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-folder-minus"></i>
			
			Java学习
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/Java%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86/ " style="margin-left:75px";>
				  
		          <span>Java入门</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Javaweb/ " style="margin-left:75px";>
				  
		          <span>Java Web</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/spring%E6%95%99%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>Spring教程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/springboot%E6%95%99%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>SpringBoot教程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/springcloud%E6%95%99%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>SpringCloud教程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Java%E9%9D%A2%E8%AF%95%E9%A2%98/ " style="margin-left:75px";>
				  
		          <span>Java面试</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E5%89%91%E6%8C%87offer/ " style="margin-left:75px";>
				  
		          <span>剑指offer</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-code-branch"></i>
			
			Java进阶
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%B3%BB%E5%88%97/ " style="margin-left:75px";>
				  
		          <span>设计模式</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>Java并发编程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3/ " style="margin-left:75px";>
				  
		          <span>数据库</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/redis/ " style="margin-left:75px";>
				  
		          <span>Redis</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/linux/ " style="margin-left:75px";>
				  
		          <span>Linux</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/ " style="margin-left:75px";>
				  
		          <span>Java实战项目</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-code"></i>
			
			python学习
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/python%E5%9F%BA%E7%A1%80/ " style="margin-left:75px";>
				  
		          <span>python基础</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/python%E6%A1%86%E6%9E%B6/ " style="margin-left:75px";>
				  
		          <span>python框架</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/python%E5%85%B6%E4%BB%96/ " style="margin-left:75px";>
				  
		          <span>python其他</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-coffee"></i>
			
			Java扩展
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/dubbo/ " style="margin-left:75px";>
				  
		          <span>dubbo</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/netty/ " style="margin-left:75px";>
				  
		          <span>netty</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/rpc/ " style="margin-left:75px";>
				  
		          <span>rpc</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/eureka/ " style="margin-left:75px";>
				  
		          <span>eureka</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/ " style="margin-left:75px";>
				  
		          <span>中间件</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/ " style="margin-left:75px";>
				  
		          <span>分布式</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-desktop"></i>
			
			计算机核心
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ " style="margin-left:75px";>
				  
		          <span>数据结构</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/leetcode%E5%88%B7%E9%A2%98/ " style="margin-left:75px";>
				  
		          <span>leetcode刷题</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ " style="margin-left:75px";>
				  
		          <span>计算机网络</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E7%AE%97%E6%B3%95/ " style="margin-left:75px";>
				  
		          <span>算法</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/" class="waves-effect waves-light">
			
			    <i class="fa fa-fw fa-adjust"></i>
			
			学习资源
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa fa-fw fa-envelope"></i>
			
			留言
		</a>
          
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

        



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/9.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        深入源码分析SpringIOC（二）
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }

    /* 自定义mycard：欧阳思海 */

    #my-card {
        /* position: relative; */
        width: 310px;
        height: 300px;
        /* max-height: 330px; */
        margin-bottom: 15px;
        margin-top: 15px;
        /* text-align: center; */
        border: 0;
        border-radius: 3px;
        color: rgba(0, 0, 0, .87);
        background: #fff 50%;
        background-image: none;
        background-size: auto;
        background-size: cover;
        box-shadow: 0 15px 35px rgba(50, 50, 93, .1), 0 5px 15px rgba(0, 0, 0, .07);
    }

    /* .widget {
        line-height: 1.6em;
        word-wrap: break-word;
        font-size: 0.9em;
        padding-top: 15px;
        padding-left: -45px;
    } */
</style>




<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- shw2018 洪卫  modify 2019.08.15-->

<!-- 代码块修改的代码开始 -->
<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFunction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

<!-- 代码块修改代码结束 -->


<!-- 文章内容详情 -->
<div id="container">
    <div id="artDetail">
        <div class="card">
            <div class="card-content article-info">
                <div class="row tag-cate">
                    <div class="col s7">
                        
                        <div class="article-tag">
                            <!--我修改的地方：欧阳思海-->
                            
                            <a href="/tags/spring-spring%E6%95%99%E7%A8%8B-spring%E6%BA%90%E7%A0%81/" target="_blank">
                                <span class="chip bg-color">spring,spring教程,spring源码</span>
                            </a>
                            
                        </div>
                        
                    </div>
                    <div class="col s5 right-align">
                        
                        <div class="post-cate">
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/spring%E6%95%99%E7%A8%8B/" class="post-category" target="_blank">
                                spring教程
                            </a>
                            
                        </div>
                        
                    </div>
                </div>

                <div class="post-info">
                    <div class="post-date info-break-policy">
                        <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                        2021-04-05
                    </div>

                    <div class="post-author info-break-policy">
                        <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                        
                        欧阳思海
                        
                    </div>

                    
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        14.2k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        60 分
                    </div>
                    
                    

                    
                    <span id="busuanzi_container_site_pv" style='display:none'></span>
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>

                    

                </div>
            </div>
            <hr class="clearfix">
            <div class="card-content article-card-content">
                <!-- 欧阳思海，modify，2020.05.01-->
<!-- 文章详情详情页面的头部广告位置信息 -->
<div id="post-head-panel">
    
    <a href="https://github.com/OUYANGSIHAI/JavaInterview" style="font-size: 18px;" target="_blank">
        <img src="/icons/hot.gif">
        本人花费半年的时间总结的《Java面试指南》已拿腾讯等大厂offer，已开源在github ，欢迎star！
    </a>
    
    
</div>
<br />



<blockquote>
    
            <p>本文GitHub <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">https://github.com/OUYANGSIHAI/JavaInterview</a> 已收录，这是我花了6个月总结的<b>一线大厂Java面试</b>总结，本人已拿大厂offer，欢迎star</p>
    
    <p>原文链接：blog.ouyangsihai.cn &gt;&gt; <a href="/shen-ru-yuan-ma-fen-xi-springioc-er.html" target="_blank">深入源码分析SpringIOC（二）</a></p>
</blockquote>
                <div id="articleContent">
                    <h1 id="IOC之Bean的初始化（实例化与依赖注入）"><a href="#IOC之Bean的初始化（实例化与依赖注入）" class="headerlink" title="IOC之Bean的初始化（实例化与依赖注入）"></a>IOC之Bean的初始化（实例化与依赖注入）</h1><h3 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h3><li>
<ul>
- 
- 
<li>
<ul>
- 
- 
- 

<h2 id=""><a href="#" class="headerlink" title="- "></a>- </h2><p>- </p>
<p> </p>
<h2 id="前情概要"><a href="#前情概要" class="headerlink" title="前情概要"></a>前情概要</h2><p>回顾之前的内容IOC初始化之准备工作（定位、加载、注册） ，说到在<code class="java">
ApplicationContext</code>初始化时，会先去根据资源路径去定位、加载并且注册Bean信息到<code class="java">
BeanFactory</code>中，但此过程并未实例化，在结尾也说了，在调用<strong>BeanFactory</strong>的<strong>getBean</strong>方法时Bean才会真正实例化。那么在<code class="java">
ApplicationContext</code>中是什么时候去初始化Bean的呢？回顾一下<strong>refresh</strong>方法：</p>
<td class="line_numbers"><pre>1234567891011121314151617</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">@Overridepublic void refresh() throws BeansException, IllegalStateException {    synchronized (this.startupShutdownMonitor) {         // Tell the subclass to refresh the internal bean factory.        //告诉子类启动refreshBeanFactory()方法，Bean定义资源文件的载入从        //子类的refreshBeanFactory()方法启动        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();         //略...         // Instantiate all remaining (non-lazy-init) singletons.        //初始化所有剩余的单例Bean        finishBeanFactoryInitialization(beanFactory);         //略...}</pre></td>

<p>@Override<br>public void refresh() throws BeansException, IllegalStateException {<br>    synchronized (this.startupShutdownMonitor) {</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// Tell the subclass to refresh the internal bean factory.</span>
    <span class="token comment" spellcheck="true">//告诉子类启动refreshBeanFactory()方法，Bean定义资源文件的载入从</span>
    <span class="token comment" spellcheck="true">//子类的refreshBeanFactory()方法启动</span>
    ConfigurableListableBeanFactory beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment" spellcheck="true">//略...</span>
    
    <span class="token comment" spellcheck="true">// Instantiate all remaining (non-lazy-init) singletons.</span>
    <span class="token comment" spellcheck="true">//初始化所有剩余的单例Bean</span>
    <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//略...</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>由refresh方法可知，<code class="java">
ApplicationContext</code>将在方法接近末尾的时候去初始化Bean，但不是初始化所有Bean，而是作用域为singleton<strong>单例</strong>的且配置<strong>lazy-init&#x3D;false</strong>才会进行初始化Bean的操作。</p>
<td class="line_numbers"><pre>123456789</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//对配置了lazy-init属性的Bean进行预实例化处理protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) {     //略...     // Instantiate all remaining (non-lazy-init) singletons.    //对配置了lazy-init属性的单态模式Bean进行预实例化处理    beanFactory.preInstantiateSingletons();}</pre></td>

<p>&#x2F;&#x2F;对配置了lazy-init属性的Bean进行预实例化处理<br>protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">//略...</span>

<span class="token comment" spellcheck="true">// Instantiate all remaining (non-lazy-init) singletons.</span>
<span class="token comment" spellcheck="true">//对配置了lazy-init属性的单态模式Bean进行预实例化处理</span>
beanFactory<span class="token punctuation">.</span><span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>注意这里初始化方法还是委托给了我们上一篇文章说的BeanFactory去做，而不是<code class="java">
ApplicationContext</code>，对于很多操作Bean的场景大部分都是由<code class="java">
DefaultListableBeanFactory</code>去做。</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//对配置lazy-init属性单态Bean的预实例化@Overridepublic void preInstantiateSingletons() throws BeansException {     // Iterate over a copy to allow for init methods which in turn register new bean definitions.    // While this may not be part of the regular factory bootstrap, it does otherwise work fine.    ListString beanNames = new ArrayList(this.beanDefinitionNames);     // Trigger initialization of all non-lazy singleton beans...    //遍历所有的beanNames    for (String beanName : beanNames) {        //获取指定名称的Bean定义        RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);        //Bean不是抽象的，是单态模式的，且lazy-init属性配置为false        if (!bd.isAbstract() && bd.isSingleton() && !bd.isLazyInit()) {            //如果指定名称的bean是创建容器的Bean            if (isFactoryBean(beanName)) {                //FACTORY_BEAN_PREFIX=”&”，当Bean名称前面加”&”符号                //时，获取的是产生容器对象本身，而不是容器产生的Bean.                //调用getBean方法，触发容器对Bean实例化和依赖注入过程                final FactoryBean? factory = (FactoryBean?) getBean(FACTORY_BEAN_PREFIX + beanName);                //标识是否需要预实例化                boolean isEagerInit;                if (System.getSecurityManager() != null && factory instanceof SmartFactoryBean) {                    //一个匿名内部类                    isEagerInit = AccessController.doPrivileged((PrivilegedActionBoolean) () -                                                                ((SmartFactoryBean?) factory).isEagerInit(),                                                                getAccessControlContext());                }                else {                    isEagerInit = (factory instanceof SmartFactoryBean &&                                   ((SmartFactoryBean?) factory).isEagerInit());                }                if (isEagerInit) {                    //调用getBean方法，触发容器对Bean实例化和依赖注入过程                    getBean(beanName);                }            }            else {                getBean(beanName);            }        }    }     //略...}</pre></td>

<p>&#x2F;&#x2F;对配置lazy-init属性单态Bean的预实例化<br>@Override<br>public void preInstantiateSingletons() throws BeansException {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span>
<span class="token comment" spellcheck="true">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span>
ListString beanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Trigger initialization of all non-lazy singleton beans...</span>
<span class="token comment" spellcheck="true">//遍历所有的beanNames</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>String beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//获取指定名称的Bean定义</span>
    RootBeanDefinition bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//Bean不是抽象的，是单态模式的，且lazy-init属性配置为false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果指定名称的bean是创建容器的Bean</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//FACTORY_BEAN_PREFIX=”&amp;”，当Bean名称前面加”&amp;”符号</span>
            <span class="token comment" spellcheck="true">//时，获取的是产生容器对象本身，而不是容器产生的Bean.</span>
            <span class="token comment" spellcheck="true">//调用getBean方法，触发容器对Bean实例化和依赖注入过程</span>
            <span class="token keyword">final</span> FactoryBean<span class="token operator">?</span> factory <span class="token operator">=</span> <span class="token punctuation">(</span>FactoryBean<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token function">getBean</span><span class="token punctuation">(</span>FACTORY_BEAN_PREFIX <span class="token operator">+</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//标识是否需要预实例化</span>
            <span class="token keyword">boolean</span> isEagerInit<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//一个匿名内部类</span>
                isEagerInit <span class="token operator">=</span> AccessController<span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PrivilegedActionBoolean<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span>
                                                            <span class="token punctuation">(</span><span class="token punctuation">(</span>SmartFactoryBean<span class="token operator">?</span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEagerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                            <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                isEagerInit <span class="token operator">=</span> <span class="token punctuation">(</span>factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span> <span class="token operator">&amp;&amp;</span>
                               <span class="token punctuation">(</span><span class="token punctuation">(</span>SmartFactoryBean<span class="token operator">?</span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEagerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isEagerInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//调用getBean方法，触发容器对Bean实例化和依赖注入过程</span>
                <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//略...</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>可以看到，这里会<strong>遍历所有的Bean</strong>，如果是<strong>单例且lazy-init&#x3D;false</strong>才会进行初始化，而真正初始化的工作将从<strong>getBean方法</strong> 中展开。</p>
<h2 id="初始化Bean"><a href="#初始化Bean" class="headerlink" title="初始化Bean"></a>初始化Bean</h2><p>在BeanFactory继承体系结构中，可以看到<code class="java">
AbstractBeanFactory</code>这个抽象类实现了BeanFactory接口，自然在这个抽象类中会实现getBean方法：</p>
<td class="line_numbers"><pre>123456</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//获取IOC容器中指定名称的Bean@Overridepublic Object getBean(String name) throws BeansException {    //doGetBean才是真正向IoC容器获取被管理Bean的过程    return doGetBean(name, null, null, false);}</pre></td>

<p>&#x2F;&#x2F;获取IOC容器中指定名称的Bean<br>@Override<br>public Object getBean(String name) throws BeansException {<br>    &#x2F;&#x2F;doGetBean才是真正向IoC容器获取被管理Bean的过程<br>    return doGetBean(name, null, null, false);<br>}</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//真正实现向IOC容器获取Bean的功能，也是触发依赖注入功能的地方protected T T doGetBean(final String name, @Nullable final ClassT requiredType,                          @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {     //根据指定的名称获取被管理Bean的名称，剥离指定名称中对容器的相关依赖    //如果指定的是别名，将别名转换为规范的Bean名称    final String beanName = transformedBeanName(name);    Object bean;     // Eagerly check singleton cache for manually registered singletons.    //先从缓存中取是否已经有被创建过的单态类型的Bean    //对于单例模式的Bean整个IOC容器中只创建一次，不需要重复创建    Object sharedInstance = getSingleton(beanName);    //IOC容器创建单例模式Bean实例对象    if (sharedInstance != null && args == null) {        if (logger.isDebugEnabled()) {            //如果指定名称的Bean在容器中已有单例模式的Bean被创建            //直接返回已经创建的Bean            if (isSingletonCurrentlyInCreation(beanName)) {                logger.debug("Returning eagerly cached instance of singleton bean '" + beanName +                             "' that is not fully initialized yet - a consequence of a circular reference");            }            else {                logger.debug("Returning cached instance of singleton bean '" + beanName + "'");            }        }        //获取给定Bean的实例对象，主要是完成FactoryBean的相关处理        //注意：BeanFactory是管理容器中Bean的工厂，而FactoryBean是        //创建创建对象的工厂Bean，两者之间有区别        bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);    }     else {        // Fail if we're already creating this bean instance:        // We're assumably within a circular reference.        //缓存没有正在创建的单例模式Bean        //缓存中已经有已经创建的原型模式Bean        //但是由于循环引用的问题导致实例化对象失败        if (isPrototypeCurrentlyInCreation(beanName)) {            throw new BeanCurrentlyInCreationException(beanName);        }         // Check if bean definition exists in this factory.        //对IOC容器中是否存在指定名称的BeanDefinition进行检查，首先检查是否        //能在当前的BeanFactory中获取的所需要的Bean，如果不能则委托当前容器        //的父级容器去查找，如果还是找不到则沿着容器的继承体系向父级容器查找        BeanFactory parentBeanFactory = getParentBeanFactory();        //当前容器的父级容器存在，且当前容器中不存在指定名称的Bean        if (parentBeanFactory != null && !containsBeanDefinition(beanName)) {            // Not found - check parent.            //解析指定Bean名称的原始名称            String nameToLookup = originalBeanName(name);            if (parentBeanFactory instanceof AbstractBeanFactory) {                return ((AbstractBeanFactory) parentBeanFactory).doGetBean(                    nameToLookup, requiredType, args, typeCheckOnly);            }            else if (args != null) {                // Delegation to parent with explicit args.                //委派父级容器根据指定名称和显式的参数查找                return (T) parentBeanFactory.getBean(nameToLookup, args);            }            else {                // No args - delegate to standard getBean method.                //委派父级容器根据指定名称和类型查找                return parentBeanFactory.getBean(nameToLookup, requiredType);            }        }         //创建的Bean是否需要进行类型验证，一般不需要        if (!typeCheckOnly) {            //向容器标记指定的Bean已经被创建            markBeanAsCreated(beanName);        }         try {            //根据指定Bean名称获取其父级的Bean定义            //主要解决Bean继承时子类合并父类公共属性问题            final RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);            checkMergedBeanDefinition(mbd, beanName, args);             // Guarantee initialization of beans that the current bean depends on.            //获取当前Bean所有依赖Bean的名称            String[] dependsOn = mbd.getDependsOn();            //如果当前Bean有依赖Bean            if (dependsOn != null) {                for (String dep : dependsOn) {                    if (isDependent(beanName, dep)) {                        throw new BeanCreationException(mbd.getResourceDescription(), beanName,                                                        "Circular depends-on relationship between '" + beanName + "' and '" + dep + "'");                    }                    //递归调用getBean方法，获取当前Bean的依赖Bean                    registerDependentBean(dep, beanName);                    //把被依赖Bean注册给当前依赖的Bean                    getBean(dep);                }            }             // Create bean instance.            //创建单例模式Bean的实例对象            if (mbd.isSingleton()) {                //这里使用了一个匿名内部类，创建Bean实例对象，并且注册给所依赖的对象                sharedInstance = getSingleton(beanName, () - {                    try {                        //创建一个指定Bean实例对象，如果有父级继承，则合并子类和父类的定义                        return createBean(beanName, mbd, args);                    }                    catch (BeansException ex) {                        // Explicitly remove instance from singleton cache: It might have been put there                        // eagerly by the creation process, to allow for circular reference resolution.                        // Also remove any beans that received a temporary reference to the bean.                        //显式地从容器单例模式Bean缓存中清除实例对象                        destroySingleton(beanName);                        throw ex;                    }                });                //获取给定Bean的实例对象                bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);            }             //IOC容器创建原型模式Bean实例对象            else if (mbd.isPrototype()) {                // It's a prototype - create a new instance.                //原型模式(Prototype)是每次都会创建一个新的对象                Object prototypeInstance = null;                try {                    //回调beforePrototypeCreation方法，默认的功能是注册当前创建的原型对象                    beforePrototypeCreation(beanName);                    //创建指定Bean对象实例                    prototypeInstance = createBean(beanName, mbd, args);                }                finally {                    //回调afterPrototypeCreation方法，默认的功能告诉IOC容器指定Bean的原型对象不再创建                    afterPrototypeCreation(beanName);                }                //获取给定Bean的实例对象                bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);            }             //要创建的Bean既不是单例模式，也不是原型模式，则根据Bean定义资源中            //配置的生命周期范围，选择实例化Bean的合适方法，这种在Web应用程序中            //比较常用，如：request、session、application等生命周期            else {                String scopeName = mbd.getScope();                final Scope scope = this.scopes.get(scopeName);                //Bean定义资源中没有配置生命周期范围，则Bean定义不合法                if (scope == null) {                    throw new IllegalStateException("No Scope registered for scope name '" + scopeName + "'");                }                try {                    //这里又使用了一个匿名内部类，获取一个指定生命周期范围的实例                    Object scopedInstance = scope.get(beanName, () - {                        beforePrototypeCreation(beanName);                        try {                            return createBean(beanName, mbd, args);                        }                        finally {                            afterPrototypeCreation(beanName);                        }                    });                    //获取给定Bean的实例对象                    bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);                }                catch (IllegalStateException ex) {                    throw new BeanCreationException(beanName,                                                    "Scope '" + scopeName + "' is not active for the current thread; consider " +                                                    "defining a scoped proxy for this bean if you intend to refer to it from a singleton",                                                    ex);                }            }        }        catch (BeansException ex) {            cleanupAfterBeanCreationFailure(beanName);            throw ex;        }    }     // Check if required type matches the type of the actual bean instance.    //对创建的Bean实例对象进行类型检查    if (requiredType != null && !requiredType.isInstance(bean)) {        try {            T convertedBean = getTypeConverter().convertIfNecessary(bean, requiredType);            if (convertedBean == null) {                throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());            }            return convertedBean;        }        catch (TypeMismatchException ex) {            if (logger.isDebugEnabled()) {                logger.debug("Failed to convert bean '" + name + "' to required type '" +                             ClassUtils.getQualifiedName(requiredType) + "'", ex);            }            throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());        }    }    return (T) bean;}</pre></td>

<p>&#x2F;&#x2F;真正实现向IOC容器获取Bean的功能，也是触发依赖注入功能的地方<br>protected  T doGetBean(final String name, @Nullable final Class requiredType,<br>                          @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">//根据指定的名称获取被管理Bean的名称，剥离指定名称中对容器的相关依赖</span>
<span class="token comment" spellcheck="true">//如果指定的是别名，将别名转换为规范的Bean名称</span>
<span class="token keyword">final</span> String beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
Object bean<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Eagerly check singleton cache for manually registered singletons.</span>
<span class="token comment" spellcheck="true">//先从缓存中取是否已经有被创建过的单态类型的Bean</span>
<span class="token comment" spellcheck="true">//对于单例模式的Bean整个IOC容器中只创建一次，不需要重复创建</span>
Object sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//IOC容器创建单例模式Bean实例对象</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果指定名称的Bean在容器中已有单例模式的Bean被创建</span>
        <span class="token comment" spellcheck="true">//直接返回已经创建的Bean</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Returning eagerly cached instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
                         <span class="token string">"' that is not fully initialized yet - a consequence of a circular reference"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Returning cached instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//获取给定Bean的实例对象，主要是完成FactoryBean的相关处理</span>
    <span class="token comment" spellcheck="true">//注意：BeanFactory是管理容器中Bean的工厂，而FactoryBean是</span>
    <span class="token comment" spellcheck="true">//创建创建对象的工厂Bean，两者之间有区别</span>
    bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fail if we're already creating this bean instance:</span>
    <span class="token comment" spellcheck="true">// We're assumably within a circular reference.</span>
    <span class="token comment" spellcheck="true">//缓存没有正在创建的单例模式Bean</span>
    <span class="token comment" spellcheck="true">//缓存中已经有已经创建的原型模式Bean</span>
    <span class="token comment" spellcheck="true">//但是由于循环引用的问题导致实例化对象失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Check if bean definition exists in this factory.</span>
    <span class="token comment" spellcheck="true">//对IOC容器中是否存在指定名称的BeanDefinition进行检查，首先检查是否</span>
    <span class="token comment" spellcheck="true">//能在当前的BeanFactory中获取的所需要的Bean，如果不能则委托当前容器</span>
    <span class="token comment" spellcheck="true">//的父级容器去查找，如果还是找不到则沿着容器的继承体系向父级容器查找</span>
    BeanFactory parentBeanFactory <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//当前容器的父级容器存在，且当前容器中不存在指定名称的Bean</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Not found - check parent.</span>
        <span class="token comment" spellcheck="true">//解析指定Bean名称的原始名称</span>
        String nameToLookup <span class="token operator">=</span> <span class="token function">originalBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>AbstractBeanFactory<span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doGetBean</span><span class="token punctuation">(</span>
                nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> args<span class="token punctuation">,</span> typeCheckOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Delegation to parent with explicit args.</span>
            <span class="token comment" spellcheck="true">//委派父级容器根据指定名称和显式的参数查找</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// No args - delegate to standard getBean method.</span>
            <span class="token comment" spellcheck="true">//委派父级容器根据指定名称和类型查找</span>
            <span class="token keyword">return</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//创建的Bean是否需要进行类型验证，一般不需要</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>typeCheckOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//向容器标记指定的Bean已经被创建</span>
        <span class="token function">markBeanAsCreated</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//根据指定Bean名称获取其父级的Bean定义</span>
        <span class="token comment" spellcheck="true">//主要解决Bean继承时子类合并父类公共属性问题</span>
        <span class="token keyword">final</span> RootBeanDefinition mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkMergedBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Guarantee initialization of beans that the current bean depends on.</span>
        <span class="token comment" spellcheck="true">//获取当前Bean所有依赖Bean的名称</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> dependsOn <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//如果当前Bean有依赖Bean</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dependsOn <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String dep <span class="token operator">:</span> dependsOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDependent</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                                    <span class="token string">"Circular depends-on relationship between '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' and '"</span> <span class="token operator">+</span> dep <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">//递归调用getBean方法，获取当前Bean的依赖Bean</span>
                <span class="token function">registerDependentBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//把被依赖Bean注册给当前依赖的Bean</span>
                <span class="token function">getBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Create bean instance.</span>
        <span class="token comment" spellcheck="true">//创建单例模式Bean的实例对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//这里使用了一个匿名内部类，创建Bean实例对象，并且注册给所依赖的对象</span>
            sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//创建一个指定Bean实例对象，如果有父级继承，则合并子类和父类的定义</span>
                    <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Explicitly remove instance from singleton cache: It might have been put there</span>
                    <span class="token comment" spellcheck="true">// eagerly by the creation process, to allow for circular reference resolution.</span>
                    <span class="token comment" spellcheck="true">// Also remove any beans that received a temporary reference to the bean.</span>
                    <span class="token comment" spellcheck="true">//显式地从容器单例模式Bean缓存中清除实例对象</span>
                    <span class="token function">destroySingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//获取给定Bean的实例对象</span>
            bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//IOC容器创建原型模式Bean实例对象</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// It's a prototype - create a new instance.</span>
            <span class="token comment" spellcheck="true">//原型模式(Prototype)是每次都会创建一个新的对象</span>
            Object prototypeInstance <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//回调beforePrototypeCreation方法，默认的功能是注册当前创建的原型对象</span>
                <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//创建指定Bean对象实例</span>
                prototypeInstance <span class="token operator">=</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//回调afterPrototypeCreation方法，默认的功能告诉IOC容器指定Bean的原型对象不再创建</span>
                <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//获取给定Bean的实例对象</span>
            bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>prototypeInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//要创建的Bean既不是单例模式，也不是原型模式，则根据Bean定义资源中</span>
        <span class="token comment" spellcheck="true">//配置的生命周期范围，选择实例化Bean的合适方法，这种在Web应用程序中</span>
        <span class="token comment" spellcheck="true">//比较常用，如：request、session、application等生命周期</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            String scopeName <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Scope scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scopeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//Bean定义资源中没有配置生命周期范围，则Bean定义不合法</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No Scope registered for scope name '"</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//这里又使用了一个匿名内部类，获取一个指定生命周期范围的实例</span>
                Object scopedInstance <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">{</span>
                    <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//获取给定Bean的实例对象</span>
                bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>scopedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                                                <span class="token string">"Scope '"</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">"' is not active for the current thread; consider "</span> <span class="token operator">+</span>
                                                <span class="token string">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span><span class="token punctuation">,</span>
                                                ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cleanupAfterBeanCreationFailure</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Check if required type matches the type of the actual bean instance.</span>
<span class="token comment" spellcheck="true">//对创建的Bean实例对象进行类型检查</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requiredType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        T convertedBean <span class="token operator">=</span> <span class="token function">getTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>convertedBean <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> convertedBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TypeMismatchException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Failed to convert bean '"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"' to required type '"</span> <span class="token operator">+</span>
                         ClassUtils<span class="token punctuation">.</span><span class="token function">getQualifiedName</span><span class="token punctuation">(</span>requiredType<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>在doGetBean方法中，其实做了很多事，这里一一解释：</p>
<ol>
<li>首先调用 <strong>getSingleton(beanName);</strong> 方法，先尝试获取一个单例实例，这个方法解决了循环依赖的问题，下面我会详细的说明。</li>
<li>如果尝试获取的实例不存在当前IOC容器，如果父容器不为空会去父容器中获取Bean。<li>经过以上步骤都没有获取到Bean实例的话，先寻找所有依赖的Bean，对依赖的Bean循环调用getBean()方法（依赖Bean有可能为单例，此时如果是单例Bean的话这样做的目的第一是先将此Bean初始化，第二是会将其缓存下来，等之后依赖注入会用到）
<ul></li>
<li>如果是<strong>单例</strong>Bean：调用<strong>getSingleton</strong>方法，其第二个参数<code class="java">
ObjectFactory</code>是一个<strong>功能接口</strong>，里面有一个模板提供方法，<strong>getObject</strong>，调用方法返回实例，所以在外面调用<strong>getSingleton</strong>方法时使用匿名类方式将子类<strong>createBean</strong>方法赋给<code class="java">
ObjectFactory</code>对象的<strong>getObject</strong>方法，便于在<strong>getSingleton</strong>方法中可以调用。这里是一个<strong>面向函数式编程思想</strong> 。这里多一层<strong>getSingleton</strong>方法是为了<strong>解决循环依赖问题</strong> ，下面会详细解释。</li>
<li>如果是<strong>原型</strong>Bean：直接调用子类<strong>createBean</strong>方法，因为其不需要经过一些循环依赖步骤，换言之，如果有原型Bean循环依赖了，是不能解决的，会抛出异常。</li>
<li>如果是<strong>其他scope</strong>的Bean：会设置其scope，然后同样是调用<strong>createBean</strong>去创建。</ul>
</li></li>
</ol>
<p>到这里我们应该要明白了，真正去创建Bean的方法是<strong>createBean</strong>：</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//创建Bean实例对象@Overrideprotected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)    throws BeanCreationException {     if (logger.isDebugEnabled()) {        logger.debug("Creating instance of bean '" + beanName + "'");    }    RootBeanDefinition mbdToUse = mbd;     // Make sure bean class is actually resolved at this point, and    // clone the bean definition in case of a dynamically resolved Class    // which cannot be stored in the shared merged bean definition.    //判断需要创建的Bean是否可以实例化，即是否可以通过当前的类加载器加载    Class? resolvedClass = resolveBeanClass(mbd, beanName);    if (resolvedClass != null && !mbd.hasBeanClass() && mbd.getBeanClassName() != null) {        mbdToUse = new RootBeanDefinition(mbd);        mbdToUse.setBeanClass(resolvedClass);    }     //略...     try {        // Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.        //如果Bean配置了初始化前和初始化后的处理器，则试图返回一个需要创建Bean的代理对象        Object bean = resolveBeforeInstantiation(beanName, mbdToUse);        if (bean != null) {            return bean;        }    }    catch (Throwable ex) {        throw new BeanCreationException(mbdToUse.getResourceDescription(), beanName,                                        "BeanPostProcessor before instantiation of bean failed", ex);    }     try {        //创建Bean的入口        Object beanInstance = doCreateBean(beanName, mbdToUse, args);        if (logger.isDebugEnabled()) {            logger.debug("Finished creating instance of bean '" + beanName + "'");        }        return beanInstance;    }     //略...}</pre></td>

<p>&#x2F;&#x2F;创建Bean实例对象<br>@Override<br>protected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)<br>    throws BeanCreationException {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Creating instance of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
RootBeanDefinition mbdToUse <span class="token operator">=</span> mbd<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Make sure bean class is actually resolved at this point, and</span>
<span class="token comment" spellcheck="true">// clone the bean definition in case of a dynamically resolved Class</span>
<span class="token comment" spellcheck="true">// which cannot be stored in the shared merged bean definition.</span>
<span class="token comment" spellcheck="true">//判断需要创建的Bean是否可以实例化，即是否可以通过当前的类加载器加载</span>
Class<span class="token operator">?</span> resolvedClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedClass <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mbdToUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mbdToUse<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span>resolvedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//略...</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span>
    <span class="token comment" spellcheck="true">//如果Bean配置了初始化前和初始化后的处理器，则试图返回一个需要创建Bean的代理对象</span>
    Object bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                    <span class="token string">"BeanPostProcessor before instantiation of bean failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//创建Bean的入口</span>
    Object beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Finished creating instance of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//略...</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>这里也分步骤进行解读：</p>
<ol>
<li>首先会先判断此Bean是否可以实例化。</li>
<li>然后此时会调用<strong>resolveBeforeInstantiation</strong>方法，这是一个通知回调方法，会将此时的Bean的Class与BeanName传入容器中实现了<code class="java">
InstantiationAwareBeanPostProcessor</code>接口的方法<strong>postProcessBeforeInstantiation</strong>。举个例子<code class="java">
AbstractAutoProxyCreator</code>这个类实现了<code class="java">
BeanPostProcessor</code>这个接口来完成AOP代理，但它同时也实现了<code class="java">
InstantiationAwareBeanPostProcessor</code>这个接口，这个接口的方法调用时间即为上述Bean实例化与依赖注入之前（<strong>doCreateBean</strong> 才真正进行Bean实例化与依赖注入）。如果关于<code class="java">
BeanPostProcessor</code>的知识不懂的话，可以看看下一章我会讲到Spring的自定义扩展方式，然后下下章讲到AOP的时候也会详细讲解<code class="java">
AbstractAutoProxyCreator</code>实现<code class="java">
InstantiationAwareBeanPostProcessor</code>接口的真正作用，这里读者只要记住，<code class="java">
InstantiationAwareBeanPostProcessor</code>的调用时机是在Bean实例化以前。</li>
<li>如果此时<code class="java">
InstantiationAwareBeanPostProcessor</code>的回调方法没有获取到Bean（自定义扩展的内容，说明没有进行自定义扩展），那么进入真正创建Bean的方法<strong>doCreateBean</strong>。<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//真正创建Bean的方法protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)    throws BeanCreationException {     // Instantiate the bean.    //封装被创建的Bean对象    BeanWrapper instanceWrapper = null;    if (mbd.isSingleton()) {        instanceWrapper = this.factoryBeanInstanceCache.remove(beanName);    }    if (instanceWrapper == null) {        instanceWrapper = createBeanInstance(beanName, mbd, args);    }    final Object bean = instanceWrapper.getWrappedInstance();    //获取实例化对象的类型    Class? beanType = instanceWrapper.getWrappedClass();    if (beanType != NullBean.class) {        mbd.resolvedTargetType = beanType;    }     // Allow post-processors to modify the merged bean definition.    //调用PostProcessor后置处理器    synchronized (mbd.postProcessingLock) {        if (!mbd.postProcessed) {            try {                applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);            }            catch (Throwable ex) {                throw new BeanCreationException(mbd.getResourceDescription(), beanName,                                                "Post-processing of merged bean definition failed", ex);            }            mbd.postProcessed = true;        }    }     // Eagerly cache singletons to be able to resolve circular references    // even when triggered by lifecycle interfaces like BeanFactoryAware.    //向容器中缓存单例模式的Bean对象，以防循环引用    boolean earlySingletonExposure = (mbd.isSingleton() && this.allowCircularReferences &&                                      isSingletonCurrentlyInCreation(beanName));    if (earlySingletonExposure) {        if (logger.isDebugEnabled()) {            logger.debug("Eagerly caching bean '" + beanName +                         "' to allow for resolving potential circular references");        }        //这里是一个匿名内部类，为了防止循环引用，尽早持有对象的引用        addSingletonFactory(beanName, () - getEarlyBeanReference(beanName, mbd, bean));    }     // Initialize the bean instance.    //Bean对象的初始化，依赖注入在此触发    //这个exposedObject在初始化完成之后返回作为依赖注入完成后的Bean    Object exposedObject = bean;    try {        //将Bean实例对象封装，并且Bean定义中配置的属性值赋值给实例对象        populateBean(beanName, mbd, instanceWrapper);        //初始化Bean对象        exposedObject = initializeBean(beanName, exposedObject, mbd);    }    catch (Throwable ex) {        if (ex instanceof BeanCreationException && beanName.equals(((BeanCreationException) ex).getBeanName())) {            throw (BeanCreationException) ex;        }        else {            //抛异常..略...        }    }     if (earlySingletonExposure) {        //获取指定名称的已注册的单例模式Bean对象        Object earlySingletonReference = getSingleton(beanName, false);        if (earlySingletonReference != null) {            //根据名称获取的已注册的Bean和正在实例化的Bean是同一个            if (exposedObject == bean) {                //当前实例化的Bean初始化完成                exposedObject = earlySingletonReference;            }            //当前Bean依赖其他Bean，并且当发生循环引用时不允许新创建实例对象            else if (!this.allowRawInjectionDespiteWrapping && hasDependentBean(beanName)) {                String[] dependentBeans = getDependentBeans(beanName);                SetString actualDependentBeans = new LinkedHashSet(dependentBeans.length);                //获取当前Bean所依赖的其他Bean                for (String dependentBean : dependentBeans) {                    //对依赖Bean进行类型检查                    if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) {                        actualDependentBeans.add(dependentBean);                    }                }                 //略...             }        }    }     // Register bean as disposable.    //注册完成依赖注入的Bean    try {        registerDisposableBeanIfNecessary(beanName, bean, mbd);    }    catch (BeanDefinitionValidationException ex) {        throw new BeanCreationException(            mbd.getResourceDescription(), beanName, "Invalid destruction signature", ex);    }     return exposedObject;}</pre></td></li>
</ol>
<p>&#x2F;&#x2F;真正创建Bean的方法<br>protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)<br>    throws BeanCreationException {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// Instantiate the bean.</span>
<span class="token comment" spellcheck="true">//封装被创建的Bean对象</span>
BeanWrapper instanceWrapper <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">final</span> Object bean <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//获取实例化对象的类型</span>
Class<span class="token operator">?</span> beanType <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>beanType <span class="token operator">!=</span> NullBean<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mbd<span class="token punctuation">.</span>resolvedTargetType <span class="token operator">=</span> beanType<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Allow post-processors to modify the merged bean definition.</span>
<span class="token comment" spellcheck="true">//调用PostProcessor后置处理器</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>postProcessingLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span>postProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                            <span class="token string">"Post-processing of merged bean definition failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mbd<span class="token punctuation">.</span>postProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Eagerly cache singletons to be able to resolve circular references</span>
<span class="token comment" spellcheck="true">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
<span class="token comment" spellcheck="true">//向容器中缓存单例模式的Bean对象，以防循环引用</span>
<span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span>
                                  <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Eagerly caching bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
                     <span class="token string">"' to allow for resolving potential circular references"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//这里是一个匿名内部类，为了防止循环引用，尽早持有对象的引用</span>
    <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Initialize the bean instance.</span>
<span class="token comment" spellcheck="true">//Bean对象的初始化，依赖注入在此触发</span>
<span class="token comment" spellcheck="true">//这个exposedObject在初始化完成之后返回作为依赖注入完成后的Bean</span>
Object exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//将Bean实例对象封装，并且Bean定义中配置的属性值赋值给实例对象</span>
    <span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//初始化Bean对象</span>
    exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">BeanCreationException</span> <span class="token operator">&amp;&amp;</span> beanName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BeanCreationException<span class="token punctuation">)</span> ex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token punctuation">(</span>BeanCreationException<span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//抛异常..略...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//获取指定名称的已注册的单例模式Bean对象</span>
    Object earlySingletonReference <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonReference <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//根据名称获取的已注册的Bean和正在实例化的Bean是同一个</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">==</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//当前实例化的Bean初始化完成</span>
            exposedObject <span class="token operator">=</span> earlySingletonReference<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//当前Bean依赖其他Bean，并且当发生循环引用时不允许新创建实例对象</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowRawInjectionDespiteWrapping <span class="token operator">&amp;&amp;</span> <span class="token function">hasDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> dependentBeans <span class="token operator">=</span> <span class="token function">getDependentBeans</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            SetString actualDependentBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token punctuation">(</span>dependentBeans<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//获取当前Bean所依赖的其他Bean</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String dependentBean <span class="token operator">:</span> dependentBeans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//对依赖Bean进行类型检查</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">removeSingletonIfCreatedForTypeCheckOnly</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    actualDependentBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment" spellcheck="true">//略...</span>
            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Register bean as disposable.</span>
<span class="token comment" spellcheck="true">//注册完成依赖注入的Bean</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
        mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Invalid destruction signature"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<ol>
<li>创建完成的Bean实例，其实又被Spring封装了一层，最终封装Bean为<code class="java">
BeanWrapper</code>，此封装类存放Bean实例对象、Bean的Class类型等。<strong>createBeanInstance(beanName, mbd, args)</strong> 方法会实例化Bean，并且封装成<code class="java">
BeanWrapper</code>返回。注意此时仅仅只是调用构造器实例化Bean而已。</li>
<li>在实例化Bean之后，如果该Bean是单例且允许循环依赖（可在配置中配置此属性），在此为了解决循环引用，提前将对象引用暴露出来，下面会提到循环引用的解决方法。</li>
<li>到这里Bean已经实例化好了，接下来调用<strong>populateBean(beanName, mbd, instanceWrapper)</strong> 方法进行依赖注入。</li>
<li>此时的Bean已是实例化且依赖注入好的Bean，接着会调用<strong>initializeBean(beanName, exposedObject, mbd)</strong> 方法，该方法是一个回调通知方法，在扩展Spring中会详细解释，这里只要记住，在这个时机Spring提供出了一个回调方法可供扩展。</li>
<li>调用 <strong>registerDisposableBeanIfNecessary(beanName, bean, mbd);</strong> 方法注册此Bean。</li>
</ol>
<h2 id="解决循环依赖的问题"><a href="#解决循环依赖的问题" class="headerlink" title="解决循环依赖的问题"></a>解决循环依赖的问题</h2><h3 id="什么是循环依赖？"><a href="#什么是循环依赖？" class="headerlink" title="什么是循环依赖？"></a>什么是循环依赖？</h3><p>假设aBean中需要依赖bBean，而bBean中也需要依赖aBean，这时初始化aBean时，需要进行依赖注入，所以需要初始化bBean，而在bBean初始化时又需要依赖注入，此时需要一个aBean，这就造成了一个死锁，aBean在等待bBean初始化好，才能完成aBean的初始化，而bBean又在等待aBean初始化好，才能完成bBean的初始化，那么在Spring中是如何解决这种循环依赖问题的呢？</p>
<h3 id="Spring中如何解决循环依赖"><a href="#Spring中如何解决循环依赖" class="headerlink" title="Spring中如何解决循环依赖"></a>Spring中如何解决循环依赖</h3><p>让我们回顾一下时序，我们先是调用了getBean方法，接着调用doGetBean方法真正去获取Bean，不知读者是否还记得，此时会先去调用<strong>getSingleton(beanName)</strong> 方法，尝试获取一个单例实例：</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">@Nullableprotected Object getSingleton(String beanName, boolean allowEarlyReference) {    //尝试先从singletonObjects获取实例    Object singletonObject = this.singletonObjects获取实例.get(beanName);    //如果singletonObjects没有存放此Bean的实例的话，获取早期暴露的实例    if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {        synchronized (this.singletonObjects) {            //先尝试从早期暴露缓存earlySingletonObjects中获取            singletonObject = this.earlySingletonObjects.get(beanName);            //早期暴露的缓存没有的话，去早期暴露的Map中获取            if (singletonObject == null && allowEarlyReference) {                //singletonFactories此Map即为早期暴露的Map                ObjectFactory? singletonFactory = this.singletonFactories.get(beanName);                //如果可以获取到早期暴露的对象的话                if (singletonFactory != null) {                    //从此singletonFactory中获取Bean实例                    singletonObject = singletonFactory.getObject();                    //存放在早期暴露的缓存中，下次取只需要从earlySingletonObjects拿即可                    this.earlySingletonObjects.put(beanName, singletonObject);                    //由于已经存放在缓存中，singletonFactories继续存放没有意义，移除                    this.singletonFactories.remove(beanName);                }            }        }    }    return singletonObject;}</pre></td>

<p>@Nullable<br>protected Object getSingleton(String beanName, boolean allowEarlyReference) {<br>    &#x2F;&#x2F;尝试先从singletonObjects获取实例<br>    Object singletonObject &#x3D; this.singletonObjects获取实例.get(beanName);<br>    &#x2F;&#x2F;如果singletonObjects没有存放此Bean的实例的话，获取早期暴露的实例<br>    if (singletonObject &#x3D;&#x3D; null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) {<br>        synchronized (this.singletonObjects) {<br>            &#x2F;&#x2F;先尝试从早期暴露缓存earlySingletonObjects中获取<br>            singletonObject &#x3D; this.earlySingletonObjects.get(beanName);<br>            &#x2F;&#x2F;早期暴露的缓存没有的话，去早期暴露的Map中获取<br>            if (singletonObject &#x3D;&#x3D; null &amp;&amp; allowEarlyReference) {<br>                &#x2F;&#x2F;singletonFactories此Map即为早期暴露的Map<br>                ObjectFactory? singletonFactory &#x3D; this.singletonFactories.get(beanName);<br>                &#x2F;&#x2F;如果可以获取到早期暴露的对象的话<br>                if (singletonFactory !&#x3D; null) {<br>                    &#x2F;&#x2F;从此singletonFactory中获取Bean实例<br>                    singletonObject &#x3D; singletonFactory.getObject();<br>                    &#x2F;&#x2F;存放在早期暴露的缓存中，下次取只需要从earlySingletonObjects拿即可<br>                    this.earlySingletonObjects.put(beanName, singletonObject);<br>                    &#x2F;&#x2F;由于已经存放在缓存中，singletonFactories继续存放没有意义，移除<br>                    this.singletonFactories.remove(beanName);<br>                }<br>            }<br>        }<br>    }<br>    return singletonObject;<br>}</p>
<p>此时读者需要记住几个Map，关注接下来的方法它们的put时机和put的value到底是什么：</p>
<ol>
<li><strong>singletonObjects</strong>：存放单例Bean的一个Map。</li>
<li><strong>earlySingletonObjects</strong> ：早期暴露的缓存，在获取早期暴露对象之后会进行缓存。</li>
<li><strong>singletonFactories</strong> ：关键解决了循环依赖问题的一个Map对象，方式是过早暴露Bean引用。需要关注的点是它的value是一个<code class="java">
ObjectFactory</code>对象，此时依然是<strong>面向函数式编程</strong> ，此接口只是一个功能暴露接口，也就是最终调用<strong>singletonFactory.getObject();</strong> 的方法为关键，该方法获取早期Bean实例。</li>
</ol>
<p>接着回忆一下，在尝试调用<strong>getSingleton</strong>方法未获得对象时，会判断是否为单例，如果Bean为单例则会调用<strong>getSingleton(String beanName, ObjectFactory? singletonFactory)</strong> 方法，注意此时的方法与上面的参数不一样，重载方法：</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public Object getSingleton(String beanName, ObjectFactory? singletonFactory) {    Assert.notNull(beanName, "Bean name must not be null");    //此过程需要进行同步处理    synchronized (this.singletonObjects) {        //依然先尝试从singletonObjects中获取        Object singletonObject = this.singletonObjects.get(beanName);        //获取不到的话        if (singletonObject == null) {            //如果此时单例Bean已经是在创建了，由于是单例的Bean，所以需要抛出异常            if (this.singletonsCurrentlyInDestruction) {                throw new BeanCreationNotAllowedException(beanName,                                                          "Singleton bean creation not allowed while singletons of this factory are in destruction " +                                                          "(Do not request a bean from a BeanFactory in a destroy method implementation!)");            }            if (logger.isDebugEnabled()) {                logger.debug("Creating shared instance of singleton bean '" + beanName + "'");            }            //此时就是上述提到的创建Bean的标识，在此标记此Bean已经正在创建            beforeSingletonCreation(beanName);            boolean newSingleton = false;            boolean recordSuppressedExceptions = (this.suppressedExceptions == null);            if (recordSuppressedExceptions) {                this.suppressedExceptions = new LinkedHashSet();            }            try {                //面向函数编程，调用功能接口中的方法获取单例Bean，getObject方法的实现                //在调用getSingleton之前就已经使用匿名类的方式传入                singletonObject = singletonFactory.getObject();                newSingleton = true;            }            catch (IllegalStateException ex) {                // Has the singleton object implicitly appeared in the meantime -                // if yes, proceed with it since the exception indicates that state.                singletonObject = this.singletonObjects.get(beanName);                if (singletonObject == null) {                    throw ex;                }            }            catch (BeanCreationException ex) {                if (recordSuppressedExceptions) {                    for (Exception suppressedException : this.suppressedExceptions) {                        ex.addRelatedCause(suppressedException);                    }                }                throw ex;            }            finally {                if (recordSuppressedExceptions) {                    this.suppressedExceptions = null;                }                //此时移除Bean创建的标识，表示此Bean不在创建时间了，已经创建完成                afterSingletonCreation(beanName);            }            if (newSingleton) {                //此时会将创建好了的Bean存入单例Map中                addSingleton(beanName, singletonObject);            }        }        return singletonObject;    }}</pre></td>

<p>public Object getSingleton(String beanName, ObjectFactory? singletonFactory) {<br>    Assert.notNull(beanName, “Bean name must not be null”);<br>    &#x2F;&#x2F;此过程需要进行同步处理<br>    synchronized (this.singletonObjects) {<br>        &#x2F;&#x2F;依然先尝试从singletonObjects中获取<br>        Object singletonObject &#x3D; this.singletonObjects.get(beanName);<br>        &#x2F;&#x2F;获取不到的话<br>        if (singletonObject &#x3D;&#x3D; null) {<br>            &#x2F;&#x2F;如果此时单例Bean已经是在创建了，由于是单例的Bean，所以需要抛出异常<br>            if (this.singletonsCurrentlyInDestruction) {<br>                throw new BeanCreationNotAllowedException(beanName,<br>                                                          “Singleton bean creation not allowed while singletons of this factory are in destruction “ +<br>                                                          “(Do not request a bean from a BeanFactory in a destroy method implementation!)”);<br>            }<br>            if (logger.isDebugEnabled()) {<br>                logger.debug(“Creating shared instance of singleton bean ‘“ + beanName + “‘“);<br>            }<br>            &#x2F;&#x2F;此时就是上述提到的创建Bean的标识，在此标记此Bean已经正在创建<br>            beforeSingletonCreation(beanName);<br>            boolean newSingleton &#x3D; false;<br>            boolean recordSuppressedExceptions &#x3D; (this.suppressedExceptions &#x3D;&#x3D; null);<br>            if (recordSuppressedExceptions) {<br>                this.suppressedExceptions &#x3D; new LinkedHashSet();<br>            }<br>            try {<br>                &#x2F;&#x2F;面向函数编程，调用功能接口中的方法获取单例Bean，getObject方法的实现<br>                &#x2F;&#x2F;在调用getSingleton之前就已经使用匿名类的方式传入<br>                singletonObject &#x3D; singletonFactory.getObject();<br>                newSingleton &#x3D; true;<br>            }<br>            catch (IllegalStateException ex) {<br>                &#x2F;&#x2F; Has the singleton object implicitly appeared in the meantime -<br>                &#x2F;&#x2F; if yes, proceed with it since the exception indicates that state.<br>                singletonObject &#x3D; this.singletonObjects.get(beanName);<br>                if (singletonObject &#x3D;&#x3D; null) {<br>                    throw ex;<br>                }<br>            }<br>            catch (BeanCreationException ex) {<br>                if (recordSuppressedExceptions) {<br>                    for (Exception suppressedException : this.suppressedExceptions) {<br>                        ex.addRelatedCause(suppressedException);<br>                    }<br>                }<br>                throw ex;<br>            }<br>            finally {<br>                if (recordSuppressedExceptions) {<br>                    this.suppressedExceptions &#x3D; null;<br>                }<br>                &#x2F;&#x2F;此时移除Bean创建的标识，表示此Bean不在创建时间了，已经创建完成<br>                afterSingletonCreation(beanName);<br>            }<br>            if (newSingleton) {<br>                &#x2F;&#x2F;此时会将创建好了的Bean存入单例Map中<br>                addSingleton(beanName, singletonObject);<br>            }<br>        }<br>        return singletonObject;<br>    }<br>}</p>
<td class="line_numbers"><pre>123456789101112</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">protected void addSingleton(String beanName, Object singletonObject) {    //需要同步处理    synchronized (this.singletonObjects) {        //加入singletonObjects以供后续getBean时直接获取实例        this.singletonObjects.put(beanName, singletonObject);        //将早期暴露的实例移除，就算不移除这里也没有用了，因为根本不会有进入此Map的时机        this.singletonFactories.remove(beanName);        //这里就更不用说了，不会有进入此Map的时机        this.earlySingletonObjects.remove(beanName);        this.registeredSingletons.add(beanName);    }}</pre></td>

<p>protected void addSingleton(String beanName, Object singletonObject) {<br>    &#x2F;&#x2F;需要同步处理<br>    synchronized (this.singletonObjects) {<br>        &#x2F;&#x2F;加入singletonObjects以供后续getBean时直接获取实例<br>        this.singletonObjects.put(beanName, singletonObject);<br>        &#x2F;&#x2F;将早期暴露的实例移除，就算不移除这里也没有用了，因为根本不会有进入此Map的时机<br>        this.singletonFactories.remove(beanName);<br>        &#x2F;&#x2F;这里就更不用说了，不会有进入此Map的时机<br>        this.earlySingletonObjects.remove(beanName);<br>        this.registeredSingletons.add(beanName);<br>    }<br>}</p>
<p>由于此时已经将完整的Bean（实例化以及依赖注入完成）创建出来了，所以直接放入<strong>singletonObjects</strong>这个Map中，以供后续<strong>getBean</strong>时就可以直接取出。如果你还记得上面我让你记住的那几个Map的话，此时你应该可以有一个承上启下的感觉，<strong>singletonObjects是在初始化Bean完成时才会put实例</strong> 。</p>
<p>此时我们回到创建单例Bean中：</p>
<td class="line_numbers"><pre>123456789101112131415161718192021</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// Create bean instance.//创建单例模式Bean的实例对象if (mbd.isSingleton()) {    //这里使用了一个匿名内部类，创建Bean实例对象，并且注册给所依赖的对象    sharedInstance = getSingleton(beanName, () - {        try {            //创建一个指定Bean实例对象，如果有父级继承，则合并子类和父类的定义            return createBean(beanName, mbd, args);        }        catch (BeansException ex) {            // Explicitly remove instance from singleton cache: It might have been put there            // eagerly by the creation process, to allow for circular reference resolution.            // Also remove any beans that received a temporary reference to the bean.            //显式地从容器单例模式Bean缓存中清除实例对象            destroySingleton(beanName);            throw ex;        }    });    //获取给定Bean的实例对象    bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);}</pre></td>

<p>&#x2F;&#x2F; Create bean instance.<br>&#x2F;&#x2F;创建单例模式Bean的实例对象<br>if (mbd.isSingleton()) {<br>    &#x2F;&#x2F;这里使用了一个匿名内部类，创建Bean实例对象，并且注册给所依赖的对象<br>    sharedInstance &#x3D; getSingleton(beanName, () - {<br>        try {<br>            &#x2F;&#x2F;创建一个指定Bean实例对象，如果有父级继承，则合并子类和父类的定义<br>            return createBean(beanName, mbd, args);<br>        }<br>        catch (BeansException ex) {<br>            &#x2F;&#x2F; Explicitly remove instance from singleton cache: It might have been put there<br>            &#x2F;&#x2F; eagerly by the creation process, to allow for circular reference resolution.<br>            &#x2F;&#x2F; Also remove any beans that received a temporary reference to the bean.<br>            &#x2F;&#x2F;显式地从容器单例模式Bean缓存中清除实例对象<br>            destroySingleton(beanName);<br>            throw ex;<br>        }<br>    });<br>    &#x2F;&#x2F;获取给定Bean的实例对象<br>    bean &#x3D; getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>}</p>
<p>这里可以看得出来，此时将子类实现的<strong>createBean</strong>方法传入<strong>getSingleton</strong>中以供后续<strong>getObject</strong>调用，也就是说，真正创建Bean的方法是<strong>createBean</strong>（在上面说初始化的时候也有提到，所以这里只是提一下经过了哪些方法，不贴代码详细描述），而<strong>createBean</strong>中判断了一下此Bean是否可以实例化，接着调用真正干事情的<strong>doCreateBean</strong>方法去初始化Bean，此时会先调用构造器实例化此Bean，注意此时仅仅是实例化一个Bean对象出来，Bean实例还未依赖注入，此时会调用这样一段代码：</p>
<td class="line_numbers"><pre>1234567891011</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//向容器中缓存单例模式的Bean对象，以防循环引用boolean earlySingletonExposure = (mbd.isSingleton() && this.allowCircularReferences &&                                  isSingletonCurrentlyInCreation(beanName));if (earlySingletonExposure) {    if (logger.isDebugEnabled()) {        logger.debug("Eagerly caching bean '" + beanName +                     "' to allow for resolving potential circular references");    }    //这里是一个匿名内部类，为了防止循环引用，尽早持有对象的引用    addSingletonFactory(beanName, () - getEarlyBeanReference(beanName, mbd, bean));}</pre></td>

<p>&#x2F;&#x2F;向容器中缓存单例模式的Bean对象，以防循环引用<br>boolean earlySingletonExposure &#x3D; (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp;<br>                                  isSingletonCurrentlyInCreation(beanName));<br>if (earlySingletonExposure) {<br>    if (logger.isDebugEnabled()) {<br>        logger.debug(“Eagerly caching bean ‘“ + beanName +<br>                     “‘ to allow for resolving potential circular references”);<br>    }<br>    &#x2F;&#x2F;这里是一个匿名内部类，为了防止循环引用，尽早持有对象的引用<br>    addSingletonFactory(beanName, () - getEarlyBeanReference(beanName, mbd, bean));<br>}</p>
<p>上面也有说过，这里会判断是否为单例，且允许循环依赖，才会进入<strong>addSingletonFactory</strong>方法：</p>
<td class="line_numbers"><pre>12345678910111213</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">protected void addSingletonFactory(String beanName, ObjectFactory? singletonFactory) {    Assert.notNull(singletonFactory, "Singleton factory must not be null");    //同步处理    synchronized (this.singletonObjects) {        //如果singletonObjects不存在该Bean才进行早期暴露        if (!this.singletonObjects.containsKey(beanName)) {            //会put一个功能接口对象到singletonFactories这个Map中            this.singletonFactories.put(beanName, singletonFactory);            this.earlySingletonObjects.remove(beanName);            this.registeredSingletons.add(beanName);        }    }}</pre></td>

<p>protected void addSingletonFactory(String beanName, ObjectFactory? singletonFactory) {<br>    Assert.notNull(singletonFactory, “Singleton factory must not be null”);<br>    &#x2F;&#x2F;同步处理<br>    synchronized (this.singletonObjects) {<br>        &#x2F;&#x2F;如果singletonObjects不存在该Bean才进行早期暴露<br>        if (!this.singletonObjects.containsKey(beanName)) {<br>            &#x2F;&#x2F;会put一个功能接口对象到singletonFactories这个Map中<br>            this.singletonFactories.put(beanName, singletonFactory);<br>            this.earlySingletonObjects.remove(beanName);<br>            this.registeredSingletons.add(beanName);<br>        }<br>    }<br>}</p>
<p>此方法我称为一个早期暴露实例的方法，注意此时这里可以通过<strong>getEarlyBeanReference</strong>方法获得此时Bean的引用（Bean<strong>仅仅是实例化</strong>），然后将该方法传给<code class="java">
ObjectFactory</code>这个功能接口的getObject方法，此时只需要将<code class="java">
ObjectFactory</code>这个具有获取早期Bean引用的方法的对象put进singletonFactories这个Map中，读到这里，聪明的读者应该已经知道了Spring到底是如何解决循环依赖问题的了。</p>
<h3 id="循环依赖总结"><a href="#循环依赖总结" class="headerlink" title="循环依赖总结"></a>循环依赖总结</h3><p><strong>心中需要有一个时序图，你将会看的更清晰</strong>：</p>
<p><strong>getBean</strong> - <strong>doGetBean</strong> - 先去<strong>singletonObjects</strong>这个Map中查看是否已经有Bean实例，如果没有 - 此Bean为单例的情况下，查看<strong>singletonFactories</strong>此Map是否有<strong>早期暴露的单例Bean引用</strong> - 如果有证明此时这个单例Bean在其他地方已经在创建了，此时只需要返回此引用作为Bean实例即可。</p>
<ol>
<li><strong>singletonObjects时机</strong>：会在完整创建完一个单例Bean时，存放起来，容器即为singletonObjects这个Map，并且会移除早期暴露 singletonFactories 这个Map中关于该Bean的引用。</li>
<li><strong>singletonFactories时机</strong>：在单例Bean情况下，在仅仅是实例化还未依赖注入此Bean时提前将Bean引用早期就存放在singletonFactories这个Map中，所以在doGetBean 尝试获取Bean实例时即可拿到一个Bean引用。</li>
</ol>
<p><strong>此时就来回顾一下上述的循环依赖问题：</strong></p>
<p>当创建<code class="java">
aBean</code>时，先去看看<strong>singletonObjects</strong>是否已经有实例，显然是没有，然后就会实例化此Bean，在这之后，依赖注入之前，将<code class="java">
aBean</code>的引用存放在<strong>singletonFactories</strong>这个Map中，然后进行依赖注入，此时发现<code class="java">
aBean</code>依赖<code class="java">
bBean</code>，所以需要去初始化<code class="java">
bBean</code>，依然是先看看<strong>singletonObjects</strong>是否有<code class="java">
bBean</code>，显然也没有，然后就实例化<code class="java">
bBean</code>，在<code class="java">
bBean</code>依赖注入时，发现此<code class="java">
Bean</code>依赖<code class="java">
aBean</code>，所以又去初始化<code class="java">
aBean</code>了，然后<code class="java">
aBean</code>又去<strong>singletonObjects</strong>看是否存在实例，显然此时还是没有的，然后去<strong>singletonFactories</strong>这个Map查找的时候，发现存在一个Bean引用，所以获取该引用作为<code class="java">
aBean</code>，将此引用注入到<code class="java">
bBean</code>完成<code class="java">
bBean</code>依赖注入的过程，<code class="java">
bBean</code>初始化结束，然后回到<code class="java">
aBean</code>依赖注入，初始化<code class="java">
bBean</code>成功，将<code class="java">
bBean</code>注入到<code class="java">
aBean</code>，然后<code class="java">
aBean</code>初始化也成功，没有循环依赖问题。</p>
<p><strong>为什么早期暴露一个引用就可以解决循环依赖问题呢？</strong></p>
<p>还是看这个例子，在<code class="java">
bBean</code>中注入的<code class="java">
aBean</code>依赖仅仅是一个<code class="java">
aBean</code>实例化之后还未依赖注入（<strong>不完整</strong>的<code class="java">
aBean</code>）引用，但当<code class="java">
aBean</code>也初始化好了，<code class="java">
bBean</code>中的<code class="java">
aBean</code>（此时是<strong>完整</strong>的aBean）不也初始化好了吗？因为引用指向的对象都是同一个地址，这样<code class="java">
bBean</code>就能提前初始化好，只有<code class="java">
bBean</code>初始化好了<code class="java">
aBean</code>才能初始化好，所以解决了循环依赖的问题。</p>
<p>但此时有一个问题，在上面介绍的所有的过程都是针对于单例Bean的，如果不是单例Bean根本都不会进行上述操作，如果是原型Bean循环依赖另一个原型Bean怎么办呢？目前我所知道的这个应该是解决不了的，在初始化的过程中就会报循环依赖的异常，所以要保证Bean为单例，才可以循环依赖。</p>
<h2 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h2><p>FactoryBean是Spring定义的一个特殊的Bean，先来看看它定义了什么方法：</p>
<td class="line_numbers"><pre>1234567891011121314151617</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//工厂Bean，用于产生其他对象public interface FactoryBeanT {     //获取容器管理的对象实例    @Nullable    T getObject() throws Exception;     //获取Bean工厂创建的对象的类型    @Nullable    Class? getObjectType();     //Bean工厂创建的对象是否是单态模式，如果是单态模式，则整个容器中只有一个实例    //对象，每次请求都返回同一个实例对象    default boolean isSingleton() {        return true;    }}</pre></td>

<p>&#x2F;&#x2F;工厂Bean，用于产生其他对象<br>public interface FactoryBean {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">//获取容器管理的对象实例</span>
<span class="token annotation punctuation">@Nullable</span>
T <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//获取Bean工厂创建的对象的类型</span>
<span class="token annotation punctuation">@Nullable</span>
Class<span class="token operator">?</span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//Bean工厂创建的对象是否是单态模式，如果是单态模式，则整个容器中只有一个实例</span>
<span class="token comment" spellcheck="true">//对象，每次请求都返回同一个实例对象</span>
<span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>如果此Bean是FactoryBean，就必须实现FactoryBean接口。通过该接口可以看出FactoryBean的一些特性：</p>
<ol>
<li>getObeject：定义了一个获取Bean对象的方法。</li>
<li>getObjectType：定义了一个获取Bean的Class对象的方法。</li>
<li>isSingleton：判断此Factory生成的Bean是否为单例Bean，默认为true。</li>
</ol>
<h3 id="FactoryBean是什么"><a href="#FactoryBean是什么" class="headerlink" title="FactoryBean是什么"></a>FactoryBean是什么</h3><p>它是一个<strong>特殊的Bean</strong>，从名字就可以看出来，它是由Bean结尾的，意味着是一个Bean，但此Bean是<strong>工厂类型</strong>的Bean，什么意思呢？普通Bean只是IOC容器管理的真正代码中使用的对象，但<strong>工厂Bean不是我们要使用的对象</strong>，它负责生产真正的Bean，它<strong>是一个工厂</strong>，但它也是由工厂（BeanFactory）生产出来的，也就是说，<strong>FactroyBean是用来生产Bean而生的</strong>。</p>
<h3 id="FactoryBean在IOC容器哪里用到"><a href="#FactoryBean在IOC容器哪里用到" class="headerlink" title="FactoryBean在IOC容器哪里用到"></a>FactoryBean在IOC容器哪里用到</h3><p>在<code class="java">
BeanFactory</code>接口中，定义了一个静态变量：</p>
<td class="line_numbers"><pre>123</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//对FactoryBean的转义定义，因为如果使用bean的名字检索FactoryBean得到的对象是工厂生成的对象，//如果需要得到工厂本身，需要转义String FACTORY_BEAN_PREFIX = "&";</pre></td>

<p>&#x2F;&#x2F;对FactoryBean的转义定义，因为如果使用bean的名字检索FactoryBean得到的对象是工厂生成的对象，<br>&#x2F;&#x2F;如果需要得到工厂本身，需要转义<br>String FACTORY_BEAN_PREFIX &#x3D; “&amp;”;</p>
<p>这个用处是用来区分要获取的是FactoryBean本身还是FactoryBean生产出来的Bean。假设有一个FactoryBean，BeanName&#x3D;“demo”，你调用getBean方法希望获取到它的本身，你需要加一个符号：<strong>getBean(“&amp;demo”)<strong>，此时你get到的对象会是</strong>FactoryBean本身</strong>，如果不加此符号，会获取此FactoryBean的方法getObject<strong>生产出来的Bean</strong>作为返回值。没听懂？看看下面就懂了。</p>
<p>回顾以上初始化Bean的过程，我们回到<strong>getBean</strong>之后的<strong>doGetBean</strong>这个一开始的起点方法中：</p>
<td class="line_numbers"><pre>123456789101112131415161718192021</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// Create bean instance.//创建单例模式Bean的实例对象if (mbd.isSingleton()) {    //这里使用了一个匿名内部类，创建Bean实例对象，并且注册给所依赖的对象    sharedInstance = getSingleton(beanName, () - {        try {            //创建一个指定Bean实例对象，如果有父级继承，则合并子类和父类的定义            return createBean(beanName, mbd, args);        }        catch (BeansException ex) {            // Explicitly remove instance from singleton cache: It might have been put there            // eagerly by the creation process, to allow for circular reference resolution.            // Also remove any beans that received a temporary reference to the bean.            //显式地从容器单例模式Bean缓存中清除实例对象            destroySingleton(beanName);            throw ex;        }    });    //获取给定Bean的实例对象    bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);}</pre></td>

<p>&#x2F;&#x2F; Create bean instance.<br>&#x2F;&#x2F;创建单例模式Bean的实例对象<br>if (mbd.isSingleton()) {<br>    &#x2F;&#x2F;这里使用了一个匿名内部类，创建Bean实例对象，并且注册给所依赖的对象<br>    sharedInstance &#x3D; getSingleton(beanName, () - {<br>        try {<br>            &#x2F;&#x2F;创建一个指定Bean实例对象，如果有父级继承，则合并子类和父类的定义<br>            return createBean(beanName, mbd, args);<br>        }<br>        catch (BeansException ex) {<br>            &#x2F;&#x2F; Explicitly remove instance from singleton cache: It might have been put there<br>            &#x2F;&#x2F; eagerly by the creation process, to allow for circular reference resolution.<br>            &#x2F;&#x2F; Also remove any beans that received a temporary reference to the bean.<br>            &#x2F;&#x2F;显式地从容器单例模式Bean缓存中清除实例对象<br>            destroySingleton(beanName);<br>            throw ex;<br>        }<br>    });<br>    &#x2F;&#x2F;获取给定Bean的实例对象<br>    bean &#x3D; getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>}</p>
<p>这里举一个创建单例Bean过程的一段代码。我们上面介绍了<strong>createBean</strong>的流程，此时返回一个Bean是已经是实例化好了并且依赖注入完成，各种回调方法完成之后的一个Bean实例<code class="java">
sharedInstance</code>，但是它没有真正的返回出去，而是又执行了一个方法<strong>getObjectForBeanInstance</strong>：</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536373839404142434445464748</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//获取给定Bean的实例对象，主要是完成FactoryBean的相关处理protected Object getObjectForBeanInstance(    Object beanInstance, String name, String beanName, @Nullable RootBeanDefinition mbd) {     // Don't let calling code try to dereference the factory if the bean isn't a factory.    //容器已经得到了Bean实例对象，这个实例对象可能是一个普通的Bean，    //也可能是一个工厂Bean，如果是一个工厂Bean，则使用它创建一个Bean实例对象，    //如果调用本身就想获得一个容器的引用，则指定返回这个工厂Bean实例对象    //如果指定的名称是容器的解引用(dereference，即是对象本身而非内存地址)，    //且Bean实例也不是创建Bean实例对象的工厂Bean    if (BeanFactoryUtils.isFactoryDereference(name) && !(beanInstance instanceof FactoryBean)) {        throw new BeanIsNotAFactoryException(transformedBeanName(name), beanInstance.getClass());    }     // Now we have the bean instance, which may be a normal bean or a FactoryBean.    // If it's a FactoryBean, we use it to create a bean instance, unless the    // caller actually wants a reference to the factory.    //如果Bean实例不是工厂Bean，或者指定名称是容器的解引用，    //调用者向获取对容器的引用，则直接返回当前的Bean实例    if (!(beanInstance instanceof FactoryBean) || BeanFactoryUtils.isFactoryDereference(name)) {        return beanInstance;    }     //处理指定名称不是容器的解引用，或者根据名称获取的Bean实例对象是一个工厂Bean    //使用工厂Bean创建一个Bean的实例对象    Object object = null;    if (mbd == null) {        //从Bean工厂缓存中获取给定名称的Bean实例对象        object = getCachedObjectForFactoryBean(beanName);    }    //让Bean工厂生产给定名称的Bean对象实例    if (object == null) {        // Return bean instance from factory.        FactoryBean? factory = (FactoryBean?) beanInstance;        // Caches object obtained from FactoryBean if it is a singleton.        //如果从Bean工厂生产的Bean是单态模式的，则缓存        if (mbd == null && containsBeanDefinition(beanName)) {            //从容器中获取指定名称的Bean定义，如果继承基类，则合并基类相关属性            mbd = getMergedLocalBeanDefinition(beanName);        }         boolean synthetic = (mbd != null && mbd.isSynthetic());        //调用FactoryBeanRegistrySupport类的getObjectFromFactoryBean方法，        //实现工厂Bean生产Bean对象实例的过程        object = getObjectFromFactoryBean(factory, beanName, !synthetic);    }    return object;}</pre></td>

<p>&#x2F;&#x2F;获取给定Bean的实例对象，主要是完成FactoryBean的相关处理<br>protected Object getObjectForBeanInstance(<br>    Object beanInstance, String name, String beanName, @Nullable RootBeanDefinition mbd) {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// Don't let calling code try to dereference the factory if the bean isn't a factory.</span>
<span class="token comment" spellcheck="true">//容器已经得到了Bean实例对象，这个实例对象可能是一个普通的Bean，</span>
<span class="token comment" spellcheck="true">//也可能是一个工厂Bean，如果是一个工厂Bean，则使用它创建一个Bean实例对象，</span>
<span class="token comment" spellcheck="true">//如果调用本身就想获得一个容器的引用，则指定返回这个工厂Bean实例对象</span>
<span class="token comment" spellcheck="true">//如果指定的名称是容器的解引用(dereference，即是对象本身而非内存地址)，</span>
<span class="token comment" spellcheck="true">//且Bean实例也不是创建Bean实例对象的工厂Bean</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>BeanFactoryUtils<span class="token punctuation">.</span><span class="token function">isFactoryDereference</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>beanInstance <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanIsNotAFactoryException</span><span class="token punctuation">(</span><span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> beanInstance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span>
<span class="token comment" spellcheck="true">// If it's a FactoryBean, we use it to create a bean instance, unless the</span>
<span class="token comment" spellcheck="true">// caller actually wants a reference to the factory.</span>
<span class="token comment" spellcheck="true">//如果Bean实例不是工厂Bean，或者指定名称是容器的解引用，</span>
<span class="token comment" spellcheck="true">//调用者向获取对容器的引用，则直接返回当前的Bean实例</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanInstance <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span> <span class="token operator">||</span> BeanFactoryUtils<span class="token punctuation">.</span><span class="token function">isFactoryDereference</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//处理指定名称不是容器的解引用，或者根据名称获取的Bean实例对象是一个工厂Bean</span>
<span class="token comment" spellcheck="true">//使用工厂Bean创建一个Bean的实例对象</span>
Object object <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//从Bean工厂缓存中获取给定名称的Bean实例对象</span>
    object <span class="token operator">=</span> <span class="token function">getCachedObjectForFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//让Bean工厂生产给定名称的Bean对象实例</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Return bean instance from factory.</span>
    FactoryBean<span class="token operator">?</span> factory <span class="token operator">=</span> <span class="token punctuation">(</span>FactoryBean<span class="token operator">?</span><span class="token punctuation">)</span> beanInstance<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Caches object obtained from FactoryBean if it is a singleton.</span>
    <span class="token comment" spellcheck="true">//如果从Bean工厂生产的Bean是单态模式的，则缓存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//从容器中获取指定名称的Bean定义，如果继承基类，则合并基类相关属性</span>
        mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">boolean</span> synthetic <span class="token operator">=</span> <span class="token punctuation">(</span>mbd <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//调用FactoryBeanRegistrySupport类的getObjectFromFactoryBean方法，</span>
    <span class="token comment" spellcheck="true">//实现工厂Bean生产Bean对象实例的过程</span>
    object <span class="token operator">=</span> <span class="token function">getObjectFromFactoryBean</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token operator">!</span>synthetic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> object<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>也就是说，每一个Bean在初始化完成时，都会进入这个方法，这个方法会判断该Bean是否是<strong>FactoryBean</strong>，如果是的话，我们需要get的并不是这个FactoryBean，而是<strong>FactoryBean生产出来的Bean</strong>。</p>
<ol>
<li>先是判断get的名称是否为 <strong>“&amp;”</strong> 符号开头，如果是的话就是指<strong>获取FactoryBean本身</strong>即可，但此Bean又没有实现FactoryBean，也就是说在不是FactoryBean的Bean上获取本身（”&amp;”）将会<strong>抛出异常</strong>。</li>
<li>再是判断该Bean如果不是<strong>FactoryBean</strong>，说明是<strong>普通Bean</strong>，直接<strong>返回本身</strong>即可，亦或是以”&amp;”开头的，上面也说了，以“&amp;”开头的话获取的是本身，所以也是<strong>直接返回本身</strong>即可。</li>
<li>如果程序运行到了这里，我们可以知道，<strong>此Bean是一个FactoryBean</strong>，<strong>且并不是获取本身</strong>，而是获取FactoryBean生产出来的Bean，此时会先去FactoryBean缓存中获取是否有已经创建好了的Bean实例。</li>
<li>缓存如果有返回缓存即可，缓存没有就调用<strong>getObjectFromFactoryBean</strong>方法，从FactoryBean中生产Bean<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//Bean工厂生产Bean实例对象protected Object getObjectFromFactoryBean(FactoryBean? factory, String beanName, boolean shouldPostProcess) {    //Bean工厂是单态模式，并且Bean工厂缓存中存在指定名称的Bean实例对象    if (factory.isSingleton() && containsSingleton(beanName)) {        //多线程同步，以防止数据不一致        synchronized (getSingletonMutex()) {            //直接从Bean工厂缓存中获取指定名称的Bean实例对象            Object object = this.factoryBeanObjectCache.get(beanName);            //Bean工厂缓存中没有指定名称的实例对象，则生产该实例对象            if (object == null) {                //调用Bean工厂的getObject方法生产指定Bean的实例对象                object = doGetObjectFromFactoryBean(factory, beanName);                // Only post-process and store if not put there already during getObject() call above                // (e.g. because of circular reference processing triggered by custom getBean calls)                Object alreadyThere = this.factoryBeanObjectCache.get(beanName);                if (alreadyThere != null) {                    object = alreadyThere;                }                else {                    if (shouldPostProcess) {                        try {                            object = postProcessObjectFromFactoryBean(object, beanName);                        }                        catch (Throwable ex) {                            throw new BeanCreationException(beanName,                                                            "Post-processing of FactoryBean's singleton object failed", ex);                        }                    }                    //将生产的实例对象添加到Bean工厂缓存中                    this.factoryBeanObjectCache.put(beanName, object);                }            }            return object;        }    }    //调用Bean工厂的getObject方法生产指定Bean的实例对象    else {        Object object = doGetObjectFromFactoryBean(factory, beanName);        if (shouldPostProcess) {            try {                object = postProcessObjectFromFactoryBean(object, beanName);            }            catch (Throwable ex) {                throw new BeanCreationException(beanName, "Post-processing of FactoryBean's object failed", ex);            }        }        return object;    }}</pre></td></li>
</ol>
<p>&#x2F;&#x2F;Bean工厂生产Bean实例对象<br>protected Object getObjectFromFactoryBean(FactoryBean? factory, String beanName, boolean shouldPostProcess) {<br>    &#x2F;&#x2F;Bean工厂是单态模式，并且Bean工厂缓存中存在指定名称的Bean实例对象<br>    if (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) {<br>        &#x2F;&#x2F;多线程同步，以防止数据不一致<br>        synchronized (getSingletonMutex()) {<br>            &#x2F;&#x2F;直接从Bean工厂缓存中获取指定名称的Bean实例对象<br>            Object object &#x3D; this.factoryBeanObjectCache.get(beanName);<br>            &#x2F;&#x2F;Bean工厂缓存中没有指定名称的实例对象，则生产该实例对象<br>            if (object &#x3D;&#x3D; null) {<br>                &#x2F;&#x2F;调用Bean工厂的getObject方法生产指定Bean的实例对象<br>                object &#x3D; doGetObjectFromFactoryBean(factory, beanName);<br>                &#x2F;&#x2F; Only post-process and store if not put there already during getObject() call above<br>                &#x2F;&#x2F; (e.g. because of circular reference processing triggered by custom getBean calls)<br>                Object alreadyThere &#x3D; this.factoryBeanObjectCache.get(beanName);<br>                if (alreadyThere !&#x3D; null) {<br>                    object &#x3D; alreadyThere;<br>                }<br>                else {<br>                    if (shouldPostProcess) {<br>                        try {<br>                            object &#x3D; postProcessObjectFromFactoryBean(object, beanName);<br>                        }<br>                        catch (Throwable ex) {<br>                            throw new BeanCreationException(beanName,<br>                                                            “Post-processing of FactoryBean’s singleton object failed”, ex);<br>                        }<br>                    }<br>                    &#x2F;&#x2F;将生产的实例对象添加到Bean工厂缓存中<br>                    this.factoryBeanObjectCache.put(beanName, object);<br>                }<br>            }<br>            return object;<br>        }<br>    }<br>    &#x2F;&#x2F;调用Bean工厂的getObject方法生产指定Bean的实例对象<br>    else {<br>        Object object &#x3D; doGetObjectFromFactoryBean(factory, beanName);<br>        if (shouldPostProcess) {<br>            try {<br>                object &#x3D; postProcessObjectFromFactoryBean(object, beanName);<br>            }<br>            catch (Throwable ex) {<br>                throw new BeanCreationException(beanName, “Post-processing of FactoryBean’s object failed”, ex);<br>            }<br>        }<br>        return object;<br>    }<br>}</p>
<ol>
<li>首先判断FactoryBean生产的Bean<strong>是否为单例</strong>的，判断方法在FactoryBean接口中就已经定义此方法，并且要在熟悉的singletonObjects这个存放单例Bean的Map中存在此Bean，就可以判断生产的Bean为单例，所以需要<strong>缓存它</strong>，这个过程需要<strong>同步控制</strong>，接下来就调用<strong>doGetObjectFromFactoryBean</strong>方法去获取真正的Bean，并将其放入缓存中**factoryBeanObjectCache.put(beanName, object)**，以便下一次获取。然后返回真正生产出来的Bean。</li>
<li>此时如果走到这里，说明生产出来的Bean为<strong>非单例</strong>的，所以<strong>不需要缓存</strong>，只需要简单的调用<strong>doGetObjectFromFactoryBean</strong>方法去获取真正的Bean返回即可</li>
</ol>
<p>以上两种可能性都调用了同一个方法<strong>doGetObjectFromFactoryBean</strong>：</p>
<td class="line_numbers"><pre>123456789101112131415</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//调用Bean工厂的getObject方法生产指定Bean的实例对象private Object doGetObjectFromFactoryBean(final FactoryBean? factory, final String beanName)    throws BeanCreationException {     Object object;     //安全验证，略...     //调用BeanFactory接口实现类的创建对象方法    object = factory.getObject();     //略...     return object;}</pre></td>

<p>&#x2F;&#x2F;调用Bean工厂的getObject方法生产指定Bean的实例对象<br>private Object doGetObjectFromFactoryBean(final FactoryBean? factory, final String beanName)<br>    throws BeanCreationException {</p>
<pre class="line-numbers language-java"><code class="language-java">
Object object<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//安全验证，略...</span>

<span class="token comment" spellcheck="true">//调用BeanFactory接口实现类的创建对象方法</span>
object <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//略...</span>

<span class="token keyword">return</span> object<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>为了凸显出主线，我删减了一些支线代码，在这里可以看出来，最终调用的是<strong>FactoryBean的getObject方法</strong>，正是FactoryBean接口定义的这个方法，此方法为生产Bean的方法。</p>
<h3 id="FactoryBean例子"><a href="#FactoryBean例子" class="headerlink" title="FactoryBean例子"></a>FactoryBean例子</h3><p>为了加深理解，我举一个生产环境都会用到的一个FactoryBean来演示到底FactoryBean有什么用。</p>
<p>这里我拿MyBatis与Spring整合包下的一个类<code class="java">
MapperFactoryBean</code>作为例子讲解一下：</p>
<td class="line_numbers"><pre>123456789101112131415</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">/**   * {@inheritDoc}   */@Overridepublic T getObject() throws Exception {    return getSqlSession().getMapper(this.mapperInterface);} /**   * {@inheritDoc}   */@Overridepublic boolean isSingleton() {    return true;}</pre></td>

<p>&#x2F;**</p>
<ul>
<li>{@inheritDoc}</li>
</ul>
<p>   *&#x2F;<br>@Override<br>public T getObject() throws Exception {<br>    return getSqlSession().getMapper(this.mapperInterface);<br>}</p>
<p>&#x2F;**</p>
<ul>
<li>{@inheritDoc}</li>
</ul>
<p>   *&#x2F;<br>@Override<br>public boolean isSingleton() {<br>    return true;<br>}</p>
<p>这里贴两个主要方法（需要有一点MyBatis的基础），我在分析MyBatis那篇文章中有提到，我们定义的那些Mapper接口，其实是<strong>SqlSession调用getMapper方法创建出来的</strong>，从以上<strong>getObject</strong>中可以看出，<code class="java">
MapperFactoryBean</code>是一个专门<strong>生产Mapper</strong>的一个FactoryBean，从<strong>isSingleton</strong>方法中可以看出，获取的<strong>Mapper都为单例</strong>。我们回忆一下在使用SSM的时候，如果是一个一个Mapper去配置成Bean放在IOC容器中，需要这样写：</p>
<td class="line_numbers"><pre>1234</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">bean id="demoMapper" class="org.mybatis.Spring.mapper.MapperFactoryBean"    property name="mapperInterface" value="com.demo.DemoMapper"/property    property name="sqlSessionFactory" ref="sqlSessionFactory"/property/bean</pre></td>

<p>bean id&#x3D;”demoMapper” class&#x3D;”org.mybatis.Spring.mapper.MapperFactoryBean”<br>    property name&#x3D;”mapperInterface” value&#x3D;”com.demo.DemoMapper”&#x2F;property<br>    property name&#x3D;”sqlSessionFactory” ref&#x3D;”sqlSessionFactory”&#x2F;property<br>&#x2F;bean</p>
<p>请注意，此Bean的class类型就是我们上面介绍的<code class="java">
MapperFactoryBean</code>，其中有属性<strong>mapperInterface</strong> ，根据此属性去使用getObject方法获取真正的Mapper对象，就算你直接配置一个Mapper扫描路径，它的底层也是将扫描到的每一个mapper接口类型作为<code class="java">
MapperFactoryBean</code>，以一个<strong>FactoryBean</strong>的形式存放在IOC容器中，当<strong>getBean</strong>的时候其实是调用<code class="java">
MapperFactoryBean</code>这个FactoryBean的<strong>getObject</strong>方法：</p>
<td class="line_numbers"><pre>12</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">@Autowiredprivate DemoMapper demoMapper</pre></td>

<p>@Autowired<br>private DemoMapper demoMapper</p>
<p>也就是说，你这样使用一个Mapper的时候，Spring容器其实是先获取<code class="java">
MapperFactoryBean</code>，然后调用所有Bean都会调用的方法<strong>getObjectForBeanInstance</strong>去进行判断，发现此Bean为一个FactoryBean，调用此Bean的getObject方法，也就是委派其中的SqlSession去getMapper，从而获取真正的Mapper。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>到此就结束了初始化Bean的全过程，我们可以总结出来几件事：</strong></p>
<ol>
<li>在Spring中有一个特殊的单例模式，称为<strong>注册式单例</strong>，往Map中put那些Bean实例达到单例的效果（<strong>过程进行同步处理，解决并发问题</strong>）。</li>
<li>在初始化IOC容器时就会初始化Bean（ <strong>单例且lazy-init &#x3D; false</strong> ），并将这些Bean存放在（<code class="java">
BeanFactory</code>的）<code class="java">
Map</code>中，这可以<strong>节省时间</strong>，一些单例Bean在启动时就已经创建好，使用时只需获取Map中实例即可。</li>
<li>与上一个类似的，如果Bean是除了单例之外的scope，在<strong>getBean</strong>时同样会走<strong>doCrateBean</strong>去创建实例，但区别在于<strong>不会对其进行缓存</strong>，也就是说，除单例之外的scope，可以达到<strong>每次getBean都是不同实例</strong>的Bean的效果。</li>
<li>循环依赖问题只在<strong>单例Bean</strong> 上被解决，原型Bean之间的循环依赖会<strong>抛出异常</strong>。</li>
<li>在初始化Bean时多次出现<strong>回调通知方法</strong>，这个特性展现了Spring框架的<strong>易扩展性</strong>，这是非常强大的设计，将在下一章中对其进行讲解，AOP的实现也依赖于此。</li>
<li>Factory是一个<strong>特殊的Bean</strong> ，主要用途是<strong>用来生产Bean</strong>的，请注意IOC容器中<strong>singletonObjects</strong>这个Map将会存放<strong>所有初始化好的单例Bean</strong>（包括那些单例的FactoryBean），而factoryBeanObjectCache存放的则是那些<strong>FactoryBean生产出来的Bean</strong>，也就是说，IOC容器不仅会存放FactoryBean在容器中，还会存放FactoryBean生产的Bean在容器中，双重缓存加快获取Bean的效率。这里读者要理清两者的关系。</li>
</ol>

                </div>
                <!-- 欧阳思海，modify，2020.05.01-->
<!-- 文章详情详情页面的头部广告位置信息 -->
<div id="post-head-panel">
    
    <a href="https://github.com/OUYANGSIHAI/JavaInterview" style="font-size: 18px;" target="_blank">
        <img src="/icons/hot.gif">
        本人花费半年的时间总结的《Java面试指南》已拿腾讯等大厂offer，已开源在github ，欢迎star！
    </a>
    
    
</div>
<br />



<blockquote>
    
            <p>本文GitHub <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">https://github.com/OUYANGSIHAI/JavaInterview</a> 已收录，这是我花了6个月总结的<b>一线大厂Java面试</b>总结，本人已拿大厂offer，欢迎star</p>
    
    <p>原文链接：blog.ouyangsihai.cn &gt;&gt; <a href="/shen-ru-yuan-ma-fen-xi-springioc-er.html" target="_blank">深入源码分析SpringIOC（二）</a></p>
</blockquote>
                <hr />

                
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">多少都是对我的认可</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="http://image.ouyangsihai.cn/FpbhsOuf3Ar9vY34B97Y2qQ7LVGe" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="http://image.ouyangsihai.cn/FgYlMzms68PH73PWpZBwPfbLTAws" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
                

                <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

                

                
                <div class="reprint1">
                    <p>
                        <span class="reprint1-tip">
                            <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                        </span>
                        <a href="https://blog.ouyangsihai.cn" class="b-link-green">好好学java</a>
                        <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                        <a href="/shen-ru-yuan-ma-fen-xi-springioc-er.html" class="b-link-green">深入源码分析SpringIOC（二）</a>
                    </p>
                </div>

            </div>
        </div>

        

        

        

        

        
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }
    /* valine 评论框增加背景图片 */
    #vcomments textarea {
        box-sizing: border-box;
        background: url("") 100% 100% no-repeat;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    /* 修复评论第一行位置错位 */
    .v .vlist .vcard {
    padding-top: 2.5em !important ;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <link rel="stylesheet" type="text/css" href="/libs//libs/jQuery-emoji/dist/css/jquery.emoji.css">
<script src="/libs//libs/jQuery-emoji/dist/js/jquery.emoji.min.js"></script>
<script src="/libs//libs/jQuery-emoji/dist/js/emoji.list.js"></script> -->
<script>
    new Valine({
        el: '#vcomments',
        appId: 'MxSNOS83TYWU3Opsy2GTW1ih-gzGzoHsz',
        appKey: '4XevOgmAxHEwVDnIKgvEUihB',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '请畅所欲言吧，别害羞~',

    });

//     function parse_emoji() {
//     jQuery(".vcontent").emojiParse({
//       basePath: '/libs/jQuery-emoji/images/emoji',
//       icons: emojiLists   // 注：详见 js/emoji.list.js
//     });
//   }
  
//   setTimeout(function() {
//     // jQuery emoji 解析
//     parse_emoji();
//     // jquery emoji 初始化
//     jQuery(".veditor").emoji({
//       showTab: true,
//       animation: 'slide',
//       basePath: '/libs/jQuery-emoji/images/emoji',
//       icons: emojiLists  // 注：详见 js/emoji.list.js
//     });
//     jQuery(".vmore").on("click", function() {
//       setTimeout(function() {
//         parse_emoji();
//       }, 500);
//     });
//   }, 800)

</script>
        

        

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/shen-ru-yuan-ma-fen-xi-springioc-yi.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="深入源码分析SpringIOC（一）">
                        
                        <span class="card-title">深入源码分析SpringIOC（一）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock fa-fw icon-date"></i>2021-04-05
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/spring%E6%95%99%E7%A8%8B/" class="post-category" target="_blank">
                                    spring教程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/spring-spring%E6%95%99%E7%A8%8B-spring%E6%BA%90%E7%A0%81/" target="_blank">
                        <span class="chip bg-color">spring,spring教程,spring源码</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/shen-ru-yuan-ma-fen-xi-springioc-san.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="深入源码分析SpringIOC（三）">
                        
                        <span class="card-title">深入源码分析SpringIOC（三）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock fa-fw icon-date"></i>2021-04-05
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/spring%E6%95%99%E7%A8%8B/" class="post-category" target="_blank">
                                    spring教程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/spring-spring%E6%95%99%E7%A8%8B-spring%E6%BA%90%E7%A0%81/" target="_blank">
                        <span class="chip bg-color">spring,spring教程,spring源码</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
    </div>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('500')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 好好学java<br />'
            + '作者: 好好学java<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>



<!--
<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'container',
        blogId: '15305-1590684104111-518',
        name: '程序员的技术圈子',
        qrcode: 'http://image.ouyangsihai.cn/FtAUOeE5--1JTdcuuZFIhMuEUuJO',
        keyword: 'vip',
    });
</script>
-->

    </div>
    <div id="toc-aside" style="width: 310px;" class="expanded col l3 hide-on-med-and-down">
        <!-- 自定义右侧card：欧阳思海 -->
        <!-- <div id="my-card" style="background: ">
            
        </div> -->
        <!-- <div class="toc-widget">
            <div class="toc-title" style="display: none;"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;</div>
            <div id="toc-content"></div>
        </div> -->








        <aside class="col-lg-3" style="width: 300px;">

            <link rel="stylesheet" type="text/css" href="/css/my-aside.css">

            <!-- 关注公众号信息：欧阳思海 -->
            <div class="widget-wrap">
                <div class="widget bg-danger" style="color:whitesmoke; background-color: #419488">
                    <div class="card-front animated col s12 m12 l8 offset-l2 fadeInUp">
                        <div class="row">
                            <div class="col-md-5" style="text-align: center;">
                                <img class="adv" style="width: 95px; height: 95px;"
                                    src="http://image.ouyangsihai.cn/FtAUOeE5--1JTdcuuZFIhMuEUuJO">
                            </div>
                            <div class="col-md-7" style="text-align: center;">
                                <h2 style="font-size: 18px; 
                                    margin: 0; 
                                    padding: 0;
                                    border: 0; 
                                    outline: 0;
                                    font-weight: inherit;
                                    font-style: inherit;
                                    font-family: inherit;
                                    vertical-align: baseline;">关注公众号</h2>
                                 
                                <small style="font-size: 15px;">
                                    →「技术干货」每日推送 <br>
                                    →「回复资料」领取资料 <br>
                                    →「微信加群」每周福利 <br>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- <div style="font-size: 0.8em;">
                        <a href="/assets/erweima.jpg" target="_blank"
                            style="color:orange;font-size: 14px;">点击添加我的微信，加入技术讨论群</a>
                        除公众号以外，我还会在以下平台发布内容：
                    </div>
                    -->

                    <div class="profile-block social-links col-md-7" style="text-align: center;">
                        <table style="align-items: center; 
                                        padding-left: 25px;">
                            <tbody>
                                <tr>
                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank" title="GitHub"
                                            class="tooltip">
                                            <img style="width: 22px;height: 22px;" src="/icons/github.svg"></a>
                                    </td>

                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://www.zhihu.com/people/hai-hai-ren-sheng-50/activities"
                                            target="_blank" title="知乎" class="tooltip">
                                            <img style="width: 22px;" src="/icons/zhihu.svg"></a>
                                    </td>
                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://blog.csdn.net/sihai12345" target="_blank" title="CSDN"
                                            class="tooltip">
                                            <img style="width: 18px;" src="/icons/CSDN.svg"></a>
                                    </td>
                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://www.jianshu.com/u/12b0bd4c857c" target="_blank" title="简书"
                                            class="tooltip">
                                            <img style="width: 22px;" src="/icons/JianShu.svg"></a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            

            <!-- custom rightside_link：热门文章推荐：欧阳思海 -->
            
            <div class="widget-wrap widget-panel">
                <p style="text-align: left;padding-bottom: 10px;line-height: 30px; font-size: 14px;">
                    
                    <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">

                        <img src="/icons/hot.gif">

                        本人花费半年的时间总结的《 Java 面试指南》已拿腾讯等大厂 offer，已开源在 github ，欢迎 star！
                    </a><br>
                    
                    <a href="https://mp.weixin.qq.com/s/I0jimqziHqRNaIy0kXRCnw" target="_blank">

                        <img src="/icons/hot.gif">

                        2020 Java 1000G 最新学习资源，Java基础、Java项目实战、Java分布式等等！
                    </a><br>
                    
                    <a href="http://image.ouyangsihai.cn/FpB-dO6g-XU44mMrVlj7EL1y7Rs7" target="_blank">

                        <img src="/icons/hot.gif">

                        高级 Java 开发微信群，一起搞事情吧！
                    </a><br>
                    
                </p>
            </div>
            

            

            <!-- custom rightside_banner：右侧广告或者其他的栏目设置：欧阳思海 -->
            
            <div class="widget-wrap">
                <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">
                    <img src="http://image.ouyangsihai.cn/FhhoEYMaNr6m0v8KhG8vSPgoREBV" style="width: 100%;">
                </a>
            </div>
            
            

            

            <!-- 右侧专栏分类：欧阳思海 -->
            
            <div class="widget-wrap widget-panel">
                <ul class="media-list">
                    
                    <li class="media">
                        <a href="/categories/MySQL的艺术世界/" target="_blank">
                            <div class="media-left">
                                <img class="media-object" src="http://image.ouyangsihai.cn/Fn3kQurieQ_0QUeqPmx5RW5i6R9n" style="width: 55px;">
                            </div>
                            <div class="media-body">
                                <h4 class="media-heading" style="margin-bottom: 10px; font-size: 100%;
                                                                    margin: 0;
                                                                    padding: 0;
                                                                    border: 0;
                                                                    outline: 0;
                                                                    font-weight: inherit;
                                                                    font-style: inherit;
                                                                    font-family: inherit;
                                                                    vertical-align: baseline;">
                                    MySQL 的系列文章，解决全部面试问题！
                                </h4>
                                <p>
                                    总共10篇文章，面试热门的锁、事务，通通解决了！
                                </p>
                            </div>
                        </a>
                    </li>
                    <hr>
                    
                    <li class="media">
                        <a href="/categories/深入理解Java虚拟机/" target="_blank">
                            <div class="media-left">
                                <img class="media-object" src="http://image.ouyangsihai.cn/FpcS21VWJOHSgGzKcpW3_xVTSEeN" style="width: 55px;">
                            </div>
                            <div class="media-body">
                                <h4 class="media-heading" style="margin-bottom: 10px; font-size: 100%;
                                                                    margin: 0;
                                                                    padding: 0;
                                                                    border: 0;
                                                                    outline: 0;
                                                                    font-weight: inherit;
                                                                    font-style: inherit;
                                                                    font-family: inherit;
                                                                    vertical-align: baseline;">
                                    深入理解 Java 虚拟机，面试必问
                                </h4>
                                <p>
                                    总共10篇文章，包括内存模型、GC算法、GC收集器等。
                                </p>
                            </div>
                        </a>
                    </li>
                    <hr>
                    
                </ul>
            </div>
            

            <!-- 右侧分类 -->
            <div class="widget-wrap widget-panel">
                <h3 class="widget-title">文章分类</h3>
                <div class="widget">
                    <ul class="category-list">
                        
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/趣聊数据结构与算法/">>
                                趣聊数据结构与算法</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/职业生涯浅谈/">>
                                职业生涯浅谈</a><span class="category-list-count">33</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java项目分享/">>
                                Java项目分享</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java面试经验/">>
                                Java面试经验</a><span class="category-list-count">4</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/我要进大厂/">>
                                我要进大厂</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/好好学java/">>
                                好好学java</a><span class="category-list-count">1116</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/剑指offer/">>
                                剑指offer</a><span class="category-list-count">112</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/css/">>
                                css</a><span class="category-list-count">12</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/其他框架/">>
                                其他框架</a><span class="category-list-count">142</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python其他/">>
                                python其他</a><span class="category-list-count">45</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/数据库相关/">>
                                数据库相关</a><span class="category-list-count">293</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java核心知识/">>
                                Java核心知识</a><span class="category-list-count">196</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java面试题/">>
                                Java面试题</a><span class="category-list-count">308</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/mybatis源码/">>
                                mybatis源码</a><span class="category-list-count">56</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/spring教程/">>
                                spring教程</a><span class="category-list-count">173</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springboot教程/">>
                                springboot教程</a><span class="category-list-count">156</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/实战Activiti工作流/">>
                                实战Activiti工作流</a><span class="category-list-count">4</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springcloud教程/">>
                                springcloud教程</a><span class="category-list-count">39</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/linux/">>
                                linux</a><span class="category-list-count">91</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python框架/">>
                                python框架</a><span class="category-list-count">43</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python基础/">>
                                python基础</a><span class="category-list-count">78</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/dubbo/">>
                                dubbo</a><span class="category-list-count">37</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java源码/">>
                                Java源码</a><span class="category-list-count">76</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/叽叽喳喳杂七杂八/">>
                                叽叽喳喳杂七杂八</a><span class="category-list-count">10</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/MySQL的艺术世界/">>
                                MySQL的艺术世界</a><span class="category-list-count">8</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/jquery/">>
                                jquery</a><span class="category-list-count">14</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java并发/">>
                                Java并发</a><span class="category-list-count">43</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java文章合辑/">>
                                Java文章合辑</a><span class="category-list-count">11</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java基础修炼/">>
                                Java基础修炼</a><span class="category-list-count">7</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/不一样的Java8/">>
                                不一样的Java8</a><span class="category-list-count">3</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/小程序开发的世界/">>
                                小程序开发的世界</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java学习资源分享/">>
                                Java学习资源分享</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java小学生漫游/">>
                                Java小学生漫游</a><span class="category-list-count">2</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/rocketmq源码解析/">>
                                rocketmq源码解析</a><span class="category-list-count">33</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springmvc最新教程/">>
                                springmvc最新教程</a><span class="category-list-count">9</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java的Exception/">>
                                Java的Exception</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/vue-js/">>
                                vue.js</a><span class="category-list-count">10</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/实战设计模式/">>
                                实战设计模式</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python数据处理/">>
                                python数据处理</a><span class="category-list-count">7</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java-Web闯关/">>
                                Java Web闯关</a><span class="category-list-count">7</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springboot2-0最新教程/">>
                                springboot2.0最新教程</a><span class="category-list-count">11</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/netty/">>
                                netty</a><span class="category-list-count">16</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/rpc/">>
                                rpc</a><span class="category-list-count">13</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/拥抱大厂系列/">>
                                拥抱大厂系列</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/eureka/">>
                                eureka</a><span class="category-list-count">19</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/分布式/">>
                                分布式</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/中间件/">>
                                中间件</a><span class="category-list-count">23</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java基础/">>
                                Java基础</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/带你学Python/">>
                                带你学Python</a><span class="category-list-count">10</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/使用技术工具/">>
                                使用技术工具</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/mycat源码/">>
                                mycat源码</a><span class="category-list-count">5</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/深入理解Java虚拟机/">>
                                深入理解Java虚拟机</a><span class="category-list-count">8</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/spring源码/">>
                                spring源码</a><span class="category-list-count">2</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java集合源码分析/">>
                                Java集合源码分析</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/github的repo/">>
                                github的repo</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java框架深究/">>
                                Java框架深究</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/分布式架构/">>
                                分布式架构</a><span class="category-list-count">2</span>
                        </li>
                        
                        
                    </ul>
                </div>
            </div>

        </aside>









    </div>
</div>

<!-- TOC 悬浮按钮. 修改成永远不显示：欧阳思海-->




<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        console.log('============');

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

                        
            /* 修复文章卡片 div 的宽度. */
            let fixPostCardWidth = function (srcId, targetId) {
                let srcDiv = $('#' + srcId);
                if (srcDiv.length === 0) {
                    return;
                }

                let w = srcDiv.width();
                if (w >= 450) {
                    w = w + 21;
                } else if (w >= 350 && w < 450) {
                    w = w + 18;
                } else if (w >= 300 && w < 350) {
                    w = w + 16;
                } else {
                    w = w + 14;
                }
                $('#' + targetId).width(w);
            };

            // 切换TOC目录展开收缩的相关操作.
            // 修改右侧边栏功能：欧阳思海
            const expandedClass = 'expanded';
            let $tocAside = $('#toc-aside');
            let $mainContent = $('#main-content');

            $('#floating-toc-btn .btn-floating').click(function () {
                if ($tocAside.hasClass(expandedClass)) {
                    $tocAside.removeClass(expandedClass).slideUp(500);
                    $mainContent.removeClass('l9');
                } else {
                    $tocAside.addClass(expandedClass).slideDown(500);
                    $mainContent.addClass('l9');
                }
                fixPostCardWidth('artDetail', 'prenext-posts');
            });
                        
                    });
</script>
    

</main>


        <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            
	    Copyright&copy; 2019 <a href="https://www.java1000.com/" target="_blank"> 好好学java </a>维护. 网站备案/许可证号：赣ICP备17007984号-3
            <br>
            <span id="sitetime"></span>
            <br>

            

            
                    <!-- 
                        <span id="busuanzi_container_site_pv" style='display:none'></span>
                        总访问量: <span id="busuanzi_value_site_pv" class="white-color"></span>
                    
        
                    
                        <span id="busuanzi_container_site_uv" style='display:none'></span>
                        人次&nbsp; | &nbsp;访客人数: <span id="busuanzi_value_site_uv" class="white-color"></span> 人
                     -->
                        <!-- 修改计数：欧阳思海 -->
                    
                        <span id="busuanzi_container_site_pv" style='display:inline'>
                            <i class="fa fa-heart-o"></i>
                            本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                        </span>
                    
                    
                        <span id="busuanzi_container_site_uv" style='display:none'>
                            人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                        </span>
                    
    
            

            
                &nbsp; | &nbsp;字数统计:&nbsp;
                <span class="white-color">8290.3k</span> 字
            

            
            <br>

        </div>

        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/OUYANGSIHAI/JavaInterview" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-code-branch"></i>
    </a>


 
    <a href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=1446037005@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>




    <a href="https://zhihu.com/people/hai-hai-ren-sheng-50/activities" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>









    <a href="https://blog.ouyangsihai.cn/sitemap.xml" class="tooltipped" target="_blank" data-tooltip="站点地图" data-position="top" data-delay="50">
        <i class="fa fa-sitemap"></i>
    </a>



    <a href="https://blog.ouyangsihai.cn/friends" class="tooltipped" target="_blank" data-tooltip="友情链接" data-position="top" data-delay="50">
        <i class="fa fa-address-book"></i>
    </a>
</div>

    </div>
</footer>

<div class="progress-bar"></div>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();

        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */

        var t1 = Date.UTC(2019, 08, 10, 00, 00, 00); //北京时间2019-8-1 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes *
            minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours +
            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒" ;
    } /*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

<!-- 修改计数：欧阳思海 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);  // 50ms周期检测函数
        var pvcountOffset = 1005469;  // 初始化首次数据
        var uvcountOffset = 250804;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int); // 停止检测
            }
        }
    });
</script>




        <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    console.log("lets go！");
    console.log("/");
    searchFunc("/" + "search.json", 'searchInput', 'searchResult');
});
</script>
        <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


        <script src="/libs/materialize/materialize.min.js"></script>
        <script src="/libs/masonry/masonry.pkgd.min.js"></script>
        <script src="/libs/aos/aos.js"></script>
        <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
        <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
        <script src="/js/matery.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-149362573-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-149362573-1');
</script>



        
            <script src="/libs/others/clicklove.js"></script>
        

        
            <script async src="/libs/others/busuanzi.pure.mini.js"></script>
        

        <!-- 洪卫 shw2018 add 2019.08.28 -->
        <script type="text/javascript">
            var OriginTitile = document.title,
                st;
            document.addEventListener("visibilitychange", function () {
                document.hidden ? (document.title = "看不见我🙈~看不见我🙈~", clearTimeout(st)) : (document.title =
                    "(๑•̀ㅂ•́) ✧被发现了～", st = setTimeout(function () {
                        document.title = OriginTitile
                    }, 3e3))
            })
        </script>

        <!-- 鼠标点击烟花爆炸效果  洪卫 shw2018 add 2019.09.09 -->
        

        <!-- 背景雪花飘落特效洪卫 shw2018 add 2019.09.10 -->
        

        <!-- 鼠标点击文字特效 洪卫 shw2018 add 2019.09.10-->
        

        <!-- 背景雪花飘落特效 洪卫 shw2018 add 2019.09.10 -->
        

        <!-- 在线聊天工具  洪卫 shw2018 add 2019.09.11 -->
        

        <!-- 背景 canvas-nest  洪卫 shw 2018  add 2019.09.15-->
        

        <!-- 背景静止彩带  洪卫 shw 2018  add 2019.09.15-->
        

        <!-- 背景动态彩带 洪卫 shw 2018  add 2019.09.15-->
        

    </body>
</html>
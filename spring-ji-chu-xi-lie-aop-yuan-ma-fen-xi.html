<!DOCTYPE HTML>
<html lang="zh-CN">
    <!-- shw2018 洪卫  modify 2019.08.15-->



<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Spring Boot, Spring Cloud, 微服务, Java技术, 好好学java, Java面试, 分布式, 最新干货分享">
    <meta name="baidu-site-verification" content="fmlEuI34ir" />
    <meta name="google-site-verification" content="ZWVq5UvPg33BCEA3LRTUkYe5J854o9lF1_WRTer9l8A" />
    <meta name="description" content="本站是 好好学java 的技术分享博客。内容涵盖Java后端技术、Spring Boot、Spring Cloud、微服务架构、分布式、Java面试、测试开发等相关的研究与知识分享。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Spring基础系列-AOP源码分析 | 好好学java | Spring Boot | Spring Cloud | 微服务 | Java技术 | Java面试 | 分布式 | 最新干货分享</title>
    <link rel="icon" type="image/png" href="http://image.ouyangsihai.cn/FjihsEiBMONnJIRtPwgGkjE4HAP7">

    <!-- <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css"> -->
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <!-- 自定义fontawesome样式：欧阳思海 -->
    <link rel="stylesheet" type="text/css" href="/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/css/brands.min.css">
    <link rel="stylesheet" type="text/css" href="/css/fontawesome.min.css">
    <link rel="stylesheet" type="text/css" href="/css/regular.min.css">
    <link rel="stylesheet" type="text/css" href="/css/solid.min.css">


    <style type="text/css">
        code[class*="language-"],
            pre[class*="language-"] {
                white-space: pre !important;
            }

            

        /* 将matery.css中的背景颜色修改放到这里：欧阳思海 */
        .bg-color {
            background-image: linear-gradient(to right, #ec8585 0%, #419488 100%);
            opacity: 0.9;
            // 透明度
        }
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>

    
    
    <script>
        (function () {
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>
    

    <script>
        var _hmt = _hmt || [];
        (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?6fe466069710c03a563713b507fbaca7";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
        })();
    </script>


    <!-- Google Analytics -->
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-XXXXX-Y', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics -->

    <script>(function (i, s, o, g, r, a, m) { i["DaoVoiceObject"] = r; i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments) }, i[r].l = 1 * new Date(); a = s.createElement(o), m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; a.charset = "utf-8"; m.parentNode.insertBefore(a, m) })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0a804bac.js", "daovoice")</script>

    <script>
        if (true) {
            daovoice('init', {
                app_id: "0a804bac",
                user_id: "NO_89757", // 必填: 该用户在您系统上的唯一ID
                email: "daovoice@example.com", // 选填:  该用户在您系统上的主邮箱
                name: "道客船长", // 选填: 用户名
                signed_up: 1449821660 // 选填: 用户的注册时间，用Unix时间戳表示
            });
            daovoice('update');

            daovoice('init', {
                app_id: "0a804bac"
            });
            daovoice('update');
        }
    </script>
<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/rss2.xml" title="好好学java" type="application/rss+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

    <body>

        <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="http://image.ouyangsihai.cn/FjihsEiBMONnJIRtPwgGkjE4HAP7" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span" style="font-size: 1.4rem;">好好学java</span>
                </a>
            </div>
            


<!-- <a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="" class="waves-effect waves-light">
            
            <i class="fa "></i>
            
            <span></span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title=""></i>
        </a>
    </li>
</ul> -->

<!-- 支持二级菜单特性 洪卫 shw2018 modify 2019.09.17  -->
<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-align-justify"></i></a>
<ul class="right nav-menu">
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-folder-minus"></i>
                
                <span style="font-size: 1.1rem;">Java学习</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/Java%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86/" >
                    
                    <span>Java入门</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/Javaweb/" >
                    
                    <span>Java Web</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/spring%E6%95%99%E7%A8%8B/" >
                    
                    <span>Spring教程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/springboot%E6%95%99%E7%A8%8B/" >
                    
                    <span>SpringBoot教程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/springcloud%E6%95%99%E7%A8%8B/" >
                    
                    <span>SpringCloud教程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/Java%E9%9D%A2%E8%AF%95%E9%A2%98/" >
                    
                    <span>Java面试</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E5%89%91%E6%8C%87offer/" >
                    
                    <span>剑指offer</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-code-branch"></i>
                
                <span style="font-size: 1.1rem;">Java进阶</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%B3%BB%E5%88%97/" >
                    
                    <span>设计模式</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" >
                    
                    <span>Java并发编程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3/" >
                    
                    <span>数据库</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/redis/" >
                    
                    <span>Redis</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/linux/" >
                    
                    <span>Linux</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/" >
                    
                    <span>Java实战项目</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-code"></i>
                
                <span style="font-size: 1.1rem;">python学习</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/python%E5%9F%BA%E7%A1%80/" >
                    
                    <span>python基础</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/python%E6%A1%86%E6%9E%B6/" >
                    
                    <span>python框架</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/python%E5%85%B6%E4%BB%96/" >
                    
                    <span>python其他</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-coffee"></i>
                
                <span style="font-size: 1.1rem;">Java扩展</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/dubbo/" >
                    
                    <span>dubbo</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/netty/" >
                    
                    <span>netty</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/rpc/" >
                    
                    <span>rpc</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/eureka/" >
                    
                    <span>eureka</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" >
                    
                    <span>中间件</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" >
                    
                    <span>分布式</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-desktop"></i>
                
                <span style="font-size: 1.1rem;">计算机核心</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" >
                    
                    <span>数据结构</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/leetcode%E5%88%B7%E9%A2%98/" >
                    
                    <span>leetcode刷题</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" >
                    
                    <span>计算机网络</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E7%AE%97%E6%B3%95/" >
                    
                    <span>算法</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/categories/" class="waves-effect waves-light">
              
                <i style="font-size: 1.1rem;" class="fa fa-adjust"></i>
              
              <span style="font-size: 1.1rem;">学习资源</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/contact" class="waves-effect waves-light">
              
                <i style="font-size: 1.1rem;" class="fa fa-envelope"></i>
              
              <span style="font-size: 1.1rem;">留言</span>
            </a>

            
      </li>
    

    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="http://image.ouyangsihai.cn/FjihsEiBMONnJIRtPwgGkjE4HAP7" class="logo-img circle responsive-img">
        
        <div class="logo-name">好好学java</div>
        <div class="logo-desc">
            
            
            本站是 好好学java 的技术分享博客，涵盖Java后端技术、SpringBoot、微服务架构、分布式、Java面试等知 ...
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-folder-minus"></i>
			
			Java学习
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/Java%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86/ " style="margin-left:75px";>
				  
		          <span>Java入门</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Javaweb/ " style="margin-left:75px";>
				  
		          <span>Java Web</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/spring%E6%95%99%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>Spring教程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/springboot%E6%95%99%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>SpringBoot教程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/springcloud%E6%95%99%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>SpringCloud教程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Java%E9%9D%A2%E8%AF%95%E9%A2%98/ " style="margin-left:75px";>
				  
		          <span>Java面试</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E5%89%91%E6%8C%87offer/ " style="margin-left:75px";>
				  
		          <span>剑指offer</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-code-branch"></i>
			
			Java进阶
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%B3%BB%E5%88%97/ " style="margin-left:75px";>
				  
		          <span>设计模式</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>Java并发编程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3/ " style="margin-left:75px";>
				  
		          <span>数据库</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/redis/ " style="margin-left:75px";>
				  
		          <span>Redis</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/linux/ " style="margin-left:75px";>
				  
		          <span>Linux</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/ " style="margin-left:75px";>
				  
		          <span>Java实战项目</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-code"></i>
			
			python学习
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/python%E5%9F%BA%E7%A1%80/ " style="margin-left:75px";>
				  
		          <span>python基础</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/python%E6%A1%86%E6%9E%B6/ " style="margin-left:75px";>
				  
		          <span>python框架</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/python%E5%85%B6%E4%BB%96/ " style="margin-left:75px";>
				  
		          <span>python其他</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-coffee"></i>
			
			Java扩展
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/dubbo/ " style="margin-left:75px";>
				  
		          <span>dubbo</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/netty/ " style="margin-left:75px";>
				  
		          <span>netty</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/rpc/ " style="margin-left:75px";>
				  
		          <span>rpc</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/eureka/ " style="margin-left:75px";>
				  
		          <span>eureka</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/ " style="margin-left:75px";>
				  
		          <span>中间件</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/ " style="margin-left:75px";>
				  
		          <span>分布式</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-desktop"></i>
			
			计算机核心
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ " style="margin-left:75px";>
				  
		          <span>数据结构</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/leetcode%E5%88%B7%E9%A2%98/ " style="margin-left:75px";>
				  
		          <span>leetcode刷题</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ " style="margin-left:75px";>
				  
		          <span>计算机网络</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E7%AE%97%E6%B3%95/ " style="margin-left:75px";>
				  
		          <span>算法</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/" class="waves-effect waves-light">
			
			    <i class="fa fa-fw fa-adjust"></i>
			
			学习资源
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa fa-fw fa-envelope"></i>
			
			留言
		</a>
          
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

        



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/11.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Spring基础系列-AOP源码分析
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }

    /* 自定义mycard：欧阳思海 */

    #my-card {
        /* position: relative; */
        width: 310px;
        height: 300px;
        /* max-height: 330px; */
        margin-bottom: 15px;
        margin-top: 15px;
        /* text-align: center; */
        border: 0;
        border-radius: 3px;
        color: rgba(0, 0, 0, .87);
        background: #fff 50%;
        background-image: none;
        background-size: auto;
        background-size: cover;
        box-shadow: 0 15px 35px rgba(50, 50, 93, .1), 0 5px 15px rgba(0, 0, 0, .07);
    }

    /* .widget {
        line-height: 1.6em;
        word-wrap: break-word;
        font-size: 0.9em;
        padding-top: 15px;
        padding-left: -45px;
    } */
</style>




<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- shw2018 洪卫  modify 2019.08.15-->

<!-- 代码块修改的代码开始 -->
<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFunction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

<!-- 代码块修改代码结束 -->


<!-- 文章内容详情 -->
<div id="container">
    <div id="artDetail">
        <div class="card">
            <div class="card-content article-info">
                <div class="row tag-cate">
                    <div class="col s7">
                        
                        <div class="article-tag">
                            <!--我修改的地方：欧阳思海-->
                            
                            <a href="/tags/spring-spring%E6%95%99%E7%A8%8B-spring%E6%BA%90%E7%A0%81/" target="_blank">
                                <span class="chip bg-color">spring,spring教程,spring源码</span>
                            </a>
                            
                        </div>
                        
                    </div>
                    <div class="col s5 right-align">
                        
                        <div class="post-cate">
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/spring%E6%95%99%E7%A8%8B/" class="post-category" target="_blank">
                                spring教程
                            </a>
                            
                        </div>
                        
                    </div>
                </div>

                <div class="post-info">
                    <div class="post-date info-break-policy">
                        <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                        2021-04-05
                    </div>

                    <div class="post-author info-break-policy">
                        <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                        
                        欧阳思海
                        
                    </div>

                    
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        17.2k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        77 分
                    </div>
                    
                    

                    
                    <span id="busuanzi_container_site_pv" style='display:none'></span>
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>

                    

                </div>
            </div>
            <hr class="clearfix">
            <div class="card-content article-card-content">
                <!-- 欧阳思海，modify，2020.05.01-->
<!-- 文章详情详情页面的头部广告位置信息 -->
<div id="post-head-panel">
    
    <a href="https://github.com/OUYANGSIHAI/JavaInterview" style="font-size: 18px;" target="_blank">
        <img src="/icons/hot.gif">
        本人花费半年的时间总结的《Java面试指南》已拿腾讯等大厂offer，已开源在github ，欢迎star！
    </a>
    
    
</div>
<br />



<blockquote>
    
            <p>本文GitHub <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">https://github.com/OUYANGSIHAI/JavaInterview</a> 已收录，这是我花了6个月总结的<b>一线大厂Java面试</b>总结，本人已拿大厂offer，欢迎star</p>
    
    <p>原文链接：blog.ouyangsihai.cn &gt;&gt; <a href="/spring-ji-chu-xi-lie-aop-yuan-ma-fen-xi.html" target="_blank">Spring基础系列-AOP源码分析</a></p>
</blockquote>
                <div id="articleContent">
                    <p><strong>一、概述</strong></p>
<p>Spring的两大特性：IOC和AOP。</p>
<p>AOP是面向切面编程，Spring内置了自己实现的基于动态代理技术的AOP，同时还支持成熟的AspectJ框架，我们这里主要讲述的还是内置的基于动态代理的AOP实现。因为面对一些普通的需求，Spring内置的AOP已经绰绰有余。</p>
<p>AOP一般用于增强原来的代码的功能，这种增强体现在辅助方面，比如安全、日志、事务等。</p>
<p><strong>二、术语</strong></p>
<p><strong>1、连接点（JoinPoint）</strong></p>
<p>连接点就是具体的代码中的切入点，指的是<strong>具体的一处</strong>代码位置。</p>
<p><strong>2、切点（PointCut）</strong></p>
<p>切点是对一系列代表同种功能（目的）的切入点（连接点）的统称，<strong>切点不是一个点，而是代表某一功能的一系列连接点的集合</strong>。</p>
<p><strong>3、通知（Advice）</strong></p>
<p>通知就是我们要在切点执行的操作，就是我们要实现的目的，是要实现的功能的代码实现。一般通知又称为增强，所谓增强就是对原来功能的基础上添加新功能，进行功能增强。</p>
<p><strong>4、切面（Aspect）</strong></p>
<p><strong>切面是通知和切点的综合体</strong>，定义好了一个切面，那么我们就知道，这个AOP要实现的功能是什么，需要切入到程序中的那些地方。抽象层次中，<strong>切面是代码功能的横切面</strong>，这个横切面的位置就是切点、这个切面的功能就是通知。</p>
<p><strong>5、织入（Weaving）</strong></p>
<p>织入就是切面作用到目标代码中的方式，Spring内置的AOP采用的是动态代理的方式来织入，还可以采用编译器织入和加载期织入，后两者分别需要特定的编译器和类加载器来完成，后两种方式是AspectJ所支持的织入方式。</p>
<p><strong>6、引介（Introduction）</strong></p>
<p>引介是另一种类型的增强，它可以为类添加一些属性和方法。它和通知是并列的两种不同的增强。</p>
<p><strong>7、目标对象（Target）</strong></p>
<p>目标对象就是我们想要织入的对象，一般不会是一个，通常是一批符合条件的对象。</p>
<p>8、代理（Proxy）</p>
<p>代理就好理解了，Spring内置的AOP就是通过动态代理的方式实现织入的，创建目标对象的代理类，在代理类中执行通知的内容，然后在合适的位置调用目标对象的方法，来达到织入的目的。</p>
<p>三、Spring AOP概述</p>
<p>Spring AOP是基于动态代理技术实现的切面编程，代理技术包括JDK动态代理和CGLIB动态代理，前者基于接口实现，后者基于类实现。</p>
<p><strong>1、Spring中使用AOP技术的方式：</strong></p>
<p>1）定义切面类，使用@Aspect注解</p>
<p>2）在切面类中定义切点方法，使用@PointCut注解</p>
<p>3）在切面类中定义通知方法，使用@Before、@After、@Around等注解</p>
<p>4）在通知方法的注解中使用切点方法</p>
<p>5）在切面类上加设注解@Component</p>
<p>6）启动AOP功能，两种方式：原始的XML配置方式和注解方式</p>
<p>XMl方式：aop:aspectj-autoproxy&#x2F;</p>
<p>注解方式：@EnableAspectJAutoProxy</p>
<p>配置方式：spring.auto.proxy&#x3D;true</p>
<p><strong>2、Spring AOP支持的增强类型</strong></p>
<p>通知增强：Advice</p>
<p>前置通知：MethodBeforeAdvice-在连接点之前执行</p>
<p>后置通知：AfterReturningAdvice-在连接点正常执行完后执行，如果还未到连接点就异常，不会执行</p>
<p>环绕通知：AroundAdvice-在连接点前后执行</p>
<p>异常通知：AfterThrowingAdvice-在连接点抛出异常后执行</p>
<p>finally通知：AfterAdvice-最终执行，无论是否异常，方法执行结束都会执行</p>
<p>引介增强：IntroductionInterceptor-DelegatingIntroductionInterceptor</p>
<p>前五种很好理解，重点是最后一种引介增强，这种增强并不是针对方法的增强，而是针对类的增强，它会为目标添加属性和方法，比如它可以为目标类添加一个接口的实现。目标类原本没有实现某个接口，但是我们可以使用引介增强的方式为目标类创建一个实现该接口的代理，在这个代理中可以使用接口的功能来作用于目标对象。</p>
<p><strong>3、原理图：</strong>（右键打开看大图）</p>
<img title="Spring基础系列-AOP源码分析" src="https://www.javazhiyin.com/wp-content/uploads/2018/09/java5-1536470850.jpeg" src="https://www.javazhiyin.com/wp-content/themes/mnews/images/post-loading.gif" alt="Spring基础系列-AOP源码分析">

<p>四、源码分析</p>
<p><strong>1、入口</strong></p>
<p><strong><strong>1.1 入口一：aop:aspectj-autoproxy&#x2F;</strong></strong></p>
<p>源码1-来自：AopNamespaceHandler</p>
<td class="line_numbers"><pre>12345678910</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">@Override    public void init() {        // In 2.0 XSD as well as in 2.1 XSD.        registerBeanDefinitionParser("config", new ConfigBeanDefinitionParser());        registerBeanDefinitionParser("aspectj-autoproxy", new AspectJAutoProxyBeanDefinitionParser());        registerBeanDefinitionDecorator("scoped-proxy", new ScopedProxyBeanDefinitionDecorator());         // Only in 2.0 XSD: moved to context namespace as of 2.1        registerBeanDefinitionParser("spring-configured", new SpringConfiguredBeanDefinitionParser());    }</pre></td>

<p>@Override<br>    public void init() {<br>        &#x2F;&#x2F; In 2.0 XSD as well as in 2.1 XSD.<br>        registerBeanDefinitionParser(“config”, new ConfigBeanDefinitionParser());<br>        registerBeanDefinitionParser(“aspectj-autoproxy”, new AspectJAutoProxyBeanDefinitionParser());<br>        registerBeanDefinitionDecorator(“scoped-proxy”, new ScopedProxyBeanDefinitionDecorator());</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// Only in 2.0 XSD: moved to context namespace as of 2.1</span>
    <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"spring-configured"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SpringConfiguredBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面源码就是针对XML配置中aop:XXX&#x2F;配置的解析，红色部分正是针对aop:aspectj-autoproxy&#x2F;的解析，如果配置了aspectj-autoproxy，则注册Bean定义解析器：<strong>AspectJAutoProxyBeanDefinitionParser</strong>。</p>
<p>AspectJAutoProxyBeanDefinitionParser是一个实现了BeanDefinitionParser接口的类，专门用于解析切面自动代理的Bean定义的解析工作，重点在其parse方法。</p>
<p>源码2-来自：AspectJAutoProxyBeanDefinitionParser</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">class AspectJAutoProxyBeanDefinitionParser implements BeanDefinitionParser {     @Override    @Nullable    public BeanDefinition parse(Element element, ParserContext parserContext) {        // 1-注册AnnotationAwareAspectJAutoProxyCreator        AopNamespaceUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(parserContext, element);        // 2-扩展BeanDefinition        extendBeanDefinition(element, parserContext);        return null;    }     private void extendBeanDefinition(Element element, ParserContext parserContext) {        // 获取BeanName为internalAutoProxyCreator的BeanDefinition，其实就是之前注册的自动代理构建器        BeanDefinition beanDef =                parserContext.getRegistry().getBeanDefinition(AopConfigUtils.AUTO_PROXY_CREATOR_BEAN_NAME);        if (element.hasChildNodes()) {            // 如果当前元素有子节点，则给上面获取的Bean定义添加子节点中明确定义的类型值（填充BeanDefinition）            addIncludePatterns(element, parserContext, beanDef);        }    }     private void addIncludePatterns(Element element, ParserContext parserContext, BeanDefinition beanDef) {        ManagedListTypedStringValue includePatterns = new ManagedList();        NodeList childNodes = element.getChildNodes();//获取子节点        for (int i = 0; i  childNodes.getLength(); i++) {            // 遍历子节点，获取子节点中name属性值，封装到TypeStringValue中            // 在上下文中提取子节点includeElement的元数据保存到TypedStringValue的source属性中            // 最后封装好的TypeStringValue保存到includePatterns列表中            Node node = childNodes.item(i);            if (node instanceof Element) {                Element includeElement = (Element) node;                TypedStringValue valueHolder = new TypedStringValue(includeElement.getAttribute("name"));                valueHolder.setSource(parserContext.extractSource(includeElement));                includePatterns.add(valueHolder);            }        }        if (!includePatterns.isEmpty()) {            // 从解析上下文parserContext中提取指定节点element的元数据保存到includePatterns的source属性中，            // 然后将includePatterns保存到BeanDefinition的propertyValues属性中            includePatterns.setSource(parserContext.extractSource(element));            beanDef.getPropertyValues().add("includePatterns", includePatterns);        }    } }</pre></td>

<p>class AspectJAutoProxyBeanDefinitionParser implements BeanDefinitionParser {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">public</span> BeanDefinition <span class="token function">parse</span><span class="token punctuation">(</span>Element element<span class="token punctuation">,</span> ParserContext parserContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1-注册AnnotationAwareAspectJAutoProxyCreator</span>
    AopNamespaceUtils<span class="token punctuation">.</span><span class="token function">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="token punctuation">(</span>parserContext<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 2-扩展BeanDefinition</span>
    <span class="token function">extendBeanDefinition</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> parserContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">extendBeanDefinition</span><span class="token punctuation">(</span>Element element<span class="token punctuation">,</span> ParserContext parserContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获取BeanName为internalAutoProxyCreator的BeanDefinition，其实就是之前注册的自动代理构建器</span>
    BeanDefinition beanDef <span class="token operator">=</span>
            parserContext<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>AopConfigUtils<span class="token punctuation">.</span>AUTO_PROXY_CREATOR_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">hasChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果当前元素有子节点，则给上面获取的Bean定义添加子节点中明确定义的类型值（填充BeanDefinition）</span>
        <span class="token function">addIncludePatterns</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> parserContext<span class="token punctuation">,</span> beanDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addIncludePatterns</span><span class="token punctuation">(</span>Element element<span class="token punctuation">,</span> ParserContext parserContext<span class="token punctuation">,</span> BeanDefinition beanDef<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ManagedListTypedStringValue includePatterns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ManagedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    NodeList childNodes <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取子节点</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i  childNodes<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 遍历子节点，获取子节点中name属性值，封装到TypeStringValue中</span>
        <span class="token comment" spellcheck="true">// 在上下文中提取子节点includeElement的元数据保存到TypedStringValue的source属性中</span>
        <span class="token comment" spellcheck="true">// 最后封装好的TypeStringValue保存到includePatterns列表中</span>
        Node node <span class="token operator">=</span> childNodes<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Element includeElement <span class="token operator">=</span> <span class="token punctuation">(</span>Element<span class="token punctuation">)</span> node<span class="token punctuation">;</span>
            TypedStringValue valueHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypedStringValue</span><span class="token punctuation">(</span>includeElement<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            valueHolder<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>parserContext<span class="token punctuation">.</span><span class="token function">extractSource</span><span class="token punctuation">(</span>includeElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            includePatterns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>valueHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>includePatterns<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 从解析上下文parserContext中提取指定节点element的元数据保存到includePatterns的source属性中，</span>
        <span class="token comment" spellcheck="true">// 然后将includePatterns保存到BeanDefinition的propertyValues属性中</span>
        includePatterns<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>parserContext<span class="token punctuation">.</span><span class="token function">extractSource</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanDef<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"includePatterns"</span><span class="token punctuation">,</span> includePatterns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面代码中有两个重点，首先就是registerAspectJAnnotationAutoProxyCreatorIfNecessary方法调用，用于注册AnnotationAwareAspectJAutoProxyCreator构建器；另一点就是在构建器注册完成后，为其填充一些必要内容，这些内容为XML配置中子节点的配置内容，具体内容参照源码，这里重点看看第一步，注册构建器的源码：</p>
<p>源码3-来自：AopNamespaceUtils</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public static void registerAspectJAnnotationAutoProxyCreatorIfNecessary(            ParserContext parserContext, Element sourceElement) {        // 1-注册或升级AnnotationAwareAspectJAutoProxyCreator        // parserContext.getRegistry()获取到的是BeanDefinitionRegistry注册器，第二个参数是提取的指定元素的元数据        BeanDefinition beanDefinition = AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(                parserContext.getRegistry(), parserContext.extractSource(sourceElement));        // 2-校验并设置是否适用基于CGLIB的动态代理实现AOP，和是否要暴露代理类        useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);        // 3-注册成组件        registerComponentIfNecessary(beanDefinition, parserContext);    }     private static void useClassProxyingIfNecessary(BeanDefinitionRegistry registry, @Nullable Element sourceElement) {        if (sourceElement != null) {            boolean proxyTargetClass = Boolean.parseBoolean(sourceElement.getAttribute(PROXY_TARGET_CLASS_ATTRIBUTE));//获取XML中设置的proxy-target-class属性的值，解析为Boolean值            if (proxyTargetClass) {                // 如果为true，则强制自动代理构建器使用基于类的动态代理CGLIB，需要将属性设置到自动代理构建器的BeanDefinition中                AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);            }            boolean exposeProxy = Boolean.parseBoolean(sourceElement.getAttribute(EXPOSE_PROXY_ATTRIBUTE));//获取XML中配置的expose-proxy属性的值，同样解析为Boolean值            if (exposeProxy) {                // 如果为true，强制自动代理构建器暴露代理类，需要将属性设置到自动代理构建器的BeanDefinition中                AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);            }        }    }     private static void registerComponentIfNecessary(@Nullable BeanDefinition beanDefinition, ParserContext parserContext) {        if (beanDefinition != null) {            // 将自动代理构建器包装成为一个Bean组件定义。            // Bean组件定义是将一个BeanDefinition中包含的所有的属性的值（可能为一个BeanDefinition或者BeanReference）全部封装起来成为一个组件包，然后将其注册到解析上下文中            BeanComponentDefinition componentDefinition =                    new BeanComponentDefinition(beanDefinition, AopConfigUtils.AUTO_PROXY_CREATOR_BEAN_NAME);            parserContext.registerComponent(componentDefinition);        }    }</pre></td>

<p>public static void registerAspectJAnnotationAutoProxyCreatorIfNecessary(<br>            ParserContext parserContext, Element sourceElement) {<br>        &#x2F;&#x2F; 1-注册或升级AnnotationAwareAspectJAutoProxyCreator<br>        &#x2F;&#x2F; parserContext.getRegistry()获取到的是BeanDefinitionRegistry注册器，第二个参数是提取的指定元素的元数据<br>        BeanDefinition beanDefinition &#x3D; AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(<br>                parserContext.getRegistry(), parserContext.extractSource(sourceElement));<br>        &#x2F;&#x2F; 2-校验并设置是否适用基于CGLIB的动态代理实现AOP，和是否要暴露代理类<br>        useClassProxyingIfNecessary(parserContext.getRegistry(), sourceElement);<br>        &#x2F;&#x2F; 3-注册成组件<br>        registerComponentIfNecessary(beanDefinition, parserContext);<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">useClassProxyingIfNecessary</span><span class="token punctuation">(</span>BeanDefinitionRegistry registry<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Element sourceElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceElement <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> proxyTargetClass <span class="token operator">=</span> Boolean<span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>sourceElement<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>PROXY_TARGET_CLASS_ATTRIBUTE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取XML中设置的proxy-target-class属性的值，解析为Boolean值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>proxyTargetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果为true，则强制自动代理构建器使用基于类的动态代理CGLIB，需要将属性设置到自动代理构建器的BeanDefinition中</span>
            AopConfigUtils<span class="token punctuation">.</span><span class="token function">forceAutoProxyCreatorToUseClassProxying</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> exposeProxy <span class="token operator">=</span> Boolean<span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>sourceElement<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>EXPOSE_PROXY_ATTRIBUTE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取XML中配置的expose-proxy属性的值，同样解析为Boolean值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exposeProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果为true，强制自动代理构建器暴露代理类，需要将属性设置到自动代理构建器的BeanDefinition中</span>
            AopConfigUtils<span class="token punctuation">.</span><span class="token function">forceAutoProxyCreatorToExposeProxy</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerComponentIfNecessary</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> BeanDefinition beanDefinition<span class="token punctuation">,</span> ParserContext parserContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinition <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 将自动代理构建器包装成为一个Bean组件定义。</span>
        <span class="token comment" spellcheck="true">// Bean组件定义是将一个BeanDefinition中包含的所有的属性的值（可能为一个BeanDefinition或者BeanReference）全部封装起来成为一个组件包，然后将其注册到解析上下文中</span>
        BeanComponentDefinition componentDefinition <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">BeanComponentDefinition</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">,</span> AopConfigUtils<span class="token punctuation">.</span>AUTO_PROXY_CREATOR_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        parserContext<span class="token punctuation">.</span><span class="token function">registerComponent</span><span class="token punctuation">(</span>componentDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>registerAspectJAnnotationAutoProxyCreatorIfNecessary方法中主要做了三件事情：</p>
<p>1-注册构建器</p>
<p>2-配置属性</p>
<p>3-组件注册</p>
<p>针对第2和第3，在源码注释中解释的很清楚啦，主要看看第一步，继续进行构建器的注册：</p>
<p>源码4-来自：AopConfigUtils</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public static void forceAutoProxyCreatorToUseClassProxying(BeanDefinitionRegistry registry) {        if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) {            //如果构建器已经加载，获取其BeanDefinition，添加属性proxyTargetClass，值为true            BeanDefinition definition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);            definition.getPropertyValues().add("proxyTargetClass", Boolean.TRUE);        }    }     public static void forceAutoProxyCreatorToExposeProxy(BeanDefinitionRegistry registry) {        if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) {            //如果构建器已经加载，获取其BeanDefinition，添加属性exposeProxy，值为true            BeanDefinition definition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);            definition.getPropertyValues().add("exposeProxy", Boolean.TRUE);        }    }     @Nullable    private static BeanDefinition registerOrEscalateApcAsRequired(Class? cls, BeanDefinitionRegistry registry,            @Nullable Object source) {         Assert.notNull(registry, "BeanDefinitionRegistry must not be null");         if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) {            // 1-如果internalAutoProxyCreator已经被注册那么比较新旧自动代理构建器类在列表中的优先级，如果已注册的构建器优先级低，则替换为给定的新构建器            BeanDefinition apcDefinition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);            if (!cls.getName().equals(apcDefinition.getBeanClassName())) {                int currentPriority = findPriorityForClass(apcDefinition.getBeanClassName());                int requiredPriority = findPriorityForClass(cls);                if (currentPriority  requiredPriority) {                    apcDefinition.setBeanClassName(cls.getName());                }            }            return null;        }        // 尚未注册internalAutoProxyCreator的情况下，将给定的构建器包装成RootBeanDefinition，然后注册这个BeanDefinition        RootBeanDefinition beanDefinition = new RootBeanDefinition(cls);        // 把元数据保存到BeanDefinition中        beanDefinition.setSource(source);        // 设置为最高优先值        beanDefinition.getPropertyValues().add("order", Ordered.HIGHEST_PRECEDENCE);        // 设置为基础角色        beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);        // 2-以internalAutoProxyCreator为beanName注册当前BeanDefinition（AnnotationAwareAspectJAutoProxyCreator类）        registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);        return beanDefinition;    }</pre></td>

<p>public static void forceAutoProxyCreatorToUseClassProxying(BeanDefinitionRegistry registry) {<br>        if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) {<br>            &#x2F;&#x2F;如果构建器已经加载，获取其BeanDefinition，添加属性proxyTargetClass，值为true<br>            BeanDefinition definition &#x3D; registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);<br>            definition.getPropertyValues().add(“proxyTargetClass”, Boolean.TRUE);<br>        }<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">forceAutoProxyCreatorToExposeProxy</span><span class="token punctuation">(</span>BeanDefinitionRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>AUTO_PROXY_CREATOR_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//如果构建器已经加载，获取其BeanDefinition，添加属性exposeProxy，值为true</span>
        BeanDefinition definition <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>AUTO_PROXY_CREATOR_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        definition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"exposeProxy"</span><span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> BeanDefinition <span class="token function">registerOrEscalateApcAsRequired</span><span class="token punctuation">(</span>Class<span class="token operator">?</span> cls<span class="token punctuation">,</span> BeanDefinitionRegistry registry<span class="token punctuation">,</span>
        <span class="token annotation punctuation">@Nullable</span> Object source<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token string">"BeanDefinitionRegistry must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>AUTO_PROXY_CREATOR_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 1-如果internalAutoProxyCreator已经被注册那么比较新旧自动代理构建器类在列表中的优先级，如果已注册的构建器优先级低，则替换为给定的新构建器</span>
        BeanDefinition apcDefinition <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>AUTO_PROXY_CREATOR_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cls<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>apcDefinition<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> currentPriority <span class="token operator">=</span> <span class="token function">findPriorityForClass</span><span class="token punctuation">(</span>apcDefinition<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> requiredPriority <span class="token operator">=</span> <span class="token function">findPriorityForClass</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPriority  requiredPriority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                apcDefinition<span class="token punctuation">.</span><span class="token function">setBeanClassName</span><span class="token punctuation">(</span>cls<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 尚未注册internalAutoProxyCreator的情况下，将给定的构建器包装成RootBeanDefinition，然后注册这个BeanDefinition</span>
    RootBeanDefinition beanDefinition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 把元数据保存到BeanDefinition中</span>
    beanDefinition<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 设置为最高优先值</span>
    beanDefinition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">,</span> Ordered<span class="token punctuation">.</span>HIGHEST_PRECEDENCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 设置为基础角色</span>
    beanDefinition<span class="token punctuation">.</span><span class="token function">setRole</span><span class="token punctuation">(</span>BeanDefinition<span class="token punctuation">.</span>ROLE_INFRASTRUCTURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 2-以internalAutoProxyCreator为beanName注册当前BeanDefinition（AnnotationAwareAspectJAutoProxyCreator类）</span>
    registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>AUTO_PROXY_CREATOR_BEAN_NAME<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> beanDefinition<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>源码4中前两个方法时源码3中第二步里面配置属性时调用的方法，在此给出。</p>
<p>源码4的1-中是在已存在一个自动代理构建器的情况下，将其与新的给定的AnnotationAwareAspectJAutoProxyCreator构建器的优先级进行比对，取优先极高的。</p>
<p>最后的registerBeanDefinition方法用于注册BeanDefinition。至此，自动代理构建器加载完毕。</p>
<p><strong><strong>1.2 入口二：@EnableAspectJAutoProxy</strong></strong></p>
<p>　源码5-来自：EnableAspectJAutoProxy</p>
<td class="line_numbers"><pre>123456789101112131415161718192021</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Import(AspectJAutoProxyRegistrar.class)public @interface EnableAspectJAutoProxy {     /**     * Indicate whether subclass-based (CGLIB) proxies are to be created as opposed     * to standard Java interface-based proxies. The default is {@code false}.     */    boolean proxyTargetClass() default false;     /**     * Indicate that the proxy should be exposed by the AOP framework as a {@code ThreadLocal}     * for retrieval via the {@link org.springframework.aop.framework.AopContext} class.     * Off by default, i.e. no guarantees that {@code AopContext} access will work.     * @since 4.3.1     */    boolean exposeProxy() default false; }</pre></td>

<p>@Target(ElementType.TYPE)<br>@Retention(RetentionPolicy.RUNTIME)<br>@Documented<br>@Import(AspectJAutoProxyRegistrar.class)<br>public @interface EnableAspectJAutoProxy {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">/**
 * Indicate whether subclass-based (CGLIB) proxies are to be created as opposed
 * to standard Java interface-based proxies. The default is {@code false}.
 */</span>
<span class="token keyword">boolean</span> <span class="token function">proxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * Indicate that the proxy should be exposed by the AOP framework as a {@code ThreadLocal}
 * for retrieval via the {@link org.springframework.aop.framework.AopContext} class.
 * Off by default, i.e. no guarantees that {@code AopContext} access will work.
 * @since 4.3.1
 */</span>
<span class="token keyword">boolean</span> <span class="token function">exposeProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>源码中重点关注@Import(<strong>AspectJAutoProxyRegistrar</strong>.class)，很明显这个注解导入了一个新类：<strong>AspectJAutoProxyRegistrar。</strong></p>
<p>使用@Import注解导入的方式可以将一个类注册到BeanFactory中。</p>
<p>源码6-来自AspectJAutoProxyRegistrar</p>
<td class="line_numbers"><pre>123456789101112131415161718192021</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">class AspectJAutoProxyRegistrar implements ImportBeanDefinitionRegistrar {     @Override    public void registerBeanDefinitions(            AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {        // 1-注册或升级自动代理构建器        AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);        // 2-封装注解属性，并根据属性进行配置        AnnotationAttributes enableAspectJAutoProxy =                AnnotationConfigUtils.attributesFor(importingClassMetadata, EnableAspectJAutoProxy.class);        if (enableAspectJAutoProxy != null) {            if (enableAspectJAutoProxy.getBoolean("proxyTargetClass")) {                AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);            }            if (enableAspectJAutoProxy.getBoolean("exposeProxy")) {                AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);            }        }    } }</pre></td>

<p>class AspectJAutoProxyRegistrar implements ImportBeanDefinitionRegistrar {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>
        AnnotationMetadata importingClassMetadata<span class="token punctuation">,</span> BeanDefinitionRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1-注册或升级自动代理构建器</span>
    AopConfigUtils<span class="token punctuation">.</span><span class="token function">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 2-封装注解属性，并根据属性进行配置</span>
    AnnotationAttributes enableAspectJAutoProxy <span class="token operator">=</span>
            AnnotationConfigUtils<span class="token punctuation">.</span><span class="token function">attributesFor</span><span class="token punctuation">(</span>importingClassMetadata<span class="token punctuation">,</span> EnableAspectJAutoProxy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableAspectJAutoProxy <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableAspectJAutoProxy<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"proxyTargetClass"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            AopConfigUtils<span class="token punctuation">.</span><span class="token function">forceAutoProxyCreatorToUseClassProxying</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableAspectJAutoProxy<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"exposeProxy"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            AopConfigUtils<span class="token punctuation">.</span><span class="token function">forceAutoProxyCreatorToExposeProxy</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>我们可以从源码5中看到注解@EnableAspectJAutoProxy内部有两个属性设置proxyTargetClass和exposeProxy，这个之前的入口一中源码3里面的2-中的设置是一样的，即我们在XML启动AOP的时候也可以设置这两个值。</p>
<p>proxyTargetClass属性表示是否适用基于类的的动态代理CGLIB来创建代理类。true表示使用，false表示不使用，默认是false。</p>
<p>exposeProxy属性表示是否暴露生成的代理类，暴露就是可手动调用，最常见的情况如，在一个类中使用this调用带有@Transactional注解的方法，你会发现事务是不生效的，这时候我们就可以将生成的代理暴露出来手动调用代理类来保证事务生效：</p>
<p>如下例子中：</p>
<td class="line_numbers"><pre>1234</pre></td><td class="code"><pre class="null" style="font-family:monospace;">public interface TestService {
    void testMethod1();
    void testMethod2();
 }</pre></td>

<p>public interface TestService {<br>    void testMethod1();<br>    void testMethod2();<br> }</p>
<td class="line_numbers"><pre>1234567891011</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public class TestServiceImpl {     @Transactional    public void testMethod1(){        //some transaction operate        }     public void testMethod2(){        this.testMethod1();    }}</pre></td>

<p>public class TestServiceImpl {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMethod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//some transaction operate    </span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMethod2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">testMethod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>在testMethod2中以this.testMethod1()方式调用带事务注解的testMethod1方法时，其事务是不生效的。修改方式就是将exposeProxy设置为true，然后修改调用方式为：</p>
<td class="line_numbers"><pre>1</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">((TestService)AopContext.currnetProxy()).testMethod1();</pre></td>

<p>((TestService)AopContext.currnetProxy()).testMethod1();</p>
<p>源码6中1-调用的是AopConfigUtils中的方法：</p>
<p>源码7-来自：AopConfigUtils</p>
<td class="line_numbers"><pre>1234</pre></td><td class="code"><pre class="null" style="font-family:monospace;">@Nullable
public static BeanDefinition registerAspectJAnnotationAutoProxyCreatorIfNecessary(BeanDefinitionRegistry registry) {
    return registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry, null);
}</pre></td>

<p>@Nullable<br>public static BeanDefinition registerAspectJAnnotationAutoProxyCreatorIfNecessary(BeanDefinitionRegistry registry) {<br>    return registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry, null);<br>}</p>
<p>然后它再调用的就是源码4中的源码了，到这里调用的就是公共部分啦。那么这一部分也就到此为止了，其余见源码4之后的部分。</p>
<p>到此两个主要的入口都分析完毕，入口的主要作用就是注册或者升级自动代理构建器，因为之后AOP的操作基本都要依靠这个构建器来完成。</p>
<p><strong>2、创建AOP代理</strong></p>
<p>我们的重点就是构建器AnnotationAwareAspectJAutoProxyCreator，分析下其继承结构，你会发现它实现了BeanPostProcessor接口。</p>
<p>BeanPostProcessor接口有两个方法：</p>
<p>postProcessBeforeInitialization：Bean实例初始化前调用</p>
<p>postProcessAfterInitialization：Bean实例初始化之后调用</p>
<p>然后我们在其继承体系中寻找实现这两个方法的类，一番寻找后发现：AbstractAutoProxyCreator</p>
<p>源码8-来自：AbstractAutoProxyCreator</p>
<td class="line_numbers"><pre>12345678910111213</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">@Override    public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) throws BeansException {        if (bean != null) {            // 1-生成缓存key            Object cacheKey = getCacheKey(bean.getClass(), beanName);            // 校验该key是否已存在于earlyProxyReferences缓存            if (!this.earlyProxyReferences.contains(cacheKey)) {                // 2-执行创建代理对象                return wrapIfNecessary(bean, beanName, cacheKey);            }        }        return bean;    }</pre></td>

<p>@Override<br>    public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) throws BeansException {<br>        if (bean !&#x3D; null) {<br>            &#x2F;&#x2F; 1-生成缓存key<br>            Object cacheKey &#x3D; getCacheKey(bean.getClass(), beanName);<br>            &#x2F;&#x2F; 校验该key是否已存在于earlyProxyReferences缓存<br>            if (!this.earlyProxyReferences.contains(cacheKey)) {<br>                &#x2F;&#x2F; 2-执行创建代理对象<br>                return wrapIfNecessary(bean, beanName, cacheKey);<br>            }<br>        }<br>        return bean;<br>    }</p>
<p>我们发现了这个方法的实现，这个方法会在构建器Bean初始化之后被调用。我们看看它做了啥？</p>
<p>重点就是wrapIfNecessary方法，这个方法用于代理对象的生成。</p>
<p>源码9-来自：AbstractAutoProxyCreator</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {        if (StringUtils.hasLength(beanName) && this.targetSourcedBeans.contains(beanName)) {            // 已经处理过，直接返回            return bean;        }        if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) {            // 如果不需要增强，直接返回            return bean;        }        if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) {        　　 // 检测目标类是否是AOP的基础设施类,基础设施类包括Advice、Pointcut、Advisor、AopInfrastructureBean，或者是否需要跳过代理，如果是则将其设置为无需增强            this.advisedBeans.put(cacheKey, Boolean.FALSE);            return bean;        }         // Create proxy if we have advice.        // 1-获取针对当前Bean的增强        Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);        if (specificInterceptors != DO_NOT_PROXY) {            // 如果获取到增强则执行下面的创建代理            this.advisedBeans.put(cacheKey, Boolean.TRUE);            // 2-创建代理            Object proxy = createProxy(                    bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));            // 缓存代理类            this.proxyTypes.put(cacheKey, proxy.getClass());            return proxy;        }        // 如果未获取到增强，则设置跳过代理        this.advisedBeans.put(cacheKey, Boolean.FALSE);        return bean;    }</pre></td>

<p>protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {<br>        if (StringUtils.hasLength(beanName) &amp;&amp; this.targetSourcedBeans.contains(beanName)) {<br>            &#x2F;&#x2F; 已经处理过，直接返回<br>            return bean;<br>        }<br>        if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) {<br>            &#x2F;&#x2F; 如果不需要增强，直接返回<br>            return bean;<br>        }<br>        if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) {<br>        　　 &#x2F;&#x2F; 检测目标类是否是AOP的基础设施类,基础设施类包括Advice、Pointcut、Advisor、AopInfrastructureBean，或者是否需要跳过代理，如果是则将其设置为无需增强<br>            this.advisedBeans.put(cacheKey, Boolean.FALSE);<br>            return bean;<br>        }</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// Create proxy if we have advice.</span>
    <span class="token comment" spellcheck="true">// 1-获取针对当前Bean的增强</span>
    Object<span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>specificInterceptors <span class="token operator">!=</span> DO_NOT_PROXY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果获取到增强则执行下面的创建代理</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 2-创建代理</span>
        Object proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>
                bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SingletonTargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 缓存代理类</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 如果未获取到增强，则设置跳过代理</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的源码中除了进行一些必要的校验之外，主要的逻辑是获取针对当前Bean的增强和创建代理这两步。</p>
<p>首先来看下如何获取增强</p>
<p>源码10-来自：AbstractAdvisorAutoProxyCreator</p>
<td class="line_numbers"><pre>123456789101112</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//获取通知（增强）    @Override    @Nullable    protected Object[] getAdvicesAndAdvisorsForBean(            Class? beanClass, String beanName, @Nullable TargetSource targetSource) {         ListAdvisor advisors = findEligibleAdvisors(beanClass, beanName);        if (advisors.isEmpty()) {            return DO_NOT_PROXY;        }        return advisors.toArray();    }</pre></td>

<p>&#x2F;&#x2F;获取通知（增强）<br>    @Override<br>    @Nullable<br>    protected Object[] getAdvicesAndAdvisorsForBean(<br>            Class? beanClass, String beanName, @Nullable TargetSource targetSource) {</p>
<pre class="line-numbers language-java"><code class="language-java">
    ListAdvisor advisors <span class="token operator">=</span> <span class="token function">findEligibleAdvisors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>advisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> DO_NOT_PROXY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> advisors<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>源码11-来自：AbstractAdvisorAutoProxyCreator</p>
<td class="line_numbers"><pre>123456789101112</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">protected ListAdvisor findEligibleAdvisors(Class? beanClass, String beanName) {        // 1-先获取所有的增强器列表        ListAdvisor candidateAdvisors = findCandidateAdvisors();        // 2-获取应用到当前目标类的增强器列表        ListAdvisor eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);        //这个方法是一个钩子方法，用于子类重写扩展        extendAdvisors(eligibleAdvisors);        if (!eligibleAdvisors.isEmpty()) {            eligibleAdvisors = sortAdvisors(eligibleAdvisors);//排序        }        return eligibleAdvisors;    }</pre></td>

<p>protected ListAdvisor findEligibleAdvisors(Class? beanClass, String beanName) {<br>        &#x2F;&#x2F; 1-先获取所有的增强器列表<br>        ListAdvisor candidateAdvisors &#x3D; findCandidateAdvisors();<br>        &#x2F;&#x2F; 2-获取应用到当前目标类的增强器列表<br>        ListAdvisor eligibleAdvisors &#x3D; findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);<br>        &#x2F;&#x2F;这个方法是一个钩子方法，用于子类重写扩展<br>        extendAdvisors(eligibleAdvisors);<br>        if (!eligibleAdvisors.isEmpty()) {<br>            eligibleAdvisors &#x3D; sortAdvisors(eligibleAdvisors);&#x2F;&#x2F;排序<br>        }<br>        return eligibleAdvisors;<br>    }</p>
<p>上面的源码我们重点关注<strong>findCandidateAdvisors</strong>方法和<strong>findAdvisorsThatCanApply</strong>方法，分别用于找出BeanFactory中所有的可用的增强器，和从可用增强器中找出作用于目标类的增强器。</p>
<p>源码12-来自：AbstractAdvisorAutoProxyCreator</p>
<td class="line_numbers"><pre>1234</pre></td><td class="code"><pre class="null" style="font-family:monospace;"> protected ListAdvisor findCandidateAdvisors() {
     Assert.state(this.advisorRetrievalHelper != null, "No BeanFactoryAdvisorRetrievalHelper available");
      return this.advisorRetrievalHelper.findAdvisorBeans();
  }</pre></td>

<p> protected ListAdvisor findCandidateAdvisors() {<br>     Assert.state(this.advisorRetrievalHelper !&#x3D; null, “No BeanFactoryAdvisorRetrievalHelper available”);<br>      return this.advisorRetrievalHelper.findAdvisorBeans();<br>  }</p>
<p>源码13-来自：BeanFactoryAdvisorRetrievalHelper</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public ListAdvisor findAdvisorBeans() {        // Determine list of advisor bean names, if not cached already.        String[] advisorNames = null;        synchronized (this) {            advisorNames = this.cachedAdvisorBeanNames;            if (advisorNames == null) {                // Do not initialize FactoryBeans here: We need to leave all regular beans                // uninitialized to let the auto-proxy creator apply to them!                // 1-获取当前BeanFactory及其继承体系中的容器中所有的Advisor类型的Bean的BeanName数组，排除掉FactoryBeans                advisorNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(                        this.beanFactory, Advisor.class, true, false);                this.cachedAdvisorBeanNames = advisorNames;            }        }        if (advisorNames.length == 0) {            return new LinkedList();        }         ListAdvisor advisors = new LinkedList();        for (String name : advisorNames) {            if (isEligibleBean(name)) {                // 2-再排除创建中的Bean                if (this.beanFactory.isCurrentlyInCreation(name)) {                    if (logger.isDebugEnabled()) {                        logger.debug("Skipping currently created advisor '" + name + "'");                    }                }                else {                    try {                        // 3-把剩下的Bean添加到通知（增强器）列表中                        advisors.add(this.beanFactory.getBean(name, Advisor.class));                    }                    catch (BeanCreationException ex) {                        Throwable rootCause = ex.getMostSpecificCause();                        if (rootCause instanceof BeanCurrentlyInCreationException) {                            BeanCreationException bce = (BeanCreationException) rootCause;                            String bceBeanName = bce.getBeanName();                            if (bceBeanName != null && this.beanFactory.isCurrentlyInCreation(bceBeanName)) {                                if (logger.isDebugEnabled()) {                                    logger.debug("Skipping advisor '" + name +                                            "' with dependency on currently created bean: " + ex.getMessage());                                }                                // Ignore: indicates a reference back to the bean we're trying to advise.                                // We want to find advisors other than the currently created bean itself.                                continue;                            }                        }                        throw ex;                    }                }            }        }        return advisors;    }</pre></td>

<p>public ListAdvisor findAdvisorBeans() {<br>        &#x2F;&#x2F; Determine list of advisor bean names, if not cached already.<br>        String[] advisorNames &#x3D; null;<br>        synchronized (this) {<br>            advisorNames &#x3D; this.cachedAdvisorBeanNames;<br>            if (advisorNames &#x3D;&#x3D; null) {<br>                &#x2F;&#x2F; Do not initialize FactoryBeans here: We need to leave all regular beans<br>                &#x2F;&#x2F; uninitialized to let the auto-proxy creator apply to them!<br>                &#x2F;&#x2F; 1-获取当前BeanFactory及其继承体系中的容器中所有的Advisor类型的Bean的BeanName数组，排除掉FactoryBeans<br>                advisorNames &#x3D; BeanFactoryUtils.beanNamesForTypeIncludingAncestors(<br>                        this.beanFactory, Advisor.class, true, false);<br>                this.cachedAdvisorBeanNames &#x3D; advisorNames;<br>            }<br>        }<br>        if (advisorNames.length &#x3D;&#x3D; 0) {<br>            return new LinkedList();<br>        }</p>
<pre class="line-numbers language-java"><code class="language-java">
    ListAdvisor advisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>String name <span class="token operator">:</span> advisorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEligibleBean</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 2-再排除创建中的Bean</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">isCurrentlyInCreation</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Skipping currently created advisor '"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 3-把剩下的Bean添加到通知（增强器）列表中</span>
                    advisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> Advisor<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Throwable rootCause <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">getMostSpecificCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>rootCause <span class="token keyword">instanceof</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        BeanCreationException bce <span class="token operator">=</span> <span class="token punctuation">(</span>BeanCreationException<span class="token punctuation">)</span> rootCause<span class="token punctuation">;</span>
                        String bceBeanName <span class="token operator">=</span> bce<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>bceBeanName <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">isCurrentlyInCreation</span><span class="token punctuation">(</span>bceBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Skipping advisor '"</span> <span class="token operator">+</span> name <span class="token operator">+</span>
                                        <span class="token string">"' with dependency on currently created bean: "</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// Ignore: indicates a reference back to the bean we're trying to advise.</span>
                            <span class="token comment" spellcheck="true">// We want to find advisors other than the currently created bean itself.</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这段源码看起来挺复杂，我们去掉一些不必要的内容，总结起来，总共三件事：</p>
<p>1-获取容器中所有的Advisor，排除FactoryBeans</p>
<p>2-再排除创建中的Bean</p>
<p>3-将剩余的Advisor通过getBean创建Bean实例并添加到列表中返回</p>
<p>至于再下一步的逻辑就不再探寻啦。</p>
<p>然后是源码11中的2-findAdvisorsThatCanApply方法</p>
<p>源码14-来自：AbstractAdvisorAutoProxyCreator</p>
<td class="line_numbers"><pre>12345678910111213</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">protected ListAdvisor findAdvisorsThatCanApply(            ListAdvisor candidateAdvisors, Class? beanClass, String beanName) {         // 将代理的目标Bean的beanName设置到ThreadLocal中        ProxyCreationContext.setCurrentProxiedBeanName(beanName);        try {            // 1-在候选增强器中找出可作用于目标Bean的增强器            return AopUtils.findAdvisorsThatCanApply(candidateAdvisors, beanClass);        }        finally {            ProxyCreationContext.setCurrentProxiedBeanName(null);        }    }</pre></td>

<p>protected ListAdvisor findAdvisorsThatCanApply(<br>            ListAdvisor candidateAdvisors, Class? beanClass, String beanName) {</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// 将代理的目标Bean的beanName设置到ThreadLocal中</span>
    ProxyCreationContext<span class="token punctuation">.</span><span class="token function">setCurrentProxiedBeanName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 1-在候选增强器中找出可作用于目标Bean的增强器</span>
        <span class="token keyword">return</span> AopUtils<span class="token punctuation">.</span><span class="token function">findAdvisorsThatCanApply</span><span class="token punctuation">(</span>candidateAdvisors<span class="token punctuation">,</span> beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        ProxyCreationContext<span class="token punctuation">.</span><span class="token function">setCurrentProxiedBeanName</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重点操作就是AopUtils.findAdvisorsThatCanApply(candidateAdvisors, beanClass);用于找出能作用于目标Bean的增强器列表</p>
<p>源码15-来自：AopUtils</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public static ListAdvisor findAdvisorsThatCanApply(ListAdvisor candidateAdvisors, Class? clazz) {        if (candidateAdvisors.isEmpty()) {            return candidateAdvisors;        }        ListAdvisor eligibleAdvisors = new LinkedList();        for (Advisor candidate : candidateAdvisors) {            if (candidate instanceof IntroductionAdvisor && canApply(candidate, clazz)) {                // 1-首先添加引介增强                eligibleAdvisors.add(candidate);            }        }        boolean hasIntroductions = !eligibleAdvisors.isEmpty();        for (Advisor candidate : candidateAdvisors) {            if (candidate instanceof IntroductionAdvisor) {                // already processed                //跳过引介增强                continue;            }            //校验其余增强器是否能应用到目标Bean            if (canApply(candidate, clazz, hasIntroductions)) {                // 2-添加通知增强                eligibleAdvisors.add(candidate);            }        }        return eligibleAdvisors;    }</pre></td>

<p>public static ListAdvisor findAdvisorsThatCanApply(ListAdvisor candidateAdvisors, Class? clazz) {<br>        if (candidateAdvisors.isEmpty()) {<br>            return candidateAdvisors;<br>        }<br>        ListAdvisor eligibleAdvisors &#x3D; new LinkedList();<br>        for (Advisor candidate : candidateAdvisors) {<br>            if (candidate instanceof IntroductionAdvisor &amp;&amp; canApply(candidate, clazz)) {<br>                &#x2F;&#x2F; 1-首先添加引介增强<br>                eligibleAdvisors.add(candidate);<br>            }<br>        }<br>        boolean hasIntroductions &#x3D; !eligibleAdvisors.isEmpty();<br>        for (Advisor candidate : candidateAdvisors) {<br>            if (candidate instanceof IntroductionAdvisor) {<br>                &#x2F;&#x2F; already processed<br>                &#x2F;&#x2F;跳过引介增强<br>                continue;<br>            }<br>            &#x2F;&#x2F;校验其余增强器是否能应用到目标Bean<br>            if (canApply(candidate, clazz, hasIntroductions)) {<br>                &#x2F;&#x2F; 2-添加通知增强<br>                eligibleAdvisors.add(candidate);<br>            }<br>        }<br>        return eligibleAdvisors;<br>    }</p>
<p>源码中可以看出来，这里针对了两种类型的增强器（引介增强和通知增强）分别进行了处理，首先处理了引介增强，然后是通知增强。</p>
<p>这里有两个canApply方法，第一个用于判断引介增强是否能作用到目标类，第二个用于判断通知增强是否能作用到目标类。</p>
<p>其实第一个是通过调用第二个实现的。</p>
<p>我觉得我们可以简单看看其实现逻辑：</p>
<p>源码16-来源：AopUtils</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">//用于校验引介增强    public static boolean canApply(Advisor advisor, Class? targetClass) {        return canApply(advisor, targetClass, false);    }     //用于校验通知增强    public static boolean canApply(Advisor advisor, Class? targetClass, boolean hasIntroductions) {        if (advisor instanceof IntroductionAdvisor) {            return ((IntroductionAdvisor) advisor).getClassFilter().matches(targetClass);// 针对引介增强的类级匹配校验        }        else if (advisor instanceof PointcutAdvisor) {            PointcutAdvisor pca = (PointcutAdvisor) advisor;            return canApply(pca.getPointcut(), targetClass, hasIntroductions);// 针对通知增强的匹配校验        }        else {            // It doesn't have a pointcut so we assume it applies.            return true;        }    }     // 针对通知增强的匹配校验    public static boolean canApply(Pointcut pc, Class? targetClass, boolean hasIntroductions) {        Assert.notNull(pc, "Pointcut must not be null");        if (!pc.getClassFilter().matches(targetClass)) {            return false;// 针对通知增强的类级匹配校验，如果类级校验不通过，直接驳回        }　　　　         MethodMatcher methodMatcher = pc.getMethodMatcher();// 获取方法匹配器        if (methodMatcher == MethodMatcher.TRUE) {// 获取方法匹配器匹配的是所有方法，这里直接返回true，不必要做校验            // No need to iterate the methods if we're matching any method anyway...            return true;        }         IntroductionAwareMethodMatcher introductionAwareMethodMatcher = null;        if (methodMatcher instanceof IntroductionAwareMethodMatcher) {            introductionAwareMethodMatcher = (IntroductionAwareMethodMatcher) methodMatcher;        }         SetClass? classes = new LinkedHashSet();        if (!Proxy.isProxyClass(targetClass)) {            classes.add(ClassUtils.getUserClass(targetClass));        }        classes.addAll(ClassUtils.getAllInterfacesForClassAsSet(targetClass));         for (Class? clazz : classes) {            Method[] methods = ReflectionUtils.getAllDeclaredMethods(clazz);            for (Method method : methods) {                if (introductionAwareMethodMatcher != null ?                        introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions) :                        methodMatcher.matches(method, targetClass)) {　　　　　　　　　　　　// 方法匹配校验                    return true;                }            }        }         return false;    }</pre></td>

<p>&#x2F;&#x2F;用于校验引介增强<br>    public static boolean canApply(Advisor advisor, Class? targetClass) {<br>        return canApply(advisor, targetClass, false);<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">//用于校验通知增强</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">canApply</span><span class="token punctuation">(</span>Advisor advisor<span class="token punctuation">,</span> Class<span class="token operator">?</span> targetClass<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasIntroductions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>IntroductionAdvisor<span class="token punctuation">)</span> advisor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 针对引介增强的类级匹配校验</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">PointcutAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        PointcutAdvisor pca <span class="token operator">=</span> <span class="token punctuation">(</span>PointcutAdvisor<span class="token punctuation">)</span> advisor<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">canApply</span><span class="token punctuation">(</span>pca<span class="token punctuation">.</span><span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> hasIntroductions<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 针对通知增强的匹配校验</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// It doesn't have a pointcut so we assume it applies.</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 针对通知增强的匹配校验</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">canApply</span><span class="token punctuation">(</span>Pointcut pc<span class="token punctuation">,</span> Class<span class="token operator">?</span> targetClass<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasIntroductions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>pc<span class="token punctuation">,</span> <span class="token string">"Pointcut must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pc<span class="token punctuation">.</span><span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 针对通知增强的类级匹配校验，如果类级校验不通过，直接驳回</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>　　　　<br>        MethodMatcher methodMatcher &#x3D; pc.getMethodMatcher();&#x2F;&#x2F; 获取方法匹配器<br>        if (methodMatcher &#x3D;&#x3D; MethodMatcher.TRUE) {&#x2F;&#x2F; 获取方法匹配器匹配的是所有方法，这里直接返回true，不必要做校验<br>            &#x2F;&#x2F; No need to iterate the methods if we’re matching any method anyway…<br>            return true;<br>        }</p>
<pre class="line-numbers language-java"><code class="language-java">
    IntroductionAwareMethodMatcher introductionAwareMethodMatcher <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>methodMatcher <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAwareMethodMatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        introductionAwareMethodMatcher <span class="token operator">=</span> <span class="token punctuation">(</span>IntroductionAwareMethodMatcher<span class="token punctuation">)</span> methodMatcher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    SetClass<span class="token operator">?</span> classes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Proxy<span class="token punctuation">.</span><span class="token function">isProxyClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        classes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ClassUtils<span class="token punctuation">.</span><span class="token function">getUserClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    classes<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ClassUtils<span class="token punctuation">.</span><span class="token function">getAllInterfacesForClassAsSet</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>Class<span class="token operator">?</span> clazz <span class="token operator">:</span> classes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Method<span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> ReflectionUtils<span class="token punctuation">.</span><span class="token function">getAllDeclaredMethods</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Method method <span class="token operator">:</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>introductionAwareMethodMatcher <span class="token operator">!=</span> null <span class="token operator">?</span>
                    introductionAwareMethodMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> hasIntroductions<span class="token punctuation">)</span> <span class="token operator">:</span>
                    methodMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>　　　　　　　　　　　　&#x2F;&#x2F; 方法匹配校验<br>                    return true;<br>                }<br>            }<br>        }</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>上面的源码中用于判断增强是否与给定的类匹配，用了多个matches方法，包括ClassFilter的matches方法，IntroductionAwareMethodMatcher的matches方法和MethodMatcher中的matches方法。</p>
<p>第一个matches匹配的是类，第二、三个matches匹配的是方法。其中引介增强针对的是类，所以其校验仅仅使用类级匹配进行校验，但是通知增强针对的是类中的方法，需要进行类和方法的双重匹配校验。</p>
<p>然后返回到源码9中，我们开始生成代理：</p>
<p>源码17-来自：AbstractAutoProxyCreator</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">protected Object createProxy(Class? beanClass, @Nullable String beanName,            @Nullable Object[] specificInterceptors, TargetSource targetSource) {         if (this.beanFactory instanceof ConfigurableListableBeanFactory) {            //暴露目标类，将其保存到BeanDefinition中            AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) this.beanFactory, beanName, beanClass);        }         //创建一个新的代理工厂，并为其拷贝当前类中的相关配置属性        ProxyFactory proxyFactory = new ProxyFactory();        proxyFactory.copyFrom(this);         if (!proxyFactory.isProxyTargetClass()) {            //校验proxyTargetClass设置，如果设置不是直接代理目标类，则采用默认的JDK动态代理指定接口            if (shouldProxyTargetClass(beanClass, beanName)) {                //校验该Bean的BeanDefinition中的preserveTargetClass属性，是否被代理工厂设置为true，如果设置为true，则表示代理工厂希望代理类可以强转为目标类                proxyFactory.setProxyTargetClass(true);            }            else {                //否则表示基于接口创建代理                evaluateProxyInterfaces(beanClass, proxyFactory);            }        }         //将拦截器封装成通知        Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);        proxyFactory.addAdvisors(advisors);//加入增强器        proxyFactory.setTargetSource(targetSource);//设置要代理的类        customizeProxyFactory(proxyFactory);//子类定制代理        //用于控制代理工厂被配置之后，是否还允许修改通知，默认为false（表示不允许修改）        proxyFactory.setFrozen(this.freezeProxy);        if (advisorsPreFiltered()) {            proxyFactory.setPreFiltered(true);        }        //创建代理        return proxyFactory.getProxy(getProxyClassLoader());    }</pre></td>

<p>protected Object createProxy(Class? beanClass, @Nullable String beanName,<br>            @Nullable Object[] specificInterceptors, TargetSource targetSource) {</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//暴露目标类，将其保存到BeanDefinition中</span>
        AutoProxyUtils<span class="token punctuation">.</span><span class="token function">exposeTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ConfigurableListableBeanFactory<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//创建一个新的代理工厂，并为其拷贝当前类中的相关配置属性</span>
    ProxyFactory proxyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    proxyFactory<span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>proxyFactory<span class="token punctuation">.</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//校验proxyTargetClass设置，如果设置不是直接代理目标类，则采用默认的JDK动态代理指定接口</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldProxyTargetClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//校验该Bean的BeanDefinition中的preserveTargetClass属性，是否被代理工厂设置为true，如果设置为true，则表示代理工厂希望代理类可以强转为目标类</span>
            proxyFactory<span class="token punctuation">.</span><span class="token function">setProxyTargetClass</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//否则表示基于接口创建代理</span>
            <span class="token function">evaluateProxyInterfaces</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> proxyFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//将拦截器封装成通知</span>
    Advisor<span class="token punctuation">[</span><span class="token punctuation">]</span> advisors <span class="token operator">=</span> <span class="token function">buildAdvisors</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    proxyFactory<span class="token punctuation">.</span><span class="token function">addAdvisors</span><span class="token punctuation">(</span>advisors<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//加入增强器</span>
    proxyFactory<span class="token punctuation">.</span><span class="token function">setTargetSource</span><span class="token punctuation">(</span>targetSource<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//设置要代理的类</span>
    <span class="token function">customizeProxyFactory</span><span class="token punctuation">(</span>proxyFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//子类定制代理</span>
    <span class="token comment" spellcheck="true">//用于控制代理工厂被配置之后，是否还允许修改通知，默认为false（表示不允许修改）</span>
    proxyFactory<span class="token punctuation">.</span><span class="token function">setFrozen</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>freezeProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">advisorsPreFiltered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        proxyFactory<span class="token punctuation">.</span><span class="token function">setPreFiltered</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//创建代理</span>
    <span class="token keyword">return</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token function">getProxyClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>源码中执行了一大串的工作，都在为最后的创建代理做准备：</p>
<p>源码18-来自：ProxyFactory</p>
<td class="line_numbers"><pre>1234</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public Object getProxy(@Nullable ClassLoader classLoader) {       //创建AOP代理，并获取代理对象    return createAopProxy().getProxy(classLoader);  }</pre></td>

<p>public Object getProxy(@Nullable ClassLoader classLoader) {<br>       &#x2F;&#x2F;创建AOP代理，并获取代理对象<br>    return createAopProxy().getProxy(classLoader);<br>  }</p>
<p>源码19-来自：ProxyCreatorSupport</p>
<td class="line_numbers"><pre>12345678910111213141516171819</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">protected final synchronized AopProxy createAopProxy() {        if (!this.active) {            activate();//激活开关        }        // 获取AOP代理工厂，使用AOP代理工厂创建AOP代理        return getAopProxyFactory().createAopProxy(this);    }     private void activate() {        this.active = true;        // 回调监听器的activated方法        for (AdvisedSupportListener listener : this.listeners) {            listener.activated(this);        }    }     public AopProxyFactory getAopProxyFactory() {        return this.aopProxyFactory;    }</pre></td>

<p>protected final synchronized AopProxy createAopProxy() {<br>        if (!this.active) {<br>            activate();&#x2F;&#x2F;激活开关<br>        }<br>        &#x2F;&#x2F; 获取AOP代理工厂，使用AOP代理工厂创建AOP代理<br>        return getAopProxyFactory().createAopProxy(this);<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 回调监听器的activated方法</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>AdvisedSupportListener listener <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        listener<span class="token punctuation">.</span><span class="token function">activated</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> AopProxyFactory <span class="token function">getAopProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aopProxyFactory<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重点在createAopProxy方法：</p>
<p>源码20-来自：DefaultAopProxyFactory</p>
<td class="line_numbers"><pre>123456789101112131415161718192021</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">@Override    public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException {        if (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) {            // 如果代理需要执行优化或者proxyTargetClass=true或者不存在代理接口            Class? targetClass = config.getTargetClass();            if (targetClass == null) {                throw new AopConfigException("TargetSource cannot determine target class: " +                        "Either an interface or a target is required for proxy creation.");            }            if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) {                //如果目标类是接口或者是动态生成的代理类，则使用JDK动态代理                return new JdkDynamicAopProxy(config);            }            //创建CGLIB动态AOP代理对象            return new ObjenesisCglibAopProxy(config);        }        else {            //创建JDK动态AOP代理对象            return new JdkDynamicAopProxy(config);        }    }</pre></td>

<p>@Override<br>    public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException {<br>        if (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) {<br>            &#x2F;&#x2F; 如果代理需要执行优化或者proxyTargetClass&#x3D;true或者不存在代理接口<br>            Class? targetClass &#x3D; config.getTargetClass();<br>            if (targetClass &#x3D;&#x3D; null) {<br>                throw new AopConfigException(“TargetSource cannot determine target class: “ +<br>                        “Either an interface or a target is required for proxy creation.”);<br>            }<br>            if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) {<br>                &#x2F;&#x2F;如果目标类是接口或者是动态生成的代理类，则使用JDK动态代理<br>                return new JdkDynamicAopProxy(config);<br>            }<br>            &#x2F;&#x2F;创建CGLIB动态AOP代理对象<br>            return new ObjenesisCglibAopProxy(config);<br>        }<br>        else {<br>            &#x2F;&#x2F;创建JDK动态AOP代理对象<br>            return new JdkDynamicAopProxy(config);<br>        }<br>    }</p>
<p>至此，代理对象生成，至于是使用JDK动态代理，还是Cglib动态代理，机理如下：</p>
<p>如果目标类实现了接口，默认使用JDK动态代理</p>
<p>如果目标类实现了接口，可以强制使用Cglib动态代理</p>
<p>如果目标没有实现接口，必须采用Cglib动态代理</p>
<p>至于如何强制使用Cglib动态代理：</p>
<p>首先需要添加CGLIB库，然后设置proxyTargetClass置为true，进行强制使用基于类的CGLIB动态代理。</p>
<p>JDK动态代理和Cglib动态代理的区别：</p>
<p>JDK动态代理只能基于接口生成代理，方式是通过实现JDK提供的InvocationHandler接口中的invoke方法来实现针对目标类指定方法的代理调用。</p>
<p>CGLIB可以基于类生成代理，方式是通过对目标类生成一个子类，覆盖其中的方法。</p>
<p>返回到源码18中，创建了AOP代理之后，执行其getProxy方法：（我们看下JDK动态代理的实现）</p>
<p>源码21-来自：JdkDynamicAopProxy</p>
<td class="line_numbers"><pre>123456789101112</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">@Override    public Object getProxy(@Nullable ClassLoader classLoader) {        if (logger.isDebugEnabled()) {            logger.debug("Creating JDK dynamic proxy: target source is " + this.advised.getTargetSource());        }        // 1-获取用于代理的全部接口的集合（数组）        Class?[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(this.advised, true);        // 2-查找接口集合中可能定义的equals方法获取hashCode方法        findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);        // 3-创建指定接口的代理实例        return Proxy.newProxyInstance(classLoader, proxiedInterfaces, this);    }</pre></td>

<p>@Override<br>    public Object getProxy(@Nullable ClassLoader classLoader) {<br>        if (logger.isDebugEnabled()) {<br>            logger.debug(“Creating JDK dynamic proxy: target source is “ + this.advised.getTargetSource());<br>        }<br>        &#x2F;&#x2F; 1-获取用于代理的全部接口的集合（数组）<br>        Class?[] proxiedInterfaces &#x3D; AopProxyUtils.completeProxiedInterfaces(this.advised, true);<br>        &#x2F;&#x2F; 2-查找接口集合中可能定义的equals方法获取hashCode方法<br>        findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);<br>        &#x2F;&#x2F; 3-创建指定接口的代理实例<br>        return Proxy.newProxyInstance(classLoader, proxiedInterfaces, this);<br>    }</p>
<p>上面的代理主要做了三件事情：</p>
<p>1-首先获取用于代理的全部接口集；</p>
<p>2-然后查找该接口集中有无定义equals和hashCode方法；</p>
<p>3-最后执行代理实例的创建。</p>
<p>首先看下第一件事情：completeProxiedInterfaces</p>
<p>源码22-来自：AopProxyUtils</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738394041424344454647</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// 获取用于代理的接口的集合    static Class?[] completeProxiedInterfaces(AdvisedSupport advised, boolean decoratingProxy) {        // 获取配置中所有的接口        Class?[] specifiedInterfaces = advised.getProxiedInterfaces();        if (specifiedInterfaces.length == 0) {            // No user-specified interfaces: check whether target class is an interface.            Class? targetClass = advised.getTargetClass();            if (targetClass != null) {                if (targetClass.isInterface()) {                    advised.setInterfaces(targetClass);                }                else if (Proxy.isProxyClass(targetClass)) {                    advised.setInterfaces(targetClass.getInterfaces());                }                specifiedInterfaces = advised.getProxiedInterfaces();            }        }        // 将SpringProxy、Advised、DecoratingProxy三个接口添加到接口集中        boolean addSpringProxy = !advised.isInterfaceProxied(SpringProxy.class);        boolean addAdvised = !advised.isOpaque() && !advised.isInterfaceProxied(Advised.class);        boolean addDecoratingProxy = (decoratingProxy && !advised.isInterfaceProxied(DecoratingProxy.class));        int nonUserIfcCount = 0;        if (addSpringProxy) {            nonUserIfcCount++;        }        if (addAdvised) {            nonUserIfcCount++;        }        if (addDecoratingProxy) {            nonUserIfcCount++;        }        Class?[] proxiedInterfaces = new Class?[specifiedInterfaces.length + nonUserIfcCount];        System.arraycopy(specifiedInterfaces, 0, proxiedInterfaces, 0, specifiedInterfaces.length);        int index = specifiedInterfaces.length;        if (addSpringProxy) {            proxiedInterfaces[index] = SpringProxy.class;            index++;        }        if (addAdvised) {            proxiedInterfaces[index] = Advised.class;            index++;        }        if (addDecoratingProxy) {            proxiedInterfaces[index] = DecoratingProxy.class;        }        return proxiedInterfaces;    }</pre></td>

<p>&#x2F;&#x2F; 获取用于代理的接口的集合<br>    static Class?[] completeProxiedInterfaces(AdvisedSupport advised, boolean decoratingProxy) {<br>        &#x2F;&#x2F; 获取配置中所有的接口<br>        Class?[] specifiedInterfaces &#x3D; advised.getProxiedInterfaces();<br>        if (specifiedInterfaces.length &#x3D;&#x3D; 0) {<br>            &#x2F;&#x2F; No user-specified interfaces: check whether target class is an interface.<br>            Class? targetClass &#x3D; advised.getTargetClass();<br>            if (targetClass !&#x3D; null) {<br>                if (targetClass.isInterface()) {<br>                    advised.setInterfaces(targetClass);<br>                }<br>                else if (Proxy.isProxyClass(targetClass)) {<br>                    advised.setInterfaces(targetClass.getInterfaces());<br>                }<br>                specifiedInterfaces &#x3D; advised.getProxiedInterfaces();<br>            }<br>        }<br>        &#x2F;&#x2F; 将SpringProxy、Advised、DecoratingProxy三个接口添加到接口集中<br>        boolean addSpringProxy &#x3D; !advised.isInterfaceProxied(SpringProxy.class);<br>        boolean addAdvised &#x3D; !advised.isOpaque() &amp;&amp; !advised.isInterfaceProxied(Advised.class);<br>        boolean addDecoratingProxy &#x3D; (decoratingProxy &amp;&amp; !advised.isInterfaceProxied(DecoratingProxy.class));<br>        int nonUserIfcCount &#x3D; 0;<br>        if (addSpringProxy) {<br>            nonUserIfcCount++;<br>        }<br>        if (addAdvised) {<br>            nonUserIfcCount++;<br>        }<br>        if (addDecoratingProxy) {<br>            nonUserIfcCount++;<br>        }<br>        Class?[] proxiedInterfaces &#x3D; new Class?[specifiedInterfaces.length + nonUserIfcCount];<br>        System.arraycopy(specifiedInterfaces, 0, proxiedInterfaces, 0, specifiedInterfaces.length);<br>        int index &#x3D; specifiedInterfaces.length;<br>        if (addSpringProxy) {<br>            proxiedInterfaces[index] &#x3D; SpringProxy.class;<br>            index++;<br>        }<br>        if (addAdvised) {<br>            proxiedInterfaces[index] &#x3D; Advised.class;<br>            index++;<br>        }<br>        if (addDecoratingProxy) {<br>            proxiedInterfaces[index] &#x3D; DecoratingProxy.class;<br>        }<br>        return proxiedInterfaces;<br>    }</p>
<p>下面我们再看看之前的第二步：findDefinedEqualsAndHashCodeMethods</p>
<p>源码23-来自：JdkDynamicAopProxy</p>
<td class="line_numbers"><pre>1234567891011121314151617</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void findDefinedEqualsAndHashCodeMethods(Class?[] proxiedInterfaces) {        for (Class? proxiedInterface : proxiedInterfaces) {            Method[] methods = proxiedInterface.getDeclaredMethods();            for (Method method : methods) {                // 遍历每一个接口，再获取其中的方法进行遍历，逐个校验其是否是equals方法，或者hashCode方法，只有当二者都被定义之后校验才会结束，否则一直进行下去                if (AopUtils.isEqualsMethod(method)) {                    this.equalsDefined = true;                }                if (AopUtils.isHashCodeMethod(method)) {                    this.hashCodeDefined = true;                }                if (this.equalsDefined && this.hashCodeDefined) {                    return;                }            }        }    }</pre></td>

<p>private void findDefinedEqualsAndHashCodeMethods(Class?[] proxiedInterfaces) {<br>        for (Class? proxiedInterface : proxiedInterfaces) {<br>            Method[] methods &#x3D; proxiedInterface.getDeclaredMethods();<br>            for (Method method : methods) {<br>                &#x2F;&#x2F; 遍历每一个接口，再获取其中的方法进行遍历，逐个校验其是否是equals方法，或者hashCode方法，只有当二者都被定义之后校验才会结束，否则一直进行下去<br>                if (AopUtils.isEqualsMethod(method)) {<br>                    this.equalsDefined &#x3D; true;<br>                }<br>                if (AopUtils.isHashCodeMethod(method)) {<br>                    this.hashCodeDefined &#x3D; true;<br>                }<br>                if (this.equalsDefined &amp;&amp; this.hashCodeDefined) {<br>                    return;<br>                }<br>            }<br>        }<br>    }</p>
<p>最后就是我们的重点步骤：Proxy.newProxyInstance(classLoader, proxiedInterfaces, this)，这个操作大家都不会陌生，这是JDK动态代理创建代理类的通用方式。这个方法的参数列表中最后一个是一个大家都很熟悉的家伙：InvocationHandler，我们都知道JDK动态代理的执行逻辑都是在一个实现了InvocationHandler接口中的invoke方法中，这里传入this，表示当前实例，代表当前实例所属类应该实现了InvocationHandler接口，之前已经成功创建了JDK动态代理对象，那么当我们发生对指定目标方法的调用时，就会触发JdkDynamicAopProxy中的invoke方法：</p>
<p>源码24-来自：JdkDynamicAopProxy</p>
<td class="line_numbers"><pre>123</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">final class JdkDynamicAopProxy implements AopProxy, InvocationHandler, Serializable {    ...}</pre></td>

<p>final class JdkDynamicAopProxy implements AopProxy, InvocationHandler, Serializable {<br>    …<br>}</p>
<p>这也就是说，这个类中必然实现了invoke方法：</p>
<p>源码25-来自：JdkDynamicAopProxy</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">@Override    @Nullable    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {        MethodInvocation invocation;        Object oldProxy = null;        boolean setProxyContext = false;         TargetSource targetSource = this.advised.targetSource;        Object target = null;         try {            if (!this.equalsDefined && AopUtils.isEqualsMethod(method)) {                // The target does not implement the equals(Object) method itself.                // 目标类体系中未实现equals方法，但是代理的目标方法却是equals方法                return equals(args[0]);            }            else if (!this.hashCodeDefined && AopUtils.isHashCodeMethod(method)) {                // The target does not implement the hashCode() method itself.                // 目标类体系中未实现hashCode方法，但是代理的目标方法却是hashCode方法                return hashCode();            }            else if (method.getDeclaringClass() == DecoratingProxy.class) {                // There is only getDecoratedClass() declared - dispatch to proxy config.                return AopProxyUtils.ultimateTargetClass(this.advised);            }            // isAssignableFrom方法的意义：调用方如果是参数方的同类（接口）或者父类（接口），则返回true            else if (!this.advised.opaque && method.getDeclaringClass().isInterface() &&                    method.getDeclaringClass().isAssignableFrom(Advised.class)) {                // Service invocations on ProxyConfig with the proxy config...                // 直接反射调用目标方法                return AopUtils.invokeJoinpointUsingReflection(this.advised, method, args);            }             Object retVal;             if (this.advised.exposeProxy) {                // Make invocation available if necessary.                // 如果设置了exposeProxy=true，那么就代理保存起来备用                oldProxy = AopContext.setCurrentProxy(proxy);                setProxyContext = true;            }             // Get as late as possible to minimize the time we "own" the target,            // in case it comes from a pool.            target = targetSource.getTarget();            Class? targetClass = (target != null ? target.getClass() : null);             // Get the interception chain for this method.            // 1-获取目标方法的拦截链            ListObject chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);             // Check whether we have any advice. If we don't, we can fallback on direct            // reflective invocation of the target, and avoid creating a MethodInvocation.            if (chain.isEmpty()) {                // We can skip creating a MethodInvocation: just invoke the target directly                // Note that the final invoker must be an InvokerInterceptor so we know it does                // nothing but a reflective operation on the target, and no hot swapping or fancy proxying.                // 如果目标类没有拦截器链，则直接反射调用目标方法                Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);                retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse);            }            else {                // We need to create a method invocation...                // 2-创建一个方法调用，并执行，ReflectiveMethodInvocation是Spring封装的                invocation = new ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);                // Proceed to the joinpoint through the interceptor chain.                // 3-执行拦截器链，在ReflectiveMethodInvocation中维护了拦截器调用的计数器，保证拦截器的逐个调用，完成所有拦截器调用之后会反射调用目标方法。                retVal = invocation.proceed();            }             // Massage return value if necessary.            Class? returnType = method.getReturnType();            if (retVal != null && retVal == target &&                    returnType != Object.class && returnType.isInstance(proxy) &&                    !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) {                // Special case: it returned "this" and the return type of the method                // is type-compatible. Note that we can't help if the target sets                // a reference to itself in another returned object.                retVal = proxy;            }            else if (retVal == null && returnType != Void.TYPE && returnType.isPrimitive()) {                throw new AopInvocationException(                        "Null return value from advice does not match primitive return type for: " + method);            }            return retVal;        }        finally {            if (target != null && !targetSource.isStatic()) {                // Must have come from TargetSource.                targetSource.releaseTarget(target);            }            if (setProxyContext) {                // Restore old proxy.                AopContext.setCurrentProxy(oldProxy);            }        }    }</pre></td>

<p>@Override<br>    @Nullable<br>    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {<br>        MethodInvocation invocation;<br>        Object oldProxy &#x3D; null;<br>        boolean setProxyContext &#x3D; false;</p>
<pre class="line-numbers language-java"><code class="language-java">
    TargetSource targetSource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>targetSource<span class="token punctuation">;</span>
    Object target <span class="token operator">=</span> null<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>equalsDefined <span class="token operator">&amp;&amp;</span> AopUtils<span class="token punctuation">.</span><span class="token function">isEqualsMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The target does not implement the equals(Object) method itself.</span>
            <span class="token comment" spellcheck="true">// 目标类体系中未实现equals方法，但是代理的目标方法却是equals方法</span>
            <span class="token keyword">return</span> <span class="token function">equals</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>hashCodeDefined <span class="token operator">&amp;&amp;</span> AopUtils<span class="token punctuation">.</span><span class="token function">isHashCodeMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The target does not implement the hashCode() method itself.</span>
            <span class="token comment" spellcheck="true">// 目标类体系中未实现hashCode方法，但是代理的目标方法却是hashCode方法</span>
            <span class="token keyword">return</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> DecoratingProxy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// There is only getDecoratedClass() declared - dispatch to proxy config.</span>
            <span class="token keyword">return</span> AopProxyUtils<span class="token punctuation">.</span><span class="token function">ultimateTargetClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// isAssignableFrom方法的意义：调用方如果是参数方的同类（接口）或者父类（接口），则返回true</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>opaque <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>Advised<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Service invocations on ProxyConfig with the proxy config...</span>
            <span class="token comment" spellcheck="true">// 直接反射调用目标方法</span>
            <span class="token keyword">return</span> AopUtils<span class="token punctuation">.</span><span class="token function">invokeJoinpointUsingReflection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Object retVal<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>exposeProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Make invocation available if necessary.</span>
            <span class="token comment" spellcheck="true">// 如果设置了exposeProxy=true，那么就代理保存起来备用</span>
            oldProxy <span class="token operator">=</span> AopContext<span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            setProxyContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Get as late as possible to minimize the time we "own" the target,</span>
        <span class="token comment" spellcheck="true">// in case it comes from a pool.</span>
        target <span class="token operator">=</span> targetSource<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Class<span class="token operator">?</span> targetClass <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> null <span class="token operator">?</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Get the interception chain for this method.</span>
        <span class="token comment" spellcheck="true">// 1-获取目标方法的拦截链</span>
        ListObject chain <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Check whether we have any advice. If we don't, we can fallback on direct</span>
        <span class="token comment" spellcheck="true">// reflective invocation of the target, and avoid creating a MethodInvocation.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// We can skip creating a MethodInvocation: just invoke the target directly</span>
            <span class="token comment" spellcheck="true">// Note that the final invoker must be an InvokerInterceptor so we know it does</span>
            <span class="token comment" spellcheck="true">// nothing but a reflective operation on the target, and no hot swapping or fancy proxying.</span>
            <span class="token comment" spellcheck="true">// 如果目标类没有拦截器链，则直接反射调用目标方法</span>
            Object<span class="token punctuation">[</span><span class="token punctuation">]</span> argsToUse <span class="token operator">=</span> AopProxyUtils<span class="token punctuation">.</span><span class="token function">adaptArgumentsIfNecessary</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            retVal <span class="token operator">=</span> AopUtils<span class="token punctuation">.</span><span class="token function">invokeJoinpointUsingReflection</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> argsToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// We need to create a method invocation...</span>
            <span class="token comment" spellcheck="true">// 2-创建一个方法调用，并执行，ReflectiveMethodInvocation是Spring封装的</span>
            invocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Proceed to the joinpoint through the interceptor chain.</span>
            <span class="token comment" spellcheck="true">// 3-执行拦截器链，在ReflectiveMethodInvocation中维护了拦截器调用的计数器，保证拦截器的逐个调用，完成所有拦截器调用之后会反射调用目标方法。</span>
            retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Massage return value if necessary.</span>
        Class<span class="token operator">?</span> returnType <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> retVal <span class="token operator">==</span> target <span class="token operator">&amp;&amp;</span>
                returnType <span class="token operator">!=</span> Object<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> returnType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span>RawTargetAccess<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Special case: it returned "this" and the return type of the method</span>
            <span class="token comment" spellcheck="true">// is type-compatible. Note that we can't help if the target sets</span>
            <span class="token comment" spellcheck="true">// a reference to itself in another returned object.</span>
            retVal <span class="token operator">=</span> proxy<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> returnType <span class="token operator">!=</span> Void<span class="token punctuation">.</span>TYPE <span class="token operator">&amp;&amp;</span> returnType<span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AopInvocationException</span><span class="token punctuation">(</span>
                    <span class="token string">"Null return value from advice does not match primitive return type for: "</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>targetSource<span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Must have come from TargetSource.</span>
            targetSource<span class="token punctuation">.</span><span class="token function">releaseTarget</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>setProxyContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Restore old proxy.</span>
            AopContext<span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>oldProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的源码并非发现织入的痕迹，让我们接着看看ReflectiveMethodInvocation类的proceed方法：</p>
<p>源码26-来自：ReflectiveMethodInvocation</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">@Override    @Nullable    public Object proceed() throws Throwable {        // We start with an index of -1 and increment early.        // 完成所有增强之后执行目标切点方法        if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1) {            // 直接调用目标方法            return invokeJoinpoint();        }         // 获取下一个要执行的拦截器        Object interceptorOrInterceptionAdvice =                this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex);        if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher) {            // Evaluate dynamic method matcher here: static part will already have            // been evaluated and found to match.            InterceptorAndDynamicMethodMatcher dm =                    (InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;            if (dm.methodMatcher.matches(this.method, this.targetClass, this.arguments)) {                // 动态匹配成功，则执行拦截器逻辑                return dm.interceptor.invoke(this);            }            else {                // Dynamic matching failed.                // Skip this interceptor and invoke the next in the chain.                // 动态匹配失败，跳过当前拦截器，递归执行下一个拦截器                return proceed();            }        }        else {            // It's an interceptor, so we just invoke it: The pointcut will have            // been evaluated statically before this object was constructed.            // 普通的拦截器，直接调用即可            return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this);        }    }</pre></td>

<p>@Override<br>    @Nullable<br>    public Object proceed() throws Throwable {<br>        &#x2F;&#x2F; We start with an index of -1 and increment early.<br>        &#x2F;&#x2F; 完成所有增强之后执行目标切点方法<br>        if (this.currentInterceptorIndex &#x3D;&#x3D; this.interceptorsAndDynamicMethodMatchers.size() - 1) {<br>            &#x2F;&#x2F; 直接调用目标方法<br>            return invokeJoinpoint();<br>        }</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// 获取下一个要执行的拦截器</span>
    Object interceptorOrInterceptionAdvice <span class="token operator">=</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorsAndDynamicMethodMatchers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentInterceptorIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptorOrInterceptionAdvice <span class="token keyword">instanceof</span> <span class="token class-name">InterceptorAndDynamicMethodMatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Evaluate dynamic method matcher here: static part will already have</span>
        <span class="token comment" spellcheck="true">// been evaluated and found to match.</span>
        InterceptorAndDynamicMethodMatcher dm <span class="token operator">=</span>
                <span class="token punctuation">(</span>InterceptorAndDynamicMethodMatcher<span class="token punctuation">)</span> interceptorOrInterceptionAdvice<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dm<span class="token punctuation">.</span>methodMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetClass<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 动态匹配成功，则执行拦截器逻辑</span>
            <span class="token keyword">return</span> dm<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Dynamic matching failed.</span>
            <span class="token comment" spellcheck="true">// Skip this interceptor and invoke the next in the chain.</span>
            <span class="token comment" spellcheck="true">// 动态匹配失败，跳过当前拦截器，递归执行下一个拦截器</span>
            <span class="token keyword">return</span> <span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// It's an interceptor, so we just invoke it: The pointcut will have</span>
        <span class="token comment" spellcheck="true">// been evaluated statically before this object was constructed.</span>
        <span class="token comment" spellcheck="true">// 普通的拦截器，直接调用即可</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>MethodInterceptor<span class="token punctuation">)</span> interceptorOrInterceptionAdvice<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>拦截器的调用执行invoke方法，并将this（当前实例）作为参数，来保证调用链的顺利执行，具体的逻辑那就在每个拦截器的invoke方法之中了，执行完拦截器的逻辑之后，就可以执行目标方法的逻辑了。</p>
<p>这正是织入的实现。</p>
<p>我们从织入的逻辑中并未发现有对拦截器执行顺序进行控制的逻辑，那么那些前置、后置、环绕、异常等的执行位置是怎么实现的呢？</p>
<p><strong>3、织入实现原理</strong></p>
<p>虽然在ReflectiveMethodInvocation的proceed方法中看到目标方法是最后才被执行，那么那些后置、环绕、异常的通知是怎么实现的呢，如果我们打开各种通知实现的invoke方法中，就会发现一些东西：</p>
<p>我们查看五种通知后发现</p>
<p>源码27-来自：AspectJAfterReturningAdvice、AspectJAfterAdvice、AspectJAroundAdvice、AspectJMethodBeforeAdvice、AspectJAfterThrowingAdvice</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// AspectJAfterReturningAdvice：后置通知    @Override    public void afterReturning(@Nullable Object returnValue, Method method, Object[] args, @Nullable Object target) throws Throwable {        if (shouldInvokeOnReturnValueOf(method, returnValue)) {            invokeAdviceMethod(getJoinPointMatch(), returnValue, null);        }    }     // AspectJAfterAdvice：后置终点通知    @Override    public Object invoke(MethodInvocation mi) throws Throwable {        try {            return mi.proceed();        }        finally {            invokeAdviceMethod(getJoinPointMatch(), null, null);        }    }     // AspectJAroundAdvice：环绕通知    @Override    public Object invoke(MethodInvocation mi) throws Throwable {        if (!(mi instanceof ProxyMethodInvocation)) {            throw new IllegalStateException("MethodInvocation is not a Spring ProxyMethodInvocation: " + mi);        }        ProxyMethodInvocation pmi = (ProxyMethodInvocation) mi;        ProceedingJoinPoint pjp = lazyGetProceedingJoinPoint(pmi);        JoinPointMatch jpm = getJoinPointMatch(pmi);        return invokeAdviceMethod(pjp, jpm, null, null);    }     // AspectJMethodBeforeAdvice：前置通知    @Override    public void before(Method method, Object[] args, @Nullable Object target) throws Throwable {        invokeAdviceMethod(getJoinPointMatch(), null, null);    }     // AspectJAfterThrowingAdvice：异常通知    @Override    public Object invoke(MethodInvocation mi) throws Throwable {        try {            return mi.proceed();        }        catch (Throwable ex) {            if (shouldInvokeOnThrowing(ex)) {                invokeAdviceMethod(getJoinPointMatch(), null, ex);            }            throw ex;        }    }</pre></td>

<p>&#x2F;&#x2F; AspectJAfterReturningAdvice：后置通知<br>    @Override<br>    public void afterReturning(@Nullable Object returnValue, Method method, Object[] args, @Nullable Object target) throws Throwable {<br>        if (shouldInvokeOnReturnValueOf(method, returnValue)) {<br>            invokeAdviceMethod(getJoinPointMatch(), returnValue, null);<br>        }<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// AspectJAfterAdvice：后置终点通知</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>MethodInvocation mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">invokeAdviceMethod</span><span class="token punctuation">(</span><span class="token function">getJoinPointMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// AspectJAroundAdvice：环绕通知</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>MethodInvocation mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>mi <span class="token keyword">instanceof</span> <span class="token class-name">ProxyMethodInvocation</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"MethodInvocation is not a Spring ProxyMethodInvocation: "</span> <span class="token operator">+</span> mi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ProxyMethodInvocation pmi <span class="token operator">=</span> <span class="token punctuation">(</span>ProxyMethodInvocation<span class="token punctuation">)</span> mi<span class="token punctuation">;</span>
    ProceedingJoinPoint pjp <span class="token operator">=</span> <span class="token function">lazyGetProceedingJoinPoint</span><span class="token punctuation">(</span>pmi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    JoinPointMatch jpm <span class="token operator">=</span> <span class="token function">getJoinPointMatch</span><span class="token punctuation">(</span>pmi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">invokeAdviceMethod</span><span class="token punctuation">(</span>pjp<span class="token punctuation">,</span> jpm<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// AspectJMethodBeforeAdvice：前置通知</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span>Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Object target<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
    <span class="token function">invokeAdviceMethod</span><span class="token punctuation">(</span><span class="token function">getJoinPointMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// AspectJAfterThrowingAdvice：异常通知</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>MethodInvocation mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldInvokeOnThrowing</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeAdviceMethod</span><span class="token punctuation">(</span><span class="token function">getJoinPointMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们发现这五个通知里面的invoke方法中都调用了<strong>invokeAdviceMethod</strong>方法，这个方法是在AbstractAspectJAdvice抽象类中定义的。</p>
<p>源码28-来自：AbstractAspectJAdvice</p>
<td class="line_numbers"><pre>123456</pre></td><td class="code"><pre class="null" style="font-family:monospace;"> protected Object invokeAdviceMethod(
       @Nullable JoinPointMatch jpMatch, @Nullable Object returnValue, @Nullable Throwable ex)
         throws Throwable {
    // 执行参数绑定，然后使用参数调用通知方法
     return invokeAdviceMethodWithGivenArgs(argBinding(getJoinPoint(), jpMatch, returnValue, ex));
  }</pre></td>

<p> protected Object invokeAdviceMethod(<br>       @Nullable JoinPointMatch jpMatch, @Nullable Object returnValue, @Nullable Throwable ex)<br>         throws Throwable {<br>    &#x2F;&#x2F; 执行参数绑定，然后使用参数调用通知方法<br>     return invokeAdviceMethodWithGivenArgs(argBinding(getJoinPoint(), jpMatch, returnValue, ex));<br>  }</p>
<p>此处有三个方法调用：</p>
<p>getJoinPoint方法，用户获取当前的连接点实例</p>
<p>argBinging方法，用于进行参数绑定操作</p>
<p>invokeAdviceMethodWithGivenArgs方法执行通知方法</p>
<p>首先看看getJointPoint方法：</p>
<p>源码29-来自：AbstractAspectJAdvice</p>
<td class="line_numbers"><pre>123456789101112131415161718192021</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">protected JoinPoint getJoinPoint() {        // 获取当前的连接点实例        return currentJoinPoint();    }     public static JoinPoint currentJoinPoint() {        // 首先尝试从ExposeInvocationInterceptor拦截器中获取当前的方法调用        MethodInvocation mi = ExposeInvocationInterceptor.currentInvocation();        if (!(mi instanceof ProxyMethodInvocation)) {            throw new IllegalStateException("MethodInvocation is not a Spring ProxyMethodInvocation: " + mi);        }        ProxyMethodInvocation pmi = (ProxyMethodInvocation) mi;        // 然后从方法调用之中获取连接点实例jp        JoinPoint jp = (JoinPoint) pmi.getUserAttribute(JOIN_POINT_KEY);        if (jp == null) {            // 如果未获取到连接点实例，并设置到方法调用之中            jp = new MethodInvocationProceedingJoinPoint(pmi);            pmi.setUserAttribute(JOIN_POINT_KEY, jp);        }        return jp;    }</pre></td>

<p>protected JoinPoint getJoinPoint() {<br>        &#x2F;&#x2F; 获取当前的连接点实例<br>        return currentJoinPoint();<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">public</span> <span class="token keyword">static</span> JoinPoint <span class="token function">currentJoinPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 首先尝试从ExposeInvocationInterceptor拦截器中获取当前的方法调用</span>
    MethodInvocation mi <span class="token operator">=</span> ExposeInvocationInterceptor<span class="token punctuation">.</span><span class="token function">currentInvocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>mi <span class="token keyword">instanceof</span> <span class="token class-name">ProxyMethodInvocation</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"MethodInvocation is not a Spring ProxyMethodInvocation: "</span> <span class="token operator">+</span> mi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ProxyMethodInvocation pmi <span class="token operator">=</span> <span class="token punctuation">(</span>ProxyMethodInvocation<span class="token punctuation">)</span> mi<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 然后从方法调用之中获取连接点实例jp</span>
    JoinPoint jp <span class="token operator">=</span> <span class="token punctuation">(</span>JoinPoint<span class="token punctuation">)</span> pmi<span class="token punctuation">.</span><span class="token function">getUserAttribute</span><span class="token punctuation">(</span>JOIN_POINT_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jp <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果未获取到连接点实例，并设置到方法调用之中</span>
        jp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodInvocationProceedingJoinPoint</span><span class="token punctuation">(</span>pmi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pmi<span class="token punctuation">.</span><span class="token function">setUserAttribute</span><span class="token punctuation">(</span>JOIN_POINT_KEY<span class="token punctuation">,</span> jp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> jp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面逻辑很简单，就是从方法调用上下文中获取连接点，并返回，需要注意的是，此处一般情况是需要走if(jp &#x3D;&#x3D; null)中的逻辑的，意思就是这里一般会是首次为方法调用设置连接点的地方，这也正是懒实例化的实现-在真正需要使用的时候才进行创建。</p>
<p>下面看看源码28中第二个方法：参数绑定</p>
<p>　源码30-来自：AbstractAspectJAdvice</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">protected Object[] argBinding(JoinPoint jp, @Nullable JoinPointMatch jpMatch,            @Nullable Object returnValue, @Nullable Throwable ex) {         // 提前估测参数绑定        // 最后就是将所有通知中候选的参数的名称和类型保存到了切点对应属性之中备用        calculateArgumentBindings();         // AMC start        Object[] adviceInvocationArgs = new Object[this.parameterTypes.length];        int numBound = 0;         if (this.joinPointArgumentIndex != -1) {            adviceInvocationArgs[this.joinPointArgumentIndex] = jp;            numBound++;        }        else if (this.joinPointStaticPartArgumentIndex != -1) {            adviceInvocationArgs[this.joinPointStaticPartArgumentIndex] = jp.getStaticPart();            numBound++;        }         if (!CollectionUtils.isEmpty(this.argumentBindings)) {            // binding from pointcut match            // 1-通过切点匹配进行参数绑定            if (jpMatch != null) {                PointcutParameter[] parameterBindings = jpMatch.getParameterBindings();                for (PointcutParameter parameter : parameterBindings) {                    String name = parameter.getName();                    Integer index = this.argumentBindings.get(name);                    adviceInvocationArgs[index] = parameter.getBinding();                    numBound++;                }            }            // binding from returning clause            // 2-通过返回名称进行参数绑定            if (this.returningName != null) {                Integer index = this.argumentBindings.get(this.returningName);                adviceInvocationArgs[index] = returnValue;                numBound++;            }            // binding from thrown exception            // 3-通过异常返回进行参数绑定            if (this.throwingName != null) {                Integer index = this.argumentBindings.get(this.throwingName);                adviceInvocationArgs[index] = ex;                numBound++;            }        }         if (numBound != this.parameterTypes.length) {            throw new IllegalStateException("Required to bind " + this.parameterTypes.length +                    " arguments, but only bound " + numBound + " (JoinPointMatch " +                    (jpMatch == null ? "was NOT" : "WAS") + " bound in invocation)");        }         // 这里会将通知方法中的所有参数进行绑定，因为他们都是候选者，除了一些特殊的不需绑定的之外（只三种切点类型）        return adviceInvocationArgs;    }</pre></td>

<p>protected Object[] argBinding(JoinPoint jp, @Nullable JoinPointMatch jpMatch,<br>            @Nullable Object returnValue, @Nullable Throwable ex) {</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// 提前估测参数绑定</span>
    <span class="token comment" spellcheck="true">// 最后就是将所有通知中候选的参数的名称和类型保存到了切点对应属性之中备用</span>
    <span class="token function">calculateArgumentBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// AMC start</span>
    Object<span class="token punctuation">[</span><span class="token punctuation">]</span> adviceInvocationArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>parameterTypes<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> numBound <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>joinPointArgumentIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        adviceInvocationArgs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>joinPointArgumentIndex<span class="token punctuation">]</span> <span class="token operator">=</span> jp<span class="token punctuation">;</span>
        numBound<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>joinPointStaticPartArgumentIndex <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        adviceInvocationArgs<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>joinPointStaticPartArgumentIndex<span class="token punctuation">]</span> <span class="token operator">=</span> jp<span class="token punctuation">.</span><span class="token function">getStaticPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numBound<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>CollectionUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>argumentBindings<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// binding from pointcut match</span>
        <span class="token comment" spellcheck="true">// 1-通过切点匹配进行参数绑定</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jpMatch <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PointcutParameter<span class="token punctuation">[</span><span class="token punctuation">]</span> parameterBindings <span class="token operator">=</span> jpMatch<span class="token punctuation">.</span><span class="token function">getParameterBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>PointcutParameter parameter <span class="token operator">:</span> parameterBindings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String name <span class="token operator">=</span> parameter<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Integer index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>argumentBindings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                adviceInvocationArgs<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> parameter<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                numBound<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// binding from returning clause</span>
        <span class="token comment" spellcheck="true">// 2-通过返回名称进行参数绑定</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>returningName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Integer index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>argumentBindings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>returningName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            adviceInvocationArgs<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> returnValue<span class="token punctuation">;</span>
            numBound<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// binding from thrown exception</span>
        <span class="token comment" spellcheck="true">// 3-通过异常返回进行参数绑定</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>throwingName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Integer index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>argumentBindings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>throwingName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            adviceInvocationArgs<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> ex<span class="token punctuation">;</span>
            numBound<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>numBound <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parameterTypes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Required to bind "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parameterTypes<span class="token punctuation">.</span>length <span class="token operator">+</span>
                <span class="token string">" arguments, but only bound "</span> <span class="token operator">+</span> numBound <span class="token operator">+</span> <span class="token string">" (JoinPointMatch "</span> <span class="token operator">+</span>
                <span class="token punctuation">(</span>jpMatch <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token string">"was NOT"</span> <span class="token operator">:</span> <span class="token string">"WAS"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" bound in invocation)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment" spellcheck="true">// 这里会将通知方法中的所有参数进行绑定，因为他们都是候选者，除了一些特殊的不需绑定的之外（只三种切点类型）</span>
    <span class="token keyword">return</span> adviceInvocationArgs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>参数绑定的重点在于第一步，估测参数绑定，这一步会将所有通知中候选的参数的名称和类型保存到了切点对应属性之中备用，我们来看看：</p>
<p>源码31-来自AbstractAspectJAdvice</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public final synchronized void calculateArgumentBindings() {        // The simple case... nothing to bind.        if (this.argumentsIntrospected || this.parameterTypes.length == 0) {            // 无参可绑的情况，直接返回            return;        }         // 获取参数类型的数量numUnboundArgs（未绑参数数量）        int numUnboundArgs = this.parameterTypes.length;        Class?[] parameterTypes = this.aspectJAdviceMethod.getParameterTypes();        // 排除parameterTypes中JoinPoint类型、ProceedingJoinPoint类型、JoinPoint.StaticPart类型的参数        // JoinPoint类型的参数可作为非环绕通知的首个参数        // ProceedingJoinPoint类型的参数可作为环绕通知的首个参数        // JoinPoint.StaticPart类型的参数也可以作为某些通知的首个参数        // 谨记，以上三种类型的参数只能作为对应通知的首个参数，当然也可以和其他参数共存，但位置必须位于首个，原因也很简单，因为此处判断的时候完全就是在拿首个参数类型来完成的。        // 这三个参数是可以直接使用的，无需进行参数绑定操作，所以在这里排除掉        if (maybeBindJoinPoint(parameterTypes[0]) || maybeBindProceedingJoinPoint(parameterTypes[0]) ||                maybeBindJoinPointStaticPart(parameterTypes[0])) {            // 上述三种参数不需要绑定            numUnboundArgs--;        }         if (numUnboundArgs  0) {            // need to bind arguments by name as returned from the pointcut match            // 排除以上类型之后，如果还有剩余，则需要根据从切入点匹配返回的名称绑定参数            // 我们要明白：切点表达式完全就是用来匹配用的，哪怕其中有参数，也是为了匹配指定参数用的，他不带有任何传参功能，传参功能只有通知方法才有            // 所以这里的剩余参数个数，其实就是通知方法剩余参数，这里是依据参数名称来进行参数绑定            bindArgumentsByName(numUnboundArgs);        }         this.argumentsIntrospected = true;    }</pre></td>

<p>public final synchronized void calculateArgumentBindings() {<br>        &#x2F;&#x2F; The simple case… nothing to bind.<br>        if (this.argumentsIntrospected || this.parameterTypes.length &#x3D;&#x3D; 0) {<br>            &#x2F;&#x2F; 无参可绑的情况，直接返回<br>            return;<br>        }</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// 获取参数类型的数量numUnboundArgs（未绑参数数量）</span>
    <span class="token keyword">int</span> numUnboundArgs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parameterTypes<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    Class<span class="token operator">?</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterTypes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdviceMethod<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 排除parameterTypes中JoinPoint类型、ProceedingJoinPoint类型、JoinPoint.StaticPart类型的参数</span>
    <span class="token comment" spellcheck="true">// JoinPoint类型的参数可作为非环绕通知的首个参数</span>
    <span class="token comment" spellcheck="true">// ProceedingJoinPoint类型的参数可作为环绕通知的首个参数</span>
    <span class="token comment" spellcheck="true">// JoinPoint.StaticPart类型的参数也可以作为某些通知的首个参数</span>
    <span class="token comment" spellcheck="true">// 谨记，以上三种类型的参数只能作为对应通知的首个参数，当然也可以和其他参数共存，但位置必须位于首个，原因也很简单，因为此处判断的时候完全就是在拿首个参数类型来完成的。</span>
    <span class="token comment" spellcheck="true">// 这三个参数是可以直接使用的，无需进行参数绑定操作，所以在这里排除掉</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">maybeBindJoinPoint</span><span class="token punctuation">(</span>parameterTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">maybeBindProceedingJoinPoint</span><span class="token punctuation">(</span>parameterTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token function">maybeBindJoinPointStaticPart</span><span class="token punctuation">(</span>parameterTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 上述三种参数不需要绑定</span>
        numUnboundArgs<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>numUnboundArgs  <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// need to bind arguments by name as returned from the pointcut match</span>
        <span class="token comment" spellcheck="true">// 排除以上类型之后，如果还有剩余，则需要根据从切入点匹配返回的名称绑定参数</span>
        <span class="token comment" spellcheck="true">// 我们要明白：切点表达式完全就是用来匹配用的，哪怕其中有参数，也是为了匹配指定参数用的，他不带有任何传参功能，传参功能只有通知方法才有</span>
        <span class="token comment" spellcheck="true">// 所以这里的剩余参数个数，其实就是通知方法剩余参数，这里是依据参数名称来进行参数绑定</span>
        <span class="token function">bindArgumentsByName</span><span class="token punctuation">(</span>numUnboundArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>argumentsIntrospected <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法中主要就是排除了三大类位于首位的切点参数类型，这三类型参数不需要进行绑定。然后对剩余的参数进行绑定操作：</p>
<p>　源码32-来自AbstractAspectJAdvice</p>
<td class="line_numbers"><pre>1234567891011121314151617</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// 通过name来绑定参数    private void bindArgumentsByName(int numArgumentsExpectingToBind) {        if (this.argumentNames == null) {            // 创建参数名称发现器，并获取指定通知方法的参数名称            this.argumentNames = createParameterNameDiscoverer().getParameterNames(this.aspectJAdviceMethod);        }        if (this.argumentNames != null) {            // We have been able to determine the arg names.            // 只要确认通知使用有参数的就行            bindExplicitArguments(numArgumentsExpectingToBind);    }        else {            throw new IllegalStateException("Advice method [" + this.aspectJAdviceMethod.getName() + "] " +                    "requires " + numArgumentsExpectingToBind + " arguments to be bound by name, but " +                    "the argument names were not specified and could not be discovered.");        }    }</pre></td>

<p>&#x2F;&#x2F; 通过name来绑定参数<br>    private void bindArgumentsByName(int numArgumentsExpectingToBind) {<br>        if (this.argumentNames &#x3D;&#x3D; null) {<br>            &#x2F;&#x2F; 创建参数名称发现器，并获取指定通知方法的参数名称<br>            this.argumentNames &#x3D; createParameterNameDiscoverer().getParameterNames(this.aspectJAdviceMethod);<br>        }<br>        if (this.argumentNames !&#x3D; null) {<br>            &#x2F;&#x2F; We have been able to determine the arg names.<br>            &#x2F;&#x2F; 只要确认通知使用有参数的就行<br>            bindExplicitArguments(numArgumentsExpectingToBind);<br>    }<br>        else {<br>            throw new IllegalStateException(“Advice method [“ + this.aspectJAdviceMethod.getName() + “] “ +<br>                    “requires “ + numArgumentsExpectingToBind + “ arguments to be bound by name, but “ +<br>                    “the argument names were not specified and could not be discovered.”);<br>        }<br>    }</p>
<p>这一步，我们需要先创建参数名称发现器，然后发现器来获取当前通知方法的参数名的数组argumentNames。</p>
<p>这个数组的作用仅仅是用来判空，只要其有值，即通知方法有参数，那么就需要执行绑定操作。</p>
<p>首先来看看创建发现器的源码：</p>
<p>源码33-来自AbstractAspectJAdvice</p>
<td class="line_numbers"><pre>123456789101112131415161718</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">protected ParameterNameDiscoverer createParameterNameDiscoverer() {        // We need to discover them, or if that fails, guess,        // and if we can't guess with 100% accuracy, fail.        // DefaultParameterNameDiscoverer是参数名称发现器的默认实现，他其实是一个        DefaultParameterNameDiscoverer discoverer = new DefaultParameterNameDiscoverer();        AspectJAdviceParameterNameDiscoverer adviceParameterNameDiscoverer =                new AspectJAdviceParameterNameDiscoverer(this.pointcut.getExpression());// 切点的表达式        // 如果返回通知后绑定返回值，则returningName为非null        adviceParameterNameDiscoverer.setReturningName(this.returningName);        // 如果在抛出通知后绑定了抛出的值，则throwingName为非null        adviceParameterNameDiscoverer.setThrowingName(this.throwingName);        // Last in chain, so if we're called and we fail, that's bad...        // 设置在未能推导出通知参数名称的情况下是否抛出IllegalArgumentException和AmbiguousBindingException异常        adviceParameterNameDiscoverer.setRaiseExceptions(true);        // 将配置好的发现器添加到DefaultParameterNameDiscoverer中并返回        discoverer.addDiscoverer(adviceParameterNameDiscoverer);        return discoverer;    }</pre></td>

<p>protected ParameterNameDiscoverer createParameterNameDiscoverer() {<br>        &#x2F;&#x2F; We need to discover them, or if that fails, guess,<br>        &#x2F;&#x2F; and if we can’t guess with 100% accuracy, fail.<br>        &#x2F;&#x2F; DefaultParameterNameDiscoverer是参数名称发现器的默认实现，他其实是一个<br>        DefaultParameterNameDiscoverer discoverer &#x3D; new DefaultParameterNameDiscoverer();<br>        AspectJAdviceParameterNameDiscoverer adviceParameterNameDiscoverer &#x3D;<br>                new AspectJAdviceParameterNameDiscoverer(this.pointcut.getExpression());&#x2F;&#x2F; 切点的表达式<br>        &#x2F;&#x2F; 如果返回通知后绑定返回值，则returningName为非null<br>        adviceParameterNameDiscoverer.setReturningName(this.returningName);<br>        &#x2F;&#x2F; 如果在抛出通知后绑定了抛出的值，则throwingName为非null<br>        adviceParameterNameDiscoverer.setThrowingName(this.throwingName);<br>        &#x2F;&#x2F; Last in chain, so if we’re called and we fail, that’s bad…<br>        &#x2F;&#x2F; 设置在未能推导出通知参数名称的情况下是否抛出IllegalArgumentException和AmbiguousBindingException异常<br>        adviceParameterNameDiscoverer.setRaiseExceptions(true);<br>        &#x2F;&#x2F; 将配置好的发现器添加到DefaultParameterNameDiscoverer中并返回<br>        discoverer.addDiscoverer(adviceParameterNameDiscoverer);<br>        return discoverer;<br>    }</p>
<p>源码中AspectJAdviceParameterNameDiscoverer为真正执行发现操作的发现器。</p>
<p>源码34-来自AspectJAdviceParameterNameDiscoverer</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">@Override    @Nullable    public String[] getParameterNames(Method method) {        // 参数类型        this.argumentTypes = method.getParameterTypes();        // 初始化未绑定参数个数        this.numberOfRemainingUnboundArguments = this.argumentTypes.length;        // 初始化已绑定参数名称数组        this.parameterNameBindings = new String[this.numberOfRemainingUnboundArguments];         int minimumNumberUnboundArgs = 0;// 初始化最少未绑参数个数        // 针对后置通知和异常通知进行特殊处理，需要将返回值进行绑定        if (this.returningName != null) {            // 如果通知类型为后置通知            minimumNumberUnboundArgs++;        }        if (this.throwingName != null) {            // 如果通知类型为异常通知            minimumNumberUnboundArgs++;        }        if (this.numberOfRemainingUnboundArguments  minimumNumberUnboundArgs) {            throw new IllegalStateException(                    "Not enough arguments in method to satisfy binding of returning and throwing variables");        }         try {            //分成八步进行操作            int algorithmicStep = STEP_JOIN_POINT_BINDING;            while ((this.numberOfRemainingUnboundArguments  0) && algorithmicStep  STEP_FINISHED) {                switch (algorithmicStep++) {                    case STEP_JOIN_POINT_BINDING:                        // 1-连接点参数绑定                        // 连接点参数绑定格式为：thisJoinPoint - 0                        if (!maybeBindThisJoinPoint()) {                            // 连接点参数绑定格式为：thisJoinPointStaticPart - 0                            maybeBindThisJoinPointStaticPart();                        }                        break;                    case STEP_THROWING_BINDING:                        // 2-异常返回参数绑定                        // 异常参数绑定格式为：throwingName - throwableIndex                        // throwableIndex为通知参数列表中接收异常的参数的位置                        maybeBindThrowingVariable();                        break;                    case STEP_ANNOTATION_BINDING:                        // 3-注解参数绑定                        // 格式：varName - annotationIndex                        maybeBindAnnotationsFromPointcutExpression();                        break;                    case STEP_RETURNING_BINDING:                        // 4-返回参数绑定                        // 绑定返回值时，只有在未绑定参数只剩余1个的情况下才能绑定，否则不予绑定                        // 当只剩余一个未绑定的情况下，将返回值与剩余的那个位置的下标进行绑定即可                        maybeBindReturningVariable();                        break;                    case STEP_PRIMITIVE_ARGS_BINDING:                        // 5-原始类型参数绑定                        // 只有在有1个原始类型参数，且只有一个候选位置时才执行绑定操作                        maybeBindPrimitiveArgsFromPointcutExpression();                        break;                    case STEP_THIS_TARGET_ARGS_BINDING:                        // 6-切点表达式参数绑定                        // 只有只存在一个变量名称的时候才能执行绑定                        maybeBindThisOrTargetOrArgsFromPointcutExpression();                        break;                    case STEP_REFERENCE_PCUT_BINDING:                        // 7-引用切点绑定                        // 只有只存在一个变量名称的时候才能执行绑定                        maybeBindReferencePointcutParameter();                        break;                    default:                        throw new IllegalStateException("Unknown algorithmic step: " + (algorithmicStep - 1));                }            }        }        catch (AmbiguousBindingException ambigEx) {            if (this.raiseExceptions) {                throw ambigEx;            }            else {                return null;            }        }        catch (IllegalArgumentException ex) {            if (this.raiseExceptions) {                throw ex;            }            else {                return null;            }        }         if (this.numberOfRemainingUnboundArguments == 0) {            return this.parameterNameBindings;        }        else {            if (this.raiseExceptions) {                throw new IllegalStateException("Failed to bind all argument names: " +                        this.numberOfRemainingUnboundArguments + " argument(s) could not be bound");            }            else {                // convention for failing is to return null, allowing participation in a chain of responsibility                return null;            }        }    }</pre></td>

<p>@Override<br>    @Nullable<br>    public String[] getParameterNames(Method method) {<br>        &#x2F;&#x2F; 参数类型<br>        this.argumentTypes &#x3D; method.getParameterTypes();<br>        &#x2F;&#x2F; 初始化未绑定参数个数<br>        this.numberOfRemainingUnboundArguments &#x3D; this.argumentTypes.length;<br>        &#x2F;&#x2F; 初始化已绑定参数名称数组<br>        this.parameterNameBindings &#x3D; new String[this.numberOfRemainingUnboundArguments];</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">int</span> minimumNumberUnboundArgs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 初始化最少未绑参数个数</span>
    <span class="token comment" spellcheck="true">// 针对后置通知和异常通知进行特殊处理，需要将返回值进行绑定</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>returningName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果通知类型为后置通知</span>
        minimumNumberUnboundArgs<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>throwingName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果通知类型为异常通知</span>
        minimumNumberUnboundArgs<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>numberOfRemainingUnboundArguments  minimumNumberUnboundArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                <span class="token string">"Not enough arguments in method to satisfy binding of returning and throwing variables"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//分成八步进行操作</span>
        <span class="token keyword">int</span> algorithmicStep <span class="token operator">=</span> STEP_JOIN_POINT_BINDING<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>numberOfRemainingUnboundArguments  <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> algorithmicStep  STEP_FINISHED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>algorithmicStep<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> STEP_JOIN_POINT_BINDING<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// 1-连接点参数绑定</span>
                    <span class="token comment" spellcheck="true">// 连接点参数绑定格式为：thisJoinPoint - 0</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">maybeBindThisJoinPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 连接点参数绑定格式为：thisJoinPointStaticPart - 0</span>
                        <span class="token function">maybeBindThisJoinPointStaticPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> STEP_THROWING_BINDING<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// 2-异常返回参数绑定</span>
                    <span class="token comment" spellcheck="true">// 异常参数绑定格式为：throwingName - throwableIndex</span>
                    <span class="token comment" spellcheck="true">// throwableIndex为通知参数列表中接收异常的参数的位置</span>
                    <span class="token function">maybeBindThrowingVariable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> STEP_ANNOTATION_BINDING<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// 3-注解参数绑定</span>
                    <span class="token comment" spellcheck="true">// 格式：varName - annotationIndex</span>
                    <span class="token function">maybeBindAnnotationsFromPointcutExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> STEP_RETURNING_BINDING<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// 4-返回参数绑定</span>
                    <span class="token comment" spellcheck="true">// 绑定返回值时，只有在未绑定参数只剩余1个的情况下才能绑定，否则不予绑定</span>
                    <span class="token comment" spellcheck="true">// 当只剩余一个未绑定的情况下，将返回值与剩余的那个位置的下标进行绑定即可</span>
                    <span class="token function">maybeBindReturningVariable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> STEP_PRIMITIVE_ARGS_BINDING<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// 5-原始类型参数绑定</span>
                    <span class="token comment" spellcheck="true">// 只有在有1个原始类型参数，且只有一个候选位置时才执行绑定操作</span>
                    <span class="token function">maybeBindPrimitiveArgsFromPointcutExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> STEP_THIS_TARGET_ARGS_BINDING<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// 6-切点表达式参数绑定</span>
                    <span class="token comment" spellcheck="true">// 只有只存在一个变量名称的时候才能执行绑定</span>
                    <span class="token function">maybeBindThisOrTargetOrArgsFromPointcutExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> STEP_REFERENCE_PCUT_BINDING<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// 7-引用切点绑定</span>
                    <span class="token comment" spellcheck="true">// 只有只存在一个变量名称的时候才能执行绑定</span>
                    <span class="token function">maybeBindReferencePointcutParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unknown algorithmic step: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>algorithmicStep <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AmbiguousBindingException</span> ambigEx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raiseExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ambigEx<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raiseExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>numberOfRemainingUnboundArguments <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parameterNameBindings<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raiseExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Failed to bind all argument names: "</span> <span class="token operator">+</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfRemainingUnboundArguments <span class="token operator">+</span> <span class="token string">" argument(s) could not be bound"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// convention for failing is to return null, allowing participation in a chain of responsibility</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>源码中针对各种情况进行了参数绑定操作，采用switch…case链式结构完成功能。虽然这一步最终目的是返回parameterNameBindings值，而且在源码32中看起来只是用于判空，好像用处不大，其实大错特错，这个parameterNameBindings在这里绑定完成之后，在以后会有大用，判空只是它的一个小功能罢了。</p>
<p>至于针对每种参数类型的绑定逻辑就不再细究了。下面看看源码32中<strong>bindExplicitArguments</strong>方法</p>
<p>源码35-来自：AbstractAspectJAdvice</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void bindExplicitArguments(int numArgumentsLeftToBind) {        Assert.state(this.argumentNames != null, "No argument names available");        this.argumentBindings = new HashMap();         // 获取通知方法的参数个数        int numExpectedArgumentNames = this.aspectJAdviceMethod.getParameterCount();        if (this.argumentNames.length != numExpectedArgumentNames) {            // 参数个数不匹配            throw new IllegalStateException("Expecting to find " + numExpectedArgumentNames +                    " arguments to bind by name in advice, but actually found " +                    this.argumentNames.length + " arguments.");        }         // So we match in number...        // 获取parameterTypes中剩余的参数偏移量，将其绑定到argumentBindings中，numArgumentsLeftToBind正是之前排除三大首位切点参数之后的剩余参数量        int argumentIndexOffset = this.parameterTypes.length - numArgumentsLeftToBind;        for (int i = argumentIndexOffset; i  this.argumentNames.length; i++) {            // 参数绑定的格式：name- index            this.argumentBindings.put(this.argumentNames[i], i);        }         // Check that returning and throwing were in the argument names list if        // specified, and find the discovered argument types.        if (this.returningName != null) {            if (!this.argumentBindings.containsKey(this.returningName)) {                throw new IllegalStateException("Returning argument name '" + this.returningName +                        "' was not bound in advice arguments");            }            else {                // 获取其对应的index值，将其另外绑定到discoveredReturningType和discoveredReturningGenericType中                Integer index = this.argumentBindings.get(this.returningName);                this.discoveredReturningType = this.aspectJAdviceMethod.getParameterTypes()[index];                this.discoveredReturningGenericType = this.aspectJAdviceMethod.getGenericParameterTypes()[index];            }        }        if (this.throwingName != null) {            if (!this.argumentBindings.containsKey(this.throwingName)) {                throw new IllegalStateException("Throwing argument name '" + this.throwingName +                        "' was not bound in advice arguments");            }            else {                // 获取其对应的index值，并将其另外绑定到discoveredThrowingType中                Integer index = this.argumentBindings.get(this.throwingName);                this.discoveredThrowingType = this.aspectJAdviceMethod.getParameterTypes()[index];            }        }         // configure the pointcut expression accordingly.        // 相应地配置切入点表达式。        configurePointcutParameters(this.argumentNames, argumentIndexOffset);    }</pre></td>

<p>private void bindExplicitArguments(int numArgumentsLeftToBind) {<br>        Assert.state(this.argumentNames !&#x3D; null, “No argument names available”);<br>        this.argumentBindings &#x3D; new HashMap();</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// 获取通知方法的参数个数</span>
    <span class="token keyword">int</span> numExpectedArgumentNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdviceMethod<span class="token punctuation">.</span><span class="token function">getParameterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>argumentNames<span class="token punctuation">.</span>length <span class="token operator">!=</span> numExpectedArgumentNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 参数个数不匹配</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Expecting to find "</span> <span class="token operator">+</span> numExpectedArgumentNames <span class="token operator">+</span>
                <span class="token string">" arguments to bind by name in advice, but actually found "</span> <span class="token operator">+</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>argumentNames<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">" arguments."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// So we match in number...</span>
    <span class="token comment" spellcheck="true">// 获取parameterTypes中剩余的参数偏移量，将其绑定到argumentBindings中，numArgumentsLeftToBind正是之前排除三大首位切点参数之后的剩余参数量</span>
    <span class="token keyword">int</span> argumentIndexOffset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parameterTypes<span class="token punctuation">.</span>length <span class="token operator">-</span> numArgumentsLeftToBind<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> argumentIndexOffset<span class="token punctuation">;</span> i  <span class="token keyword">this</span><span class="token punctuation">.</span>argumentNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 参数绑定的格式：name- index</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>argumentBindings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>argumentNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Check that returning and throwing were in the argument names list if</span>
    <span class="token comment" spellcheck="true">// specified, and find the discovered argument types.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>returningName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>argumentBindings<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>returningName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Returning argument name '"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>returningName <span class="token operator">+</span>
                    <span class="token string">"' was not bound in advice arguments"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取其对应的index值，将其另外绑定到discoveredReturningType和discoveredReturningGenericType中</span>
            Integer index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>argumentBindings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>returningName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>discoveredReturningType <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdviceMethod<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>discoveredReturningGenericType <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdviceMethod<span class="token punctuation">.</span><span class="token function">getGenericParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>throwingName <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>argumentBindings<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>throwingName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Throwing argument name '"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>throwingName <span class="token operator">+</span>
                    <span class="token string">"' was not bound in advice arguments"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取其对应的index值，并将其另外绑定到discoveredThrowingType中</span>
            Integer index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>argumentBindings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>throwingName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>discoveredThrowingType <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdviceMethod<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// configure the pointcut expression accordingly.</span>
    <span class="token comment" spellcheck="true">// 相应地配置切入点表达式。</span>
    <span class="token function">configurePointcutParameters</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>argumentNames<span class="token punctuation">,</span> argumentIndexOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>源码36-来自：AbstractAspectJAdvice</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void configurePointcutParameters(String[] argumentNames, int argumentIndexOffset) {        int numParametersToRemove = argumentIndexOffset;        if (this.returningName != null) {            numParametersToRemove++;        }        if (this.throwingName != null) {            numParametersToRemove++;        }        // 之前将所有要移除的参数数量累加出来，需要移除首位的三种切点参数、returningName参数和throwingName参数        // 剩余的参数就是切点表达式中可以出现的候选参数，这里初始化一个切点参数名数组pointcutParameterNames，将这些参数囊括进来        // 另外再初始化两个数组，分别用于存放这些剩余参数的参数类型（pointcutParameterTypes）和通知方法所有参数类型（methodParameterTypes）        String[] pointcutParameterNames = new String[argumentNames.length - numParametersToRemove];        Class?[] pointcutParameterTypes = new Class?[pointcutParameterNames.length];        Class?[] methodParameterTypes = this.aspectJAdviceMethod.getParameterTypes();         int index = 0;        for (int i = 0; i  argumentNames.length; i++) {            if (i  argumentIndexOffset) {                // 小于偏移量的参数为移除的三大切点类型参数                continue;            }            if (argumentNames[i].equals(this.returningName) ||                argumentNames[i].equals(this.throwingName)) {                // 这里在对returningName和throwingName参数进行排除                continue;            }            // 剩余的就是通知中的切点表达式候选参数，将这些参数的参数名逐个保存到切点参数名数组中            // 将这些参数的参数类型逐个保存到切点参数类型数组中            pointcutParameterNames[index] = argumentNames[i];            pointcutParameterTypes[index] = methodParameterTypes[i];            index++;        }         // 然后，分别将两个数组设置到切点的对应属性中        this.pointcut.setParameterNames(pointcutParameterNames);// 設置参数名称        this.pointcut.setParameterTypes(pointcutParameterTypes);// 设置参数类型    }</pre></td>

<p>private void configurePointcutParameters(String[] argumentNames, int argumentIndexOffset) {<br>        int numParametersToRemove &#x3D; argumentIndexOffset;<br>        if (this.returningName !&#x3D; null) {<br>            numParametersToRemove++;<br>        }<br>        if (this.throwingName !&#x3D; null) {<br>            numParametersToRemove++;<br>        }<br>        &#x2F;&#x2F; 之前将所有要移除的参数数量累加出来，需要移除首位的三种切点参数、returningName参数和throwingName参数<br>        &#x2F;&#x2F; 剩余的参数就是切点表达式中可以出现的候选参数，这里初始化一个切点参数名数组pointcutParameterNames，将这些参数囊括进来<br>        &#x2F;&#x2F; 另外再初始化两个数组，分别用于存放这些剩余参数的参数类型（pointcutParameterTypes）和通知方法所有参数类型（methodParameterTypes）<br>        String[] pointcutParameterNames &#x3D; new String[argumentNames.length - numParametersToRemove];<br>        Class?[] pointcutParameterTypes &#x3D; new Class?[pointcutParameterNames.length];<br>        Class?[] methodParameterTypes &#x3D; this.aspectJAdviceMethod.getParameterTypes();</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i  argumentNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i  argumentIndexOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 小于偏移量的参数为移除的三大切点类型参数</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argumentNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>returningName<span class="token punctuation">)</span> <span class="token operator">||</span>
            argumentNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>throwingName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 这里在对returningName和throwingName参数进行排除</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 剩余的就是通知中的切点表达式候选参数，将这些参数的参数名逐个保存到切点参数名数组中</span>
        <span class="token comment" spellcheck="true">// 将这些参数的参数类型逐个保存到切点参数类型数组中</span>
        pointcutParameterNames<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> argumentNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        pointcutParameterTypes<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> methodParameterTypes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        index<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 然后，分别将两个数组设置到切点的对应属性中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pointcut<span class="token punctuation">.</span><span class="token function">setParameterNames</span><span class="token punctuation">(</span>pointcutParameterNames<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 設置参数名称</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pointcut<span class="token punctuation">.</span><span class="token function">setParameterTypes</span><span class="token punctuation">(</span>pointcutParameterTypes<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 设置参数类型</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>到此为止我们看到了参数绑定操作的最终结果，将除了首位三大切点类型参数、returningName参数和throwingName参数之外的通知的剩余参数都作为候选参数，将其名称和类型分别放置到一个数组中，再设置到切点之中。</p>
<p>逻辑到这里我们可以回到源码30中，执行剩余的逻辑，将所有参数迁移到adviceInvocationArgs中进行绑定，绑定的逻辑还是一样，都是以数组的方式保存。</p>
<p>然后再回到源码28中，执行<strong>invokeAdviceMethodWithGivenArgs</strong>方法</p>
<td class="line_numbers"><pre>12345678910111213141516171819</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">protected Object invokeAdviceMethodWithGivenArgs(Object[] args) throws Throwable {        Object[] actualArgs = args;        if (this.aspectJAdviceMethod.getParameterCount() == 0) {            actualArgs = null;        }        try {            ReflectionUtils.makeAccessible(this.aspectJAdviceMethod);            // TODO AopUtils.invokeJoinpointUsingReflection            return this.aspectJAdviceMethod.invoke(this.aspectInstanceFactory.getAspectInstance(), actualArgs);        }        catch (IllegalArgumentException ex) {            throw new AopInvocationException("Mismatch on arguments to advice method [" +                    this.aspectJAdviceMethod + "]; pointcut expression [" +                    this.pointcut.getPointcutExpression() + "]", ex);        }        catch (InvocationTargetException ex) {            throw ex.getTargetException();        }    }</pre></td>

<p>protected Object invokeAdviceMethodWithGivenArgs(Object[] args) throws Throwable {<br>        Object[] actualArgs &#x3D; args;<br>        if (this.aspectJAdviceMethod.getParameterCount() &#x3D;&#x3D; 0) {<br>            actualArgs &#x3D; null;<br>        }<br>        try {<br>            ReflectionUtils.makeAccessible(this.aspectJAdviceMethod);<br>            &#x2F;&#x2F; TODO AopUtils.invokeJoinpointUsingReflection<br>            return this.aspectJAdviceMethod.invoke(this.aspectInstanceFactory.getAspectInstance(), actualArgs);<br>        }<br>        catch (IllegalArgumentException ex) {<br>            throw new AopInvocationException(“Mismatch on arguments to advice method [“ +<br>                    this.aspectJAdviceMethod + “]; pointcut expression [“ +<br>                    this.pointcut.getPointcutExpression() + “]”, ex);<br>        }<br>        catch (InvocationTargetException ex) {<br>            throw ex.getTargetException();<br>        }<br>    }</p>
<p>逻辑很简单，就是依据给定的参数来反射调用通知的方法逻辑。</p>
<p>至此我们分析完JDK动态代理实现AOP切面编程的整个逻辑。</p>

                </div>
                <!-- 欧阳思海，modify，2020.05.01-->
<!-- 文章详情详情页面的头部广告位置信息 -->
<div id="post-head-panel">
    
    <a href="https://github.com/OUYANGSIHAI/JavaInterview" style="font-size: 18px;" target="_blank">
        <img src="/icons/hot.gif">
        本人花费半年的时间总结的《Java面试指南》已拿腾讯等大厂offer，已开源在github ，欢迎star！
    </a>
    
    
</div>
<br />



<blockquote>
    
            <p>本文GitHub <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">https://github.com/OUYANGSIHAI/JavaInterview</a> 已收录，这是我花了6个月总结的<b>一线大厂Java面试</b>总结，本人已拿大厂offer，欢迎star</p>
    
    <p>原文链接：blog.ouyangsihai.cn &gt;&gt; <a href="/spring-ji-chu-xi-lie-aop-yuan-ma-fen-xi.html" target="_blank">Spring基础系列-AOP源码分析</a></p>
</blockquote>
                <hr />

                
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">多少都是对我的认可</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="http://image.ouyangsihai.cn/FpbhsOuf3Ar9vY34B97Y2qQ7LVGe" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="http://image.ouyangsihai.cn/FgYlMzms68PH73PWpZBwPfbLTAws" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
                

                <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

                

                
                <div class="reprint1">
                    <p>
                        <span class="reprint1-tip">
                            <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                        </span>
                        <a href="https://blog.ouyangsihai.cn" class="b-link-green">好好学java</a>
                        <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                        <a href="/spring-ji-chu-xi-lie-aop-yuan-ma-fen-xi.html" class="b-link-green">Spring基础系列-AOP源码分析</a>
                    </p>
                </div>

            </div>
        </div>

        

        

        

        

        
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }
    /* valine 评论框增加背景图片 */
    #vcomments textarea {
        box-sizing: border-box;
        background: url("") 100% 100% no-repeat;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    /* 修复评论第一行位置错位 */
    .v .vlist .vcard {
    padding-top: 2.5em !important ;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <link rel="stylesheet" type="text/css" href="/libs//libs/jQuery-emoji/dist/css/jquery.emoji.css">
<script src="/libs//libs/jQuery-emoji/dist/js/jquery.emoji.min.js"></script>
<script src="/libs//libs/jQuery-emoji/dist/js/emoji.list.js"></script> -->
<script>
    new Valine({
        el: '#vcomments',
        appId: 'MxSNOS83TYWU3Opsy2GTW1ih-gzGzoHsz',
        appKey: '4XevOgmAxHEwVDnIKgvEUihB',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '请畅所欲言吧，别害羞~',

    });

//     function parse_emoji() {
//     jQuery(".vcontent").emojiParse({
//       basePath: '/libs/jQuery-emoji/images/emoji',
//       icons: emojiLists   // 注：详见 js/emoji.list.js
//     });
//   }
  
//   setTimeout(function() {
//     // jQuery emoji 解析
//     parse_emoji();
//     // jquery emoji 初始化
//     jQuery(".veditor").emoji({
//       showTab: true,
//       animation: 'slide',
//       basePath: '/libs/jQuery-emoji/images/emoji',
//       icons: emojiLists  // 注：详见 js/emoji.list.js
//     });
//     jQuery(".vmore").on("click", function() {
//       setTimeout(function() {
//         parse_emoji();
//       }, 500);
//     });
//   }, 800)

</script>
        

        

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/spring-mvc-pei-zhi-xiang-jie.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="Spring MVC配置详解">
                        
                        <span class="card-title">Spring MVC配置详解</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            

作者：牧涛链接：www.cnblogs.com/superjt/
链接：www.cnblogs.com/superjt/
现在主流的Web MVC框架除了Struts这个主力 外，其次就是Spring MVC了，因此这也是作为一名程序员
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock fa-fw icon-date"></i>2021-04-05
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/spring%E6%95%99%E7%A8%8B/" class="post-category" target="_blank">
                                    spring教程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/spring-spring%E6%95%99%E7%A8%8B-spring%E6%BA%90%E7%A0%81/" target="_blank">
                        <span class="chip bg-color">spring,spring教程,spring源码</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/tou-guo-xian-xiang-kan-yuan-li-xiang-jie-spring-zhong-bean-de-this-diao-yong-dao-zhi-aop-shi-xiao-de-yuan-yin-shang.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="透过现象看原理——详解Spring中Bean的this调用导致AOP失效的原因（上）">
                        
                        <span class="card-title">透过现象看原理——详解Spring中Bean的this调用导致AOP失效的原因（上）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            

作者：光闪my.oschina.net&#x2F;guangshan&#x2F;blog&#x2F;1807721
my.oschina.net&#x2F;guangshan&#x2F;blog&#x2F;1807721
推荐：
前言在
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock fa-fw icon-date"></i>2021-04-05
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/spring%E6%95%99%E7%A8%8B/" class="post-category" target="_blank">
                                    spring教程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/spring-spring%E6%95%99%E7%A8%8B-spring%E6%BA%90%E7%A0%81/" target="_blank">
                        <span class="chip bg-color">spring,spring教程,spring源码</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
    </div>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('500')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 好好学java<br />'
            + '作者: 好好学java<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>



<!--
<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'container',
        blogId: '15305-1590684104111-518',
        name: '程序员的技术圈子',
        qrcode: 'http://image.ouyangsihai.cn/FtAUOeE5--1JTdcuuZFIhMuEUuJO',
        keyword: 'vip',
    });
</script>
-->

    </div>
    <div id="toc-aside" style="width: 310px;" class="expanded col l3 hide-on-med-and-down">
        <!-- 自定义右侧card：欧阳思海 -->
        <!-- <div id="my-card" style="background: ">
            
        </div> -->
        <!-- <div class="toc-widget">
            <div class="toc-title" style="display: none;"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;</div>
            <div id="toc-content"></div>
        </div> -->








        <aside class="col-lg-3" style="width: 300px;">

            <link rel="stylesheet" type="text/css" href="/css/my-aside.css">

            <!-- 关注公众号信息：欧阳思海 -->
            <div class="widget-wrap">
                <div class="widget bg-danger" style="color:whitesmoke; background-color: #419488">
                    <div class="card-front animated col s12 m12 l8 offset-l2 fadeInUp">
                        <div class="row">
                            <div class="col-md-5" style="text-align: center;">
                                <img class="adv" style="width: 95px; height: 95px;"
                                    src="http://image.ouyangsihai.cn/FtAUOeE5--1JTdcuuZFIhMuEUuJO">
                            </div>
                            <div class="col-md-7" style="text-align: center;">
                                <h2 style="font-size: 18px; 
                                    margin: 0; 
                                    padding: 0;
                                    border: 0; 
                                    outline: 0;
                                    font-weight: inherit;
                                    font-style: inherit;
                                    font-family: inherit;
                                    vertical-align: baseline;">关注公众号</h2>
                                 
                                <small style="font-size: 15px;">
                                    →「技术干货」每日推送 <br>
                                    →「回复资料」领取资料 <br>
                                    →「微信加群」每周福利 <br>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- <div style="font-size: 0.8em;">
                        <a href="/assets/erweima.jpg" target="_blank"
                            style="color:orange;font-size: 14px;">点击添加我的微信，加入技术讨论群</a>
                        除公众号以外，我还会在以下平台发布内容：
                    </div>
                    -->

                    <div class="profile-block social-links col-md-7" style="text-align: center;">
                        <table style="align-items: center; 
                                        padding-left: 25px;">
                            <tbody>
                                <tr>
                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank" title="GitHub"
                                            class="tooltip">
                                            <img style="width: 22px;height: 22px;" src="/icons/github.svg"></a>
                                    </td>

                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://www.zhihu.com/people/hai-hai-ren-sheng-50/activities"
                                            target="_blank" title="知乎" class="tooltip">
                                            <img style="width: 22px;" src="/icons/zhihu.svg"></a>
                                    </td>
                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://blog.csdn.net/sihai12345" target="_blank" title="CSDN"
                                            class="tooltip">
                                            <img style="width: 18px;" src="/icons/CSDN.svg"></a>
                                    </td>
                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://www.jianshu.com/u/12b0bd4c857c" target="_blank" title="简书"
                                            class="tooltip">
                                            <img style="width: 22px;" src="/icons/JianShu.svg"></a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            

            <!-- custom rightside_link：热门文章推荐：欧阳思海 -->
            
            <div class="widget-wrap widget-panel">
                <p style="text-align: left;padding-bottom: 10px;line-height: 30px; font-size: 14px;">
                    
                    <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">

                        <img src="/icons/hot.gif">

                        本人花费半年的时间总结的《 Java 面试指南》已拿腾讯等大厂 offer，已开源在 github ，欢迎 star！
                    </a><br>
                    
                    <a href="https://mp.weixin.qq.com/s/I0jimqziHqRNaIy0kXRCnw" target="_blank">

                        <img src="/icons/hot.gif">

                        2020 Java 1000G 最新学习资源，Java基础、Java项目实战、Java分布式等等！
                    </a><br>
                    
                    <a href="http://image.ouyangsihai.cn/FpB-dO6g-XU44mMrVlj7EL1y7Rs7" target="_blank">

                        <img src="/icons/hot.gif">

                        高级 Java 开发微信群，一起搞事情吧！
                    </a><br>
                    
                </p>
            </div>
            

            

            <!-- custom rightside_banner：右侧广告或者其他的栏目设置：欧阳思海 -->
            
            <div class="widget-wrap">
                <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">
                    <img src="http://image.ouyangsihai.cn/FhhoEYMaNr6m0v8KhG8vSPgoREBV" style="width: 100%;">
                </a>
            </div>
            
            

            

            <!-- 右侧专栏分类：欧阳思海 -->
            
            <div class="widget-wrap widget-panel">
                <ul class="media-list">
                    
                    <li class="media">
                        <a href="/categories/MySQL的艺术世界/" target="_blank">
                            <div class="media-left">
                                <img class="media-object" src="http://image.ouyangsihai.cn/Fn3kQurieQ_0QUeqPmx5RW5i6R9n" style="width: 55px;">
                            </div>
                            <div class="media-body">
                                <h4 class="media-heading" style="margin-bottom: 10px; font-size: 100%;
                                                                    margin: 0;
                                                                    padding: 0;
                                                                    border: 0;
                                                                    outline: 0;
                                                                    font-weight: inherit;
                                                                    font-style: inherit;
                                                                    font-family: inherit;
                                                                    vertical-align: baseline;">
                                    MySQL 的系列文章，解决全部面试问题！
                                </h4>
                                <p>
                                    总共10篇文章，面试热门的锁、事务，通通解决了！
                                </p>
                            </div>
                        </a>
                    </li>
                    <hr>
                    
                    <li class="media">
                        <a href="/categories/深入理解Java虚拟机/" target="_blank">
                            <div class="media-left">
                                <img class="media-object" src="http://image.ouyangsihai.cn/FpcS21VWJOHSgGzKcpW3_xVTSEeN" style="width: 55px;">
                            </div>
                            <div class="media-body">
                                <h4 class="media-heading" style="margin-bottom: 10px; font-size: 100%;
                                                                    margin: 0;
                                                                    padding: 0;
                                                                    border: 0;
                                                                    outline: 0;
                                                                    font-weight: inherit;
                                                                    font-style: inherit;
                                                                    font-family: inherit;
                                                                    vertical-align: baseline;">
                                    深入理解 Java 虚拟机，面试必问
                                </h4>
                                <p>
                                    总共10篇文章，包括内存模型、GC算法、GC收集器等。
                                </p>
                            </div>
                        </a>
                    </li>
                    <hr>
                    
                </ul>
            </div>
            

            <!-- 右侧分类 -->
            <div class="widget-wrap widget-panel">
                <h3 class="widget-title">文章分类</h3>
                <div class="widget">
                    <ul class="category-list">
                        
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/趣聊数据结构与算法/">>
                                趣聊数据结构与算法</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/职业生涯浅谈/">>
                                职业生涯浅谈</a><span class="category-list-count">33</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java项目分享/">>
                                Java项目分享</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java面试经验/">>
                                Java面试经验</a><span class="category-list-count">4</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/我要进大厂/">>
                                我要进大厂</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/好好学java/">>
                                好好学java</a><span class="category-list-count">1116</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/剑指offer/">>
                                剑指offer</a><span class="category-list-count">112</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/css/">>
                                css</a><span class="category-list-count">12</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/其他框架/">>
                                其他框架</a><span class="category-list-count">142</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python其他/">>
                                python其他</a><span class="category-list-count">45</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/数据库相关/">>
                                数据库相关</a><span class="category-list-count">293</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java核心知识/">>
                                Java核心知识</a><span class="category-list-count">196</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java面试题/">>
                                Java面试题</a><span class="category-list-count">308</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/mybatis源码/">>
                                mybatis源码</a><span class="category-list-count">56</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/spring教程/">>
                                spring教程</a><span class="category-list-count">173</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springboot教程/">>
                                springboot教程</a><span class="category-list-count">156</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/实战Activiti工作流/">>
                                实战Activiti工作流</a><span class="category-list-count">4</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springcloud教程/">>
                                springcloud教程</a><span class="category-list-count">39</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/linux/">>
                                linux</a><span class="category-list-count">91</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python框架/">>
                                python框架</a><span class="category-list-count">43</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python基础/">>
                                python基础</a><span class="category-list-count">78</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/dubbo/">>
                                dubbo</a><span class="category-list-count">37</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java源码/">>
                                Java源码</a><span class="category-list-count">76</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/叽叽喳喳杂七杂八/">>
                                叽叽喳喳杂七杂八</a><span class="category-list-count">10</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/MySQL的艺术世界/">>
                                MySQL的艺术世界</a><span class="category-list-count">8</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/jquery/">>
                                jquery</a><span class="category-list-count">14</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java并发/">>
                                Java并发</a><span class="category-list-count">43</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java文章合辑/">>
                                Java文章合辑</a><span class="category-list-count">11</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java基础修炼/">>
                                Java基础修炼</a><span class="category-list-count">7</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/不一样的Java8/">>
                                不一样的Java8</a><span class="category-list-count">3</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/小程序开发的世界/">>
                                小程序开发的世界</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java学习资源分享/">>
                                Java学习资源分享</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java小学生漫游/">>
                                Java小学生漫游</a><span class="category-list-count">2</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/rocketmq源码解析/">>
                                rocketmq源码解析</a><span class="category-list-count">33</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springmvc最新教程/">>
                                springmvc最新教程</a><span class="category-list-count">9</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java的Exception/">>
                                Java的Exception</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/vue-js/">>
                                vue.js</a><span class="category-list-count">10</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/实战设计模式/">>
                                实战设计模式</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python数据处理/">>
                                python数据处理</a><span class="category-list-count">7</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java-Web闯关/">>
                                Java Web闯关</a><span class="category-list-count">7</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springboot2-0最新教程/">>
                                springboot2.0最新教程</a><span class="category-list-count">11</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/netty/">>
                                netty</a><span class="category-list-count">16</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/rpc/">>
                                rpc</a><span class="category-list-count">13</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/拥抱大厂系列/">>
                                拥抱大厂系列</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/eureka/">>
                                eureka</a><span class="category-list-count">19</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/分布式/">>
                                分布式</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/中间件/">>
                                中间件</a><span class="category-list-count">23</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java基础/">>
                                Java基础</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/带你学Python/">>
                                带你学Python</a><span class="category-list-count">10</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/使用技术工具/">>
                                使用技术工具</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/mycat源码/">>
                                mycat源码</a><span class="category-list-count">5</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/深入理解Java虚拟机/">>
                                深入理解Java虚拟机</a><span class="category-list-count">8</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/spring源码/">>
                                spring源码</a><span class="category-list-count">2</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java集合源码分析/">>
                                Java集合源码分析</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/github的repo/">>
                                github的repo</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java框架深究/">>
                                Java框架深究</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/分布式架构/">>
                                分布式架构</a><span class="category-list-count">2</span>
                        </li>
                        
                        
                    </ul>
                </div>
            </div>

        </aside>









    </div>
</div>

<!-- TOC 悬浮按钮. 修改成永远不显示：欧阳思海-->




<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        console.log('============');

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

                        
            /* 修复文章卡片 div 的宽度. */
            let fixPostCardWidth = function (srcId, targetId) {
                let srcDiv = $('#' + srcId);
                if (srcDiv.length === 0) {
                    return;
                }

                let w = srcDiv.width();
                if (w >= 450) {
                    w = w + 21;
                } else if (w >= 350 && w < 450) {
                    w = w + 18;
                } else if (w >= 300 && w < 350) {
                    w = w + 16;
                } else {
                    w = w + 14;
                }
                $('#' + targetId).width(w);
            };

            // 切换TOC目录展开收缩的相关操作.
            // 修改右侧边栏功能：欧阳思海
            const expandedClass = 'expanded';
            let $tocAside = $('#toc-aside');
            let $mainContent = $('#main-content');

            $('#floating-toc-btn .btn-floating').click(function () {
                if ($tocAside.hasClass(expandedClass)) {
                    $tocAside.removeClass(expandedClass).slideUp(500);
                    $mainContent.removeClass('l9');
                } else {
                    $tocAside.addClass(expandedClass).slideDown(500);
                    $mainContent.addClass('l9');
                }
                fixPostCardWidth('artDetail', 'prenext-posts');
            });
                        
                    });
</script>
    

</main>


        <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            
	    Copyright&copy; 2019 <a href="https://www.java1000.com/" target="_blank"> 好好学java </a>维护. 网站备案/许可证号：赣ICP备17007984号-3
            <br>
            <span id="sitetime"></span>
            <br>

            

            
                    <!-- 
                        <span id="busuanzi_container_site_pv" style='display:none'></span>
                        总访问量: <span id="busuanzi_value_site_pv" class="white-color"></span>
                    
        
                    
                        <span id="busuanzi_container_site_uv" style='display:none'></span>
                        人次&nbsp; | &nbsp;访客人数: <span id="busuanzi_value_site_uv" class="white-color"></span> 人
                     -->
                        <!-- 修改计数：欧阳思海 -->
                    
                        <span id="busuanzi_container_site_pv" style='display:inline'>
                            <i class="fa fa-heart-o"></i>
                            本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                        </span>
                    
                    
                        <span id="busuanzi_container_site_uv" style='display:none'>
                            人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                        </span>
                    
    
            

            
                &nbsp; | &nbsp;字数统计:&nbsp;
                <span class="white-color">8290.3k</span> 字
            

            
            <br>

        </div>

        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/OUYANGSIHAI/JavaInterview" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-code-branch"></i>
    </a>


 
    <a href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=1446037005@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>




    <a href="https://zhihu.com/people/hai-hai-ren-sheng-50/activities" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>









    <a href="https://blog.ouyangsihai.cn/sitemap.xml" class="tooltipped" target="_blank" data-tooltip="站点地图" data-position="top" data-delay="50">
        <i class="fa fa-sitemap"></i>
    </a>



    <a href="https://blog.ouyangsihai.cn/friends" class="tooltipped" target="_blank" data-tooltip="友情链接" data-position="top" data-delay="50">
        <i class="fa fa-address-book"></i>
    </a>
</div>

    </div>
</footer>

<div class="progress-bar"></div>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();

        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */

        var t1 = Date.UTC(2019, 08, 10, 00, 00, 00); //北京时间2019-8-1 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes *
            minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours +
            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒" ;
    } /*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

<!-- 修改计数：欧阳思海 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);  // 50ms周期检测函数
        var pvcountOffset = 1005469;  // 初始化首次数据
        var uvcountOffset = 250804;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int); // 停止检测
            }
        }
    });
</script>




        <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    console.log("lets go！");
    console.log("/");
    searchFunc("/" + "search.json", 'searchInput', 'searchResult');
});
</script>
        <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


        <script src="/libs/materialize/materialize.min.js"></script>
        <script src="/libs/masonry/masonry.pkgd.min.js"></script>
        <script src="/libs/aos/aos.js"></script>
        <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
        <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
        <script src="/js/matery.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-149362573-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-149362573-1');
</script>



        
            <script src="/libs/others/clicklove.js"></script>
        

        
            <script async src="/libs/others/busuanzi.pure.mini.js"></script>
        

        <!-- 洪卫 shw2018 add 2019.08.28 -->
        <script type="text/javascript">
            var OriginTitile = document.title,
                st;
            document.addEventListener("visibilitychange", function () {
                document.hidden ? (document.title = "看不见我🙈~看不见我🙈~", clearTimeout(st)) : (document.title =
                    "(๑•̀ㅂ•́) ✧被发现了～", st = setTimeout(function () {
                        document.title = OriginTitile
                    }, 3e3))
            })
        </script>

        <!-- 鼠标点击烟花爆炸效果  洪卫 shw2018 add 2019.09.09 -->
        

        <!-- 背景雪花飘落特效洪卫 shw2018 add 2019.09.10 -->
        

        <!-- 鼠标点击文字特效 洪卫 shw2018 add 2019.09.10-->
        

        <!-- 背景雪花飘落特效 洪卫 shw2018 add 2019.09.10 -->
        

        <!-- 在线聊天工具  洪卫 shw2018 add 2019.09.11 -->
        

        <!-- 背景 canvas-nest  洪卫 shw 2018  add 2019.09.15-->
        

        <!-- 背景静止彩带  洪卫 shw 2018  add 2019.09.15-->
        

        <!-- 背景动态彩带 洪卫 shw 2018  add 2019.09.15-->
        

    </body>
</html>
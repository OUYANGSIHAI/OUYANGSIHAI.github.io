<!DOCTYPE HTML>
<html lang="zh-CN">
    <!-- shw2018 洪卫  modify 2019.08.15-->



<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Spring Boot, Spring Cloud, 微服务, Java技术, 好好学java, Java面试, 分布式, 最新干货分享">
    <meta name="baidu-site-verification" content="fmlEuI34ir" />
    <meta name="google-site-verification" content="ZWVq5UvPg33BCEA3LRTUkYe5J854o9lF1_WRTer9l8A" />
    <meta name="description" content="本站是 好好学java 的技术分享博客。内容涵盖Java后端技术、Spring Boot、Spring Cloud、微服务架构、分布式、Java面试、测试开发等相关的研究与知识分享。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MyBatis 源码分析 – 映射文件解析过程 | 好好学java | Spring Boot | Spring Cloud | 微服务 | Java技术 | Java面试 | 分布式 | 最新干货分享</title>
    <link rel="icon" type="image/png" href="http://image.ouyangsihai.cn/FjihsEiBMONnJIRtPwgGkjE4HAP7">

    <!-- <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css"> -->
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <!-- 自定义fontawesome样式：欧阳思海 -->
    <link rel="stylesheet" type="text/css" href="/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/css/brands.min.css">
    <link rel="stylesheet" type="text/css" href="/css/fontawesome.min.css">
    <link rel="stylesheet" type="text/css" href="/css/regular.min.css">
    <link rel="stylesheet" type="text/css" href="/css/solid.min.css">


    <style type="text/css">
        code[class*="language-"],
            pre[class*="language-"] {
                white-space: pre !important;
            }

            

        /* 将matery.css中的背景颜色修改放到这里：欧阳思海 */
        .bg-color {
            background-image: linear-gradient(to right, #ec8585 0%, #419488 100%);
            opacity: 0.9;
            // 透明度
        }
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>

    
    
    <script>
        (function () {
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>
    

    <script>
        var _hmt = _hmt || [];
        (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?6fe466069710c03a563713b507fbaca7";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
        })();
    </script>


    <!-- Google Analytics -->
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-XXXXX-Y', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics -->

    <script>(function (i, s, o, g, r, a, m) { i["DaoVoiceObject"] = r; i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments) }, i[r].l = 1 * new Date(); a = s.createElement(o), m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; a.charset = "utf-8"; m.parentNode.insertBefore(a, m) })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0a804bac.js", "daovoice")</script>

    <script>
        if (true) {
            daovoice('init', {
                app_id: "0a804bac",
                user_id: "NO_89757", // 必填: 该用户在您系统上的唯一ID
                email: "daovoice@example.com", // 选填:  该用户在您系统上的主邮箱
                name: "道客船长", // 选填: 用户名
                signed_up: 1449821660 // 选填: 用户的注册时间，用Unix时间戳表示
            });
            daovoice('update');

            daovoice('init', {
                app_id: "0a804bac"
            });
            daovoice('update');
        }
    </script>
<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/rss2.xml" title="好好学java" type="application/rss+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

    <body>

        <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="http://image.ouyangsihai.cn/FjihsEiBMONnJIRtPwgGkjE4HAP7" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span" style="font-size: 1.4rem;">好好学java</span>
                </a>
            </div>
            


<!-- <a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="" class="waves-effect waves-light">
            
            <i class="fa "></i>
            
            <span></span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title=""></i>
        </a>
    </li>
</ul> -->

<!-- 支持二级菜单特性 洪卫 shw2018 modify 2019.09.17  -->
<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-align-justify"></i></a>
<ul class="right nav-menu">
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-folder-minus"></i>
                
                <span style="font-size: 1.1rem;">Java学习</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/Java%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86/" >
                    
                    <span>Java入门</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/Javaweb/" >
                    
                    <span>Java Web</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/spring%E6%95%99%E7%A8%8B/" >
                    
                    <span>Spring教程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/springboot%E6%95%99%E7%A8%8B/" >
                    
                    <span>SpringBoot教程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/springcloud%E6%95%99%E7%A8%8B/" >
                    
                    <span>SpringCloud教程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/Java%E9%9D%A2%E8%AF%95%E9%A2%98/" >
                    
                    <span>Java面试</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E5%89%91%E6%8C%87offer/" >
                    
                    <span>剑指offer</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-code-branch"></i>
                
                <span style="font-size: 1.1rem;">Java进阶</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%B3%BB%E5%88%97/" >
                    
                    <span>设计模式</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" >
                    
                    <span>Java并发编程</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3/" >
                    
                    <span>数据库</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/redis/" >
                    
                    <span>Redis</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/linux/" >
                    
                    <span>Linux</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/" >
                    
                    <span>Java实战项目</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-code"></i>
                
                <span style="font-size: 1.1rem;">python学习</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/python%E5%9F%BA%E7%A1%80/" >
                    
                    <span>python基础</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/python%E6%A1%86%E6%9E%B6/" >
                    
                    <span>python框架</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/python%E5%85%B6%E4%BB%96/" >
                    
                    <span>python其他</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-coffee"></i>
                
                <span style="font-size: 1.1rem;">Java扩展</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/dubbo/" >
                    
                    <span>dubbo</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/netty/" >
                    
                    <span>netty</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/rpc/" >
                    
                    <span>rpc</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/eureka/" >
                    
                    <span>eureka</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" >
                    
                    <span>中间件</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" >
                    
                    <span>分布式</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
              <a href="/categories/" class="waves-effect waves-light">
                
                  <i style="font-size: 1.1rem;" class="fa fa-desktop"></i>
                
                <span style="font-size: 1.1rem;">计算机核心</span>
                <i style="font-size: 1.1rem;" class="fa fa-chevron-down" aria-hidden="true"></i>
              </a>

            <ul class="sub-nav menus_item_child ">
              
                <li> 
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" >
                    
                    <span>数据结构</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/leetcode%E5%88%B7%E9%A2%98/" >
                    
                    <span>leetcode刷题</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" >
                    
                    <span>计算机网络</span>
                  </a>
                </li>
              
                <li> 
                  <a href="/categories/%E7%AE%97%E6%B3%95/" >
                    
                    <span>算法</span>
                  </a>
                </li>
               
            </ul>
          
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/categories/" class="waves-effect waves-light">
              
                <i style="font-size: 1.1rem;" class="fa fa-adjust"></i>
              
              <span style="font-size: 1.1rem;">学习资源</span>
            </a>

            
      </li>
    
      <li class="hide-on-med-and-down nav-item" >

        
            <a href="/contact" class="waves-effect waves-light">
              
                <i style="font-size: 1.1rem;" class="fa fa-envelope"></i>
              
              <span style="font-size: 1.1rem;">留言</span>
            </a>

            
      </li>
    

    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="http://image.ouyangsihai.cn/FjihsEiBMONnJIRtPwgGkjE4HAP7" class="logo-img circle responsive-img">
        
        <div class="logo-name">好好学java</div>
        <div class="logo-desc">
            
            
            本站是 好好学java 的技术分享博客，涵盖Java后端技术、SpringBoot、微服务架构、分布式、Java面试等知 ...
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-folder-minus"></i>
			
			Java学习
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/Java%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86/ " style="margin-left:75px";>
				  
		          <span>Java入门</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Javaweb/ " style="margin-left:75px";>
				  
		          <span>Java Web</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/spring%E6%95%99%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>Spring教程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/springboot%E6%95%99%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>SpringBoot教程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/springcloud%E6%95%99%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>SpringCloud教程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Java%E9%9D%A2%E8%AF%95%E9%A2%98/ " style="margin-left:75px";>
				  
		          <span>Java面试</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E5%89%91%E6%8C%87offer/ " style="margin-left:75px";>
				  
		          <span>剑指offer</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-code-branch"></i>
			
			Java进阶
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%B3%BB%E5%88%97/ " style="margin-left:75px";>
				  
		          <span>设计模式</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/ " style="margin-left:75px";>
				  
		          <span>Java并发编程</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%B8%E5%85%B3/ " style="margin-left:75px";>
				  
		          <span>数据库</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/redis/ " style="margin-left:75px";>
				  
		          <span>Redis</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/linux/ " style="margin-left:75px";>
				  
		          <span>Linux</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/ " style="margin-left:75px";>
				  
		          <span>Java实战项目</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-code"></i>
			
			python学习
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/python%E5%9F%BA%E7%A1%80/ " style="margin-left:75px";>
				  
		          <span>python基础</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/python%E6%A1%86%E6%9E%B6/ " style="margin-left:75px";>
				  
		          <span>python框架</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/python%E5%85%B6%E4%BB%96/ " style="margin-left:75px";>
				  
		          <span>python其他</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-coffee"></i>
			
			Java扩展
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/dubbo/ " style="margin-left:75px";>
				  
		          <span>dubbo</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/netty/ " style="margin-left:75px";>
				  
		          <span>netty</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/rpc/ " style="margin-left:75px";>
				  
		          <span>rpc</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/eureka/ " style="margin-left:75px";>
				  
		          <span>eureka</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/ " style="margin-left:75px";>
				  
		          <span>中间件</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/ " style="margin-left:75px";>
				  
		          <span>分布式</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa fa-fw fa-desktop"></i>
			
			计算机核心
			<span class="m-icon"><i class="fa fa-chevron-right"></i></span>
		</a>
            <ul  >
              
                <li>   
				
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ " style="margin-left:75px";>
				  
		          <span>数据结构</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/leetcode%E5%88%B7%E9%A2%98/ " style="margin-left:75px";>
				  
		          <span>leetcode刷题</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ " style="margin-left:75px";>
				  
		          <span>计算机网络</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E7%AE%97%E6%B3%95/ " style="margin-left:75px";>
				  
		          <span>算法</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/" class="waves-effect waves-light">
			
			    <i class="fa fa-fw fa-adjust"></i>
			
			学习资源
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa fa-fw fa-envelope"></i>
			
			留言
		</a>
          
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

        



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/5.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        MyBatis 源码分析 – 映射文件解析过程
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }

    /* 自定义mycard：欧阳思海 */

    #my-card {
        /* position: relative; */
        width: 310px;
        height: 300px;
        /* max-height: 330px; */
        margin-bottom: 15px;
        margin-top: 15px;
        /* text-align: center; */
        border: 0;
        border-radius: 3px;
        color: rgba(0, 0, 0, .87);
        background: #fff 50%;
        background-image: none;
        background-size: auto;
        background-size: cover;
        box-shadow: 0 15px 35px rgba(50, 50, 93, .1), 0 5px 15px rgba(0, 0, 0, .07);
    }

    /* .widget {
        line-height: 1.6em;
        word-wrap: break-word;
        font-size: 0.9em;
        padding-top: 15px;
        padding-left: -45px;
    } */
</style>




<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- shw2018 洪卫  modify 2019.08.15-->

<!-- 代码块修改的代码开始 -->
<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFunction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

<!-- 代码块修改代码结束 -->


<!-- 文章内容详情 -->
<div id="container">
    <div id="artDetail">
        <div class="card">
            <div class="card-content article-info">
                <div class="row tag-cate">
                    <div class="col s7">
                        
                        <div class="article-tag">
                            <!--我修改的地方：欧阳思海-->
                            
                            <a href="/tags/mybatis-mybatis%E6%BA%90%E7%A0%81/" target="_blank">
                                <span class="chip bg-color">mybatis,mybatis源码</span>
                            </a>
                            
                        </div>
                        
                    </div>
                    <div class="col s5 right-align">
                        
                        <div class="post-cate">
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/mybatis%E6%BA%90%E7%A0%81/" class="post-category" target="_blank">
                                mybatis源码
                            </a>
                            
                        </div>
                        
                    </div>
                </div>

                <div class="post-info">
                    <div class="post-date info-break-policy">
                        <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                        2021-04-05
                    </div>

                    <div class="post-author info-break-policy">
                        <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                        
                        欧阳思海
                        
                    </div>

                    
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        21.7k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        97 分
                    </div>
                    
                    

                    
                    <span id="busuanzi_container_site_pv" style='display:none'></span>
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>

                    

                </div>
            </div>
            <hr class="clearfix">
            <div class="card-content article-card-content">
                <!-- 欧阳思海，modify，2020.05.01-->
<!-- 文章详情详情页面的头部广告位置信息 -->
<div id="post-head-panel">
    
    <a href="https://github.com/OUYANGSIHAI/JavaInterview" style="font-size: 18px;" target="_blank">
        <img src="/icons/hot.gif">
        本人花费半年的时间总结的《Java面试指南》已拿腾讯等大厂offer，已开源在github ，欢迎star！
    </a>
    
    
</div>
<br />



<blockquote>
    
            <p>本文GitHub <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">https://github.com/OUYANGSIHAI/JavaInterview</a> 已收录，这是我花了6个月总结的<b>一线大厂Java面试</b>总结，本人已拿大厂offer，欢迎star</p>
    
    <p>原文链接：blog.ouyangsihai.cn &gt;&gt; <a href="/mybatis-yuan-ma-fen-xi-ying-she-wen-jian-jie-xi-guo-cheng.html" target="_blank">MyBatis 源码分析 – 映射文件解析过程</a></p>
</blockquote>
                <div id="articleContent">
                    <h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h2><p>在上一篇文章中，我详细分析了 MyBatis 配置文件的解析过程。由于上一篇文章的篇幅比较大，加之映射文件解析过程也比较复杂的原因。所以我将映射文件解析过程的分析内容从上一篇文章中抽取出来，独立成文，于是就有了本篇文章。在本篇文章中，我将分析映射文件中出现的一些及节点，比如 cache，cache-ref，resultMap, select | insert | update | delete 等。除了分析常规的 XML 解析过程外，我还会向大家介绍 Mapper 接口的绑定过程等。综上所述，本篇文章内容会比较丰富，如果大家对此感兴趣，不妨花点时间读一读，会有新的收获。当然，本篇文章通篇是关于源码分析的，所以阅读本文需要大家对 MyBatis 有一定的了解。如果大家对 MyBatis 还不是很了解，建议阅读一下 MyBatis 的。</p>
<p>其他的就不多说了，下面开始我们的 MyBatis 源码之旅。</p>
<h2 id="2-映射文件解析过程分析"><a href="#2-映射文件解析过程分析" class="headerlink" title="2.映射文件解析过程分析"></a>2.映射文件解析过程分析</h2><p>我在前面说过，映射文件的解析过程是 MyBatis 配置文件解析过程的一部分。MyBatis 的配置文件由 XMLConfigBuilder 的 parseConfiguration 进行解析，该方法依次解析了 properties、settings、typeAliases 等节点。至于 mappers 节点，parseConfiguration 则是在方法的结尾对其进行了解析。该部分的解析逻辑封装在 mapperElement 方法中，下面来看一下。</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738394041424344</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- XMLConfigBuilderprivate void mapperElement(XNode parent) throws Exception {    if (parent != null) {        for (XNode child : parent.getChildren()) {            if ("package".equals(child.getName())) {                // 获取 package 节点中的 name 属性                String mapperPackage = child.getStringAttribute("name");                // 从指定包中查找 mapper 接口，并根据 mapper 接口解析映射配置                configuration.addMappers(mapperPackage);            } else {                // 获取 resource/url/class 等属性                String resource = child.getStringAttribute("resource");                String url = child.getStringAttribute("url");                String mapperClass = child.getStringAttribute("class");                 // resource 不为空，且其他两者为空，则从指定路径中加载配置                if (resource != null && url == null && mapperClass == null) {                    ErrorContext.instance().resource(resource);                    InputStream inputStream = Resources.getResourceAsStream(resource);                    XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments());                    // 解析映射文件                    mapperParser.parse();                 // url 不为空，且其他两者为空，则通过 url 加载配置                } else if (resource == null && url != null && mapperClass == null) {                    ErrorContext.instance().resource(url);                    InputStream inputStream = Resources.getUrlAsStream(url);                    XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, url, configuration.getSqlFragments());                    // 解析映射文件                    mapperParser.parse();                 // mapperClass 不为空，且其他两者为空，则通过 mapperClass 解析映射配置                } else if (resource == null && url == null && mapperClass != null) {                    Class? mapperInterface = Resources.classForName(mapperClass);                    configuration.addMapper(mapperInterface);                 // 以上条件不满足，则抛出异常                } else {                    throw new BuilderException("A mapper element may only specify a url, resource or class, but not more than one.");                }            }        }    }}</pre></td>

<p>&#x2F;&#x2F; -☆- XMLConfigBuilder<br>private void mapperElement(XNode parent) throws Exception {<br>    if (parent !&#x3D; null) {<br>        for (XNode child : parent.getChildren()) {<br>            if (“package”.equals(child.getName())) {<br>                &#x2F;&#x2F; 获取 package 节点中的 name 属性<br>                String mapperPackage &#x3D; child.getStringAttribute(“name”);<br>                &#x2F;&#x2F; 从指定包中查找 mapper 接口，并根据 mapper 接口解析映射配置<br>                configuration.addMappers(mapperPackage);<br>            } else {<br>                &#x2F;&#x2F; 获取 resource&#x2F;url&#x2F;class 等属性<br>                String resource &#x3D; child.getStringAttribute(“resource”);<br>                String url &#x3D; child.getStringAttribute(“url”);<br>                String mapperClass &#x3D; child.getStringAttribute(“class”);</p>
<pre class="line-numbers language-java"><code class="language-java">
            <span class="token comment" spellcheck="true">// resource 不为空，且其他两者为空，则从指定路径中加载配置</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> url <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ErrorContext<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                InputStream inputStream <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                XMLMapperBuilder mapperParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperBuilder</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 解析映射文件</span>
                mapperParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// url 不为空，且其他两者为空，则通过 url 加载配置</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> url <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ErrorContext<span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                InputStream inputStream <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">getUrlAsStream</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                XMLMapperBuilder mapperParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperBuilder</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> url<span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 解析映射文件</span>
                mapperParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// mapperClass 不为空，且其他两者为空，则通过 mapperClass 解析映射配置</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> url <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Class<span class="token operator">?</span> mapperInterface <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">classForName</span><span class="token punctuation">(</span>mapperClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                configuration<span class="token punctuation">.</span><span class="token function">addMapper</span><span class="token punctuation">(</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 以上条件不满足，则抛出异常</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"A mapper element may only specify a url, resource or class, but not more than one."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面的代码比较简单，主要逻辑是遍历 mappers 的子节点，并根据节点属性值判断通过什么方式加载映射文件或映射信息。这里，我把配置在注解中的内容称为<code class="java">
映射信息</code>，以 XML 为载体的配置称为<code class="java">
映射文件</code>。在 MyBatis 中，共有四种加载映射文件或信息的方式。第一种是从文件系统中加载映射文件；第二种是通过 URL 的方式加载和解析映射文件；第三种是通过 mapper 接口加载映射信息，映射信息可以配置在注解中，也可以配置在映射文件中。最后一种是通过包扫描的方式获取到某个包下的所有类，并使用第三种方式为每个类解析映射信息。</p>
<p>以上简单介绍了 MyBatis 加载映射文件或信息的几种方式。需要注意的是，在 MyBatis 中，通过注解配置映射信息的方式是有一定局限性的，这一点 MyBatis 官方文档中描述的比较清楚。这里引用一下：</p>
<blockquote>
<p>因为最初设计时，MyBatis 是一个 XML 驱动的框架。配置信息是基于 XML 的，而且映射语句也是定义在 XML 中的。而到了 MyBatis 3，就有新选择了。MyBatis 3 构建在全面且强大的基于 Java 语言的配置 API 之上。这个配置 API 是基于 XML 的 MyBatis 配置的基础，也是新的基于注解配置的基础。注解提供了一种简单的方式来实现<strong>简单映射语句</strong>，而不会引入大量的开销。</p>
</blockquote>
<blockquote>
<p><strong>注意：</strong> 不幸的是，<strong>Java 注解的的表达力和灵活性十分有限</strong>。尽管很多时间都花在调查、设计和试验上，<strong>最强大的 MyBatis 映射并不能用注解来构建</strong>——并不是在开玩笑，的确是这样。</p>
</blockquote>
<p>如上所示，重点语句我用黑体标注了出来。限于 Java 注解的表达力和灵活性，通过注解的方式并不能完全发挥 MyBatis 的能力。所以，对于一些较为复杂的配置信息，我们还是应该通过 XML 的方式进行配置。正因此，在接下的章节中，我会重点分析基于 XML 的映射文件的解析过程。如果能弄懂此种配置方式的解析过程，那么基于注解的解析过程也不在话下。</p>
<p>下面开始分析映射文件的解析过程，在展开分析之前，先来看一下映射文件解析入口。如下：</p>
<td class="line_numbers"><pre>1234567891011121314151617</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- XMLMapperBuilderpublic void parse() {    // 检测映射文件是否已经被解析过    if (!configuration.isResourceLoaded(resource)) {        // 解析 mapper 节点        configurationElement(parser.evalNode("/mapper"));        // 添加资源路径到“已解析资源集合”中        configuration.addLoadedResource(resource);        // 通过命名空间绑定 Mapper 接口        bindMapperForNamespace();    }     // 处理未完成解析的节点    parsePendingResultMaps();    parsePendingCacheRefs();    parsePendingStatements();}</pre></td>

<p>&#x2F;&#x2F; -☆- XMLMapperBuilder<br>public void parse() {<br>    &#x2F;&#x2F; 检测映射文件是否已经被解析过<br>    if (!configuration.isResourceLoaded(resource)) {<br>        &#x2F;&#x2F; 解析 mapper 节点<br>        configurationElement(parser.evalNode(“&#x2F;mapper”));<br>        &#x2F;&#x2F; 添加资源路径到“已解析资源集合”中<br>        configuration.addLoadedResource(resource);<br>        &#x2F;&#x2F; 通过命名空间绑定 Mapper 接口<br>        bindMapperForNamespace();<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 处理未完成解析的节点</span>
<span class="token function">parsePendingResultMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">parsePendingCacheRefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">parsePendingStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>如上，映射文件解析入口逻辑包含三个核心操作，分别如下：</p>
<ol>
<li>解析 mapper 节点</li>
<li>通过命名空间绑定 Mapper 接口</li>
<li>处理未完成解析的节点</li>
</ol>
<p>这三个操作对应的逻辑，我将会在随后的章节中依次进行分析。下面，先来分析第一个操作对应的逻辑。</p>
<h3 id="2-1-解析映射文件"><a href="#2-1-解析映射文件" class="headerlink" title="2.1 解析映射文件"></a>2.1 解析映射文件</h3><p>在 MyBatis 映射文件中，可以配置多种节点。比如 cache，resultMap，sql 以及 select | insert | update | delete 等。下面我们来看一个映射文件配置示例。</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">mapper namespace="xyz.coolblog.dao.AuthorDao"     cache/     resultMap id="authorResult" type="Author"        id property="id" column="id"/        result property="name" column="name"/        !-- ... --    /resultMap     sql id="table"        author    /sql     select id="findOne" resultMap="authorResult"        SELECT            id, name, age, sex, email        FROM            include refid="table"/        WHERE            id = #{id}    /select     !-- insert|update|delete/ --/mapper</pre></td>

<p>mapper namespace&#x3D;”xyz.coolblog.dao.AuthorDao”</p>
<pre class="line-numbers language-java"><code class="language-java">
cache<span class="token operator">/</span>

resultMap id<span class="token operator">=</span><span class="token string">"authorResult"</span> type<span class="token operator">=</span><span class="token string">"Author"</span>
    id property<span class="token operator">=</span><span class="token string">"id"</span> column<span class="token operator">=</span><span class="token string">"id"</span><span class="token operator">/</span>
    result property<span class="token operator">=</span><span class="token string">"name"</span> column<span class="token operator">=</span><span class="token string">"name"</span><span class="token operator">/</span>
    <span class="token operator">!</span><span class="token operator">--</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">--</span>
<span class="token operator">/</span>resultMap

sql id<span class="token operator">=</span><span class="token string">"table"</span>
    author
<span class="token operator">/</span>sql

select id<span class="token operator">=</span><span class="token string">"findOne"</span> resultMap<span class="token operator">=</span><span class="token string">"authorResult"</span>
    SELECT
        id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> sex<span class="token punctuation">,</span> email
    FROM
        include refid<span class="token operator">=</span><span class="token string">"table"</span><span class="token operator">/</span>
    WHERE
        id <span class="token operator">=</span> #<span class="token punctuation">{</span>id<span class="token punctuation">}</span>
<span class="token operator">/</span>select

<span class="token operator">!</span><span class="token operator">--</span> insert<span class="token operator">|</span>update<span class="token operator">|</span>delete<span class="token operator">/</span> <span class="token operator">--</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>&#x2F;mapper</p>
<p>上面是一个比较简单的映射文件，还有一些的节点没有出现在上面。以上每种配置中的每种节点的解析逻辑都封装在了相应的方法中，这些方法由 XMLMapperBuilder 类的 configurationElement 方法统一调用。该方法的逻辑如下：</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void configurationElement(XNode context) {    try {        // 获取 mapper 命名空间        String namespace = context.getStringAttribute("namespace");        if (namespace == null || namespace.equals("")) {            throw new BuilderException("Mapper's namespace cannot be empty");        }         // 设置命名空间到 builderAssistant 中        builderAssistant.setCurrentNamespace(namespace);         // 解析 cache-ref 节点        cacheRefElement(context.evalNode("cache-ref"));         // 解析 cache 节点        cacheElement(context.evalNode("cache"));         // 已废弃配置，这里不做分析        parameterMapElement(context.evalNodes("/mapper/parameterMap"));         // 解析 resultMap 节点        resultMapElements(context.evalNodes("/mapper/resultMap"));         // 解析 sql 节点        sqlElement(context.evalNodes("/mapper/sql"));         // 解析 select、...、delete 等节点        buildStatementFromContext(context.evalNodes("select|insert|update|delete"));    } catch (Exception e) {        throw new BuilderException("Error parsing Mapper XML. The XML location is '" + resource + "'. Cause: " + e, e);    }}</pre></td>

<p>private void configurationElement(XNode context) {<br>    try {<br>        &#x2F;&#x2F; 获取 mapper 命名空间<br>        String namespace &#x3D; context.getStringAttribute(“namespace”);<br>        if (namespace &#x3D;&#x3D; null || namespace.equals(“”)) {<br>            throw new BuilderException(“Mapper’s namespace cannot be empty”);<br>        }</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// 设置命名空间到 builderAssistant 中</span>
    builderAssistant<span class="token punctuation">.</span><span class="token function">setCurrentNamespace</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 cache-ref 节点</span>
    <span class="token function">cacheRefElement</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"cache-ref"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 cache 节点</span>
    <span class="token function">cacheElement</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"cache"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 已废弃配置，这里不做分析</span>
    <span class="token function">parameterMapElement</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token string">"/mapper/parameterMap"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 resultMap 节点</span>
    <span class="token function">resultMapElements</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token string">"/mapper/resultMap"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 sql 节点</span>
    <span class="token function">sqlElement</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token string">"/mapper/sql"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 解析 select、...、delete 等节点</span>
    <span class="token function">buildStatementFromContext</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">evalNodes</span><span class="token punctuation">(</span><span class="token string">"select|insert|update|delete"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Error parsing Mapper XML. The XML location is '"</span> <span class="token operator">+</span> resource <span class="token operator">+</span> <span class="token string">"'. Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面代码的执行流程清晰明了。在阅读源码时，我们可以按部就班的分析每个方法调用即可。不过在写文章进行叙述时，需要做一些调整。下面我将会先分析 cache 节点的解析过程，然后再分析 cache-ref 节点，之后会按照顺序分析其他节点的解析过程。接下来，我们来看看 cache 节点的解析过程。</p>
<h4 id="2-1-1-解析-cache-节点"><a href="#2-1-1-解析-cache-节点" class="headerlink" title="2.1.1 解析 cache 节点"></a>2.1.1 解析 cache 节点</h4><p>MyBatis 提供了一、二级缓存，其中一级缓存是 SqlSession 级别的，默认为开启状态。二级缓存配置在映射文件中，使用者需要显示配置才能开启。如果没有特殊要求，二级缓存的配置很容易。如下：</p>
<td class="line_numbers"><pre>1</pre></td><td class="code"><pre class="null" style="font-family:monospace;">cache/</pre></td>

<p>cache&#x2F;</p>
<p>如果我们想修改缓存的一些属性，可以像下面这样配置。</p>
<td class="line_numbers"><pre>12345</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">cache  eviction="FIFO"  flushInterval="60000"  size="512"  readOnly="true"/</pre></td>

<p>cache<br>  eviction&#x3D;”FIFO”<br>  flushInterval&#x3D;”60000”<br>  size&#x3D;”512”<br>  readOnly&#x3D;”true”&#x2F;</p>
<p>根据上面的配置创建出的缓存有以下特点：</p>
<ol>
<li>按先进先出的策略淘汰缓存项</li>
<li>缓存的容量为 512 个对象引用</li>
<li>缓存每隔60秒刷新一次</li>
<li>缓存返回的对象是写安全的，即在外部修改对象不会影响到缓存内部存储对象</li>
</ol>
<p>除了上面两种配置方式，我们还可以给 MyBatis 配置第三方缓存或者自己实现的缓存等。比如，我们将 Ehcache 缓存整合到 MyBatis 中，可以这样配置。</p>
<td class="line_numbers"><pre>1234567</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">cache type="org.mybatis.caches.ehcache.EhcacheCache"/    property name="timeToIdleSeconds" value="3600"/    property name="timeToLiveSeconds" value="3600"/    property name="maxEntriesLocalHeap" value="1000"/    property name="maxEntriesLocalDisk" value="10000000"/    property name="memoryStoreEvictionPolicy" value="LRU"//cache</pre></td>

<p>cache type&#x3D;”org.mybatis.caches.ehcache.EhcacheCache”&#x2F;<br>    property name&#x3D;”timeToIdleSeconds” value&#x3D;”3600”&#x2F;<br>    property name&#x3D;”timeToLiveSeconds” value&#x3D;”3600”&#x2F;<br>    property name&#x3D;”maxEntriesLocalHeap” value&#x3D;”1000”&#x2F;<br>    property name&#x3D;”maxEntriesLocalDisk” value&#x3D;”10000000”&#x2F;<br>    property name&#x3D;”memoryStoreEvictionPolicy” value&#x3D;”LRU”&#x2F;<br>&#x2F;cache</p>
<p>以上简单介绍了几种缓存配置方式，关于 MyBatis 缓存更多的知识，后面我会独立成文进行分析，这里就不深入说明了。下面我们来分析一下缓存配置的解析逻辑，如下：</p>
<td class="line_numbers"><pre>12345678910111213141516171819</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void cacheElement(XNode context) throws Exception {    if (context != null) {        // 获取各种属性        String type = context.getStringAttribute("type", "PERPETUAL");        Class? extends Cache typeClass = typeAliasRegistry.resolveAlias(type);        String eviction = context.getStringAttribute("eviction", "LRU");        Class? extends Cache evictionClass = typeAliasRegistry.resolveAlias(eviction);        Long flushInterval = context.getLongAttribute("flushInterval");        Integer size = context.getIntAttribute("size");        boolean readWrite = !context.getBooleanAttribute("readOnly", false);        boolean blocking = context.getBooleanAttribute("blocking", false);         // 获取子节点配置        Properties props = context.getChildrenAsProperties();         // 构建缓存对象        builderAssistant.useNewCache(typeClass, evictionClass, flushInterval, size, readWrite, blocking, props);    }}</pre></td>

<p>private void cacheElement(XNode context) throws Exception {<br>    if (context !&#x3D; null) {<br>        &#x2F;&#x2F; 获取各种属性<br>        String type &#x3D; context.getStringAttribute(“type”, “PERPETUAL”);<br>        Class? extends Cache typeClass &#x3D; typeAliasRegistry.resolveAlias(type);<br>        String eviction &#x3D; context.getStringAttribute(“eviction”, “LRU”);<br>        Class? extends Cache evictionClass &#x3D; typeAliasRegistry.resolveAlias(eviction);<br>        Long flushInterval &#x3D; context.getLongAttribute(“flushInterval”);<br>        Integer size &#x3D; context.getIntAttribute(“size”);<br>        boolean readWrite &#x3D; !context.getBooleanAttribute(“readOnly”, false);<br>        boolean blocking &#x3D; context.getBooleanAttribute(“blocking”, false);</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// 获取子节点配置</span>
    Properties props <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getChildrenAsProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 构建缓存对象</span>
    builderAssistant<span class="token punctuation">.</span><span class="token function">useNewCache</span><span class="token punctuation">(</span>typeClass<span class="token punctuation">,</span> evictionClass<span class="token punctuation">,</span> flushInterval<span class="token punctuation">,</span> size<span class="token punctuation">,</span> readWrite<span class="token punctuation">,</span> blocking<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面代码中，大段代码用来解析 cache 节点的属性和子节点，这些代码没什么好说的。缓存的构建逻辑封装在 BuilderAssistant 类的 useNewCache 方法中，下面我们来看一下该方法的逻辑。</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- MapperBuilderAssistantpublic Cache useNewCache(Class? extends Cache typeClass,    Class? extends Cache evictionClass,Long flushInterval,    Integer size,boolean readWrite,boolean blocking,Properties props) {     // 使用建造模式构建缓存实例    Cache cache = new CacheBuilder(currentNamespace)        .implementation(valueOrDefault(typeClass, PerpetualCache.class))        .addDecorator(valueOrDefault(evictionClass, LruCache.class))        .clearInterval(flushInterval)        .size(size)        .readWrite(readWrite)        .blocking(blocking)        .properties(props)        .build();     // 添加缓存到 Configuration 对象中    configuration.addCache(cache);     // 设置 currentCache 遍历，即当前使用的缓存    currentCache = cache;    return cache;}</pre></td>

<p>&#x2F;&#x2F; -☆- MapperBuilderAssistant<br>public Cache useNewCache(Class? extends Cache typeClass,<br>    Class? extends Cache evictionClass,Long flushInterval,<br>    Integer size,boolean readWrite,boolean blocking,Properties props) {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 使用建造模式构建缓存实例</span>
Cache cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheBuilder</span><span class="token punctuation">(</span>currentNamespace<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">implementation</span><span class="token punctuation">(</span><span class="token function">valueOrDefault</span><span class="token punctuation">(</span>typeClass<span class="token punctuation">,</span> PerpetualCache<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addDecorator</span><span class="token punctuation">(</span><span class="token function">valueOrDefault</span><span class="token punctuation">(</span>evictionClass<span class="token punctuation">,</span> LruCache<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">clearInterval</span><span class="token punctuation">(</span>flushInterval<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">readWrite</span><span class="token punctuation">(</span>readWrite<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">blocking</span><span class="token punctuation">(</span>blocking<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">properties</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 添加缓存到 Configuration 对象中</span>
configuration<span class="token punctuation">.</span><span class="token function">addCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 设置 currentCache 遍历，即当前使用的缓存</span>
currentCache <span class="token operator">=</span> cache<span class="token punctuation">;</span>
<span class="token keyword">return</span> cache<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面使用了建造模式构建 Cache 实例，Cache 实例的构建过程略为复杂，我们跟下去看看。</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- CacheBuilderpublic Cache build() {    // 设置默认的缓存类型（PerpetualCache）和缓存装饰器（LruCache）    setDefaultImplementations();     // 通过反射创建缓存    Cache cache = newBaseCacheInstance(implementation, id);    setCacheProperties(cache);    // 仅对内置缓存 PerpetualCache 应用装饰器    if (PerpetualCache.class.equals(cache.getClass())) {        // 遍历装饰器集合，应用装饰器        for (Class? extends Cache decorator : decorators) {            // 通过反射创建装饰器实例            cache = newCacheDecoratorInstance(decorator, cache);            // 设置属性值到缓存实例中            setCacheProperties(cache);        }        // 应用标准的装饰器，比如 LoggingCache、SynchronizedCache        cache = setStandardDecorators(cache);    } else if (!LoggingCache.class.isAssignableFrom(cache.getClass())) {        // 应用具有日志功能的缓存装饰器        cache = new LoggingCache(cache);    }    return cache;}</pre></td>

<p>&#x2F;&#x2F; -☆- CacheBuilder<br>public Cache build() {<br>    &#x2F;&#x2F; 设置默认的缓存类型（PerpetualCache）和缓存装饰器（LruCache）<br>    setDefaultImplementations();</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 通过反射创建缓存</span>
Cache cache <span class="token operator">=</span> <span class="token function">newBaseCacheInstance</span><span class="token punctuation">(</span>implementation<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setCacheProperties</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 仅对内置缓存 PerpetualCache 应用装饰器</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>PerpetualCache<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 遍历装饰器集合，应用装饰器</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Class<span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Cache</span> decorator <span class="token operator">:</span> decorators<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 通过反射创建装饰器实例</span>
        cache <span class="token operator">=</span> <span class="token function">newCacheDecoratorInstance</span><span class="token punctuation">(</span>decorator<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置属性值到缓存实例中</span>
        <span class="token function">setCacheProperties</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 应用标准的装饰器，比如 LoggingCache、SynchronizedCache</span>
    cache <span class="token operator">=</span> <span class="token function">setStandardDecorators</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>LoggingCache<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 应用具有日志功能的缓存装饰器</span>
    cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggingCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> cache<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面的构建过程流程较为复杂，这里总结一下。如下：</p>
<ol>
<li>设置默认的缓存类型及装饰器<li>应用装饰器到 PerpetualCache 对象上
<ul></li>
<li>遍历装饰器类型集合，并通过反射创建装饰器实例</li>
<li>将属性设置到实例中</ul>
</li></li>
<li>应用一些标准的装饰器</li>
<li>对非 LoggingCache 类型的缓存应用 LoggingCache 装饰器</li>
</ol>
<p>在以上4个步骤中，最后一步的逻辑很简单，无需多说。下面按顺序分析前3个步骤对应的逻辑，如下：</p>
<td class="line_numbers"><pre>12345678910</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void setDefaultImplementations() {    if (implementation == null) {        // 设置默认的缓存实现类        implementation = PerpetualCache.class;        if (decorators.isEmpty()) {            // 添加 LruCache 装饰器            decorators.add(LruCache.class);        }    }}</pre></td>

<p>private void setDefaultImplementations() {<br>    if (implementation &#x3D;&#x3D; null) {<br>        &#x2F;&#x2F; 设置默认的缓存实现类<br>        implementation &#x3D; PerpetualCache.class;<br>        if (decorators.isEmpty()) {<br>            &#x2F;&#x2F; 添加 LruCache 装饰器<br>            decorators.add(LruCache.class);<br>        }<br>    }<br>}</p>
<p>以上逻辑比较简单，主要做的事情是在 implementation 为空的情况下，为它设置一个默认值。如果大家仔细看前面的方法，会发现 MyBatis 做了不少判空的操作。比如：</p>
<td class="line_numbers"><pre>12345678910</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// 判空操作1，若用户未设置 cache 节点的 type 和 eviction 属性，这里设置默认值 PERPETUALString type = context.getStringAttribute("type", "PERPETUAL");String eviction = context.getStringAttribute("eviction", "LRU"); // 判空操作2，若 typeClass 或 evictionClass 为空，valueOrDefault 方法会为它们设置默认值Cache cache = new CacheBuilder(currentNamespace)            .implementation(valueOrDefault(typeClass, PerpetualCache.class))            .addDecorator(valueOrDefault(evictionClass, LruCache.class))            // 省略部分代码            .build();</pre></td>

<p>&#x2F;&#x2F; 判空操作1，若用户未设置 cache 节点的 type 和 eviction 属性，这里设置默认值 PERPETUAL<br>String type &#x3D; context.getStringAttribute(“type”, “PERPETUAL”);<br>String eviction &#x3D; context.getStringAttribute(“eviction”, “LRU”);</p>
<p>&#x2F;&#x2F; 判空操作2，若 typeClass 或 evictionClass 为空，valueOrDefault 方法会为它们设置默认值<br>Cache cache &#x3D; new CacheBuilder(currentNamespace)<br>            .implementation(valueOrDefault(typeClass, PerpetualCache.class))<br>            .addDecorator(valueOrDefault(evictionClass, LruCache.class))<br>            &#x2F;&#x2F; 省略部分代码<br>            .build();</p>
<p>既然前面已经做了两次判空操作，implementation 不可能为空，那么 setDefaultImplementations 方法似乎没有存在的必要了。其实不然，如果有人不按套路写代码。比如：</p>
<td class="line_numbers"><pre>123</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">Cache cache = new CacheBuilder(currentNamespace)            // 忘记设置 implementation            .build();</pre></td>

<p>Cache cache &#x3D; new CacheBuilder(currentNamespace)<br>            &#x2F;&#x2F; 忘记设置 implementation<br>            .build();</p>
<p>这里忘记设置 implementation，或人为的将 implementation 设为空。如果不对 implementation 进行判空，会导致 build 方法在构建实例时触发空指针异常，对于框架来说，出现空指针异常是很尴尬的，这是一个低级错误。这里以及之前做了这么多判空，就是为了避免出现空指针的情况，以提高框架的健壮性。好了，关于 setDefaultImplementations 方法的分析先到这，继续往下分析。</p>
<p>我们在使用 MyBatis 内置缓存时，一般不用为它们配置自定义属性。但使用第三方缓存时，则应按需进行配置。比如前面演示 MyBatis 整合 Ehcache 时，就为 Ehcache 配置了一些必要的属性。下面我们来看一下这部分配置是如何设置到缓存实例中的。</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void setCacheProperties(Cache cache) {    if (properties != null) {        /*         * 为缓存实例生成一个“元信息”实例，forObject 方法调用层次比较深，但最终调用了          * MetaClass 的 forClass 方法。关于 MetaClass 的源码，我在上一篇文章中已经         * 详细分析过了，这里不再赘述。         */        MetaObject metaCache = SystemMetaObject.forObject(cache);        for (Map.EntryObject, Object entry : properties.entrySet()) {            String name = (String) entry.getKey();            String value = (String) entry.getValue();            if (metaCache.hasSetter(name)) {                // 获取 setter 方法的参数类型                Class? type = metaCache.getSetterType(name);                /*                 * 根据参数类型对属性值进行转换，并将转换后的值                 * 通过 setter 方法设置到 Cache 实例中                 */                if (String.class == type) {                    metaCache.setValue(name, value);                } else if (int.class == type || Integer.class == type) {                    /*                     * 此处及以下分支包含两个步骤：                     *   1.类型转换 → Integer.valueOf(value)                     *   2.将转换后的值设置到缓存实例中 → metaCache.setValue(name, value)                     */                     metaCache.setValue(name, Integer.valueOf(value));                } else if (long.class == type || Long.class == type) {                    metaCache.setValue(name, Long.valueOf(value));                }                 else if (short.class == type || Short.class == type) {...}                 else if (byte.class == type || Byte.class == type) {...}                 else if (float.class == type || Float.class == type) {...}                 else if (boolean.class == type || Boolean.class == type) {...}                 else if (double.class == type || Double.class == type) {...}                 else {                    throw new CacheException("Unsupported property type for cache: '" + name + "' of type " + type);                }            }        }    }     // 如果缓存类实现了 InitializingObject 接口，则调用 initialize 方法执行初始化逻辑    if (InitializingObject.class.isAssignableFrom(cache.getClass())) {        try {            ((InitializingObject) cache).initialize();        } catch (Exception e) {            throw new CacheException("Failed cache initialization for '" +                cache.getId() + "' on '" + cache.getClass().getName() + "'", e);        }    }}</pre></td>

<p>private void setCacheProperties(Cache cache) {<br>    if (properties !&#x3D; null) {<br>        &#x2F;*<br>         * 为缓存实例生成一个“元信息”实例，forObject 方法调用层次比较深，但最终调用了<br>         * MetaClass 的 forClass 方法。关于 MetaClass 的源码，我在上一篇文章中已经<br>         * 详细分析过了，这里不再赘述。<br>         <em>&#x2F;<br>        MetaObject metaCache &#x3D; SystemMetaObject.forObject(cache);<br>        for (Map.EntryObject, Object entry : properties.entrySet()) {<br>            String name &#x3D; (String) entry.getKey();<br>            String value &#x3D; (String) entry.getValue();<br>            if (metaCache.hasSetter(name)) {<br>                &#x2F;&#x2F; 获取 setter 方法的参数类型<br>                Class? type &#x3D; metaCache.getSetterType(name);<br>                &#x2F;</em><br>                 * 根据参数类型对属性值进行转换，并将转换后的值<br>                 * 通过 setter 方法设置到 Cache 实例中<br>                 <em>&#x2F;<br>                if (String.class &#x3D;&#x3D; type) {<br>                    metaCache.setValue(name, value);<br>                } else if (int.class &#x3D;&#x3D; type || Integer.class &#x3D;&#x3D; type) {<br>                    &#x2F;</em><br>                     * 此处及以下分支包含两个步骤：<br>                     *   1.类型转换 → Integer.valueOf(value)<br>                     *   2.将转换后的值设置到缓存实例中 → metaCache.setValue(name, value)<br>                     *&#x2F;<br>                    metaCache.setValue(name, Integer.valueOf(value));<br>                } else if (long.class &#x3D;&#x3D; type || Long.class &#x3D;&#x3D; type) {<br>                    metaCache.setValue(name, Long.valueOf(value));<br>                }<br>                else if (short.class &#x3D;&#x3D; type || Short.class &#x3D;&#x3D; type) {…}<br>                else if (byte.class &#x3D;&#x3D; type || Byte.class &#x3D;&#x3D; type) {…}<br>                else if (float.class &#x3D;&#x3D; type || Float.class &#x3D;&#x3D; type) {…}<br>                else if (boolean.class &#x3D;&#x3D; type || Boolean.class &#x3D;&#x3D; type) {…}<br>                else if (double.class &#x3D;&#x3D; type || Double.class &#x3D;&#x3D; type) {…}<br>                else {<br>                    throw new CacheException(“Unsupported property type for cache: ‘“ + name + “‘ of type “ + type);<br>                }<br>            }<br>        }<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 如果缓存类实现了 InitializingObject 接口，则调用 initialize 方法执行初始化逻辑</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>InitializingObject<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>InitializingObject<span class="token punctuation">)</span> cache<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheException</span><span class="token punctuation">(</span><span class="token string">"Failed cache initialization for '"</span> <span class="token operator">+</span>
            cache<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"' on '"</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面的大段代码用于对属性值进行类型转换，和设置转换后的值到 Cache 实例中。关于上面代码中出现的 MetaObject，大家可以自己尝试分析一下。最后，我们来看一下设置标准装饰器的过程。如下：</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private Cache setStandardDecorators(Cache cache) {    try {        // 创建“元信息”对象        MetaObject metaCache = SystemMetaObject.forObject(cache);        if (size != null && metaCache.hasSetter("size")) {            // 设置 size 属性，            metaCache.setValue("size", size);        }        if (clearInterval != null) {            // clearInterval 不为空，应用 ScheduledCache 装饰器            cache = new ScheduledCache(cache);            ((ScheduledCache) cache).setClearInterval(clearInterval);        }        if (readWrite) {            // readWrite 为 true，应用 SerializedCache 装饰器            cache = new SerializedCache(cache);        }        /*         * 应用 LoggingCache，SynchronizedCache 装饰器，         * 使原缓存具备打印日志和线程同步的能力         */        cache = new LoggingCache(cache);        cache = new SynchronizedCache(cache);        if (blocking) {            // blocking 为 true，应用 BlockingCache 装饰器            cache = new BlockingCache(cache);        }        return cache;    } catch (Exception e) {        throw new CacheException("Error building standard cache decorators.  Cause: " + e, e);    }}</pre></td>

<p>private Cache setStandardDecorators(Cache cache) {<br>    try {<br>        &#x2F;&#x2F; 创建“元信息”对象<br>        MetaObject metaCache &#x3D; SystemMetaObject.forObject(cache);<br>        if (size !&#x3D; null &amp;&amp; metaCache.hasSetter(“size”)) {<br>            &#x2F;&#x2F; 设置 size 属性，<br>            metaCache.setValue(“size”, size);<br>        }<br>        if (clearInterval !&#x3D; null) {<br>            &#x2F;&#x2F; clearInterval 不为空，应用 ScheduledCache 装饰器<br>            cache &#x3D; new ScheduledCache(cache);<br>            ((ScheduledCache) cache).setClearInterval(clearInterval);<br>        }<br>        if (readWrite) {<br>            &#x2F;&#x2F; readWrite 为 true，应用 SerializedCache 装饰器<br>            cache &#x3D; new SerializedCache(cache);<br>        }<br>        &#x2F;*<br>         * 应用 LoggingCache，SynchronizedCache 装饰器，<br>         * 使原缓存具备打印日志和线程同步的能力<br>         *&#x2F;<br>        cache &#x3D; new LoggingCache(cache);<br>        cache &#x3D; new SynchronizedCache(cache);<br>        if (blocking) {<br>            &#x2F;&#x2F; blocking 为 true，应用 BlockingCache 装饰器<br>            cache &#x3D; new BlockingCache(cache);<br>        }<br>        return cache;<br>    } catch (Exception e) {<br>        throw new CacheException(“Error building standard cache decorators.  Cause: “ + e, e);<br>    }<br>}</p>
<p>以上代码用于为缓存应用一些基本的装饰器，除了 LoggingCache 和 SynchronizedCache 这两个是必要的装饰器，其他的装饰器应用与否，取决于用户的配置。</p>
<p>到此，关于缓存的解析过程就分析完了。这一块的内容比较多，不过好在代码逻辑不是很复杂，耐心看还是可以弄懂的。其他的就不多说了，进入下一节的分析。</p>
<h4 id="2-1-2-解析-cache-ref-节点"><a href="#2-1-2-解析-cache-ref-节点" class="headerlink" title="2.1.2 解析 cache-ref 节点"></a>2.1.2 解析 cache-ref 节点</h4><p>在 MyBatis 中，二级缓存是可以共用的。这需要使用 cache-ref 节点配置参照缓存，比如像下面这样。</p>
<td class="line_numbers"><pre>12345678910</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">!-- Mapper1.xml --mapper namespace="xyz.coolblog.dao.Mapper1"    !-- Mapper1 与 Mapper2 共用一个二级缓存 --    cache-ref namespace="xyz.coolblog.dao.Mapper2"//mapper !-- Mapper2.xml --mapper namespace="xyz.coolblog.dao.Mapper2"    cache//mapper</pre></td>

<p>!– Mapper1.xml –<br>mapper namespace&#x3D;”xyz.coolblog.dao.Mapper1”<br>    !– Mapper1 与 Mapper2 共用一个二级缓存 –<br>    cache-ref namespace&#x3D;”xyz.coolblog.dao.Mapper2”&#x2F;<br>&#x2F;mapper</p>
<p>!– Mapper2.xml –<br>mapper namespace&#x3D;”xyz.coolblog.dao.Mapper2”<br>    cache&#x2F;<br>&#x2F;mapper</p>
<p>接下来，我们对照上面的配置分析 cache-ref 的解析过程。如下：</p>
<td class="line_numbers"><pre>1234567891011121314151617</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void cacheRefElement(XNode context) {    if (context != null) {        configuration.addCacheRef(builderAssistant.getCurrentNamespace(), context.getStringAttribute("namespace"));        // 创建 CacheRefResolver 实例        CacheRefResolver cacheRefResolver = new CacheRefResolver(builderAssistant, context.getStringAttribute("namespace"));        try {            // 解析参照缓存            cacheRefResolver.resolveCacheRef();        } catch (IncompleteElementException e) {            /*             * 这里对 IncompleteElementException 异常进行捕捉，并将 cacheRefResolver              * 存入到 Configuration 的 incompleteCacheRefs 集合中             */            configuration.addIncompleteCacheRef(cacheRefResolver);        }    }}</pre></td>

<p>private void cacheRefElement(XNode context) {<br>    if (context !&#x3D; null) {<br>        configuration.addCacheRef(builderAssistant.getCurrentNamespace(), context.getStringAttribute(“namespace”));<br>        &#x2F;&#x2F; 创建 CacheRefResolver 实例<br>        CacheRefResolver cacheRefResolver &#x3D; new CacheRefResolver(builderAssistant, context.getStringAttribute(“namespace”));<br>        try {<br>            &#x2F;&#x2F; 解析参照缓存<br>            cacheRefResolver.resolveCacheRef();<br>        } catch (IncompleteElementException e) {<br>            &#x2F;*<br>             * 这里对 IncompleteElementException 异常进行捕捉，并将 cacheRefResolver<br>             * 存入到 Configuration 的 incompleteCacheRefs 集合中<br>             *&#x2F;<br>            configuration.addIncompleteCacheRef(cacheRefResolver);<br>        }<br>    }<br>}</p>
<p>如上所示，cache-ref 节点的解析逻辑封装在了 CacheRefResolver 的 resolveCacheRef 方法中。下面，我们一起看一下这个方法的逻辑。</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- CacheRefResolverpublic Cache resolveCacheRef() {    // 调用 builderAssistant 的 useNewCache(namespace) 方法    return assistant.useCacheRef(cacheRefNamespace);} // -☆- MapperBuilderAssistantpublic Cache useCacheRef(String namespace) {    if (namespace == null) {        throw new BuilderException("cache-ref element requires a namespace attribute.");    }    try {        unresolvedCacheRef = true;        // 根据命名空间从全局配置对象（Configuration）中查找相应的缓存实例        Cache cache = configuration.getCache(namespace);         /*         * 若未查找到缓存实例，此处抛出异常。这里存在两种情况导致未查找到 cache 实例，         * 分别如下：         *     1.使用者在 cache-ref 中配置了一个不存在的命名空间，         *       导致无法找到 cache 实例         *     2.使用者所引用的缓存实例还未创建         */        if (cache == null) {            throw new IncompleteElementException("No cache for namespace '" + namespace + "' could be found.");        }         // 设置 cache 为当前使用缓存        currentCache = cache;        unresolvedCacheRef = false;        return cache;    } catch (IllegalArgumentException e) {        throw new IncompleteElementException("No cache for namespace '" + namespace + "' could be found.", e);    }}</pre></td>

<p>&#x2F;&#x2F; -☆- CacheRefResolver<br>public Cache resolveCacheRef() {<br>    &#x2F;&#x2F; 调用 builderAssistant 的 useNewCache(namespace) 方法<br>    return assistant.useCacheRef(cacheRefNamespace);<br>}</p>
<p>&#x2F;&#x2F; -☆- MapperBuilderAssistant<br>public Cache useCacheRef(String namespace) {<br>    if (namespace &#x3D;&#x3D; null) {<br>        throw new BuilderException(“cache-ref element requires a namespace attribute.”);<br>    }<br>    try {<br>        unresolvedCacheRef &#x3D; true;<br>        &#x2F;&#x2F; 根据命名空间从全局配置对象（Configuration）中查找相应的缓存实例<br>        Cache cache &#x3D; configuration.getCache(namespace);</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">/*
     * 若未查找到缓存实例，此处抛出异常。这里存在两种情况导致未查找到 cache 实例，
     * 分别如下：
     *     1.使用者在 cache-ref 中配置了一个不存在的命名空间，
     *       导致无法找到 cache 实例
     *     2.使用者所引用的缓存实例还未创建
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IncompleteElementException</span><span class="token punctuation">(</span><span class="token string">"No cache for namespace '"</span> <span class="token operator">+</span> namespace <span class="token operator">+</span> <span class="token string">"' could be found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment" spellcheck="true">// 设置 cache 为当前使用缓存</span>
    currentCache <span class="token operator">=</span> cache<span class="token punctuation">;</span>
    unresolvedCacheRef <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cache<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IncompleteElementException</span><span class="token punctuation">(</span><span class="token string">"No cache for namespace '"</span> <span class="token operator">+</span> namespace <span class="token operator">+</span> <span class="token string">"' could be found."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>以上是 cache-ref 的解析过程，逻辑并不复杂。不过这里要注意 cache 为空的情况，我在代码中已经注释了可能导致 cache 为空的两种情况。第一种情况比较好理解，第二种情况稍微复杂点，但是也不难理解。我会在 2.3 节进行解释说明，这里先不说。</p>
<p>到此，关于 cache-ref 节点的解析过程就分析完了。本节的内容不是很难理解，就不多说了。</p>
<h4 id="2-1-3-解析-resultMap-节点"><a href="#2-1-3-解析-resultMap-节点" class="headerlink" title="2.1.3 解析 resultMap 节点"></a>2.1.3 解析 resultMap 节点</h4><p>resultMap 是 MyBatis 框架中常用的特性，主要用于映射结果。resultMap 是 MyBatis 提供的一个强力武器，这一点官方文档中有所描述，这里引用一下。</p>
<blockquote>
<p>resultMap 元素是 MyBatis 中最重要最强大的元素。它可以让你从 90% 的 JDBC ResultSets 数据提取代码中解放出来, 并在一些情形下允许你做一些 JDBC 不支持的事情。 实际上，在对复杂语句进行联合映射的时候，它很可能可以代替数千行的同等功能的代码。 ResultMap 的设计思想是，简单的语句不需要明确的结果映射，而复杂一点的语句只需要描述它们的关系就行了。</p>
</blockquote>
<p>如上描述，resultMap 元素是 MyBatis 中最重要最强大的元素，它可以把大家从 JDBC ResultSets 数据提取的工作中解放出来。通过 resultMap 和自动映射，可以让 MyBatis 帮助我们完成 ResultSet → Object 的映射，这将会大大提高了开发效率。关于 resultMap 的用法，我相信大家都比较熟悉了，所以这里我就不介绍了。当然，如果大家不熟悉也没关系，MyBatis 的上对此进行了详细的介绍，大家不妨去看看。</p>
<p>好了，其他的就不多说了，下面开始分析 resultMap 配置的解析过程。</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- XMLMapperBuilderprivate void resultMapElements(ListXNode list) throws Exception {    // 遍历 resultMap 节点列表    for (XNode resultMapNode : list) {        try {            // 解析 resultMap 节点            resultMapElement(resultMapNode);        } catch (IncompleteElementException e) {            // ignore, it will be retried        }    }} private ResultMap resultMapElement(XNode resultMapNode) throws Exception {    // 调用重载方法    return resultMapElement(resultMapNode, Collections.ResultMappingemptyList());} private ResultMap resultMapElement(XNode resultMapNode, ListResultMapping additionalResultMappings) throws Exception {    ErrorContext.instance().activity("processing " + resultMapNode.getValueBasedIdentifier());     // 获取 id 和 type 属性    String id = resultMapNode.getStringAttribute("id", resultMapNode.getValueBasedIdentifier());    String type = resultMapNode.getStringAttribute("type",        resultMapNode.getStringAttribute("ofType",            resultMapNode.getStringAttribute("resultType",                resultMapNode.getStringAttribute("javaType"))));    // 获取 extends 和 autoMapping    String extend = resultMapNode.getStringAttribute("extends");    Boolean autoMapping = resultMapNode.getBooleanAttribute("autoMapping");     // 解析 type 属性对应的类型    Class? typeClass = resolveClass(type);    Discriminator discriminator = null;    ListResultMapping resultMappings = new ArrayListResultMapping();    resultMappings.addAll(additionalResultMappings);     // 获取并遍历 resultMap 的子节点列表    ListXNode resultChildren = resultMapNode.getChildren();    for (XNode resultChild : resultChildren) {        if ("constructor".equals(resultChild.getName())) {            // 解析 constructor 节点，并生成相应的 ResultMapping            processConstructorElement(resultChild, typeClass, resultMappings);        } else if ("discriminator".equals(resultChild.getName())) {            // 解析 discriminator 节点            discriminator = processDiscriminatorElement(resultChild, typeClass, resultMappings);        } else {             ListResultFlag flags = new ArrayListResultFlag();            if ("id".equals(resultChild.getName())) {                // 添加 ID 到 flags 集合中                flags.add(ResultFlag.ID);            }            // 解析 id 和 property 节点，并生成相应的 ResultMapping            resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));        }    }    ResultMapResolver resultMapResolver = new ResultMapResolver(builderAssistant, id, typeClass, extend,        discriminator, resultMappings, autoMapping);    try {        // 根据前面获取到的信息构建 ResultMap 对象        return resultMapResolver.resolve();    } catch (IncompleteElementException e) {        /*         * 如果发生 IncompleteElementException 异常，         * 这里将 resultMapResolver 添加到 incompleteResultMaps 集合中         */         configuration.addIncompleteResultMap(resultMapResolver);        throw e;    }}</pre></td>

<p>&#x2F;&#x2F; -☆- XMLMapperBuilder<br>private void resultMapElements(ListXNode list) throws Exception {<br>    &#x2F;&#x2F; 遍历 resultMap 节点列表<br>    for (XNode resultMapNode : list) {<br>        try {<br>            &#x2F;&#x2F; 解析 resultMap 节点<br>            resultMapElement(resultMapNode);<br>        } catch (IncompleteElementException e) {<br>            &#x2F;&#x2F; ignore, it will be retried<br>        }<br>    }<br>}</p>
<p>private ResultMap resultMapElement(XNode resultMapNode) throws Exception {<br>    &#x2F;&#x2F; 调用重载方法<br>    return resultMapElement(resultMapNode, Collections.ResultMappingemptyList());<br>}</p>
<p>private ResultMap resultMapElement(XNode resultMapNode, ListResultMapping additionalResultMappings) throws Exception {<br>    ErrorContext.instance().activity(“processing “ + resultMapNode.getValueBasedIdentifier());</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 获取 id 和 type 属性</span>
String id <span class="token operator">=</span> resultMapNode<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> resultMapNode<span class="token punctuation">.</span><span class="token function">getValueBasedIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String type <span class="token operator">=</span> resultMapNode<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span>
    resultMapNode<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"ofType"</span><span class="token punctuation">,</span>
        resultMapNode<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resultType"</span><span class="token punctuation">,</span>
            resultMapNode<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"javaType"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 获取 extends 和 autoMapping</span>
String extend <span class="token operator">=</span> resultMapNode<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"extends"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Boolean autoMapping <span class="token operator">=</span> resultMapNode<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">"autoMapping"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 解析 type 属性对应的类型</span>
Class<span class="token operator">?</span> typeClass <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
Discriminator discriminator <span class="token operator">=</span> null<span class="token punctuation">;</span>
ListResultMapping resultMappings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayListResultMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
resultMappings<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>additionalResultMappings<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 获取并遍历 resultMap 的子节点列表</span>
ListXNode resultChildren <span class="token operator">=</span> resultMapNode<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>XNode resultChild <span class="token operator">:</span> resultChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"constructor"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>resultChild<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 解析 constructor 节点，并生成相应的 ResultMapping</span>
        <span class="token function">processConstructorElement</span><span class="token punctuation">(</span>resultChild<span class="token punctuation">,</span> typeClass<span class="token punctuation">,</span> resultMappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"discriminator"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>resultChild<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 解析 discriminator 节点</span>
        discriminator <span class="token operator">=</span> <span class="token function">processDiscriminatorElement</span><span class="token punctuation">(</span>resultChild<span class="token punctuation">,</span> typeClass<span class="token punctuation">,</span> resultMappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

        ListResultFlag flags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayListResultFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>resultChild<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 添加 ID 到 flags 集合中</span>
            flags<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ResultFlag<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 解析 id 和 property 节点，并生成相应的 ResultMapping</span>
        resultMappings<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">buildResultMappingFromContext</span><span class="token punctuation">(</span>resultChild<span class="token punctuation">,</span> typeClass<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
ResultMapResolver resultMapResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResultMapResolver</span><span class="token punctuation">(</span>builderAssistant<span class="token punctuation">,</span> id<span class="token punctuation">,</span> typeClass<span class="token punctuation">,</span> extend<span class="token punctuation">,</span>
    discriminator<span class="token punctuation">,</span> resultMappings<span class="token punctuation">,</span> autoMapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 根据前面获取到的信息构建 ResultMap 对象</span>
    <span class="token keyword">return</span> resultMapResolver<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IncompleteElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/*
     * 如果发生 IncompleteElementException 异常，
     * 这里将 resultMapResolver 添加到 incompleteResultMaps 集合中
     */</span> 
    configuration<span class="token punctuation">.</span><span class="token function">addIncompleteResultMap</span><span class="token punctuation">(</span>resultMapResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面的代码比较多，看起来有点复杂，这里总结一下：</p>
<ol>
<li>获取 resultMap 节点的各种属性</li>
<li>遍历 resultMap 的子节点，并根据子节点名称执行相应的解析逻辑</li>
<li>构建 ResultMap 对象</li>
<li>若构建过程中发生异常，则将 resultMapResolver 添加到 incompleteResultMaps 集合中</li>
</ol>
<p>如上流程，第1步和最后一步都是一些常规操作，无需过多解释。第2步和第3步则是接下来需要重点分析的操作，这其中，鉴别器 discriminator 不是很常用的特性，我觉得大家知道它有什么用就行了，所以就不分析了。下面先来分析 id 和 result 节点的解析逻辑。</p>
<h5 id="2-1-3-1-解析-id-和-result-节点"><a href="#2-1-3-1-解析-id-和-result-节点" class="headerlink" title="2.1.3.1 解析 id 和 result 节点"></a>2.1.3.1 解析 id 和 result 节点</h5><p>在 resultMap 节点中，子节点 id 和 result 都是常规配置，比较常见。相信大家对此也比较熟悉了，我就不多说了。下面我们直接分析这两个节点的解析过程。如下：</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private ResultMapping buildResultMappingFromContext(XNode context, Class? resultType, ListResultFlag flags) throws Exception {    String property;    // 根据节点类型获取 name 或 property 属性    if (flags.contains(ResultFlag.CONSTRUCTOR)) {        property = context.getStringAttribute("name");    } else {        property = context.getStringAttribute("property");    }     // 获取其他各种属性    String column = context.getStringAttribute("column");    String javaType = context.getStringAttribute("javaType");    String jdbcType = context.getStringAttribute("jdbcType");    String nestedSelect = context.getStringAttribute("select");     /*     * 解析 resultMap 属性，该属性出现在 association 和 collection 节点中。     * 若这两个节点不包含 resultMap 属性，则调用 processNestedResultMappings 方法     * 解析嵌套 resultMap。     */    String nestedResultMap = context.getStringAttribute("resultMap", processNestedResultMappings(context, Collections.ResultMappingemptyList()));     String notNullColumn = context.getStringAttribute("notNullColumn");    String columnPrefix = context.getStringAttribute("columnPrefix");    String typeHandler = context.getStringAttribute("typeHandler");    String resultSet = context.getStringAttribute("resultSet");    String foreignColumn = context.getStringAttribute("foreignColumn");    boolean lazy = "lazy".equals(context.getStringAttribute("fetchType", configuration.isLazyLoadingEnabled() ? "lazy" : "eager"));     // 解析 javaType、typeHandler 的类型以及枚举类型 JdbcType    Class? javaTypeClass = resolveClass(javaType);    Class? extends TypeHandler? typeHandlerClass = (Class? extends TypeHandler?) resolveClass(typeHandler);    JdbcType jdbcTypeEnum = resolveJdbcType(jdbcType);     // 构建 ResultMapping 对象    return builderAssistant.buildResultMapping(resultType, property, column, javaTypeClass, jdbcTypeEnum, nestedSelect,        nestedResultMap, notNullColumn, columnPrefix, typeHandlerClass, flags, resultSet, foreignColumn, lazy);}</pre></td>

<p>private ResultMapping buildResultMappingFromContext(XNode context, Class? resultType, ListResultFlag flags) throws Exception {<br>    String property;<br>    &#x2F;&#x2F; 根据节点类型获取 name 或 property 属性<br>    if (flags.contains(ResultFlag.CONSTRUCTOR)) {<br>        property &#x3D; context.getStringAttribute(“name”);<br>    } else {<br>        property &#x3D; context.getStringAttribute(“property”);<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 获取其他各种属性</span>
String column <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"column"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String javaType <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"javaType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String jdbcType <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"jdbcType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String nestedSelect <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
 * 解析 resultMap 属性，该属性出现在 association 和 collection 节点中。
 * 若这两个节点不包含 resultMap 属性，则调用 processNestedResultMappings 方法
 * 解析嵌套 resultMap。
 */</span>
String nestedResultMap <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resultMap"</span><span class="token punctuation">,</span> <span class="token function">processNestedResultMappings</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> Collections<span class="token punctuation">.</span><span class="token function">ResultMappingemptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

String notNullColumn <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"notNullColumn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String columnPrefix <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"columnPrefix"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String typeHandler <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"typeHandler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String resultSet <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resultSet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String foreignColumn <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"foreignColumn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> lazy <span class="token operator">=</span> <span class="token string">"lazy"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"fetchType"</span><span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">isLazyLoadingEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"lazy"</span> <span class="token operator">:</span> <span class="token string">"eager"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 解析 javaType、typeHandler 的类型以及枚举类型 JdbcType</span>
Class<span class="token operator">?</span> javaTypeClass <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>javaType<span class="token punctuation">)</span><span class="token punctuation">;</span>
Class<span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">TypeHandler</span><span class="token operator">?</span> typeHandlerClass <span class="token operator">=</span> <span class="token punctuation">(</span>Class<span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">TypeHandler</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>typeHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
JdbcType jdbcTypeEnum <span class="token operator">=</span> <span class="token function">resolveJdbcType</span><span class="token punctuation">(</span>jdbcType<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 构建 ResultMapping 对象</span>
<span class="token keyword">return</span> builderAssistant<span class="token punctuation">.</span><span class="token function">buildResultMapping</span><span class="token punctuation">(</span>resultType<span class="token punctuation">,</span> property<span class="token punctuation">,</span> column<span class="token punctuation">,</span> javaTypeClass<span class="token punctuation">,</span> jdbcTypeEnum<span class="token punctuation">,</span> nestedSelect<span class="token punctuation">,</span>
    nestedResultMap<span class="token punctuation">,</span> notNullColumn<span class="token punctuation">,</span> columnPrefix<span class="token punctuation">,</span> typeHandlerClass<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> resultSet<span class="token punctuation">,</span> foreignColumn<span class="token punctuation">,</span> lazy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面的方法主要用于获取 id 和 result 节点的属性，其中，resultMap 属性的解析过程要相对复杂一些。该属性存在于 association 和 collection 节点中。下面以 association 节点为例，演示该节点的两种配置方式，分别如下：</p>
<p>第一种配置方式是通过 resultMap 属性引用其他的 resultMap 节点，配置如下：</p>
<td class="line_numbers"><pre>1234567891011</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">resultMap id="articleResult" type="Article"    id property="id" column="id"/    result property="title" column="article_title"/    !-- 引用 authorResult --    association property="article_author" column="article_author_id" javaType="Author" resultMap="authorResult"//resultMap resultMap id="authorResult" type="Author"    id property="id" column="author_id"/    result property="name" column="author_name"//resultMap</pre></td>

<p>resultMap id&#x3D;”articleResult” type&#x3D;”Article”<br>    id property&#x3D;”id” column&#x3D;”id”&#x2F;<br>    result property&#x3D;”title” column&#x3D;”article_title”&#x2F;<br>    !– 引用 authorResult –<br>    association property&#x3D;”article_author” column&#x3D;”article_author_id” javaType&#x3D;”Author” resultMap&#x3D;”authorResult”&#x2F;<br>&#x2F;resultMap</p>
<p>resultMap id&#x3D;”authorResult” type&#x3D;”Author”<br>    id property&#x3D;”id” column&#x3D;”author_id”&#x2F;<br>    result property&#x3D;”name” column&#x3D;”author_name”&#x2F;<br>&#x2F;resultMap</p>
<p>第二种配置方式是采取 resultMap 嵌套的方式进行配置，如下：</p>
<td class="line_numbers"><pre>123456789</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">resultMap id="articleResult" type="Article"    id property="id" column="id"/    result property="title" column="article_title"/    !-- resultMap 嵌套 --    association property="article_author" javaType="Author"        id property="id" column="author_id"/        result property="name" column="author_name"/    /association/resultMap</pre></td>

<p>resultMap id&#x3D;”articleResult” type&#x3D;”Article”<br>    id property&#x3D;”id” column&#x3D;”id”&#x2F;<br>    result property&#x3D;”title” column&#x3D;”article_title”&#x2F;<br>    !– resultMap 嵌套 –<br>    association property&#x3D;”article_author” javaType&#x3D;”Author”<br>        id property&#x3D;”id” column&#x3D;”author_id”&#x2F;<br>        result property&#x3D;”name” column&#x3D;”author_name”&#x2F;<br>    &#x2F;association<br>&#x2F;resultMap</p>
<p>如上配置，association 的子节点是一些结果映射配置，这些结果配置最终也会被解析成 ResultMap。我们可以看看解析过程是怎样的，如下：</p>
<td class="line_numbers"><pre>1234567891011121314</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private String processNestedResultMappings(XNode context, ListResultMapping resultMappings) throws Exception {    // 判断节点名称    if ("association".equals(context.getName())        || "collection".equals(context.getName())        || "case".equals(context.getName())) {        if (context.getStringAttribute("select") == null) {            // resultMapElement 是解析 ResultMap 入口方法            ResultMap resultMap = resultMapElement(context, resultMappings);            // 返回 resultMap id            return resultMap.getId();        }    }    return null;}</pre></td>

<p>private String processNestedResultMappings(XNode context, ListResultMapping resultMappings) throws Exception {<br>    &#x2F;&#x2F; 判断节点名称<br>    if (“association”.equals(context.getName())<br>        || “collection”.equals(context.getName())<br>        || “case”.equals(context.getName())) {<br>        if (context.getStringAttribute(“select”) &#x3D;&#x3D; null) {<br>            &#x2F;&#x2F; resultMapElement 是解析 ResultMap 入口方法<br>            ResultMap resultMap &#x3D; resultMapElement(context, resultMappings);<br>            &#x2F;&#x2F; 返回 resultMap id<br>            return resultMap.getId();<br>        }<br>    }<br>    return null;<br>}</p>
<p>如上，association 的子节点由 resultMapElement 方法解析成 ResultMap，并在最后返回 resultMap.id。对于 resultMap 节点，id 的值配置在该节点的 id 属性中。但 association 节点无法配置 id 属性，那么该 id 如何产生的呢？答案在 XNode 类的 getValueBasedIdentifier 方法中，这个方法具体逻辑我就不分析了。下面直接看一下以上配置中的 association 节点解析成 ResultMap 后的 id 值，如下：</p>
<td class="line_numbers"><pre>1</pre></td><td class="code"><pre class="null" style="font-family:monospace;">id = mapper_resultMap[articleResult]_association[article_author]</pre></td>

<p>id &#x3D; mapper_resultMap[articleResult]_association[article_author]</p>
<p>关于嵌套 resultMap 的解析逻辑就先分析到这，下面分析 ResultMapping 的构建过程。</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738394041424344454647</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public ResultMapping buildResultMapping(Class? resultType, String property, String column, Class? javaType,JdbcType jdbcType,     String nestedSelect, String nestedResultMap, String notNullColumn, String columnPrefix,Class? extends TypeHandler? typeHandler,     ListResultFlag flags, String resultSet, String foreignColumn, boolean lazy) {     /*     * 若 javaType 为空，这里根据 property 的属性进行解析。关于下面方法中的参数，     * 这里说明一下：     *   - resultType：即 resultMap type="xxx"/ 中的 type 属性     *   - property：即 result property="xxx"/ 中的 property 属性     */    Class? javaTypeClass = resolveResultJavaType(resultType, property, javaType);     // 解析 TypeHandler    TypeHandler? typeHandlerInstance = resolveTypeHandler(javaTypeClass, typeHandler);     /*     * 解析 column = {property1=column1, property2=column2} 的情况，     * 这里会将 column 拆分成多个 ResultMapping     */    ListResultMapping composites = parseCompositeColumnName(column);     // 通过建造模式构建 ResultMapping    return new ResultMapping.Builder(configuration, property, column, javaTypeClass)        .jdbcType(jdbcType)        .nestedQueryId(applyCurrentNamespace(nestedSelect, true))        .nestedResultMapId(applyCurrentNamespace(nestedResultMap, true))        .resultSet(resultSet)        .typeHandler(typeHandlerInstance)        .flags(flags == null ? new ArrayListResultFlag() : flags)        .composites(composites)        .notNullColumns(parseMultipleColumnNames(notNullColumn))        .columnPrefix(columnPrefix)        .foreignColumn(foreignColumn)        .lazy(lazy)        .build();} // -☆- ResultMapping.Builderpublic ResultMapping build() {    // 将 flags 和 composites 两个集合变为不可修改集合    resultMapping.flags = Collections.unmodifiableList(resultMapping.flags);    resultMapping.composites = Collections.unmodifiableList(resultMapping.composites);    // 从 TypeHandlerRegistry 中获取相应 TypeHandler    resolveTypeHandler();    validate();    return resultMapping;}</pre></td>

<p>public ResultMapping buildResultMapping(Class? resultType, String property, String column, Class? javaType,JdbcType jdbcType,<br>    String nestedSelect, String nestedResultMap, String notNullColumn, String columnPrefix,Class? extends TypeHandler? typeHandler,<br>    ListResultFlag flags, String resultSet, String foreignColumn, boolean lazy) {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">/*
 * 若 javaType 为空，这里根据 property 的属性进行解析。关于下面方法中的参数，
 * 这里说明一下：
 *   - resultType：即 resultMap type="xxx"/ 中的 type 属性
 *   - property：即 result property="xxx"/ 中的 property 属性
 */</span>
Class<span class="token operator">?</span> javaTypeClass <span class="token operator">=</span> <span class="token function">resolveResultJavaType</span><span class="token punctuation">(</span>resultType<span class="token punctuation">,</span> property<span class="token punctuation">,</span> javaType<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 解析 TypeHandler</span>
TypeHandler<span class="token operator">?</span> typeHandlerInstance <span class="token operator">=</span> <span class="token function">resolveTypeHandler</span><span class="token punctuation">(</span>javaTypeClass<span class="token punctuation">,</span> typeHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
 * 解析 column = {property1=column1, property2=column2} 的情况，
 * 这里会将 column 拆分成多个 ResultMapping
 */</span>
ListResultMapping composites <span class="token operator">=</span> <span class="token function">parseCompositeColumnName</span><span class="token punctuation">(</span>column<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 通过建造模式构建 ResultMapping</span>
<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResultMapping<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> property<span class="token punctuation">,</span> column<span class="token punctuation">,</span> javaTypeClass<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">jdbcType</span><span class="token punctuation">(</span>jdbcType<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">nestedQueryId</span><span class="token punctuation">(</span><span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>nestedSelect<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">nestedResultMapId</span><span class="token punctuation">(</span><span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>nestedResultMap<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">resultSet</span><span class="token punctuation">(</span>resultSet<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">typeHandler</span><span class="token punctuation">(</span>typeHandlerInstance<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flags</span><span class="token punctuation">(</span>flags <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ArrayListResultFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> flags<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">composites</span><span class="token punctuation">(</span>composites<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">notNullColumns</span><span class="token punctuation">(</span><span class="token function">parseMultipleColumnNames</span><span class="token punctuation">(</span>notNullColumn<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">columnPrefix</span><span class="token punctuation">(</span>columnPrefix<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">foreignColumn</span><span class="token punctuation">(</span>foreignColumn<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span>lazy<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>&#x2F;&#x2F; -☆- ResultMapping.Builder<br>public ResultMapping build() {<br>    &#x2F;&#x2F; 将 flags 和 composites 两个集合变为不可修改集合<br>    resultMapping.flags &#x3D; Collections.unmodifiableList(resultMapping.flags);<br>    resultMapping.composites &#x3D; Collections.unmodifiableList(resultMapping.composites);<br>    &#x2F;&#x2F; 从 TypeHandlerRegistry 中获取相应 TypeHandler<br>    resolveTypeHandler();<br>    validate();<br>    return resultMapping;<br>}</p>
<p>ResultMapping 的构建过程不是很复杂，首先是解析 javaType 类型，并创建 typeHandler 实例。然后处理复合 column。最后通过建造器构建 ResultMapping 实例。关于上面方法中出现的一些方法调用，这里接不跟下去分析了，大家可以自己看看。</p>
<p>到此关于 ResultMapping 的解析和构建过程就分析完了，总的来说，还是比较复杂的。不过再难也是人写的，静下心都可以看懂。好了，其他就不多说了，继续往下分析。</p>
<h5 id="2-1-3-2-解析-constructor-节点"><a href="#2-1-3-2-解析-constructor-节点" class="headerlink" title="2.1.3.2 解析 constructor 节点"></a>2.1.3.2 解析 constructor 节点</h5><p>一般情况下，我们所定义的实体类都是简单的 Java 对象，即 POJO。这种对象包含一些私有属性和相应的 getter&#x2F;setter 方法，通常这种 POJO 可以满足大部分需求。但如果你想使用<code class="java">
不可变类</code>存储查询结果，则就需要做一些改动。比如把 POJO 的 setter 方法移除，增加构造方法用于初始化成员变量。对于这种不可变的 Java 类，需要通过带有参数的构造方法进行初始化（反射也可以达到同样目的）。下面举个例子说明一下：</p>
<td class="line_numbers"><pre>123456789101112</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public class ArticleDO {     // ...     public ArticleDO(Integer id, String title, String content) {        this.id = id;        this.title = title;        this.content = content;    }     // ...}</pre></td>

<p>public class ArticleDO {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">public</span> <span class="token function">ArticleDO</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">,</span> String title<span class="token punctuation">,</span> String content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>title <span class="token operator">=</span> title<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// ...</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>如上，ArticleDO 的构造方法对应的配置如下：</p>
<td class="line_numbers"><pre>12345</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">constructor    idArg column="id" name="id"/    arg column="title" name="title"/    arg column="content" name="content"//constructor</pre></td>

<p>constructor<br>    idArg column&#x3D;”id” name&#x3D;”id”&#x2F;<br>    arg column&#x3D;”title” name&#x3D;”title”&#x2F;<br>    arg column&#x3D;”content” name&#x3D;”content”&#x2F;<br>&#x2F;constructor</p>
<p>下面，分析 constructor 节点的解析过程。如下：</p>
<td class="line_numbers"><pre>123456789101112131415</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void processConstructorElement(XNode resultChild, Class? resultType, ListResultMapping resultMappings) throws Exception {    // 获取子节点列表    ListXNode argChildren = resultChild.getChildren();    for (XNode argChild : argChildren) {        ListResultFlag flags = new ArrayListResultFlag();        // 向 flags 中添加 CONSTRUCTOR 标志        flags.add(ResultFlag.CONSTRUCTOR);        if ("idArg".equals(argChild.getName())) {            // 向 flags 中添加 ID 标志            flags.add(ResultFlag.ID);        }        // 构建 ResultMapping，上一节已经分析过        resultMappings.add(buildResultMappingFromContext(argChild, resultType, flags));    }}</pre></td>

<p>private void processConstructorElement(XNode resultChild, Class? resultType, ListResultMapping resultMappings) throws Exception {<br>    &#x2F;&#x2F; 获取子节点列表<br>    ListXNode argChildren &#x3D; resultChild.getChildren();<br>    for (XNode argChild : argChildren) {<br>        ListResultFlag flags &#x3D; new ArrayListResultFlag();<br>        &#x2F;&#x2F; 向 flags 中添加 CONSTRUCTOR 标志<br>        flags.add(ResultFlag.CONSTRUCTOR);<br>        if (“idArg”.equals(argChild.getName())) {<br>            &#x2F;&#x2F; 向 flags 中添加 ID 标志<br>            flags.add(ResultFlag.ID);<br>        }<br>        &#x2F;&#x2F; 构建 ResultMapping，上一节已经分析过<br>        resultMappings.add(buildResultMappingFromContext(argChild, resultType, flags));<br>    }<br>}</p>
<p>如上，上面方法的逻辑并不复杂。首先是获取并遍历子节点列表，然后为每个子节点创建 flags 集合，并添加 CONSTRUCTOR 标志。对于 idArg 节点，额外添加 ID 标志。最后一步则是构建 ResultMapping，该步逻辑前面已经分析过，这里就不多说了。</p>
<p>分析完 resultMap 的子节点 id，result 以及 constructor 的解析过程，下面来看看 ResultMap 实例的构建过程。</p>
<h5 id="2-1-3-3-ResultMap-对象构建过程分析"><a href="#2-1-3-3-ResultMap-对象构建过程分析" class="headerlink" title="2.1.3.3 ResultMap 对象构建过程分析"></a>2.1.3.3 ResultMap 对象构建过程分析</h5><p>前面用了不少的篇幅来分析 resultMap 子节点的解析过程。通过前面的分析，我们可知 id，result 等节点最终都被解析成了 ResultMapping。在得到这些 ResultMapping 后，紧接着要做的事情是构建 ResultMap。如果说 ResultMapping 与单条结果映射相对应，那 ResultMap 与什么对应呢？答案是…。答案暂时还不能说，我们到源码中去找寻吧。下面，让我们带着这个疑问开始本节的源码分析。</p>
<p>前面分析了很多源码，大家可能都忘了 ResultMap 构建的入口了。这里再贴一下，如下：</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private ResultMap resultMapElement(XNode resultMapNode, ListResultMapping additionalResultMappings) throws Exception {     // 获取 resultMap 节点中的属性    // ...     // 解析 resultMap 对应的类型    // ...     // 遍历 resultMap 节点的子节点，构建 ResultMapping 对象    // ...     // 创建 ResultMap 解析器    ResultMapResolver resultMapResolver = new ResultMapResolver(builderAssistant, id, typeClass, extend,        discriminator, resultMappings, autoMapping);    try {        // 根据前面获取到的信息构建 ResultMap 对象        return resultMapResolver.resolve();    } catch (IncompleteElementException e) {        configuration.addIncompleteResultMap(resultMapResolver);        throw e;    }}</pre></td>

<p>private ResultMap resultMapElement(XNode resultMapNode, ListResultMapping additionalResultMappings) throws Exception {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 获取 resultMap 节点中的属性</span>
<span class="token comment" spellcheck="true">// ...</span>

<span class="token comment" spellcheck="true">// 解析 resultMap 对应的类型</span>
<span class="token comment" spellcheck="true">// ...</span>

<span class="token comment" spellcheck="true">// 遍历 resultMap 节点的子节点，构建 ResultMapping 对象</span>
<span class="token comment" spellcheck="true">// ...</span>

<span class="token comment" spellcheck="true">// 创建 ResultMap 解析器</span>
ResultMapResolver resultMapResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResultMapResolver</span><span class="token punctuation">(</span>builderAssistant<span class="token punctuation">,</span> id<span class="token punctuation">,</span> typeClass<span class="token punctuation">,</span> extend<span class="token punctuation">,</span>
    discriminator<span class="token punctuation">,</span> resultMappings<span class="token punctuation">,</span> autoMapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 根据前面获取到的信息构建 ResultMap 对象</span>
    <span class="token keyword">return</span> resultMapResolver<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IncompleteElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    configuration<span class="token punctuation">.</span><span class="token function">addIncompleteResultMap</span><span class="token punctuation">(</span>resultMapResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>如上，ResultMap 的构建逻辑分装在 ResultMapResolver 的 resolve 方法中，下面我从该方法进行分析。</p>
<td class="line_numbers"><pre>1234</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- ResultMapResolverpublic ResultMap resolve() {    return assistant.addResultMap(this.id, this.type, this.extend, this.discriminator, this.resultMappings, this.autoMapping);}</pre></td>

<p>&#x2F;&#x2F; -☆- ResultMapResolver<br>public ResultMap resolve() {<br>    return assistant.addResultMap(this.id, this.type, this.extend, this.discriminator, this.resultMappings, this.autoMapping);<br>}</p>
<p>上面的方法将构建 ResultMap 实例的任务委托给了 MapperBuilderAssistant 的 addResultMap，我们跟进到这个方法中看看。</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- MapperBuilderAssistantpublic ResultMap addResultMap(    String id, Class? type, String extend, Discriminator discriminator,    ListResultMapping resultMappings, Boolean autoMapping) {     // 为 ResultMap 的 id 和 extend 属性值拼接命名空间    id = applyCurrentNamespace(id, false);    extend = applyCurrentNamespace(extend, true);     if (extend != null) {        if (!configuration.hasResultMap(extend)) {            throw new IncompleteElementException("Could not find a parent resultmap with id '" + extend + "'");        }        ResultMap resultMap = configuration.getResultMap(extend);        ListResultMapping extendedResultMappings = new ArrayListResultMapping(resultMap.getResultMappings());        // 为拓展 ResultMappings 取出重复项        extendedResultMappings.removeAll(resultMappings);         boolean declaresConstructor = false;        // 检测当前 resultMappings 集合中是否包含 CONSTRUCTOR 标志的元素        for (ResultMapping resultMapping : resultMappings) {            if (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) {                declaresConstructor = true;                break;            }        }         /*         * 如果当前 resultMap 节点中包含 constructor 子节点，         * 则将拓展 ResultMapping 集合中的包含 CONSTRUCTOR 标志的元素移除         */        if (declaresConstructor) {            IteratorResultMapping extendedResultMappingsIter = extendedResultMappings.iterator();            while (extendedResultMappingsIter.hasNext()) {                if (extendedResultMappingsIter.next().getFlags().contains(ResultFlag.CONSTRUCTOR)) {                    extendedResultMappingsIter.remove();                }            }        }         // 将扩展 resultMappings 集合合并到当前 resultMappings 集合中        resultMappings.addAll(extendedResultMappings);    }     // 构建 ResultMap    ResultMap resultMap = new ResultMap.Builder(configuration, id, type, resultMappings, autoMapping)        .discriminator(discriminator)        .build();    configuration.addResultMap(resultMap);    return resultMap;}</pre></td>

<p>&#x2F;&#x2F; -☆- MapperBuilderAssistant<br>public ResultMap addResultMap(<br>    String id, Class? type, String extend, Discriminator discriminator,<br>    ListResultMapping resultMappings, Boolean autoMapping) {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 为 ResultMap 的 id 和 extend 属性值拼接命名空间</span>
id <span class="token operator">=</span> <span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
extend <span class="token operator">=</span> <span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>extend<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>extend <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configuration<span class="token punctuation">.</span><span class="token function">hasResultMap</span><span class="token punctuation">(</span>extend<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IncompleteElementException</span><span class="token punctuation">(</span><span class="token string">"Could not find a parent resultmap with id '"</span> <span class="token operator">+</span> extend <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ResultMap resultMap <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getResultMap</span><span class="token punctuation">(</span>extend<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ListResultMapping extendedResultMappings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayListResultMapping</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">getResultMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 为拓展 ResultMappings 取出重复项</span>
    extendedResultMappings<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>resultMappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">boolean</span> declaresConstructor <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 检测当前 resultMappings 集合中是否包含 CONSTRUCTOR 标志的元素</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>ResultMapping resultMapping <span class="token operator">:</span> resultMappings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultMapping<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ResultFlag<span class="token punctuation">.</span>CONSTRUCTOR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            declaresConstructor <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/*
     * 如果当前 resultMap 节点中包含 constructor 子节点，
     * 则将拓展 ResultMapping 集合中的包含 CONSTRUCTOR 标志的元素移除
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>declaresConstructor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        IteratorResultMapping extendedResultMappingsIter <span class="token operator">=</span> extendedResultMappings<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>extendedResultMappingsIter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>extendedResultMappingsIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ResultFlag<span class="token punctuation">.</span>CONSTRUCTOR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                extendedResultMappingsIter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 将扩展 resultMappings 集合合并到当前 resultMappings 集合中</span>
    resultMappings<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>extendedResultMappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 构建 ResultMap</span>
ResultMap resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResultMap<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> id<span class="token punctuation">,</span> type<span class="token punctuation">,</span> resultMappings<span class="token punctuation">,</span> autoMapping<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">discriminator</span><span class="token punctuation">(</span>discriminator<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
configuration<span class="token punctuation">.</span><span class="token function">addResultMap</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面的方法主要用于处理 resultMap 节点的 extend 属性，extend 不为空的话，这里将当前 resultMappings 集合和扩展 resultMappings 集合合二为一。随后，通过建造模式构建 ResultMap 实例。过程如下：</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- ResultMappublic ResultMap build() {    if (resultMap.id == null) {        throw new IllegalArgumentException("ResultMaps must have an id");    }    resultMap.mappedColumns = new HashSetString();    resultMap.mappedProperties = new HashSetString();    resultMap.idResultMappings = new ArrayListResultMapping();    resultMap.constructorResultMappings = new ArrayListResultMapping();    resultMap.propertyResultMappings = new ArrayListResultMapping();    final ListString constructorArgNames = new ArrayListString();     for (ResultMapping resultMapping : resultMap.resultMappings) {        /*         * 检测 association 或 collection 节点         * 是否包含 select 和 resultMap 属性         */        resultMap.hasNestedQueries = resultMap.hasNestedQueries || resultMapping.getNestedQueryId() != null;        resultMap.hasNestedResultMaps =            resultMap.hasNestedResultMaps || (resultMapping.getNestedResultMapId() != null && resultMapping.getResultSet() == null);         final String column = resultMapping.getColumn();        if (column != null) {            // 将 colum 转换成大写，并添加到 mappedColumns 集合中            resultMap.mappedColumns.add(column.toUpperCase(Locale.ENGLISH));        } else if (resultMapping.isCompositeResult()) {            for (ResultMapping compositeResultMapping : resultMapping.getComposites()) {                final String compositeColumn = compositeResultMapping.getColumn();                if (compositeColumn != null) {                    resultMap.mappedColumns.add(compositeColumn.toUpperCase(Locale.ENGLISH));                }            }        }         // 添加属性 property 到 mappedProperties 集合中        final String property = resultMapping.getProperty();        if (property != null) {            resultMap.mappedProperties.add(property);        }         // 检测当前 resultMapping 是否包含 CONSTRUCTOR 标志        if (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) {            // 添加 resultMapping 到 constructorResultMappings 中            resultMap.constructorResultMappings.add(resultMapping);            // 添加属性（constructor 节点的 name 属性）到 constructorArgNames 中            if (resultMapping.getProperty() != null) {                constructorArgNames.add(resultMapping.getProperty());            }        } else {            // 添加 resultMapping 到 propertyResultMappings 中            resultMap.propertyResultMappings.add(resultMapping);        }         if (resultMapping.getFlags().contains(ResultFlag.ID)) {            // 添加 resultMapping 到 idResultMappings 中            resultMap.idResultMappings.add(resultMapping);        }    }    if (resultMap.idResultMappings.isEmpty()) {        resultMap.idResultMappings.addAll(resultMap.resultMappings);    }    if (!constructorArgNames.isEmpty()) {        // 获取构造方法参数列表，篇幅原因，这个方法不分析了        final ListString actualArgNames = argNamesOfMatchingConstructor(constructorArgNames);        if (actualArgNames == null) {            throw new BuilderException("Error in result map '" + resultMap.id                + "'. Failed to find a constructor in '"                + resultMap.getType().getName() + "' by arg names " + constructorArgNames                + ". There might be more info in debug log.");        }        // 对 constructorResultMappings 按照构造方法参数列表的顺序进行排序        Collections.sort(resultMap.constructorResultMappings, new ComparatorResultMapping() {            @Override            public int compare(ResultMapping o1, ResultMapping o2) {                int paramIdx1 = actualArgNames.indexOf(o1.getProperty());                int paramIdx2 = actualArgNames.indexOf(o2.getProperty());                return paramIdx1 - paramIdx2;            }        });    }     // 将以下这些集合变为不可修改集合    resultMap.resultMappings = Collections.unmodifiableList(resultMap.resultMappings);    resultMap.idResultMappings = Collections.unmodifiableList(resultMap.idResultMappings);    resultMap.constructorResultMappings = Collections.unmodifiableList(resultMap.constructorResultMappings);    resultMap.propertyResultMappings = Collections.unmodifiableList(resultMap.propertyResultMappings);    resultMap.mappedColumns = Collections.unmodifiableSet(resultMap.mappedColumns);    return resultMap;}</pre></td>

<p>&#x2F;&#x2F; -☆- ResultMap<br>public ResultMap build() {<br>    if (resultMap.id &#x3D;&#x3D; null) {<br>        throw new IllegalArgumentException(“ResultMaps must have an id”);<br>    }<br>    resultMap.mappedColumns &#x3D; new HashSetString();<br>    resultMap.mappedProperties &#x3D; new HashSetString();<br>    resultMap.idResultMappings &#x3D; new ArrayListResultMapping();<br>    resultMap.constructorResultMappings &#x3D; new ArrayListResultMapping();<br>    resultMap.propertyResultMappings &#x3D; new ArrayListResultMapping();<br>    final ListString constructorArgNames &#x3D; new ArrayListString();</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">for</span> <span class="token punctuation">(</span>ResultMapping resultMapping <span class="token operator">:</span> resultMap<span class="token punctuation">.</span>resultMappings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/*
     * 检测 association 或 collection 节点
     * 是否包含 select 和 resultMap 属性
     */</span>
    resultMap<span class="token punctuation">.</span>hasNestedQueries <span class="token operator">=</span> resultMap<span class="token punctuation">.</span>hasNestedQueries <span class="token operator">||</span> resultMapping<span class="token punctuation">.</span><span class="token function">getNestedQueryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">;</span>
    resultMap<span class="token punctuation">.</span>hasNestedResultMaps <span class="token operator">=</span>
        resultMap<span class="token punctuation">.</span>hasNestedResultMaps <span class="token operator">||</span> <span class="token punctuation">(</span>resultMapping<span class="token punctuation">.</span><span class="token function">getNestedResultMapId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> resultMapping<span class="token punctuation">.</span><span class="token function">getResultSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> String column <span class="token operator">=</span> resultMapping<span class="token punctuation">.</span><span class="token function">getColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>column <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 将 colum 转换成大写，并添加到 mappedColumns 集合中</span>
        resultMap<span class="token punctuation">.</span>mappedColumns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>column<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resultMapping<span class="token punctuation">.</span><span class="token function">isCompositeResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>ResultMapping compositeResultMapping <span class="token operator">:</span> resultMapping<span class="token punctuation">.</span><span class="token function">getComposites</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> String compositeColumn <span class="token operator">=</span> compositeResultMapping<span class="token punctuation">.</span><span class="token function">getColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>compositeColumn <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resultMap<span class="token punctuation">.</span>mappedColumns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>compositeColumn<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 添加属性 property 到 mappedProperties 集合中</span>
    <span class="token keyword">final</span> String property <span class="token operator">=</span> resultMapping<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultMap<span class="token punctuation">.</span>mappedProperties<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 检测当前 resultMapping 是否包含 CONSTRUCTOR 标志</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resultMapping<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ResultFlag<span class="token punctuation">.</span>CONSTRUCTOR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 添加 resultMapping 到 constructorResultMappings 中</span>
        resultMap<span class="token punctuation">.</span>constructorResultMappings<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>resultMapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 添加属性（constructor 节点的 name 属性）到 constructorArgNames 中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resultMapping<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            constructorArgNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>resultMapping<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 添加 resultMapping 到 propertyResultMappings 中</span>
        resultMap<span class="token punctuation">.</span>propertyResultMappings<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>resultMapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>resultMapping<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ResultFlag<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 添加 resultMapping 到 idResultMappings 中</span>
        resultMap<span class="token punctuation">.</span>idResultMappings<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>resultMapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span>idResultMappings<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    resultMap<span class="token punctuation">.</span>idResultMappings<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span>resultMappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>constructorArgNames<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获取构造方法参数列表，篇幅原因，这个方法不分析了</span>
    <span class="token keyword">final</span> ListString actualArgNames <span class="token operator">=</span> <span class="token function">argNamesOfMatchingConstructor</span><span class="token punctuation">(</span>constructorArgNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>actualArgNames <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Error in result map '"</span> <span class="token operator">+</span> resultMap<span class="token punctuation">.</span>id
            <span class="token operator">+</span> <span class="token string">"'. Failed to find a constructor in '"</span>
            <span class="token operator">+</span> resultMap<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"' by arg names "</span> <span class="token operator">+</span> constructorArgNames
            <span class="token operator">+</span> <span class="token string">". There might be more info in debug log."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 对 constructorResultMappings 按照构造方法参数列表的顺序进行排序</span>
    Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span>constructorResultMappings<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ComparatorResultMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span>ResultMapping o1<span class="token punctuation">,</span> ResultMapping o2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> paramIdx1 <span class="token operator">=</span> actualArgNames<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>o1<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> paramIdx2 <span class="token operator">=</span> actualArgNames<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>o2<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> paramIdx1 <span class="token operator">-</span> paramIdx2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 将以下这些集合变为不可修改集合</span>
resultMap<span class="token punctuation">.</span>resultMappings <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span>resultMappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
resultMap<span class="token punctuation">.</span>idResultMappings <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span>idResultMappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
resultMap<span class="token punctuation">.</span>constructorResultMappings <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span>constructorResultMappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
resultMap<span class="token punctuation">.</span>propertyResultMappings <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span>propertyResultMappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
resultMap<span class="token punctuation">.</span>mappedColumns <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableSet</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span>mappedColumns<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>以上代码看起来很复杂，实际上这是假象。以上代码主要做的事情就是将 ResultMapping 实例及属性分别存储到不同的集合中，仅此而已。ResultMap 中定义了五种不同的集合，下面分别介绍一下这几种集合。</p>
<tr class="header">|集合名称|用途</tr>|------

<p>上面干巴巴的描述不够直观。下面我们写点代码测试一下，并把这些集合的内容打印到控制台上，大家直观感受一下。先定义一个映射文件，如下：</p>
<td class="line_numbers"><pre>123456789101112</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">mapper namespace="xyz.coolblog.dao.ArticleDao"    resultMap id="articleResult" type="xyz.coolblog.model.Article"        constructor            idArg column="id" name="id"/            arg column="title" name="title"/            arg column="content" name="content"/        /constructor        id property="id" column="id"/        result property="author" column="author"/        result property="createTime" column="create_time"/    /resultMap/mapper</pre></td>

<p>mapper namespace&#x3D;”xyz.coolblog.dao.ArticleDao”<br>    resultMap id&#x3D;”articleResult” type&#x3D;”xyz.coolblog.model.Article”<br>        constructor<br>            idArg column&#x3D;”id” name&#x3D;”id”&#x2F;<br>            arg column&#x3D;”title” name&#x3D;”title”&#x2F;<br>            arg column&#x3D;”content” name&#x3D;”content”&#x2F;<br>        &#x2F;constructor<br>        id property&#x3D;”id” column&#x3D;”id”&#x2F;<br>        result property&#x3D;”author” column&#x3D;”author”&#x2F;<br>        result property&#x3D;”createTime” column&#x3D;”create_time”&#x2F;<br>    &#x2F;resultMap<br>&#x2F;mapper</p>
<p>测试代码如下：</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536373839</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public class ResultMapTest {     @Test    public void printResultMapInfo() throws Exception {        Configuration configuration = new Configuration();        String resource = "mapper/ArticleMapper.xml";        InputStream inputStream = Resources.getResourceAsStream(resource);        XMLMapperBuilder builder = new XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments());        builder.parse();         ResultMap resultMap = configuration.getResultMap("articleResult");         System.out.println("\n-------------------+✨ mappedColumns ✨+--------------------");        System.out.println(resultMap.getMappedColumns());         System.out.println("\n------------------+✨ mappedProperties ✨+------------------");        System.out.println(resultMap.getMappedProperties());         System.out.println("\n------------------+✨ idResultMappings ✨+------------------");        resultMap.getIdResultMappings().forEach(rm - System.out.println(simplify(rm)));         System.out.println("\n---------------+✨ propertyResultMappings ✨+---------------");        resultMap.getPropertyResultMappings().forEach(rm - System.out.println(simplify(rm)));         System.out.println("\n-------------+✨ constructorResultMappings ✨+--------------");        resultMap.getConstructorResultMappings().forEach(rm - System.out.println(simplify(rm)));         System.out.println("\n-------------------+✨ resultMappings ✨+-------------------");        resultMap.getResultMappings().forEach(rm - System.out.println(simplify(rm)));         inputStream.close();    }     /** 简化 ResultMapping 输出结果 */    private String simplify(ResultMapping resultMapping) {        return String.format("ResultMapping{column='%s', property='%s', flags=%s, ...}",            resultMapping.getColumn(), resultMapping.getProperty(), resultMapping.getFlags());    }}</pre></td>

<p>public class ResultMapTest {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printResultMapInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
    Configuration configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    String resource <span class="token operator">=</span> <span class="token string">"mapper/ArticleMapper.xml"</span><span class="token punctuation">;</span>
    InputStream inputStream <span class="token operator">=</span> Resources<span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    XMLMapperBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperBuilder</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ResultMap resultMap <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getResultMap</span><span class="token punctuation">(</span><span class="token string">"articleResult"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n-------------------+✨ mappedColumns ✨+--------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">getMappedColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n------------------+✨ mappedProperties ✨+------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">getMappedProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n------------------+✨ idResultMappings ✨+------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resultMap<span class="token punctuation">.</span><span class="token function">getIdResultMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>rm <span class="token operator">-</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">simplify</span><span class="token punctuation">(</span>rm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n---------------+✨ propertyResultMappings ✨+---------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resultMap<span class="token punctuation">.</span><span class="token function">getPropertyResultMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>rm <span class="token operator">-</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">simplify</span><span class="token punctuation">(</span>rm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n-------------+✨ constructorResultMappings ✨+--------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resultMap<span class="token punctuation">.</span><span class="token function">getConstructorResultMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>rm <span class="token operator">-</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">simplify</span><span class="token punctuation">(</span>rm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n-------------------+✨ resultMappings ✨+-------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    resultMap<span class="token punctuation">.</span><span class="token function">getResultMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>rm <span class="token operator">-</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">simplify</span><span class="token punctuation">(</span>rm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/** 简化 ResultMapping 输出结果 */</span>
<span class="token keyword">private</span> String <span class="token function">simplify</span><span class="token punctuation">(</span>ResultMapping resultMapping<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"ResultMapping{column='%s', property='%s', flags=%s, ...}"</span><span class="token punctuation">,</span>
        resultMapping<span class="token punctuation">.</span><span class="token function">getColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resultMapping<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resultMapping<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>这里，我们把5个集合转给你的内容都打印出来，结果如下：</p>
<img class=" aligncenter" title="MyBatis 源码分析 - 映射文件解析过程" src="https://www.javazhiyin.com/wp-content/uploads/2018/07/6-1532922959.jpeg" src="https://www.javazhiyin.com/wp-content/themes/mnews/images/post-loading.gif" alt="MyBatis 源码分析 - 映射文件解析过程">

<p>如上，结果比较清晰明了，不需要过多解释了。我们参照上面配置文件及输出的结果，把 ResultMap 的大致轮廓画出来。如下：</p>
<img class=" aligncenter" title="MyBatis 源码分析 - 映射文件解析过程" src="https://www.javazhiyin.com/wp-content/uploads/2018/07/2-1532922959.jpeg" src="https://www.javazhiyin.com/wp-content/themes/mnews/images/post-loading.gif" alt="MyBatis 源码分析 - 映射文件解析过程">

<p>到这里，resultMap 节点的解析过程就分析完了。总的来说，该节点的解析过程还是比较复杂的。好了，其他的就不多说了，继续后面的分析。</p>
<h4 id="2-1-4-解析-sql-节点"><a href="#2-1-4-解析-sql-节点" class="headerlink" title="2.1.4 解析 sql 节点"></a>2.1.4 解析 sql 节点</h4><p>sql 节点用来定义一些可重用的 SQL 语句片段，比如表名，或表的列名等。在映射文件中，我们可以通过 include 节点引用 sql 节点定义的内容。下面我来演示一下 sql 节点的使用方式，如下：</p>
<td class="line_numbers"><pre>1234567891011</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">sql id="table"    article/sql select id="findOne" resultType="Article"    SELECT id, title FROM include refid="table"/ WHERE id = #{id}/select update id="update" parameterType="Article"    UPDATE include refid="table"/ SET title = #{title} WHERE id = #{id}/update</pre></td>

<p>sql id&#x3D;”table”<br>    article<br>&#x2F;sql</p>
<p>select id&#x3D;”findOne” resultType&#x3D;”Article”<br>    SELECT id, title FROM include refid&#x3D;”table”&#x2F; WHERE id &#x3D; #{id}<br>&#x2F;select</p>
<p>update id&#x3D;”update” parameterType&#x3D;”Article”<br>    UPDATE include refid&#x3D;”table”&#x2F; SET title &#x3D; #{title} WHERE id &#x3D; #{id}<br>&#x2F;update</p>
<p>如上，上面配置中，select 和 update 节点通过 include 引入定义在 sql 节点中的表名。上面的配置比较常规，除了静态文本，sql 节点还支持属性占位符 ${}。比如：</p>
<td class="line_numbers"><pre>123</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">sql id="table"    ${table_prefix}_article/sql</pre></td>

<p>sql id&#x3D;”table”<br>    ${table_prefix}_article<br>&#x2F;sql</p>
<p>如果属性 table_prefix &#x3D; blog，那么 sql 节点中的内容最终为 blog_article。</p>
<p>上面介绍了 sql 节点的用法，比较容易。下面分析一下 sql 节点的解析过程，如下：</p>
<td class="line_numbers"><pre>123456789</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void sqlElement(ListXNode list) throws Exception {    if (configuration.getDatabaseId() != null) {        // 调用 sqlElement 解析 sql 节点        sqlElement(list, configuration.getDatabaseId());    }     // 再次调用 sqlElement，不同的是，这次调用，该方法的第二个参数为 null    sqlElement(list, null);}</pre></td>

<p>private void sqlElement(ListXNode list) throws Exception {<br>    if (configuration.getDatabaseId() !&#x3D; null) {<br>        &#x2F;&#x2F; 调用 sqlElement 解析 sql 节点<br>        sqlElement(list, configuration.getDatabaseId());<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 再次调用 sqlElement，不同的是，这次调用，该方法的第二个参数为 null</span>
<span class="token function">sqlElement</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>这个方法需要大家注意一下，如果 Configuration 的 databaseId 不为空，sqlElement 方法会被调用了两次。第一次传入具体的 databaseId，用于解析带有 databaseId 属性，且属性值与此相等的 sql 节点。第二次传入的 databaseId 为空，用于解析未配置 databaseId 属性的 sql 节点。这里是个小细节，大家注意一下就好。我们继续往下分析。</p>
<td class="line_numbers"><pre>12345678910111213141516</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void sqlElement(ListXNode list, String requiredDatabaseId) throws Exception {    for (XNode context : list) {        // 获取 id 和 databaseId 属性        String databaseId = context.getStringAttribute("databaseId");        String id = context.getStringAttribute("id");         // id = currentNamespace + "." + id        id = builderAssistant.applyCurrentNamespace(id, false);         // 检测当前 databaseId 和 requiredDatabaseId 是否一致        if (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) {            // 将 id, XNode 键值对缓存到 sqlFragments 中            sqlFragments.put(id, context);        }    }}</pre></td>

<p>private void sqlElement(ListXNode list, String requiredDatabaseId) throws Exception {<br>    for (XNode context : list) {<br>        &#x2F;&#x2F; 获取 id 和 databaseId 属性<br>        String databaseId &#x3D; context.getStringAttribute(“databaseId”);<br>        String id &#x3D; context.getStringAttribute(“id”);</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// id = currentNamespace + "." + id</span>
    id <span class="token operator">=</span> builderAssistant<span class="token punctuation">.</span><span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 检测当前 databaseId 和 requiredDatabaseId 是否一致</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">databaseIdMatchesCurrent</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> databaseId<span class="token punctuation">,</span> requiredDatabaseId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 将 id, XNode 键值对缓存到 sqlFragments 中</span>
        sqlFragments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>这个方法逻辑比较简单，首先是获取 sql 节点的 id 和 databaseId 属性，然后为 id 属性值拼接命名空间。最后，通过检测当前 databaseId 和 requiredDatabaseId 是否一致，来决定保存还是忽略当前的 sql 节点。下面，我们来看一下 databaseId 的匹配逻辑是怎样的。</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private boolean databaseIdMatchesCurrent(String id, String databaseId, String requiredDatabaseId) {    if (requiredDatabaseId != null) {        // 当前 databaseId 和目标 databaseId 不一致时，返回 false        if (!requiredDatabaseId.equals(databaseId)) {            return false;        }    } else {        // 如果目标 databaseId 为空，但当前 databaseId 不为空。两者不一致，返回 false        if (databaseId != null) {            return false;        }        /*         * 如果当前 sql 节点的 id 与之前的 sql 节点重复，且先前节点          * databaseId 不为空。则忽略当前节点，并返回 false         */        if (this.sqlFragments.containsKey(id)) {            XNode context = this.sqlFragments.get(id);            if (context.getStringAttribute("databaseId") != null) {                return false;            }        }    }    return true;}</pre></td>

<p>private boolean databaseIdMatchesCurrent(String id, String databaseId, String requiredDatabaseId) {<br>    if (requiredDatabaseId !&#x3D; null) {<br>        &#x2F;&#x2F; 当前 databaseId 和目标 databaseId 不一致时，返回 false<br>        if (!requiredDatabaseId.equals(databaseId)) {<br>            return false;<br>        }<br>    } else {<br>        &#x2F;&#x2F; 如果目标 databaseId 为空，但当前 databaseId 不为空。两者不一致，返回 false<br>        if (databaseId !&#x3D; null) {<br>            return false;<br>        }<br>        &#x2F;*<br>         * 如果当前 sql 节点的 id 与之前的 sql 节点重复，且先前节点<br>         * databaseId 不为空。则忽略当前节点，并返回 false<br>         *&#x2F;<br>        if (this.sqlFragments.containsKey(id)) {<br>            XNode context &#x3D; this.sqlFragments.get(id);<br>            if (context.getStringAttribute(“databaseId”) !&#x3D; null) {<br>                return false;<br>            }<br>        }<br>    }<br>    return true;<br>}</p>
<p>下面总结一下 databaseId 的匹配规则。</p>
<ol>
<li>databaseId 与 requiredDatabaseId 不一致，即失配，返回 false</li>
<li>当前节点与之前的节点出现 id 重复的情况，若之前的 sql 节点 databaseId 属性不为空，返回 false</li>
<li>若以上两条规则均匹配失败，此时返回 true</li>
</ol>
<p>在上面三条匹配规则中，第二条规则稍微难理解一点。这里简单分析一下，考虑下面这种配置。</p>
<td class="line_numbers"><pre>123456789</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">!-- databaseId 不为空 --sql id="table" databaseId="mysql"    article/sql !-- databaseId 为空 --sql id="table"    article/sql</pre></td>

<p>!– databaseId 不为空 –<br>sql id&#x3D;”table” databaseId&#x3D;”mysql”<br>    article<br>&#x2F;sql</p>
<p>!– databaseId 为空 –<br>sql id&#x3D;”table”<br>    article<br>&#x2F;sql</p>
<p>在上面配置中，两个 sql 节点的 id 属性值相同，databaseId 属性不一致。假设 configuration.databaseId &#x3D; mysql，第一次调用 sqlElement 方法，第一个 sql 节点对应的 XNode 会被放入到 sqlFragments 中。第二次调用 sqlElement 方法时，requiredDatabaseId 参数为空。由于 sqlFragments 中已包含了一个 id 节点，且该节点的 databaseId 不为空，此时匹配逻辑返回 false，第二个节点不会被保存到 sqlFragments。</p>
<p>上面的分析内容涉及到了 databaseId，关于 databaseId 的用途，这里简单介绍一下。databaseId 用于标明数据库厂商的身份，不同厂商有自己的 SQL 方言，MyBatis 可以根据 databaseId 执行不同 SQL 语句。databaseId 在 sql 节点中有什么用呢？这个问题也不难回答。sql 节点用于保存 SQL 语句片段，如果 SQL 语句片段中包含方言的话，那么该 sql 节点只能被同一 databaseId 的查询语句或更新语句引用。关于 databaseId，这里就介绍这么多。</p>
<p>好了，本节内容先到这里。继续往下分析。</p>
<h4 id="2-1-5-解析-SQL-语句节点"><a href="#2-1-5-解析-SQL-语句节点" class="headerlink" title="2.1.5 解析 SQL 语句节点"></a>2.1.5 解析 SQL 语句节点</h4><p>前面分析了 cache、cache-ref、resultMap 以及 sql 节点，从这一节开始，我们要分析映射文件中剩余的几个节点，分别是 select、insert、update 以及 delete 等。这几个节点中存储的是相同的内容，都是 SQL 语句，所以这几个节点的解析过程也是相同的。在进行代码分析之前，这里需要特别说明一下：为了避免和 sql 节点混淆，同时也为了描述方便，这里把 select、insert、update 以及 delete 等节点统称为 SQL 语句节点。好了，下面开始本节的分析。</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void buildStatementFromContext(ListXNode list) {    if (configuration.getDatabaseId() != null) {        // 调用重载方法构建 Statement        buildStatementFromContext(list, configuration.getDatabaseId());    }    // 调用重载方法构建 Statement，requiredDatabaseId 参数为空    buildStatementFromContext(list, null);} private void buildStatementFromContext(ListXNode list, String requiredDatabaseId) {    for (XNode context : list) {        // 创建 Statement 建造类        final XMLStatementBuilder statementParser = new XMLStatementBuilder(configuration, builderAssistant, context, requiredDatabaseId);        try {            /*             * 解析 Statement 节点，并将解析结果存储到              * configuration 的 mappedStatements 集合中             */            statementParser.parseStatementNode();        } catch (IncompleteElementException e) {            // 解析失败，将解析器放入 configuration 的 incompleteStatements 集合中            configuration.addIncompleteStatement(statementParser);        }    }}</pre></td>

<p>private void buildStatementFromContext(ListXNode list) {<br>    if (configuration.getDatabaseId() !&#x3D; null) {<br>        &#x2F;&#x2F; 调用重载方法构建 Statement<br>        buildStatementFromContext(list, configuration.getDatabaseId());<br>    }<br>    &#x2F;&#x2F; 调用重载方法构建 Statement，requiredDatabaseId 参数为空<br>    buildStatementFromContext(list, null);<br>}</p>
<p>private void buildStatementFromContext(ListXNode list, String requiredDatabaseId) {<br>    for (XNode context : list) {<br>        &#x2F;&#x2F; 创建 Statement 建造类<br>        final XMLStatementBuilder statementParser &#x3D; new XMLStatementBuilder(configuration, builderAssistant, context, requiredDatabaseId);<br>        try {<br>            &#x2F;*<br>             * 解析 Statement 节点，并将解析结果存储到<br>             * configuration 的 mappedStatements 集合中<br>             *&#x2F;<br>            statementParser.parseStatementNode();<br>        } catch (IncompleteElementException e) {<br>            &#x2F;&#x2F; 解析失败，将解析器放入 configuration 的 incompleteStatements 集合中<br>            configuration.addIncompleteStatement(statementParser);<br>        }<br>    }<br>}</p>
<p>上面的解析方法没有什么实质性的解析逻辑，我们继续往下分析。</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public void parseStatementNode() {    // 获取 id 和 databaseId 属性    String id = context.getStringAttribute("id");    String databaseId = context.getStringAttribute("databaseId");     // 根据 databaseId 进行检测，检测逻辑和上一节基本一致，这里不再赘述    if (!databaseIdMatchesCurrent(id, databaseId, this.requiredDatabaseId)) {        return;    }     // 获取各种属性    Integer fetchSize = context.getIntAttribute("fetchSize");    Integer timeout = context.getIntAttribute("timeout");    String parameterMap = context.getStringAttribute("parameterMap");    String parameterType = context.getStringAttribute("parameterType");    Class? parameterTypeClass = resolveClass(parameterType);    String resultMap = context.getStringAttribute("resultMap");    String resultType = context.getStringAttribute("resultType");    String lang = context.getStringAttribute("lang");    LanguageDriver langDriver = getLanguageDriver(lang);     // 通过别名解析 resultType 对应的类型    Class? resultTypeClass = resolveClass(resultType);    String resultSetType = context.getStringAttribute("resultSetType");     // 解析 Statement 类型，默认为 PREPARED    StatementType statementType = StatementType.valueOf(context.getStringAttribute("statementType", StatementType.PREPARED.toString()));     // 解析 ResultSetType    ResultSetType resultSetTypeEnum = resolveResultSetType(resultSetType);     // 获取节点的名称，比如 select 节点名称为 select    String nodeName = context.getNode().getNodeName();    // 根据节点名称解析 SqlCommandType    SqlCommandType sqlCommandType = SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));    boolean isSelect = sqlCommandType == SqlCommandType.SELECT;    boolean flushCache = context.getBooleanAttribute("flushCache", !isSelect);    boolean useCache = context.getBooleanAttribute("useCache", isSelect);    boolean resultOrdered = context.getBooleanAttribute("resultOrdered", false);     // 解析 include 节点    XMLIncludeTransformer includeParser = new XMLIncludeTransformer(configuration, builderAssistant);    includeParser.applyIncludes(context.getNode());     // 解析 selectKey 节点    processSelectKeyNodes(id, parameterTypeClass, langDriver);     // 解析 SQL 语句    SqlSource sqlSource = langDriver.createSqlSource(configuration, context, parameterTypeClass);    String resultSets = context.getStringAttribute("resultSets");    String keyProperty = context.getStringAttribute("keyProperty");    String keyColumn = context.getStringAttribute("keyColumn");     KeyGenerator keyGenerator;    String keyStatementId = id + SelectKeyGenerator.SELECT_KEY_SUFFIX;    keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, true);    if (configuration.hasKeyGenerator(keyStatementId)) {        // 获取 KeyGenerator 实例        keyGenerator = configuration.getKeyGenerator(keyStatementId);    } else {        // 创建 KeyGenerator 实例        keyGenerator = context.getBooleanAttribute("useGeneratedKeys",            configuration.isUseGeneratedKeys() && SqlCommandType.INSERT.equals(sqlCommandType)) ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;    }     /*     * 构建 MappedStatement 对象，并将该对象存储到      * Configuration 的 mappedStatements 集合中     */    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,        fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,        resultSetTypeEnum, flushCache, useCache, resultOrdered,        keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);}</pre></td>

<p>public void parseStatementNode() {<br>    &#x2F;&#x2F; 获取 id 和 databaseId 属性<br>    String id &#x3D; context.getStringAttribute(“id”);<br>    String databaseId &#x3D; context.getStringAttribute(“databaseId”);</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 根据 databaseId 进行检测，检测逻辑和上一节基本一致，这里不再赘述</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">databaseIdMatchesCurrent</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> databaseId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requiredDatabaseId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 获取各种属性</span>
Integer fetchSize <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getIntAttribute</span><span class="token punctuation">(</span><span class="token string">"fetchSize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Integer timeout <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getIntAttribute</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String parameterMap <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"parameterMap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String parameterType <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"parameterType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Class<span class="token operator">?</span> parameterTypeClass <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>parameterType<span class="token punctuation">)</span><span class="token punctuation">;</span>
String resultMap <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resultMap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String resultType <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resultType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String lang <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"lang"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
LanguageDriver langDriver <span class="token operator">=</span> <span class="token function">getLanguageDriver</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 通过别名解析 resultType 对应的类型</span>
Class<span class="token operator">?</span> resultTypeClass <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>resultType<span class="token punctuation">)</span><span class="token punctuation">;</span>
String resultSetType <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resultSetType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 解析 Statement 类型，默认为 PREPARED</span>
StatementType statementType <span class="token operator">=</span> StatementType<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"statementType"</span><span class="token punctuation">,</span> StatementType<span class="token punctuation">.</span>PREPARED<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 解析 ResultSetType</span>
ResultSetType resultSetTypeEnum <span class="token operator">=</span> <span class="token function">resolveResultSetType</span><span class="token punctuation">(</span>resultSetType<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 获取节点的名称，比如 select 节点名称为 select</span>
String nodeName <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 根据节点名称解析 SqlCommandType</span>
SqlCommandType sqlCommandType <span class="token operator">=</span> SqlCommandType<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>nodeName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> isSelect <span class="token operator">=</span> sqlCommandType <span class="token operator">==</span> SqlCommandType<span class="token punctuation">.</span>SELECT<span class="token punctuation">;</span>
<span class="token keyword">boolean</span> flushCache <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">"flushCache"</span><span class="token punctuation">,</span> <span class="token operator">!</span>isSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> useCache <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">"useCache"</span><span class="token punctuation">,</span> isSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> resultOrdered <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">"resultOrdered"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 解析 include 节点</span>
XMLIncludeTransformer includeParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLIncludeTransformer</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> builderAssistant<span class="token punctuation">)</span><span class="token punctuation">;</span>
includeParser<span class="token punctuation">.</span><span class="token function">applyIncludes</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 解析 selectKey 节点</span>
<span class="token function">processSelectKeyNodes</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">,</span> langDriver<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 解析 SQL 语句</span>
SqlSource sqlSource <span class="token operator">=</span> langDriver<span class="token punctuation">.</span><span class="token function">createSqlSource</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> context<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
String resultSets <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resultSets"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String keyProperty <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"keyProperty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String keyColumn <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"keyColumn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

KeyGenerator keyGenerator<span class="token punctuation">;</span>
String keyStatementId <span class="token operator">=</span> id <span class="token operator">+</span> SelectKeyGenerator<span class="token punctuation">.</span>SELECT_KEY_SUFFIX<span class="token punctuation">;</span>
keyStatementId <span class="token operator">=</span> builderAssistant<span class="token punctuation">.</span><span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>keyStatementId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">hasKeyGenerator</span><span class="token punctuation">(</span>keyStatementId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获取 KeyGenerator 实例</span>
    keyGenerator <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getKeyGenerator</span><span class="token punctuation">(</span>keyStatementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建 KeyGenerator 实例</span>
    keyGenerator <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">"useGeneratedKeys"</span><span class="token punctuation">,</span>
        configuration<span class="token punctuation">.</span><span class="token function">isUseGeneratedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> SqlCommandType<span class="token punctuation">.</span>INSERT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>sqlCommandType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> Jdbc3KeyGenerator<span class="token punctuation">.</span>INSTANCE <span class="token operator">:</span> NoKeyGenerator<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*
 * 构建 MappedStatement 对象，并将该对象存储到 
 * Configuration 的 mappedStatements 集合中
 */</span>
builderAssistant<span class="token punctuation">.</span><span class="token function">addMappedStatement</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> sqlSource<span class="token punctuation">,</span> statementType<span class="token punctuation">,</span> sqlCommandType<span class="token punctuation">,</span>
    fetchSize<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> parameterMap<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">,</span> resultMap<span class="token punctuation">,</span> resultTypeClass<span class="token punctuation">,</span>
    resultSetTypeEnum<span class="token punctuation">,</span> flushCache<span class="token punctuation">,</span> useCache<span class="token punctuation">,</span> resultOrdered<span class="token punctuation">,</span>
    keyGenerator<span class="token punctuation">,</span> keyProperty<span class="token punctuation">,</span> keyColumn<span class="token punctuation">,</span> databaseId<span class="token punctuation">,</span> langDriver<span class="token punctuation">,</span> resultSets<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面的代码比较长，看起来有点复杂。不过如果大家耐心看一下源码，会发现，上面的代码中起码有一般的代码都是用来获取节点属性，以及解析部分属性等。抛去这部分代码，以上代码做的事情如下。</p>
<ol>
<li>解析 include 节点</li>
<li>解析 selectKey 节点</li>
<li>解析 SQL，获取 SqlSource</li>
<li>构建 MappedStatement 实例</li>
</ol>
<p>以上流程对应的代码比较复杂，每个步骤都能分析出一些东西来。下面我会每个步骤都进行分析，首先来分析 include 节点的解析过程。</p>
<h5 id="2-1-5-1-解析-include-节点"><a href="#2-1-5-1-解析-include-节点" class="headerlink" title="2.1.5.1 解析 include 节点"></a>2.1.5.1 解析 include 节点</h5><p>include 节点的解析逻辑封装在 applyIncludes 中，该方法的代码如下：</p>
<td class="line_numbers"><pre>1234567891011</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public void applyIncludes(Node source) {    Properties variablesContext = new Properties();    Properties configurationVariables = configuration.getVariables();    if (configurationVariables != null) {        // 将 configurationVariables 中的数据添加到 variablesContext 中        variablesContext.putAll(configurationVariables);    }     // 调用重载方法处理 include 节点    applyIncludes(source, variablesContext, false);}</pre></td>

<p>public void applyIncludes(Node source) {<br>    Properties variablesContext &#x3D; new Properties();<br>    Properties configurationVariables &#x3D; configuration.getVariables();<br>    if (configurationVariables !&#x3D; null) {<br>        &#x2F;&#x2F; 将 configurationVariables 中的数据添加到 variablesContext 中<br>        variablesContext.putAll(configurationVariables);<br>    }</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 调用重载方法处理 include 节点</span>
<span class="token function">applyIncludes</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> variablesContext<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面代码创建了一个新的 Properties 对象，并将全局 Properties 添加到其中。这样做的原因是 applyIncludes 的重载方法会向 Properties 中添加新的元素，如果直接将全局 Properties 传给重载方法，会造成全局 Properties 被污染。这是个小细节，一般容易被忽视掉。其他没什么需要注意的了，我们继续往下看。</p>
<td class="line_numbers"><pre>1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void applyIncludes(Node source, final Properties variablesContext, boolean included) {     // ⭐️ 第一个条件分支    if (source.getNodeName().equals("include")) {         /*         * 获取 sql 节点。若 refid 中包含属性占位符 ${}，         * 则需先将属性占位符替换为对应的属性值         */        Node toInclude = findSqlFragment(getStringAttribute(source, "refid"), variablesContext);         /*         * 解析 include 的子节点 property，并将解析结果与 variablesContext 融合，         * 然后返回融合后的 Properties。若 property 节点的 value 属性中存在占位符 ${}，         * 则将占位符替换为对应的属性值         */        Properties toIncludeContext = getVariablesContext(source, variablesContext);         /*         * 这里是一个递归调用，用于将 sql 节点内容中出现的属性占位符 ${} 替换为对应的         * 属性值。这里要注意一下递归调用的参数：         *          *  - toInclude：sql 节点对象         *  - toIncludeContext：include 子节点 property 的解析结果与         *                      全局变量融合后的结果          */        applyIncludes(toInclude, toIncludeContext, true);         /*         * 如果 sql 和 include 节点不在一个文档中，         * 则从其他文档中将 sql 节点引入到 include 所在文档中         */        if (toInclude.getOwnerDocument() != source.getOwnerDocument()) {            toInclude = source.getOwnerDocument().importNode(toInclude, true);        }        // 将 include 节点替换为 sql 节点        source.getParentNode().replaceChild(toInclude, source);        while (toInclude.hasChildNodes()) {            // 将 sql 中的内容插入到 sql 节点之前            toInclude.getParentNode().insertBefore(toInclude.getFirstChild(), toInclude);        }         /*         * 前面已经将 sql 节点的内容插入到 dom 中了，         * 现在不需要 sql 节点了，这里将该节点从 dom 中移除         */        toInclude.getParentNode().removeChild(toInclude);     // ⭐️ 第二个条件分支    } else if (source.getNodeType() == Node.ELEMENT_NODE) {        if (included && !variablesContext.isEmpty()) {            NamedNodeMap attributes = source.getAttributes();            for (int i = 0; i  attributes.getLength(); i++) {                Node attr = attributes.item(i);                // 将 source 节点属性中的占位符 ${} 替换成具体的属性值                attr.setNodeValue(PropertyParser.parse(attr.getNodeValue(), variablesContext));            }        }         NodeList children = source.getChildNodes();        for (int i = 0; i  children.getLength(); i++) {            // 递归调用            applyIncludes(children.item(i), variablesContext, included);        }     // ⭐️ 第三个条件分支    } else if (included && source.getNodeType() == Node.TEXT_NODE && !variablesContext.isEmpty()) {        // 将文本（text）节点中的属性占位符 ${} 替换成具体的属性值        source.setNodeValue(PropertyParser.parse(source.getNodeValue(), variablesContext));    }}</pre></td>

<p>private void applyIncludes(Node source, final Properties variablesContext, boolean included) {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// ⭐️ 第一个条件分支</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"include"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/*
     * 获取 sql 节点。若 refid 中包含属性占位符 ${}，
     * 则需先将属性占位符替换为对应的属性值
     */</span>
    Node toInclude <span class="token operator">=</span> <span class="token function">findSqlFragment</span><span class="token punctuation">(</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token string">"refid"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> variablesContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*
     * 解析 include 的子节点 property，并将解析结果与 variablesContext 融合，
     * 然后返回融合后的 Properties。若 property 节点的 value 属性中存在占位符 ${}，
     * 则将占位符替换为对应的属性值
     */</span>
    Properties toIncludeContext <span class="token operator">=</span> <span class="token function">getVariablesContext</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> variablesContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*
     * 这里是一个递归调用，用于将 sql 节点内容中出现的属性占位符 ${} 替换为对应的
     * 属性值。这里要注意一下递归调用的参数：
     * 
     *  - toInclude：sql 节点对象
     *  - toIncludeContext：include 子节点 property 的解析结果与
     *                      全局变量融合后的结果 
     */</span>
    <span class="token function">applyIncludes</span><span class="token punctuation">(</span>toInclude<span class="token punctuation">,</span> toIncludeContext<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*
     * 如果 sql 和 include 节点不在一个文档中，
     * 则从其他文档中将 sql 节点引入到 include 所在文档中
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>toInclude<span class="token punctuation">.</span><span class="token function">getOwnerDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> source<span class="token punctuation">.</span><span class="token function">getOwnerDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        toInclude <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">getOwnerDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">importNode</span><span class="token punctuation">(</span>toInclude<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 将 include 节点替换为 sql 节点</span>
    source<span class="token punctuation">.</span><span class="token function">getParentNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>toInclude<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>toInclude<span class="token punctuation">.</span><span class="token function">hasChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 将 sql 中的内容插入到 sql 节点之前</span>
        toInclude<span class="token punctuation">.</span><span class="token function">getParentNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>toInclude<span class="token punctuation">.</span><span class="token function">getFirstChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> toInclude<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/*
     * 前面已经将 sql 节点的内容插入到 dom 中了，
     * 现在不需要 sql 节点了，这里将该节点从 dom 中移除
     */</span>
    toInclude<span class="token punctuation">.</span><span class="token function">getParentNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>toInclude<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ⭐️ 第二个条件分支</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Node<span class="token punctuation">.</span>ELEMENT_NODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>included <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>variablesContext<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        NamedNodeMap attributes <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i  attributes<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Node attr <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将 source 节点属性中的占位符 ${} 替换成具体的属性值</span>
            attr<span class="token punctuation">.</span><span class="token function">setNodeValue</span><span class="token punctuation">(</span>PropertyParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span><span class="token function">getNodeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> variablesContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    NodeList children <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i  children<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 递归调用</span>
        <span class="token function">applyIncludes</span><span class="token punctuation">(</span>children<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> variablesContext<span class="token punctuation">,</span> included<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token comment" spellcheck="true">// ⭐️ 第三个条件分支</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>included <span class="token operator">&amp;&amp;</span> source<span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Node<span class="token punctuation">.</span>TEXT_NODE <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>variablesContext<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 将文本（text）节点中的属性占位符 ${} 替换成具体的属性值</span>
    source<span class="token punctuation">.</span><span class="token function">setNodeValue</span><span class="token punctuation">(</span>PropertyParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">getNodeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> variablesContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面的代码如果从上往下读，不太容易看懂。因为上面的方法由三个条件分支，外加两个递归调用组成，代码的执行顺序并不是由上而下。要理解上面的代码，我们需要定义一些配置，并将配置带入到具体代码中，逐行进行演绎。不过，更推荐的方式是使用 IDE 进行单步调试。为了便于讲解，我把上面代码中的三个分支都用 ⭐️ 标记了出来，这个大家注意一下。好了，必要的准备工作做好了，下面开始演绎代码的执行过程。演绎所用的测试配置如下：</p>
<td class="line_numbers"><pre>123456789101112131415</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">mapper namespace="xyz.coolblog.dao.ArticleDao"    sql id="table"        ${table_name}    /sql     select id="findOne" resultType="xyz.coolblog.dao.ArticleDO"        SELECT            id, title        FROM            include refid="table"                property name="table_name" value="article"/            /include        WHERE id = #{id}    /select/mapper</pre></td>

<p>mapper namespace&#x3D;”xyz.coolblog.dao.ArticleDao”<br>    sql id&#x3D;”table”<br>        ${table_name}<br>    &#x2F;sql</p>
<pre class="line-numbers language-java"><code class="language-java">
select id<span class="token operator">=</span><span class="token string">"findOne"</span> resultType<span class="token operator">=</span><span class="token string">"xyz.coolblog.dao.ArticleDO"</span>
    SELECT
        id<span class="token punctuation">,</span> title
    FROM
        include refid<span class="token operator">=</span><span class="token string">"table"</span>
            property name<span class="token operator">=</span><span class="token string">"table_name"</span> value<span class="token operator">=</span><span class="token string">"article"</span><span class="token operator">/</span>
        <span class="token operator">/</span>include
    WHERE id <span class="token operator">=</span> #<span class="token punctuation">{</span>id<span class="token punctuation">}</span>
<span class="token operator">/</span>select
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>&#x2F;mapper</p>
<p>我们先来看一下 applyIncludes 方法第一次被调用时的状态，如下：</p>
<td class="line_numbers"><pre>12345678910</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">参数值：source = select 节点节点类型：ELEMENT_NODEvariablesContext = [ ]  // 无内容 included = false 执行流程：1. 进入条件分支22. 获取 select 子节点列表3. 遍历子节点列表，将子节点作为参数，进行递归调用</pre></td>

<p>参数值：<br>source &#x3D; select 节点<br>节点类型：ELEMENT_NODE<br>variablesContext &#x3D; [ ]  &#x2F;&#x2F; 无内容<br>included &#x3D; false</p>
<p>执行流程：</p>
<ol>
<li>进入条件分支2</li>
<li>获取 select 子节点列表</li>
<li>遍历子节点列表，将子节点作为参数，进行递归调用</li>
</ol>
<p>第一次调用 applyIncludes 方法，source &#x3D; select，代码进入条件分支2。在该分支中，首先要获取 select 节点的子节点列表。可获取到的子节点如下：</p>
<tr class="header"><th style="text-align: left;">编号</th><th style="text-align: left;">子节点</th><th style="text-align: left;">类型</th><th style="text-align: left;">描述</th></tr>|------

<p>在获取到子节点类列表后，接下来要做的事情是遍历列表，然后将子节点作为参数进行递归调用。在上面三个子节点中，子节点1和子节点3都是文本节点，调用过程一致。因此，下面我只会演示子节点1和子节点2的递归调用过程。先来演示子节点1的调用过程，如下：</p>
<img class=" aligncenter" title="MyBatis 源码分析 - 映射文件解析过程" src="https://www.javazhiyin.com/wp-content/uploads/2018/07/7-1532922960.jpeg" src="https://www.javazhiyin.com/wp-content/themes/mnews/images/post-loading.gif" alt="MyBatis 源码分析 - 映射文件解析过程">

<p>节点1的调用过程比较简单，只有两层调用。然后我们在看一下子节点2的调用过程，如下：</p>
<img class=" aligncenter" title="MyBatis 源码分析 - 映射文件解析过程" src="https://www.javazhiyin.com/wp-content/uploads/2018/07/7-1532922961.jpeg" src="https://www.javazhiyin.com/wp-content/themes/mnews/images/post-loading.gif" alt="MyBatis 源码分析 - 映射文件解析过程">

<p>上面是子节点2的调用过程，共有四层调用，略为复杂。大家自己也对着配置，把源码走一遍，然后记录每一次调用的一些状态，这样才能更好的理解 applyIncludes 方法的逻辑。</p>
<p>好了，本节内容先到这里，继续往下分析。</p>
<h5 id="2-1-5-2-解析-selectKey-节点"><a href="#2-1-5-2-解析-selectKey-节点" class="headerlink" title="2.1.5.2 解析 selectKey 节点"></a>2.1.5.2 解析 selectKey 节点</h5><p>对于一些不支持自增主键的数据库来说，我们在插入数据时，需要明确指定主键数据。以 Oracle 数据库为例，Oracle 数据库不支持自增主键，但它提供了自增序列工具。我们每次向数据库中插入数据时，可以先通过自增序列获取主键数据，然后再进行插入。这里涉及到两次数据库查询操作，我们不能在一个 select 节点中同时定义两个 select 语句，否者会导致 SQL 语句出错。对于这个问题，MyBatis 的 selectKey 可以很好的解决。下面我们看一段配置：</p>
<td class="line_numbers"><pre>123456789</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">insert id="saveAuthor"    selectKey keyProperty="id" resultType="int" order="BEFORE"        select author_seq.nextval from dual    /selectKey    insert into Author        (id, name, password)    values        (#{id}, #{username}, #{password})/insert</pre></td>

<p>insert id&#x3D;”saveAuthor”<br>    selectKey keyProperty&#x3D;”id” resultType&#x3D;”int” order&#x3D;”BEFORE”<br>        select author_seq.nextval from dual<br>    &#x2F;selectKey<br>    insert into Author<br>        (id, name, password)<br>    values<br>        (#{id}, #{username}, #{password})<br>&#x2F;insert</p>
<p>在上面的配置中，查询语句会先于插入语句执行，这样我们就可以在插入时获取到主键的值。关于 selectKey 的用法，这里不过多介绍了。下面我们来看一下 selectKey 节点的解析过程。</p>
<td class="line_numbers"><pre>1234567891011</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void processSelectKeyNodes(String id, Class? parameterTypeClass, LanguageDriver langDriver) {    ListXNode selectKeyNodes = context.evalNodes("selectKey");    if (configuration.getDatabaseId() != null) {        // 解析 selectKey 节点，databaseId 不为空        parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, configuration.getDatabaseId());    }    // 解析 selectKey 节点，databaseId 为空    parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, null);    // 将 selectKey 节点从 dom 树中移除    removeSelectKeyNodes(selectKeyNodes);}</pre></td>

<p>private void processSelectKeyNodes(String id, Class? parameterTypeClass, LanguageDriver langDriver) {<br>    ListXNode selectKeyNodes &#x3D; context.evalNodes(“selectKey”);<br>    if (configuration.getDatabaseId() !&#x3D; null) {<br>        &#x2F;&#x2F; 解析 selectKey 节点，databaseId 不为空<br>        parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, configuration.getDatabaseId());<br>    }<br>    &#x2F;&#x2F; 解析 selectKey 节点，databaseId 为空<br>    parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, null);<br>    &#x2F;&#x2F; 将 selectKey 节点从 dom 树中移除<br>    removeSelectKeyNodes(selectKeyNodes);<br>}</p>
<p>从上面的代码中可以看出，selectKey 节点在解析完成后，会被从 dom 树中移除。这样后续可以更专注的解析 insert 或 update 节点中的 SQL，无需再额外处理 selectKey 节点。继续往下看。</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void parseSelectKeyNodes(String parentId, ListXNode list, Class? parameterTypeClass,    LanguageDriver langDriver, String skRequiredDatabaseId) {    for (XNode nodeToHandle : list) {        // id = parentId + !selectKey，比如 saveUser!selectKey        String id = parentId + SelectKeyGenerator.SELECT_KEY_SUFFIX;        // 获取 selectKey 节点的 databaseId 属性        String databaseId = nodeToHandle.getStringAttribute("databaseId");        // 匹配 databaseId        if (databaseIdMatchesCurrent(id, databaseId, skRequiredDatabaseId)) {            // 解析 selectKey 节点            parseSelectKeyNode(id, nodeToHandle, parameterTypeClass, langDriver, databaseId);        }    }} private void parseSelectKeyNode(String id, XNode nodeToHandle, Class? parameterTypeClass,    LanguageDriver langDriver, String databaseId) {     // 获取各种属性    String resultType = nodeToHandle.getStringAttribute("resultType");    Class? resultTypeClass = resolveClass(resultType);    StatementType statementType = StatementType.valueOf(nodeToHandle.getStringAttribute("statementType", StatementType.PREPARED.toString()));    String keyProperty = nodeToHandle.getStringAttribute("keyProperty");    String keyColumn = nodeToHandle.getStringAttribute("keyColumn");    boolean executeBefore = "BEFORE".equals(nodeToHandle.getStringAttribute("order", "AFTER"));     // 设置默认值    boolean useCache = false;    boolean resultOrdered = false;    KeyGenerator keyGenerator = NoKeyGenerator.INSTANCE;    Integer fetchSize = null;    Integer timeout = null;    boolean flushCache = false;    String parameterMap = null;    String resultMap = null;    ResultSetType resultSetTypeEnum = null;     // 创建 SqlSource    SqlSource sqlSource = langDriver.createSqlSource(configuration, nodeToHandle, parameterTypeClass);    /*     * selectKey 节点中只能配置 SELECT 查询语句，     * 因此 sqlCommandType 为 SqlCommandType.SELECT     */    SqlCommandType sqlCommandType = SqlCommandType.SELECT;     /*     * 构建 MappedStatement，并将 MappedStatement      * 添加到 Configuration 的 mappedStatements map 中     */    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,        fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,        resultSetTypeEnum, flushCache, useCache, resultOrdered,        keyGenerator, keyProperty, keyColumn, databaseId, langDriver, null);     // id = namespace + "." + id    id = builderAssistant.applyCurrentNamespace(id, false);    MappedStatement keyStatement = configuration.getMappedStatement(id, false);    // 创建 SelectKeyGenerator，并添加到 keyGenerators map 中    configuration.addKeyGenerator(id, new SelectKeyGenerator(keyStatement, executeBefore));}</pre></td>

<p>private void parseSelectKeyNodes(String parentId, ListXNode list, Class? parameterTypeClass,<br>    LanguageDriver langDriver, String skRequiredDatabaseId) {<br>    for (XNode nodeToHandle : list) {<br>        &#x2F;&#x2F; id &#x3D; parentId + !selectKey，比如 saveUser!selectKey<br>        String id &#x3D; parentId + SelectKeyGenerator.SELECT_KEY_SUFFIX;<br>        &#x2F;&#x2F; 获取 selectKey 节点的 databaseId 属性<br>        String databaseId &#x3D; nodeToHandle.getStringAttribute(“databaseId”);<br>        &#x2F;&#x2F; 匹配 databaseId<br>        if (databaseIdMatchesCurrent(id, databaseId, skRequiredDatabaseId)) {<br>            &#x2F;&#x2F; 解析 selectKey 节点<br>            parseSelectKeyNode(id, nodeToHandle, parameterTypeClass, langDriver, databaseId);<br>        }<br>    }<br>}</p>
<p>private void parseSelectKeyNode(String id, XNode nodeToHandle, Class? parameterTypeClass,<br>    LanguageDriver langDriver, String databaseId) {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 获取各种属性</span>
String resultType <span class="token operator">=</span> nodeToHandle<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"resultType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Class<span class="token operator">?</span> resultTypeClass <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>resultType<span class="token punctuation">)</span><span class="token punctuation">;</span>
StatementType statementType <span class="token operator">=</span> StatementType<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>nodeToHandle<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"statementType"</span><span class="token punctuation">,</span> StatementType<span class="token punctuation">.</span>PREPARED<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String keyProperty <span class="token operator">=</span> nodeToHandle<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"keyProperty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String keyColumn <span class="token operator">=</span> nodeToHandle<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"keyColumn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> executeBefore <span class="token operator">=</span> <span class="token string">"BEFORE"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>nodeToHandle<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">,</span> <span class="token string">"AFTER"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 设置默认值</span>
<span class="token keyword">boolean</span> useCache <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> resultOrdered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
KeyGenerator keyGenerator <span class="token operator">=</span> NoKeyGenerator<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>
Integer fetchSize <span class="token operator">=</span> null<span class="token punctuation">;</span>
Integer timeout <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token keyword">boolean</span> flushCache <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
String parameterMap <span class="token operator">=</span> null<span class="token punctuation">;</span>
String resultMap <span class="token operator">=</span> null<span class="token punctuation">;</span>
ResultSetType resultSetTypeEnum <span class="token operator">=</span> null<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 创建 SqlSource</span>
SqlSource sqlSource <span class="token operator">=</span> langDriver<span class="token punctuation">.</span><span class="token function">createSqlSource</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> nodeToHandle<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/*
 * selectKey 节点中只能配置 SELECT 查询语句，
 * 因此 sqlCommandType 为 SqlCommandType.SELECT
 */</span>
SqlCommandType sqlCommandType <span class="token operator">=</span> SqlCommandType<span class="token punctuation">.</span>SELECT<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
 * 构建 MappedStatement，并将 MappedStatement 
 * 添加到 Configuration 的 mappedStatements map 中
 */</span>
builderAssistant<span class="token punctuation">.</span><span class="token function">addMappedStatement</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> sqlSource<span class="token punctuation">,</span> statementType<span class="token punctuation">,</span> sqlCommandType<span class="token punctuation">,</span>
    fetchSize<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> parameterMap<span class="token punctuation">,</span> parameterTypeClass<span class="token punctuation">,</span> resultMap<span class="token punctuation">,</span> resultTypeClass<span class="token punctuation">,</span>
    resultSetTypeEnum<span class="token punctuation">,</span> flushCache<span class="token punctuation">,</span> useCache<span class="token punctuation">,</span> resultOrdered<span class="token punctuation">,</span>
    keyGenerator<span class="token punctuation">,</span> keyProperty<span class="token punctuation">,</span> keyColumn<span class="token punctuation">,</span> databaseId<span class="token punctuation">,</span> langDriver<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// id = namespace + "." + id</span>
id <span class="token operator">=</span> builderAssistant<span class="token punctuation">.</span><span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
MappedStatement keyStatement <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getMappedStatement</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 创建 SelectKeyGenerator，并添加到 keyGenerators map 中</span>
configuration<span class="token punctuation">.</span><span class="token function">addKeyGenerator</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SelectKeyGenerator</span><span class="token punctuation">(</span>keyStatement<span class="token punctuation">,</span> executeBefore<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面的源码比较长，但大部分代码都是一些基础代码，不是很难理解。以上代码比较重要的步骤如下：</p>
<ol>
<li>创建 SqlSource 实例</li>
<li>构建并缓存 MappedStatement 实例</li>
<li>构建并缓存 SelectKeyGenerator 实例</li>
</ol>
<p>在这三步中，第1步和第2步调用的是公共逻辑，其他地方也会调用，这两步对应的源码后续会分两节进行讲解。第3步则是创建一个 SelectKeyGenerator 实例，SelectKeyGenerator 创建的过程本身没什么好说的，所以就不多说了。下面分析一下 SqlSource 和 MappedStatement 实例的创建过程。</p>
<h5 id="2-1-5-3-解析-SQL-语句"><a href="#2-1-5-3-解析-SQL-语句" class="headerlink" title="2.1.5.3 解析 SQL 语句"></a>2.1.5.3 解析 SQL 语句</h5><p>前面分析了 include 和 selectKey 节点的解析过程，这两个节点解析完成后，都会以不同的方式从 dom 树中消失。所以目前的 SQL 语句节点由一些文本节点和普通节点组成，比如 if、where 等。那下面我们来看一下移除掉 include 和 selectKey 节点后的 SQL 语句节点是如何解析的。</p>
<td class="line_numbers"><pre>12345678910111213141516171819</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- XMLLanguageDriverpublic SqlSource createSqlSource(Configuration configuration, XNode script, Class? parameterType) {    XMLScriptBuilder builder = new XMLScriptBuilder(configuration, script, parameterType);    return builder.parseScriptNode();} // -☆- XMLScriptBuilderpublic SqlSource parseScriptNode() {    // 解析 SQL 语句节点    MixedSqlNode rootSqlNode = parseDynamicTags(context);    SqlSource sqlSource = null;    // 根据 isDynamic 状态创建不同的 SqlSource    if (isDynamic) {        sqlSource = new DynamicSqlSource(configuration, rootSqlNode);    } else {        sqlSource = new RawSqlSource(configuration, rootSqlNode, parameterType);    }    return sqlSource;}</pre></td>

<p>&#x2F;&#x2F; -☆- XMLLanguageDriver<br>public SqlSource createSqlSource(Configuration configuration, XNode script, Class? parameterType) {<br>    XMLScriptBuilder builder &#x3D; new XMLScriptBuilder(configuration, script, parameterType);<br>    return builder.parseScriptNode();<br>}</p>
<p>&#x2F;&#x2F; -☆- XMLScriptBuilder<br>public SqlSource parseScriptNode() {<br>    &#x2F;&#x2F; 解析 SQL 语句节点<br>    MixedSqlNode rootSqlNode &#x3D; parseDynamicTags(context);<br>    SqlSource sqlSource &#x3D; null;<br>    &#x2F;&#x2F; 根据 isDynamic 状态创建不同的 SqlSource<br>    if (isDynamic) {<br>        sqlSource &#x3D; new DynamicSqlSource(configuration, rootSqlNode);<br>    } else {<br>        sqlSource &#x3D; new RawSqlSource(configuration, rootSqlNode, parameterType);<br>    }<br>    return sqlSource;<br>}</p>
<p>如上，SQL 语句的解析逻辑被封装在了 XMLScriptBuilder 类的 parseScriptNode 方法中。该方法首先会调用 parseDynamicTags 解析 SQL 语句节点，在解析过程中，会判断节点是是否包含一些动态标记，比如 ${} 占位符以及动态 SQL 节点等。若包含动态标记，则会将 isDynamic 设为 true。后续可根据 isDynamic 创建不同的 SqlSource。下面，我们来看一下 parseDynamicTags 方法的逻辑。</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">/** 该方法用于初始化 nodeHandlerMap 集合，该集合后面会用到 */private void initNodeHandlerMap() {    nodeHandlerMap.put("trim", new TrimHandler());    nodeHandlerMap.put("where", new WhereHandler());    nodeHandlerMap.put("set", new SetHandler());    nodeHandlerMap.put("foreach", new ForEachHandler());    nodeHandlerMap.put("if", new IfHandler());    nodeHandlerMap.put("choose", new ChooseHandler());    nodeHandlerMap.put("when", new IfHandler());    nodeHandlerMap.put("otherwise", new OtherwiseHandler());    nodeHandlerMap.put("bind", new BindHandler());} protected MixedSqlNode parseDynamicTags(XNode node) {    ListSqlNode contents = new ArrayListSqlNode();    NodeList children = node.getNode().getChildNodes();    // 遍历子节点    for (int i = 0; i  children.getLength(); i++) {        XNode child = node.newXNode(children.item(i));        if (child.getNode().getNodeType() == Node.CDATA_SECTION_NODE || child.getNode().getNodeType() == Node.TEXT_NODE) {            // 获取文本内容            String data = child.getStringBody("");            TextSqlNode textSqlNode = new TextSqlNode(data);            // 若文本中包含 ${} 占位符，也被认为是动态节点            if (textSqlNode.isDynamic()) {                contents.add(textSqlNode);                // 设置 isDynamic 为 true                isDynamic = true;            } else {                // 创建 StaticTextSqlNode                contents.add(new StaticTextSqlNode(data));            }         // child 节点是 ELEMENT_NODE 类型，比如 if、where 等        } else if (child.getNode().getNodeType() == Node.ELEMENT_NODE) {            // 获取节点名称，比如 if、where、trim 等            String nodeName = child.getNode().getNodeName();            // 根据节点名称获取 NodeHandler            NodeHandler handler = nodeHandlerMap.get(nodeName);            /*             * 如果 handler 为空，表明当前节点对与 MyBatis 来说，是未知节点。             * MyBatis 无法处理这种节点，故抛出异常             */             if (handler == null) {                throw new BuilderException("Unknown element " + nodeName + " in SQL statement.");            }            // 处理 child 节点，生成相应的 SqlNode            handler.handleNode(child, contents);             // 设置 isDynamic 为 true            isDynamic = true;        }    }    return new MixedSqlNode(contents);}</pre></td>

<p>&#x2F;** 该方法用于初始化 nodeHandlerMap 集合，该集合后面会用到 *&#x2F;<br>private void initNodeHandlerMap() {<br>    nodeHandlerMap.put(“trim”, new TrimHandler());<br>    nodeHandlerMap.put(“where”, new WhereHandler());<br>    nodeHandlerMap.put(“set”, new SetHandler());<br>    nodeHandlerMap.put(“foreach”, new ForEachHandler());<br>    nodeHandlerMap.put(“if”, new IfHandler());<br>    nodeHandlerMap.put(“choose”, new ChooseHandler());<br>    nodeHandlerMap.put(“when”, new IfHandler());<br>    nodeHandlerMap.put(“otherwise”, new OtherwiseHandler());<br>    nodeHandlerMap.put(“bind”, new BindHandler());<br>}</p>
<p>protected MixedSqlNode parseDynamicTags(XNode node) {<br>    ListSqlNode contents &#x3D; new ArrayListSqlNode();<br>    NodeList children &#x3D; node.getNode().getChildNodes();<br>    &#x2F;&#x2F; 遍历子节点<br>    for (int i &#x3D; 0; i  children.getLength(); i++) {<br>        XNode child &#x3D; node.newXNode(children.item(i));<br>        if (child.getNode().getNodeType() &#x3D;&#x3D; Node.CDATA_SECTION_NODE || child.getNode().getNodeType() &#x3D;&#x3D; Node.TEXT_NODE) {<br>            &#x2F;&#x2F; 获取文本内容<br>            String data &#x3D; child.getStringBody(“”);<br>            TextSqlNode textSqlNode &#x3D; new TextSqlNode(data);<br>            &#x2F;&#x2F; 若文本中包含 ${} 占位符，也被认为是动态节点<br>            if (textSqlNode.isDynamic()) {<br>                contents.add(textSqlNode);<br>                &#x2F;&#x2F; 设置 isDynamic 为 true<br>                isDynamic &#x3D; true;<br>            } else {<br>                &#x2F;&#x2F; 创建 StaticTextSqlNode<br>                contents.add(new StaticTextSqlNode(data));<br>            }</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token comment" spellcheck="true">// child 节点是 ELEMENT_NODE 类型，比如 if、where 等</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Node<span class="token punctuation">.</span>ELEMENT_NODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 获取节点名称，比如 if、where、trim 等</span>
        String nodeName <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 根据节点名称获取 NodeHandler</span>
        NodeHandler handler <span class="token operator">=</span> nodeHandlerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nodeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*
         * 如果 handler 为空，表明当前节点对与 MyBatis 来说，是未知节点。
         * MyBatis 无法处理这种节点，故抛出异常
         */</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Unknown element "</span> <span class="token operator">+</span> nodeName <span class="token operator">+</span> <span class="token string">" in SQL statement."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 处理 child 节点，生成相应的 SqlNode</span>
        handler<span class="token punctuation">.</span><span class="token function">handleNode</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 设置 isDynamic 为 true</span>
        isDynamic <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MixedSqlNode</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面方法的逻辑我前面已经说过，主要是用来判断节点是否包含一些动态标记，比如 ${} 占位符以及动态 SQL 节点等。这里，不管是动态 SQL 节点还是静态 SQL 节点，我们都可以把它们看成是 SQL 片段，一个 SQL 语句由多个 SQL 片段组成。在解析过程中，这些 SQL 片段被存储在 contents 集合中。最后，该集合会被传给 MixedSqlNode 构造方法，用于创建 MixedSqlNode 实例。从 MixedSqlNode 类名上可知，它会存储多种类型的 SqlNode。除了上面代码中已出现的几种 SqlNode 实现类，还有一些 SqlNode 实现类未出现在上面的代码中。但它们也参与了 SQL 语句节点的解析过程，这里我们来看一下这些幕后的 SqlNode 类。</p>
<img class=" aligncenter" title="MyBatis 源码分析 - 映射文件解析过程" src="https://www.javazhiyin.com/wp-content/uploads/2018/07/2-1532922961.jpeg" src="https://www.javazhiyin.com/wp-content/themes/mnews/images/post-loading.gif" alt="MyBatis 源码分析 - 映射文件解析过程">

<p>上面的 SqlNode 实现类用于处理不同的动态 SQL 逻辑，这些 SqlNode 是如何生成的呢？答案是由各种 NodeHandler 生成。我们再回到上面的代码中，可以看到这样一句代码：</p>
<td class="line_numbers"><pre>1</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">handler.handleNode(child, contents);</pre></td>

<p>handler.handleNode(child, contents);</p>
<p>该代码用于处理动态 SQL 节点，并生成相应的 SqlNode。下面来简单分析一下 WhereHandler 的代码。</p>
<td class="line_numbers"><pre>12345678910111213141516</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">/** 定义在 XMLScriptBuilder 中 */private class WhereHandler implements NodeHandler {     public WhereHandler() {    }     @Override    public void handleNode(XNode nodeToHandle, ListSqlNode targetContents) {        // 调用 parseDynamicTags 解析 where 节点        MixedSqlNode mixedSqlNode = parseDynamicTags(nodeToHandle);        // 创建 WhereSqlNode        WhereSqlNode where = new WhereSqlNode(configuration, mixedSqlNode);        // 添加到 targetContents        targetContents.add(where);    }}</pre></td>

<p>&#x2F;** 定义在 XMLScriptBuilder 中 *&#x2F;<br>private class WhereHandler implements NodeHandler {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">public</span> <span class="token function">WhereHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleNode</span><span class="token punctuation">(</span>XNode nodeToHandle<span class="token punctuation">,</span> ListSqlNode targetContents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 调用 parseDynamicTags 解析 where 节点</span>
    MixedSqlNode mixedSqlNode <span class="token operator">=</span> <span class="token function">parseDynamicTags</span><span class="token punctuation">(</span>nodeToHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 创建 WhereSqlNode</span>
    WhereSqlNode where <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WhereSqlNode</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> mixedSqlNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 添加到 targetContents</span>
    targetContents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>where<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>如上，handleNode 方法内部会再次调用 parseDynamicTags 解析 where 节点中的内容，这样又会生成一个 MixedSqlNode 对象。最终，整个 SQL 语句节点会生成一个具有树状结构的 MixedSqlNode。如下图：</p>
<img class=" aligncenter" title="MyBatis 源码分析 - 映射文件解析过程" src="https://www.javazhiyin.com/wp-content/uploads/2018/07/10-1532922962.jpeg" src="https://www.javazhiyin.com/wp-content/themes/mnews/images/post-loading.gif" alt="MyBatis 源码分析 - 映射文件解析过程">

<p>到此，SQL 语句的解析过程就分析完了。现在，我们已经将 XML 配置解析了 SqlSource，但这还没有结束。SqlSource 中只能记录 SQL 语句信息，除此之外，这里还有一些额外的信息需要记录。因此，我们需要一个类能够同时存储 SqlSource 和其他的信息。这个类就是 MappedStatement。下面我们来看一下它的构建过程。</p>
<h5 id="2-1-5-4-构建-MappedStatement"><a href="#2-1-5-4-构建-MappedStatement" class="headerlink" title="2.1.5.4 构建 MappedStatement"></a>2.1.5.4 构建 MappedStatement</h5><p>SQL 语句节点可以定义很多属性，这些属性和属性值最终存储在 MappedStatement 中。下面我们看一下 MappedStatement 的构建过程是怎样的。</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536373839</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">public MappedStatement addMappedStatement(    String id, SqlSource sqlSource, StatementType statementType,     SqlCommandType sqlCommandType,Integer fetchSize, Integer timeout,     String parameterMap, Class? parameterType,String resultMap,     Class? resultType, ResultSetType resultSetType, boolean flushCache,    boolean useCache, boolean resultOrdered, KeyGenerator keyGenerator,     String keyProperty,String keyColumn, String databaseId,     LanguageDriver lang, String resultSets) {     if (unresolvedCacheRef) {        throw new IncompleteElementException("Cache-ref not yet resolved");    }     id = applyCurrentNamespace(id, false);    boolean isSelect = sqlCommandType == SqlCommandType.SELECT;     // 创建建造器，设置各种属性    MappedStatement.Builder statementBuilder = new MappedStatement.Builder(configuration, id, sqlSource, sqlCommandType)        .resource(resource).fetchSize(fetchSize).timeout(timeout)        .statementType(statementType).keyGenerator(keyGenerator)        .keyProperty(keyProperty).keyColumn(keyColumn).databaseId(databaseId)        .lang(lang).resultOrdered(resultOrdered).resultSets(resultSets)        .resultMaps(getStatementResultMaps(resultMap, resultType, id))        .flushCacheRequired(valueOrDefault(flushCache, !isSelect))        .resultSetType(resultSetType).useCache(valueOrDefault(useCache, isSelect))        .cache(currentCache);     // 获取或创建 ParameterMap    ParameterMap statementParameterMap = getStatementParameterMap(parameterMap, parameterType, id);    if (statementParameterMap != null) {        statementBuilder.parameterMap(statementParameterMap);    }     // 构建 MappedStatement，没有什么复杂逻辑，不跟下去了    MappedStatement statement = statementBuilder.build();    // 添加 MappedStatement 到 configuration 的 mappedStatements 集合中    configuration.addMappedStatement(statement);    return statement;}</pre></td>

<p>public MappedStatement addMappedStatement(<br>    String id, SqlSource sqlSource, StatementType statementType,<br>    SqlCommandType sqlCommandType,Integer fetchSize, Integer timeout,<br>    String parameterMap, Class? parameterType,String resultMap,<br>    Class? resultType, ResultSetType resultSetType, boolean flushCache,<br>    boolean useCache, boolean resultOrdered, KeyGenerator keyGenerator,<br>    String keyProperty,String keyColumn, String databaseId,<br>    LanguageDriver lang, String resultSets) {</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token keyword">if</span> <span class="token punctuation">(</span>unresolvedCacheRef<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IncompleteElementException</span><span class="token punctuation">(</span><span class="token string">"Cache-ref not yet resolved"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

id <span class="token operator">=</span> <span class="token function">applyCurrentNamespace</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> isSelect <span class="token operator">=</span> sqlCommandType <span class="token operator">==</span> SqlCommandType<span class="token punctuation">.</span>SELECT<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 创建建造器，设置各种属性</span>
MappedStatement<span class="token punctuation">.</span>Builder statementBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedStatement<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> id<span class="token punctuation">,</span> sqlSource<span class="token punctuation">,</span> sqlCommandType<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fetchSize</span><span class="token punctuation">(</span>fetchSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">statementType</span><span class="token punctuation">(</span>statementType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keyGenerator</span><span class="token punctuation">(</span>keyGenerator<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keyProperty</span><span class="token punctuation">(</span>keyProperty<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keyColumn</span><span class="token punctuation">(</span>keyColumn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">databaseId</span><span class="token punctuation">(</span>databaseId<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">lang</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resultOrdered</span><span class="token punctuation">(</span>resultOrdered<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resultSets</span><span class="token punctuation">(</span>resultSets<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">resultMaps</span><span class="token punctuation">(</span><span class="token function">getStatementResultMaps</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">,</span> resultType<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flushCacheRequired</span><span class="token punctuation">(</span><span class="token function">valueOrDefault</span><span class="token punctuation">(</span>flushCache<span class="token punctuation">,</span> <span class="token operator">!</span>isSelect<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">resultSetType</span><span class="token punctuation">(</span>resultSetType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useCache</span><span class="token punctuation">(</span><span class="token function">valueOrDefault</span><span class="token punctuation">(</span>useCache<span class="token punctuation">,</span> isSelect<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>currentCache<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 获取或创建 ParameterMap</span>
ParameterMap statementParameterMap <span class="token operator">=</span> <span class="token function">getStatementParameterMap</span><span class="token punctuation">(</span>parameterMap<span class="token punctuation">,</span> parameterType<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>statementParameterMap <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    statementBuilder<span class="token punctuation">.</span><span class="token function">parameterMap</span><span class="token punctuation">(</span>statementParameterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 构建 MappedStatement，没有什么复杂逻辑，不跟下去了</span>
MappedStatement statement <span class="token operator">=</span> statementBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 添加 MappedStatement 到 configuration 的 mappedStatements 集合中</span>
configuration<span class="token punctuation">.</span><span class="token function">addMappedStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> statement<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>上面就是 MappedStatement，没什么复杂的地方，就不多说了。</p>
<h4 id="2-1-6-小节"><a href="#2-1-6-小节" class="headerlink" title="2.1.6 小节"></a>2.1.6 小节</h4><p>本章分析了映射文件的解析过程，总的来说，本章的内容还是比较复杂的，逻辑太多。不过如果大家自己也能把映射文件的解析过程认真分析一遍，会对 MyBatis 有更深入的理解。分析过程很累，但是在此过程中会收获了很多东西，还是很开心的。好了，本章内容先到这里。后面还有一些代码需要分析，我们继续往后看。</p>
<h3 id="2-2-Mapper-接口绑定过程分析"><a href="#2-2-Mapper-接口绑定过程分析" class="headerlink" title="2.2 Mapper 接口绑定过程分析"></a>2.2 Mapper 接口绑定过程分析</h3><p>映射文件解析完成后，并不意味着整个解析过程就结束了。此时还需要通过命名空间绑定 mapper 接口，这样才能将映射文件中的 SQL 语句和 mapper 接口中的方法绑定在一起，后续即可通过调用 mapper 接口方法执行与之对应的 SQL 语句。下面我们来分析一下 mapper 接口的绑定过程。</p>
<td class="line_numbers"><pre>123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- XMLMapperBuilderprivate void bindMapperForNamespace() {    // 获取映射文件的命名空间    String namespace = builderAssistant.getCurrentNamespace();    if (namespace != null) {        Class? boundType = null;        try {            // 根据命名空间解析 mapper 类型            boundType = Resources.classForName(namespace);        } catch (ClassNotFoundException e) {        }        if (boundType != null) {            // 检测当前 mapper 类是否被绑定过            if (!configuration.hasMapper(boundType)) {                configuration.addLoadedResource("namespace:" + namespace);                // 绑定 mapper 类                configuration.addMapper(boundType);            }        }    }} // -☆- Configurationpublic T void addMapper(ClassT type) {    // 通过 MapperRegistry 绑定 mapper 类    mapperRegistry.addMapper(type);} // -☆- MapperRegistrypublic T void addMapper(ClassT type) {    if (type.isInterface()) {        if (hasMapper(type)) {            throw new BindingException("Type " + type + " is already known to the MapperRegistry.");        }        boolean loadCompleted = false;        try {            /*             * 将 type 和 MapperProxyFactory 进行绑定，             * MapperProxyFactory 可为 mapper 接口生成代理类             */            knownMappers.put(type, new MapperProxyFactoryT(type));             // 创建注解解析器。在 MyBatis 中，有 XML 和 注解两种配置方式可选            MapperAnnotationBuilder parser = new MapperAnnotationBuilder(config, type);            // 解析注解中的信息            parser.parse();            loadCompleted = true;        } finally {            if (!loadCompleted) {                knownMappers.remove(type);            }        }    }}</pre></td>

<p>&#x2F;&#x2F; -☆- XMLMapperBuilder<br>private void bindMapperForNamespace() {<br>    &#x2F;&#x2F; 获取映射文件的命名空间<br>    String namespace &#x3D; builderAssistant.getCurrentNamespace();<br>    if (namespace !&#x3D; null) {<br>        Class? boundType &#x3D; null;<br>        try {<br>            &#x2F;&#x2F; 根据命名空间解析 mapper 类型<br>            boundType &#x3D; Resources.classForName(namespace);<br>        } catch (ClassNotFoundException e) {<br>        }<br>        if (boundType !&#x3D; null) {<br>            &#x2F;&#x2F; 检测当前 mapper 类是否被绑定过<br>            if (!configuration.hasMapper(boundType)) {<br>                configuration.addLoadedResource(“namespace:” + namespace);<br>                &#x2F;&#x2F; 绑定 mapper 类<br>                configuration.addMapper(boundType);<br>            }<br>        }<br>    }<br>}</p>
<p>&#x2F;&#x2F; -☆- Configuration<br>public  void addMapper(Class type) {<br>    &#x2F;&#x2F; 通过 MapperRegistry 绑定 mapper 类<br>    mapperRegistry.addMapper(type);<br>}</p>
<p>&#x2F;&#x2F; -☆- MapperRegistry<br>public  void addMapper(Class type) {<br>    if (type.isInterface()) {<br>        if (hasMapper(type)) {<br>            throw new BindingException(“Type “ + type + “ is already known to the MapperRegistry.”);<br>        }<br>        boolean loadCompleted &#x3D; false;<br>        try {<br>            &#x2F;*<br>             * 将 type 和 MapperProxyFactory 进行绑定，<br>             * MapperProxyFactory 可为 mapper 接口生成代理类<br>             *&#x2F;<br>            knownMappers.put(type, new MapperProxyFactory(type));</p>
<pre class="line-numbers language-java"><code class="language-java">
        <span class="token comment" spellcheck="true">// 创建注解解析器。在 MyBatis 中，有 XML 和 注解两种配置方式可选</span>
        MapperAnnotationBuilder parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapperAnnotationBuilder</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 解析注解中的信息</span>
        parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loadCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loadCompleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            knownMappers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>以上就是 Mapper 接口的绑定过程。这里简单一下：</p>
<ol>
<li>获取命名空间，并根据命名空间解析 mapper 类型</li>
<li>将 type 和 MapperProxyFactory 实例存入 knownMappers 中</li>
<li>解析注解中的信息</li>
</ol>
<p>以上步骤中，第3步的逻辑较多。如果大家看懂了映射文件的解析过程，那么注解的解析过程也就不难理解了，这里就不深入分析了。好了，Mapper 接口的绑定过程就先分析到这。</p>
<h3 id="2-3-处理未完成解析的节点"><a href="#2-3-处理未完成解析的节点" class="headerlink" title="2.3 处理未完成解析的节点"></a>2.3 处理未完成解析的节点</h3><p>在解析某些节点的过程中，如果这些节点引用了其他一些未被解析的配置，会导致当前节点解析工作无法进行下去。对于这种情况，MyBatis 的做法是抛出 IncompleteElementException 异常。外部逻辑会捕捉这个异常，并将节点对应的解析器放入 incomplet* 集合中。这个我在分析映射文件解析的过程中进行过相应注释，不知道大家有没有注意到。没注意到也没关系，待会我会举例说明。下面我们来看一下 MyBatis 是如何处理未完成解析的节点。</p>
<td class="line_numbers"><pre>123456789101112</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">// -☆- XMLMapperBuilderpublic void parse() {    // 省略部分代码     // 解析 mapper 节点    configurationElement(parser.evalNode("/mapper"));     // 处理未完成解析的节点    parsePendingResultMaps();    parsePendingCacheRefs();    parsePendingStatements();}</pre></td>

<p>&#x2F;&#x2F; -☆- XMLMapperBuilder<br>public void parse() {<br>    &#x2F;&#x2F; 省略部分代码</p>
<pre class="line-numbers language-java"><code class="language-java">
<span class="token comment" spellcheck="true">// 解析 mapper 节点</span>
<span class="token function">configurationElement</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">"/mapper"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 处理未完成解析的节点</span>
<span class="token function">parsePendingResultMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">parsePendingCacheRefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">parsePendingStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>}</p>
<p>如上，parse 方法是映射文件的解析入口。在本章的开始，我贴过这个源码。从上面的源码中可以知道有三种节点在解析过程中可能会出现不能完成解析的情况。由于上面三个以 parsePending 开头的方法逻辑一致，所以下面我只会分析其中一个方法的源码。简单起见，这里选择分析 parsePendingCacheRefs 的源码。下面看一下如何配置映射文件会导致 cache-ref 节点无法完成解析。</p>
<td class="line_numbers"><pre>12345678910</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">!-- 映射文件1 --mapper namespace="xyz.coolblog.dao.Mapper1"    !-- 引用映射文件2中配置的缓存 --    cache-ref namespace="xyz.coolblog.dao.Mapper2"//mapper !-- 映射文件2 --mapper namespace="xyz.coolblog.dao.Mapper2"    cache//mapper</pre></td>

<p>!– 映射文件1 –<br>mapper namespace&#x3D;”xyz.coolblog.dao.Mapper1”<br>    !– 引用映射文件2中配置的缓存 –<br>    cache-ref namespace&#x3D;”xyz.coolblog.dao.Mapper2”&#x2F;<br>&#x2F;mapper</p>
<p>!– 映射文件2 –<br>mapper namespace&#x3D;”xyz.coolblog.dao.Mapper2”<br>    cache&#x2F;<br>&#x2F;mapper</p>
<p>如上，假设 MyBatis 先解析映射文件1，然后再解析映射文件2。按照这样的解析顺序，映射文件1中的 cache-ref 节点就无法完成解析，因为它所引用的缓存还未被解析。当映射文件2解析完成后，MyBatis 会调用 parsePendingCacheRefs 方法处理在此之前未完成解析的 cache-ref 节点。具体的逻辑如下：</p>
<td class="line_numbers"><pre>12345678910111213141516171819202122232425262728</pre></td><td class="code"><pre class="java5" style="font-family:monospace;">private void parsePendingCacheRefs() {    // 获取 CacheRefResolver 列表    CollectionCacheRefResolver incompleteCacheRefs = configuration.getIncompleteCacheRefs();    synchronized (incompleteCacheRefs) {        IteratorCacheRefResolver iter = incompleteCacheRefs.iterator();        // 通过迭代器遍历列表        while (iter.hasNext()) {            try {                /*                 * 尝试解析 cache-ref 节点，若解析失败，则抛出 IncompleteElementException，                 * 此时下面的删除操作不会被执行                 */                iter.next().resolveCacheRef();                /*                 * 移除 CacheRefResolver 对象。如果代码能执行到此处，                 * 表明已成功解析了 cache-ref 节点                 */                iter.remove();            } catch (IncompleteElementException e) {                /*                 * 如果再次发生 IncompleteElementException 异常，表明当前映射文件中并没有                  * cache-ref 所引用的缓存。有可能所引用的缓存在后面的映射文件中，所以这里                 * 不能将解析失败的 CacheRefResolver 从集合中删除                 */            }        }    }}</pre></td>

<p>private void parsePendingCacheRefs() {<br>    &#x2F;&#x2F; 获取 CacheRefResolver 列表<br>    CollectionCacheRefResolver incompleteCacheRefs &#x3D; configuration.getIncompleteCacheRefs();<br>    synchronized (incompleteCacheRefs) {<br>        IteratorCacheRefResolver iter &#x3D; incompleteCacheRefs.iterator();<br>        &#x2F;&#x2F; 通过迭代器遍历列表<br>        while (iter.hasNext()) {<br>            try {<br>                &#x2F;*<br>                 * 尝试解析 cache-ref 节点，若解析失败，则抛出 IncompleteElementException，<br>                 * 此时下面的删除操作不会被执行<br>                 <em>&#x2F;<br>                iter.next().resolveCacheRef();<br>                &#x2F;</em><br>                 * 移除 CacheRefResolver 对象。如果代码能执行到此处，<br>                 * 表明已成功解析了 cache-ref 节点<br>                 <em>&#x2F;<br>                iter.remove();<br>            } catch (IncompleteElementException e) {<br>                &#x2F;</em><br>                 * 如果再次发生 IncompleteElementException 异常，表明当前映射文件中并没有<br>                 * cache-ref 所引用的缓存。有可能所引用的缓存在后面的映射文件中，所以这里<br>                 * 不能将解析失败的 CacheRefResolver 从集合中删除<br>                 *&#x2F;<br>            }<br>        }<br>    }<br>}</p>
<p>上面代码不是很长，我也做了比较多的注释，应该不难理解。好了，关于未完成解析节点的解析过程就分析到这。</p>
<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h2><p>本篇文章对映射文件的解析过程进行了较为详细的分析，全文篇幅比较大，写的也比较辛苦。本篇文章耗时7天完成，在这7天中，基本上一有空闲时间，就会用来写作。虽然很累，但是收获也很多。我目前正在努力的构建自己的知识体系，我觉得对于常用的技术，还是应该花一些时间和精力，去弄懂它的原理。这样以后才能走的更远，才能成为你想成为的样子。</p>
<p>好了，其他的就不多说了，本篇文章就到这吧。谢谢大家的阅读。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><h2 id=""><a href="#" class="headerlink" title="- "></a>- </h2>
                </div>
                <!-- 欧阳思海，modify，2020.05.01-->
<!-- 文章详情详情页面的头部广告位置信息 -->
<div id="post-head-panel">
    
    <a href="https://github.com/OUYANGSIHAI/JavaInterview" style="font-size: 18px;" target="_blank">
        <img src="/icons/hot.gif">
        本人花费半年的时间总结的《Java面试指南》已拿腾讯等大厂offer，已开源在github ，欢迎star！
    </a>
    
    
</div>
<br />



<blockquote>
    
            <p>本文GitHub <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">https://github.com/OUYANGSIHAI/JavaInterview</a> 已收录，这是我花了6个月总结的<b>一线大厂Java面试</b>总结，本人已拿大厂offer，欢迎star</p>
    
    <p>原文链接：blog.ouyangsihai.cn &gt;&gt; <a href="/mybatis-yuan-ma-fen-xi-ying-she-wen-jian-jie-xi-guo-cheng.html" target="_blank">MyBatis 源码分析 – 映射文件解析过程</a></p>
</blockquote>
                <hr />

                
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">多少都是对我的认可</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="http://image.ouyangsihai.cn/FpbhsOuf3Ar9vY34B97Y2qQ7LVGe" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="http://image.ouyangsihai.cn/FgYlMzms68PH73PWpZBwPfbLTAws" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
                

                <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

                

                
                <div class="reprint1">
                    <p>
                        <span class="reprint1-tip">
                            <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                        </span>
                        <a href="https://blog.ouyangsihai.cn" class="b-link-green">好好学java</a>
                        <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                        <a href="/mybatis-yuan-ma-fen-xi-ying-she-wen-jian-jie-xi-guo-cheng.html" class="b-link-green">MyBatis 源码分析 – 映射文件解析过程</a>
                    </p>
                </div>

            </div>
        </div>

        

        

        

        

        
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }
    /* valine 评论框增加背景图片 */
    #vcomments textarea {
        box-sizing: border-box;
        background: url("") 100% 100% no-repeat;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    /* 修复评论第一行位置错位 */
    .v .vlist .vcard {
    padding-top: 2.5em !important ;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <link rel="stylesheet" type="text/css" href="/libs//libs/jQuery-emoji/dist/css/jquery.emoji.css">
<script src="/libs//libs/jQuery-emoji/dist/js/jquery.emoji.min.js"></script>
<script src="/libs//libs/jQuery-emoji/dist/js/emoji.list.js"></script> -->
<script>
    new Valine({
        el: '#vcomments',
        appId: 'MxSNOS83TYWU3Opsy2GTW1ih-gzGzoHsz',
        appKey: '4XevOgmAxHEwVDnIKgvEUihB',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '请畅所欲言吧，别害羞~',

    });

//     function parse_emoji() {
//     jQuery(".vcontent").emojiParse({
//       basePath: '/libs/jQuery-emoji/images/emoji',
//       icons: emojiLists   // 注：详见 js/emoji.list.js
//     });
//   }
  
//   setTimeout(function() {
//     // jQuery emoji 解析
//     parse_emoji();
//     // jquery emoji 初始化
//     jQuery(".veditor").emoji({
//       showTab: true,
//       animation: 'slide',
//       basePath: '/libs/jQuery-emoji/images/emoji',
//       icons: emojiLists  // 注：详见 js/emoji.list.js
//     });
//     jQuery(".vmore").on("click", function() {
//       setTimeout(function() {
//         parse_emoji();
//       }, 500);
//     });
//   }, 800)

</script>
        

        

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/mybatis-yuan-ma-fen-xi-pei-zhi-wen-jian-jie-xi-guo-cheng.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="MyBatis 源码分析 – 配置文件解析过程">
                        
                        <span class="card-title">MyBatis 源码分析 – 配置文件解析过程</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            * 本文速览由于本篇文章篇幅比较大，所以这里拿出一节对本文进行快速概括。本篇文章对 MyBatis 配置文件中常用配置的解析过程进行了较为详细的介绍和分析，包括但不限于
settings，
typeAliases和
typeHandlers
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock fa-fw icon-date"></i>2021-04-05
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/mybatis%E6%BA%90%E7%A0%81/" class="post-category" target="_blank">
                                    mybatis源码
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/mybatis-mybatis%E6%BA%90%E7%A0%81/" target="_blank">
                        <span class="chip bg-color">mybatis,mybatis源码</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/mybatis-de-sqlsession-yun-xing-yuan-li.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Mybatis的SqlSession运行原理">
                        
                        <span class="card-title">Mybatis的SqlSession运行原理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            

来源：JJianwww.cnblogs.com/jian0110/p/9452592.html公众号注：点击文末阅读原文可直达java开发学习网站
前言
SqlSession是Mybatis最重要的构建之一，可以简单的认为Mybatis
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock fa-fw icon-date"></i>2021-04-05
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/mybatis%E6%BA%90%E7%A0%81/" class="post-category" target="_blank">
                                    mybatis源码
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/mybatis-mybatis%E6%BA%90%E7%A0%81/" target="_blank">
                        <span class="chip bg-color">mybatis,mybatis源码</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
    </div>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('500')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 好好学java<br />'
            + '作者: 好好学java<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>



<!--
<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'container',
        blogId: '15305-1590684104111-518',
        name: '程序员的技术圈子',
        qrcode: 'http://image.ouyangsihai.cn/FtAUOeE5--1JTdcuuZFIhMuEUuJO',
        keyword: 'vip',
    });
</script>
-->

    </div>
    <div id="toc-aside" style="width: 310px;" class="expanded col l3 hide-on-med-and-down">
        <!-- 自定义右侧card：欧阳思海 -->
        <!-- <div id="my-card" style="background: ">
            
        </div> -->
        <!-- <div class="toc-widget">
            <div class="toc-title" style="display: none;"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;</div>
            <div id="toc-content"></div>
        </div> -->








        <aside class="col-lg-3" style="width: 300px;">

            <link rel="stylesheet" type="text/css" href="/css/my-aside.css">

            <!-- 关注公众号信息：欧阳思海 -->
            <div class="widget-wrap">
                <div class="widget bg-danger" style="color:whitesmoke; background-color: #419488">
                    <div class="card-front animated col s12 m12 l8 offset-l2 fadeInUp">
                        <div class="row">
                            <div class="col-md-5" style="text-align: center;">
                                <img class="adv" style="width: 95px; height: 95px;"
                                    src="http://image.ouyangsihai.cn/FtAUOeE5--1JTdcuuZFIhMuEUuJO">
                            </div>
                            <div class="col-md-7" style="text-align: center;">
                                <h2 style="font-size: 18px; 
                                    margin: 0; 
                                    padding: 0;
                                    border: 0; 
                                    outline: 0;
                                    font-weight: inherit;
                                    font-style: inherit;
                                    font-family: inherit;
                                    vertical-align: baseline;">关注公众号</h2>
                                 
                                <small style="font-size: 15px;">
                                    →「技术干货」每日推送 <br>
                                    →「回复资料」领取资料 <br>
                                    →「微信加群」每周福利 <br>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- <div style="font-size: 0.8em;">
                        <a href="/assets/erweima.jpg" target="_blank"
                            style="color:orange;font-size: 14px;">点击添加我的微信，加入技术讨论群</a>
                        除公众号以外，我还会在以下平台发布内容：
                    </div>
                    -->

                    <div class="profile-block social-links col-md-7" style="text-align: center;">
                        <table style="align-items: center; 
                                        padding-left: 25px;">
                            <tbody>
                                <tr>
                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank" title="GitHub"
                                            class="tooltip">
                                            <img style="width: 22px;height: 22px;" src="/icons/github.svg"></a>
                                    </td>

                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://www.zhihu.com/people/hai-hai-ren-sheng-50/activities"
                                            target="_blank" title="知乎" class="tooltip">
                                            <img style="width: 22px;" src="/icons/zhihu.svg"></a>
                                    </td>
                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://blog.csdn.net/sihai12345" target="_blank" title="CSDN"
                                            class="tooltip">
                                            <img style="width: 18px;" src="/icons/CSDN.svg"></a>
                                    </td>
                                    <td style="margin: 0;
                                                padding: 0;
                                                border: 0;
                                                outline: 0;
                                                font-weight: inherit;
                                                font-style: inherit;
                                                font-family: inherit;
                                                vertical-align: baseline;"><a
                                            style="color: whitesmoke;font-size: 25px;"
                                            href="https://www.jianshu.com/u/12b0bd4c857c" target="_blank" title="简书"
                                            class="tooltip">
                                            <img style="width: 22px;" src="/icons/JianShu.svg"></a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


            

            <!-- custom rightside_link：热门文章推荐：欧阳思海 -->
            
            <div class="widget-wrap widget-panel">
                <p style="text-align: left;padding-bottom: 10px;line-height: 30px; font-size: 14px;">
                    
                    <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">

                        <img src="/icons/hot.gif">

                        本人花费半年的时间总结的《 Java 面试指南》已拿腾讯等大厂 offer，已开源在 github ，欢迎 star！
                    </a><br>
                    
                    <a href="https://mp.weixin.qq.com/s/I0jimqziHqRNaIy0kXRCnw" target="_blank">

                        <img src="/icons/hot.gif">

                        2020 Java 1000G 最新学习资源，Java基础、Java项目实战、Java分布式等等！
                    </a><br>
                    
                    <a href="http://image.ouyangsihai.cn/FpB-dO6g-XU44mMrVlj7EL1y7Rs7" target="_blank">

                        <img src="/icons/hot.gif">

                        高级 Java 开发微信群，一起搞事情吧！
                    </a><br>
                    
                </p>
            </div>
            

            

            <!-- custom rightside_banner：右侧广告或者其他的栏目设置：欧阳思海 -->
            
            <div class="widget-wrap">
                <a href="https://github.com/OUYANGSIHAI/JavaInterview" target="_blank">
                    <img src="http://image.ouyangsihai.cn/FhhoEYMaNr6m0v8KhG8vSPgoREBV" style="width: 100%;">
                </a>
            </div>
            
            

            

            <!-- 右侧专栏分类：欧阳思海 -->
            
            <div class="widget-wrap widget-panel">
                <ul class="media-list">
                    
                    <li class="media">
                        <a href="/categories/MySQL的艺术世界/" target="_blank">
                            <div class="media-left">
                                <img class="media-object" src="http://image.ouyangsihai.cn/Fn3kQurieQ_0QUeqPmx5RW5i6R9n" style="width: 55px;">
                            </div>
                            <div class="media-body">
                                <h4 class="media-heading" style="margin-bottom: 10px; font-size: 100%;
                                                                    margin: 0;
                                                                    padding: 0;
                                                                    border: 0;
                                                                    outline: 0;
                                                                    font-weight: inherit;
                                                                    font-style: inherit;
                                                                    font-family: inherit;
                                                                    vertical-align: baseline;">
                                    MySQL 的系列文章，解决全部面试问题！
                                </h4>
                                <p>
                                    总共10篇文章，面试热门的锁、事务，通通解决了！
                                </p>
                            </div>
                        </a>
                    </li>
                    <hr>
                    
                    <li class="media">
                        <a href="/categories/深入理解Java虚拟机/" target="_blank">
                            <div class="media-left">
                                <img class="media-object" src="http://image.ouyangsihai.cn/FpcS21VWJOHSgGzKcpW3_xVTSEeN" style="width: 55px;">
                            </div>
                            <div class="media-body">
                                <h4 class="media-heading" style="margin-bottom: 10px; font-size: 100%;
                                                                    margin: 0;
                                                                    padding: 0;
                                                                    border: 0;
                                                                    outline: 0;
                                                                    font-weight: inherit;
                                                                    font-style: inherit;
                                                                    font-family: inherit;
                                                                    vertical-align: baseline;">
                                    深入理解 Java 虚拟机，面试必问
                                </h4>
                                <p>
                                    总共10篇文章，包括内存模型、GC算法、GC收集器等。
                                </p>
                            </div>
                        </a>
                    </li>
                    <hr>
                    
                </ul>
            </div>
            

            <!-- 右侧分类 -->
            <div class="widget-wrap widget-panel">
                <h3 class="widget-title">文章分类</h3>
                <div class="widget">
                    <ul class="category-list">
                        
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/趣聊数据结构与算法/">>
                                趣聊数据结构与算法</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/职业生涯浅谈/">>
                                职业生涯浅谈</a><span class="category-list-count">33</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java项目分享/">>
                                Java项目分享</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java面试经验/">>
                                Java面试经验</a><span class="category-list-count">4</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/我要进大厂/">>
                                我要进大厂</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/好好学java/">>
                                好好学java</a><span class="category-list-count">1116</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/剑指offer/">>
                                剑指offer</a><span class="category-list-count">112</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/css/">>
                                css</a><span class="category-list-count">12</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/其他框架/">>
                                其他框架</a><span class="category-list-count">142</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python其他/">>
                                python其他</a><span class="category-list-count">45</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/数据库相关/">>
                                数据库相关</a><span class="category-list-count">293</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java核心知识/">>
                                Java核心知识</a><span class="category-list-count">196</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java面试题/">>
                                Java面试题</a><span class="category-list-count">308</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/mybatis源码/">>
                                mybatis源码</a><span class="category-list-count">56</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/spring教程/">>
                                spring教程</a><span class="category-list-count">173</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springboot教程/">>
                                springboot教程</a><span class="category-list-count">156</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/实战Activiti工作流/">>
                                实战Activiti工作流</a><span class="category-list-count">4</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springcloud教程/">>
                                springcloud教程</a><span class="category-list-count">39</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/linux/">>
                                linux</a><span class="category-list-count">91</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python框架/">>
                                python框架</a><span class="category-list-count">43</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python基础/">>
                                python基础</a><span class="category-list-count">78</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/dubbo/">>
                                dubbo</a><span class="category-list-count">37</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java源码/">>
                                Java源码</a><span class="category-list-count">76</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/叽叽喳喳杂七杂八/">>
                                叽叽喳喳杂七杂八</a><span class="category-list-count">10</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/MySQL的艺术世界/">>
                                MySQL的艺术世界</a><span class="category-list-count">8</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/jquery/">>
                                jquery</a><span class="category-list-count">14</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java并发/">>
                                Java并发</a><span class="category-list-count">43</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java文章合辑/">>
                                Java文章合辑</a><span class="category-list-count">11</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java基础修炼/">>
                                Java基础修炼</a><span class="category-list-count">7</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/不一样的Java8/">>
                                不一样的Java8</a><span class="category-list-count">3</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/小程序开发的世界/">>
                                小程序开发的世界</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java学习资源分享/">>
                                Java学习资源分享</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java小学生漫游/">>
                                Java小学生漫游</a><span class="category-list-count">2</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/rocketmq源码解析/">>
                                rocketmq源码解析</a><span class="category-list-count">33</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springmvc最新教程/">>
                                springmvc最新教程</a><span class="category-list-count">9</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java的Exception/">>
                                Java的Exception</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/vue-js/">>
                                vue.js</a><span class="category-list-count">10</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/实战设计模式/">>
                                实战设计模式</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/python数据处理/">>
                                python数据处理</a><span class="category-list-count">7</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java-Web闯关/">>
                                Java Web闯关</a><span class="category-list-count">7</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/springboot2-0最新教程/">>
                                springboot2.0最新教程</a><span class="category-list-count">11</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/netty/">>
                                netty</a><span class="category-list-count">16</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/rpc/">>
                                rpc</a><span class="category-list-count">13</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/拥抱大厂系列/">>
                                拥抱大厂系列</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/eureka/">>
                                eureka</a><span class="category-list-count">19</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/分布式/">>
                                分布式</a><span class="category-list-count">6</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/中间件/">>
                                中间件</a><span class="category-list-count">23</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java基础/">>
                                Java基础</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/带你学Python/">>
                                带你学Python</a><span class="category-list-count">10</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/使用技术工具/">>
                                使用技术工具</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/mycat源码/">>
                                mycat源码</a><span class="category-list-count">5</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/深入理解Java虚拟机/">>
                                深入理解Java虚拟机</a><span class="category-list-count">8</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/spring源码/">>
                                spring源码</a><span class="category-list-count">2</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java集合源码分析/">>
                                Java集合源码分析</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/github的repo/">>
                                github的repo</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/Java框架深究/">>
                                Java框架深究</a><span class="category-list-count">1</span>
                        </li>
                        
                        <li class="category-list-item"><a class="category-list-link" href="categories/分布式架构/">>
                                分布式架构</a><span class="category-list-count">2</span>
                        </li>
                        
                        
                    </ul>
                </div>
            </div>

        </aside>









    </div>
</div>

<!-- TOC 悬浮按钮. 修改成永远不显示：欧阳思海-->




<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        console.log('============');

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

                        
            /* 修复文章卡片 div 的宽度. */
            let fixPostCardWidth = function (srcId, targetId) {
                let srcDiv = $('#' + srcId);
                if (srcDiv.length === 0) {
                    return;
                }

                let w = srcDiv.width();
                if (w >= 450) {
                    w = w + 21;
                } else if (w >= 350 && w < 450) {
                    w = w + 18;
                } else if (w >= 300 && w < 350) {
                    w = w + 16;
                } else {
                    w = w + 14;
                }
                $('#' + targetId).width(w);
            };

            // 切换TOC目录展开收缩的相关操作.
            // 修改右侧边栏功能：欧阳思海
            const expandedClass = 'expanded';
            let $tocAside = $('#toc-aside');
            let $mainContent = $('#main-content');

            $('#floating-toc-btn .btn-floating').click(function () {
                if ($tocAside.hasClass(expandedClass)) {
                    $tocAside.removeClass(expandedClass).slideUp(500);
                    $mainContent.removeClass('l9');
                } else {
                    $tocAside.addClass(expandedClass).slideDown(500);
                    $mainContent.addClass('l9');
                }
                fixPostCardWidth('artDetail', 'prenext-posts');
            });
                        
                    });
</script>
    

</main>


        <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            
	    Copyright&copy; 2019 <a href="https://www.java1000.com/" target="_blank"> 好好学java </a>维护. 网站备案/许可证号：赣ICP备17007984号-3
            <br>
            <span id="sitetime"></span>
            <br>

            

            
                    <!-- 
                        <span id="busuanzi_container_site_pv" style='display:none'></span>
                        总访问量: <span id="busuanzi_value_site_pv" class="white-color"></span>
                    
        
                    
                        <span id="busuanzi_container_site_uv" style='display:none'></span>
                        人次&nbsp; | &nbsp;访客人数: <span id="busuanzi_value_site_uv" class="white-color"></span> 人
                     -->
                        <!-- 修改计数：欧阳思海 -->
                    
                        <span id="busuanzi_container_site_pv" style='display:inline'>
                            <i class="fa fa-heart-o"></i>
                            本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
                        </span>
                    
                    
                        <span id="busuanzi_container_site_uv" style='display:none'>
                            人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
                        </span>
                    
    
            

            
                &nbsp; | &nbsp;字数统计:&nbsp;
                <span class="white-color">8290.3k</span> 字
            

            
            <br>

        </div>

        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/OUYANGSIHAI/JavaInterview" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-code-branch"></i>
    </a>


 
    <a href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=1446037005@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>




    <a href="https://zhihu.com/people/hai-hai-ren-sheng-50/activities" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>









    <a href="https://blog.ouyangsihai.cn/sitemap.xml" class="tooltipped" target="_blank" data-tooltip="站点地图" data-position="top" data-delay="50">
        <i class="fa fa-sitemap"></i>
    </a>



    <a href="https://blog.ouyangsihai.cn/friends" class="tooltipped" target="_blank" data-tooltip="友情链接" data-position="top" data-delay="50">
        <i class="fa fa-address-book"></i>
    </a>
</div>

    </div>
</footer>

<div class="progress-bar"></div>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();

        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */

        var t1 = Date.UTC(2019, 08, 10, 00, 00, 00); //北京时间2019-8-1 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes *
            minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours +
            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒" ;
    } /*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

<!-- 修改计数：欧阳思海 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);  // 50ms周期检测函数
        var pvcountOffset = 1005469;  // 初始化首次数据
        var uvcountOffset = 250804;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int); // 停止检测
            }
        }
    });
</script>




        <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    console.log("lets go！");
    console.log("/");
    searchFunc("/" + "search.json", 'searchInput', 'searchResult');
});
</script>
        <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


        <script src="/libs/materialize/materialize.min.js"></script>
        <script src="/libs/masonry/masonry.pkgd.min.js"></script>
        <script src="/libs/aos/aos.js"></script>
        <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
        <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
        <script src="/js/matery.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-149362573-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-149362573-1');
</script>



        
            <script src="/libs/others/clicklove.js"></script>
        

        
            <script async src="/libs/others/busuanzi.pure.mini.js"></script>
        

        <!-- 洪卫 shw2018 add 2019.08.28 -->
        <script type="text/javascript">
            var OriginTitile = document.title,
                st;
            document.addEventListener("visibilitychange", function () {
                document.hidden ? (document.title = "看不见我🙈~看不见我🙈~", clearTimeout(st)) : (document.title =
                    "(๑•̀ㅂ•́) ✧被发现了～", st = setTimeout(function () {
                        document.title = OriginTitile
                    }, 3e3))
            })
        </script>

        <!-- 鼠标点击烟花爆炸效果  洪卫 shw2018 add 2019.09.09 -->
        

        <!-- 背景雪花飘落特效洪卫 shw2018 add 2019.09.10 -->
        

        <!-- 鼠标点击文字特效 洪卫 shw2018 add 2019.09.10-->
        

        <!-- 背景雪花飘落特效 洪卫 shw2018 add 2019.09.10 -->
        

        <!-- 在线聊天工具  洪卫 shw2018 add 2019.09.11 -->
        

        <!-- 背景 canvas-nest  洪卫 shw 2018  add 2019.09.15-->
        

        <!-- 背景静止彩带  洪卫 shw 2018  add 2019.09.15-->
        

        <!-- 背景动态彩带 洪卫 shw 2018  add 2019.09.15-->
        

    </body>
</html>